<!DOCTYPE html><html>
<head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Yanyan's Wiki</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"/><link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css"/><meta name="next-head-count" content="5"/><link rel="preload" href="../_next/static/css/e993edd6a18ef4f0.css" as="style"/><link rel="stylesheet" href="../_next/static/css/e993edd6a18ef4f0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="../_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="../_next/static/chunks/webpack-f73d82589f972e7d.js" defer=""></script><script src="../_next/static/chunks/framework-66d32731bdd20e83.js" defer=""></script><script src="../_next/static/chunks/main-3929bf55b0f13a18.js" defer=""></script><script src="../_next/static/chunks/pages/_app-00b06920b385caf1.js" defer=""></script><script src="../_next/static/chunks/pages/%5b%5b...index%5d%5d-877ec949b69be209.js" defer=""></script><script src="../_next/static/a2FwJzUPGFGc0QcwaUr13/_buildManifest.js" defer=""></script><script src="../_next/static/a2FwJzUPGFGc0QcwaUr13/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-slate-300/10"><div class="sticky top-0 z-40 w-full backdrop-blur flex-none border-b border-slate-900/10 bg-white/75 supports-backdrop-blur:bg-white/60"><div class="max-w-8xl mx-auto"><div class="py-4 border-b border-slate-900/10 lg:px-8 lg:border-0 dark:border-slate-300/10 mx-4 lg:mx-0"><div class="relative flex items-center"><a href="../index.html">Yanyan's wiki</a><form class="text-xs text-slate-500">Â forÂ <input type="text" name="token" class="font-mono text-xs w-16" maxLength="8"/></form><div class="relative hidden lg:flex items-center ml-4 pl-4 border-l"><nav class="text-sm leading-6 font-semibold text-slate-700 dark:text-slate-200"><ul class="flex space-x-8"><li><a class="hover:text-sky-500 dark:hover:text-sky-400" href="../OS/2025/index.html">æ“ä½œç³»ç»Ÿ (2025 æ˜¥)</a></li></ul></nav></div></div></div></div></div><div class="container mx-auto max-w-5xl flex flex-col min-h-screen px-4"><div class="wiki bg-neutral-200/10"><h1>AbstractMachine: æŠ½è±¡è®¡ç®—æœº</h1>
<p>AbstractMachine æ˜¯è£¸æœºä¸Šçš„ C è¯­è¨€è¿è¡Œç¯å¢ƒï¼Œæä¾› 5 ç»„ (15 ä¸ª) ä¸»è¦ APIï¼Œå¯ä»¥å®ç°å„ç±»ç³»ç»Ÿè½¯ä»¶ (å¦‚æ“ä½œç³»ç»Ÿ)ï¼š</p>
<ul>
<li>(TRM) <code>putch</code>/<code>halt</code> - æœ€åŸºç¡€çš„è®¡ç®—ã€æ˜¾ç¤ºå’Œåœæœº</li>
<li>(IOE) <code>ioe_read/ioe_write</code> - I/O è®¾å¤‡ç®¡ç†</li>
<li>(CTE) <code>ienabled</code>/<code>iset</code>/<code>yield</code>/<code>kcontext</code> - ä¸­æ–­å’Œå¼‚å¸¸</li>
<li>(VME) <code>protect</code>/<code>unprotect</code>/<code>map</code>/<code>ucontext</code> - è™šå­˜ç®¡ç†</li>
<li>(MPE) <code>cpu_count</code>/<code>cpu_current</code>/<code>atomic_xchg</code> - å¤šå¤„ç†å™¨</li>
</ul>
<div class="box blue-box"><div><span class="float-left text-4xl mr-3 mt-2">ğŸ—’ï¸</span><span class="font-serif text-lg border-b border-slate-600"><b>ç›®å½•</b></span><div class="font-serif pt-2"><ul>
<li><a href="AM_Spec.html">AbstractMachine è§„çº¦ (Specifications)</a></li>
<li>(WiP) Tutorial: <a href="AM_Programs/index.html">å¦‚ä½•ä¸º â€œè£¸æœºâ€ (bare-metal) ç¼–ç¨‹</a></li>
<li>(WiP) Tutorial: <a href="AM_klib/index.html">åœ¨ AbstractMachine ä¸Šå°è£…åº“å‡½æ•°</a></li>
<li>(WiP) <a href="AM_Design/index.html">AbstractMachine è®¾è®¡æ¦‚è¿°</a></li>
<li>(WiP) <a href="AM_Devices/index.html">AbstractMachine è®¾å¤‡è§„çº¦</a></li>
</ul></div></div></div>
<h2>1. ç®€ä»‹</h2>
<p>ä»ç¡¬ä»¶çš„è§†è§’ï¼Œâ€œæ“ä½œç³»ç»Ÿâ€ å°±æ˜¯ä¸€æ®µæŒ‡ä»¤åºåˆ—ï¼›è€Œä»æ•°å­¦çš„è§†è§’ï¼Œä»»ä½•ç¨‹åºéƒ½æ˜¯çŠ¶æ€æœºâ€”â€”å› æ­¤ï¼Œæˆ‘ä»¬æ²¡æœ‰é“ç†ä¸èƒ½è½»æ¾æ„‰å¿«åœ°ç”¨é«˜çº§è¯­è¨€ (ä¾‹å¦‚ C è¯­è¨€) å®ç°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“æ“ä½œç³»ç»Ÿå†…æ ¸éœ€è¦ç®¡ç†ä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨ã€è™šæ‹Ÿå­˜å‚¨ã€I/Oã€å¤šå¤„ç†å™¨ç­‰è®¡ç®—æœºç¡¬ä»¶ä¸ºæˆ‘ä»¬æä¾›çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¼¼ä¹å¹¶ä¸æ˜¯ C è¯­è¨€æ‰€ â€œå†…ç½®â€ çš„ï¼šC è¯­è¨€åªæ”¯æŒçº¯ç²¹çš„è®¡ç®—ï¼Œéè®¡ç®—çš„éƒ¨åˆ†éƒ½é€šè¿‡åº“å‡½æ•°å®ç°ï¼Œä¾‹å¦‚ <code>fwrite</code>ã€<code>setjmp</code> ç­‰ã€‚AbstractMachine é€šè¿‡ 15 ä¸ª C API å®ç°äº†ç¡¬ä»¶æŠ½è±¡å±‚ (hardware abstraction layer, HAL)ï¼Œä½¿æˆ‘ä»¬å¯ä»¥åœ¨ C ä»£ç ä¸­æ“çºµè®¡ç®—æœºç¡¬ä»¶ã€‚</p>
<h2>2. å®‰è£…ä¸é…ç½®</h2>
<h3>2.1 é…ç½® AbstractMachine</h3>
<p>åœ¨æ“ä½œç³»ç»Ÿå®éªŒçš„ <code>os-workbench</code> ä¸­å·²ç»åŒ…å«äº† AbstractMachine ä»£ç ï¼Œå¹¶ä¸”å®éªŒæ¡†æ¶ä»£ç å·²ç»å®Œæˆäº†é…ç½®ã€‚å¦‚æœä½ ä½¿ç”¨ Debian/Ubuntu ç³»ç»Ÿï¼Œä½ åœ¨ç¼–è¯‘ä»£ç æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å‘½ä»¤æ‰§è¡Œå¤±è´¥çš„æƒ…å†µï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹è½¯ä»¶åŒ… (å¦‚æœæœ‰å…¶ä»–ä¾èµ–ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼Œè¯·ç›¸åº”è§£å†³)ï¼š</p>
<ul>
<li><code>gcc-multilib</code> (äº¤å‰ç¼–è¯‘ç”¨)</li>
<li><code>libsdl2-dev</code> (å›¾å½¢åº“)</li>
<li><code>qemu-system</code> (å…¨ç³»ç»Ÿæ¨¡æ‹Ÿå™¨)</li>
</ul>
<p>å¦‚æœä½ å¸Œæœ›å»ºç«‹è‡ªå·±çš„ AbstractMachine é¡¹ç›®æˆ–ç¼–è¯‘è¿è¡Œå…¶ä»–ç¤ºä¾‹ä»£ç  (microbench, fceux, litenes, ...) ç­‰ï¼Œåˆ™éœ€è¦å…ˆé…ç½®å¥½ <code>AM_HOME</code> ç¯å¢ƒå˜é‡ï¼ŒæŠŠå®ƒè®¾ç½®ä¸º AbstractMachine ç›®å½•çš„<strong>ç»å¯¹è·¯å¾„</strong>ï¼š</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> AM_HOME=/abs/path/to/.../os-workbench/abstract-machine
</code></pre>
<p>ä½ å¯ä»¥æŠŠè¿™ä¸€è¡Œå†™åœ¨ä½  shell çš„é»˜è®¤é…ç½®ä¸­ (ä¾‹å¦‚ <code>.bashrc</code>)ï¼Œä½¿å¾—ä¸å¿…æ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½é‡æ–°é…ç½®ã€‚å¦‚æœä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨ Linuxï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªæ¯”è¾ƒç—›è‹¦çš„è¿‡ç¨‹â€”â€”ä½ è¿˜éœ€è¦å­¦ä¹  Shell æœ‰å…³çš„åŸºç¡€çŸ¥è¯†ã€‚ä¸€ä»½ä¸é”™çš„å…¥é—¨ææ–™æ˜¯ MIT çš„ â€œ<a href="https://missing.csail.mit.edu/">The Missing Semester of Your CS Education</a>â€ã€‚</p>
<h2>2.2 Hello, AbstractMachine</h2>
<p>å®Œæˆå¿…è¦è½¯ä»¶çš„å®‰è£…å’Œæ­£ç¡®çš„ <code>AM_HOME</code> é…ç½®åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ AbstractMachine ä¸Šç¼–ç¨‹äº†ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ä»»æ„ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª <code>.c</code> æ–‡ä»¶å’Œ <code>Makefile</code> (å‚è€ƒ <code>man 3 stdarg</code>)ã€‚ä¾‹å¦‚ï¼Œåˆ›å»º hello.c:</p>
<pre><code class="hljs language-c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string"><am.h></span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string"><stdarg.h></span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, ...)</span> {
    va_list ap;
    va_start(ap, s);
    <span class="hljs-keyword">while</span> (s) {
        <span class="hljs-keyword">for</span> (; *s; s ++) putch(*s);
        s = va_arg(ap, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *);
    }
    va_end(ap);
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *args)</span> {
    print(<span class="hljs-string">"\""</span>, args, <span class="hljs-string">"\""</span>, <span class="hljs-string">" from "</span> __ISA__ <span class="hljs-string">" program!\n"</span>, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Makefile:</p>
<pre><code class="hljs language-Makefile">NAME := hello
SRCS := hello.c
<span class="hljs-keyword">include</span> <span class="hljs-variable">$(AM_HOME)</span>/Makefile.app
</code></pre>
<p>æˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ª<strong>å¯ç§»æ¤</strong>åˆ°å¤šä¸ª â€œbare-metalâ€ å¹³å°çš„ Hello World ç¨‹åºï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥åœ¨æ¨¡æ‹Ÿå™¨é‡Œè¿è¡Œï¼Œç”šè‡³ç›´æ¥åœ¨å¼€å‘æ¿ä¸Šè¿è¡Œï¼å½“ç„¶äº†ï¼Œç°åœ¨ç¼–è¯‘ã€é“¾æ¥ã€è¿è¡Œéƒ½ä¼šäº¤ç»™ AbstractMachine ä¸­çš„ä»£ç å¸®å¿™æå®šã€‚</p>
<p>ä¸ºäº†ç¼–è¯‘è¿è¡Œï¼ŒAbstractMachine éœ€è¦çŸ¥é“ç›®æ ‡çš„å¹³å°/ä½“ç³»ç»“æ„ï¼Œé€šè¿‡ <code>ARCH</code> ç¯å¢ƒå˜é‡æŒ‡å®šã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›ç¼–è¯‘å‡ºèƒ½åœ¨ x86-64 (QEMU) ä¸‹è¿è¡Œçš„é•œåƒï¼š</p>
<pre><code class="hljs language-text">$ make ARCH=x86_64-qemu
# Building hello-image [x86_64-qemu]
+ CC hello.c
...
+ CREATE -> build/hello-x86_64-qemu
</code></pre>
<p>ä¼šè‡ªåŠ¨å®Œæˆç¼–è¯‘ï¼Œå¾—åˆ° <code>build/</code> ç›®å½•ä¸‹çš„è‹¥å¹²æ–‡ä»¶ï¼š</p>
<pre><code class="hljs language-text">build
â”œâ”€â”€ hello-x86_64-qemu    // å¯è¿è¡Œã€åŒ…å« bootloader ç­‰çš„ç£ç›˜é•œåƒ
â”œâ”€â”€ hello-x86_64-qemu.o  // hello é¡¹ç›®çš„äºŒè¿›åˆ¶æ–‡ä»¶
â””â”€â”€ x86_64-qemu
    â”œâ”€â”€ hello.d          // hello.c ä¾èµ–çš„å¤´æ–‡ä»¶ (gcc -MMD ç”Ÿæˆ)
    â””â”€â”€ hello.o          // ç¼–è¯‘ hello.c å¾—åˆ°çš„ç›®æ ‡æ–‡ä»¶
</code></pre>
<p>ä¸å¦¨ç”¨ <code>objdump -d</code> å‘½ä»¤æŸ¥çœ‹ <code>hello-x86_64-qemu.o</code> åæ±‡ç¼–åçš„ä»£ç ï¼Œæ˜¯ç›´æ¥è¿è¡Œåœ¨è£¸æœºä¸Šçš„ C ç¨‹åºä»£ç ï¼Œç¨‹åºçš„å…¥å£æ˜¯ <code>_start</code>ã€‚Makefile ä¹Ÿè‡ªå¸¦äº†è¿è¡ŒåŠŸèƒ½ï¼Œä¼ å…¥ <code>mainargs</code> ç¯å¢ƒå˜é‡ï¼Œå³å¯å°†å‚æ•°ä¼ é€’ç»™ <code>main</code> å‡½æ•°ï¼š</p>
<pre><code class="hljs language-text">$ make run ARCH=x86_64-qemu mainargs="Hello World"
...
"Hello World" from x86_64 program!
CPU #0 Halt (00).
</code></pre>
<p>ä½ å¯ä»¥å°è¯•å…¶ä»–çš„ <code>ARCH</code> ç¯å¢ƒå˜é‡ï¼š<code>x86-qemu</code>, <code>native</code>ï¼Œåœ¨ä¸åŒå¹³å°ä¸‹è¿è¡Œã€‚ä½ ä¹Ÿå¯ä»¥ export é»˜è®¤çš„ <code>ARCH=x86_64-qemu</code> (ç”šè‡³å†™åˆ° Makefile ä¸­)ï¼Œé¿å…æ¯æ¬¡é”®å…¥ã€‚</p>
<div class="box blue-box"><div><span class="float-left text-4xl mr-3 mt-2">â˜•ï¸</span><span class="font-serif text-lg border-b border-slate-600"><b>ç†è§£ç¨‹åºä¸­çš„å®</b></span><div class="font-serif pt-2"><p>æˆ‘ä»¬çš„ Hello World ç¨‹åºå¼•ç”¨äº†ä¸€äº›å¥‡æ€ªçš„å®ï¼Œä¾‹å¦‚ <code>__ISA__</code>ï¼›æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚è¿™ä¸ªå®ä¸æ˜¯ C æ ‡å‡†é‡Œå®šä¹‰çš„ï¼Œé‚£ä¹ˆæ˜¯è°å®šä¹‰çš„ï¼Ÿå½“æˆ‘ä»¬è®¾ç½®ä¸åŒçš„ <code>ARCH</code>ï¼Œæ‰“å°çš„ <code>__ISA__</code> ä¹Ÿå„ä¸ç›¸åŒã€‚è¿™ä¸€å®šæ˜¯ Makefile åšçš„ã€‚æ€ä¹ˆçŸ¥é“å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¯¹ AbstractMachine ä»£ç åšä¸€ä¸ªå…¨æ–‡æŸ¥æ‰¾ â€œ<code>__ISA__</code>â€â€”â€”æˆ‘ä»¬èƒ½å®šä½åˆ° <code>Makefile</code> ä¸­çš„ä¸€è¡Œä»£ç ï¼Œå°† <code>__ISA__</code> çš„å®šä¹‰ä½¿ç”¨ gcc çš„ <code>-D</code> é€‰é¡¹åŠ å…¥äº† <code>CFLAGS</code>ã€‚</p><p>æ²¡é”™ï¼Œè®¡ç®—æœºç³»ç»Ÿæ²¡æœ‰é­”æ³•ï¼Œâ€œç¥å¥‡â€ çš„äº‹æƒ…åªæ˜¯å› ä¸ºä½ å¯¹æœ‰äº›è¯­è¨€æœºåˆ¶/ç”¨æ³•å¹¶ä¸ç†Ÿæ‚‰ã€‚</p></div></div></div>
<p><img src="img/full-system.webp" alt=""/></p></div></div><div class="bg-neutral-100 text-center text-neutral-600 dark:bg-neutral-600 dark:text-neutral-200 lg:text-left"><div class="bg-neutral-200 p-6 text-center dark:bg-neutral-700"><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons License: BY-NC 4.0</a><br/><a href="https://beian.miit.gov.cn/">è‹ ICP å¤‡ 2020049101 å·</a></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    p: \"p\",\n    ul: \"ul\",\n    li: \"li\",\n    code: \"code\",\n    a: \"a\",\n    h2: \"h2\",\n    h3: \"h3\",\n    strong: \"strong\",\n    pre: \"pre\",\n    span: \"span\",\n    img: \"img\"\n  }, _provideComponents(), props.components), {Box} = _components;\n  if (!Box) _missingMdxReference(\"Box\", true);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"AbstractMachine: æŠ½è±¡è®¡ç®—æœº\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"AbstractMachine æ˜¯è£¸æœºä¸Šçš„ C è¯­è¨€è¿è¡Œç¯å¢ƒï¼Œæä¾› 5 ç»„ (15 ä¸ª) ä¸»è¦ APIï¼Œå¯ä»¥å®ç°å„ç±»ç³»ç»Ÿè½¯ä»¶ (å¦‚æ“ä½œç³»ç»Ÿ)ï¼š\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"(TRM) \", _jsx(_components.code, {\n          children: \"putch\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"halt\"\n        }), \" - æœ€åŸºç¡€çš„è®¡ç®—ã€æ˜¾ç¤ºå’Œåœæœº\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(IOE) \", _jsx(_components.code, {\n          children: \"ioe_read/ioe_write\"\n        }), \" - I/O è®¾å¤‡ç®¡ç†\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(CTE) \", _jsx(_components.code, {\n          children: \"ienabled\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"iset\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"yield\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"kcontext\"\n        }), \" - ä¸­æ–­å’Œå¼‚å¸¸\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(VME) \", _jsx(_components.code, {\n          children: \"protect\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"unprotect\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"map\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"ucontext\"\n        }), \" - è™šå­˜ç®¡ç†\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(MPE) \", _jsx(_components.code, {\n          children: \"cpu_count\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"cpu_current\"\n        }), \"/\", _jsx(_components.code, {\n          children: \"atomic_xchg\"\n        }), \" - å¤šå¤„ç†å™¨\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(Box, {\n      logo: \"ğŸ—’ï¸\",\n      title: \"ç›®å½•\",\n      children: _jsxs(_components.ul, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: _jsx(_components.a, {\n            href: \"AM_Spec.md\",\n            children: \"AbstractMachine è§„çº¦ (Specifications)\"\n          })\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"(WiP) Tutorial: \", _jsx(_components.a, {\n            href: \"AM_Programs\",\n            children: \"å¦‚ä½•ä¸º â€œè£¸æœºâ€ (bare-metal) ç¼–ç¨‹\"\n          })]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"(WiP) Tutorial: \", _jsx(_components.a, {\n            href: \"AM_klib\",\n            children: \"åœ¨ AbstractMachine ä¸Šå°è£…åº“å‡½æ•°\"\n          })]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"(WiP) \", _jsx(_components.a, {\n            href: \"AM_Design\",\n            children: \"AbstractMachine è®¾è®¡æ¦‚è¿°\"\n          })]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"(WiP) \", _jsx(_components.a, {\n            href: \"AM_Devices\",\n            children: \"AbstractMachine è®¾å¤‡è§„çº¦\"\n          })]\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"1. ç®€ä»‹\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä»ç¡¬ä»¶çš„è§†è§’ï¼Œâ€œæ“ä½œç³»ç»Ÿâ€ å°±æ˜¯ä¸€æ®µæŒ‡ä»¤åºåˆ—ï¼›è€Œä»æ•°å­¦çš„è§†è§’ï¼Œä»»ä½•ç¨‹åºéƒ½æ˜¯çŠ¶æ€æœºâ€”â€”å› æ­¤ï¼Œæˆ‘ä»¬æ²¡æœ‰é“ç†ä¸èƒ½è½»æ¾æ„‰å¿«åœ°ç”¨é«˜çº§è¯­è¨€ (ä¾‹å¦‚ C è¯­è¨€) å®ç°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“æ“ä½œç³»ç»Ÿå†…æ ¸éœ€è¦ç®¡ç†ä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨ã€è™šæ‹Ÿå­˜å‚¨ã€I/Oã€å¤šå¤„ç†å™¨ç­‰è®¡ç®—æœºç¡¬ä»¶ä¸ºæˆ‘ä»¬æä¾›çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¼¼ä¹å¹¶ä¸æ˜¯ C è¯­è¨€æ‰€ â€œå†…ç½®â€ çš„ï¼šC è¯­è¨€åªæ”¯æŒçº¯ç²¹çš„è®¡ç®—ï¼Œéè®¡ç®—çš„éƒ¨åˆ†éƒ½é€šè¿‡åº“å‡½æ•°å®ç°ï¼Œä¾‹å¦‚ \", _jsx(_components.code, {\n        children: \"fwrite\"\n      }), \"ã€\", _jsx(_components.code, {\n        children: \"setjmp\"\n      }), \" ç­‰ã€‚AbstractMachine é€šè¿‡ 15 ä¸ª C API å®ç°äº†ç¡¬ä»¶æŠ½è±¡å±‚ (hardware abstraction layer, HAL)ï¼Œä½¿æˆ‘ä»¬å¯ä»¥åœ¨ C ä»£ç ä¸­æ“çºµè®¡ç®—æœºç¡¬ä»¶ã€‚\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"2. å®‰è£…ä¸é…ç½®\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"2.1 é…ç½® AbstractMachine\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"åœ¨æ“ä½œç³»ç»Ÿå®éªŒçš„ \", _jsx(_components.code, {\n        children: \"os-workbench\"\n      }), \" ä¸­å·²ç»åŒ…å«äº† AbstractMachine ä»£ç ï¼Œå¹¶ä¸”å®éªŒæ¡†æ¶ä»£ç å·²ç»å®Œæˆäº†é…ç½®ã€‚å¦‚æœä½ ä½¿ç”¨ Debian/Ubuntu ç³»ç»Ÿï¼Œä½ åœ¨ç¼–è¯‘ä»£ç æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å‘½ä»¤æ‰§è¡Œå¤±è´¥çš„æƒ…å†µï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹è½¯ä»¶åŒ… (å¦‚æœæœ‰å…¶ä»–ä¾èµ–ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼Œè¯·ç›¸åº”è§£å†³)ï¼š\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"gcc-multilib\"\n        }), \" (äº¤å‰ç¼–è¯‘ç”¨)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"libsdl2-dev\"\n        }), \" (å›¾å½¢åº“)\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"qemu-system\"\n        }), \" (å…¨ç³»ç»Ÿæ¨¡æ‹Ÿå™¨)\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"å¦‚æœä½ å¸Œæœ›å»ºç«‹è‡ªå·±çš„ AbstractMachine é¡¹ç›®æˆ–ç¼–è¯‘è¿è¡Œå…¶ä»–ç¤ºä¾‹ä»£ç  (microbench, fceux, litenes, ...) ç­‰ï¼Œåˆ™éœ€è¦å…ˆé…ç½®å¥½ \", _jsx(_components.code, {\n        children: \"AM_HOME\"\n      }), \" ç¯å¢ƒå˜é‡ï¼ŒæŠŠå®ƒè®¾ç½®ä¸º AbstractMachine ç›®å½•çš„\", _jsx(_components.strong, {\n        children: \"ç»å¯¹è·¯å¾„\"\n      }), \"ï¼š\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-bash\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-built_in\",\n          children: \"export\"\n        }), \" AM_HOME=/abs/path/to/.../os-workbench/abstract-machine\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä½ å¯ä»¥æŠŠè¿™ä¸€è¡Œå†™åœ¨ä½  shell çš„é»˜è®¤é…ç½®ä¸­ (ä¾‹å¦‚ \", _jsx(_components.code, {\n        children: \".bashrc\"\n      }), \")ï¼Œä½¿å¾—ä¸å¿…æ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½é‡æ–°é…ç½®ã€‚å¦‚æœä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨ Linuxï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªæ¯”è¾ƒç—›è‹¦çš„è¿‡ç¨‹â€”â€”ä½ è¿˜éœ€è¦å­¦ä¹  Shell æœ‰å…³çš„åŸºç¡€çŸ¥è¯†ã€‚ä¸€ä»½ä¸é”™çš„å…¥é—¨ææ–™æ˜¯ MIT çš„ â€œ\", _jsx(_components.a, {\n        href: \"https://missing.csail.mit.edu/\",\n        children: \"The Missing Semester of Your CS Education\"\n      }), \"â€ã€‚\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"2.2 Hello, AbstractMachine\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"å®Œæˆå¿…è¦è½¯ä»¶çš„å®‰è£…å’Œæ­£ç¡®çš„ \", _jsx(_components.code, {\n        children: \"AM_HOME\"\n      }), \" é…ç½®åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ AbstractMachine ä¸Šç¼–ç¨‹äº†ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ä»»æ„ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª \", _jsx(_components.code, {\n        children: \".c\"\n      }), \" æ–‡ä»¶å’Œ \", _jsx(_components.code, {\n        children: \"Makefile\"\n      }), \" (å‚è€ƒ \", _jsx(_components.code, {\n        children: \"man 3 stdarg\"\n      }), \")ã€‚ä¾‹å¦‚ï¼Œåˆ›å»º hello.c:\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-c\",\n        children: [_jsxs(_components.span, {\n          className: \"hljs-meta\",\n          children: [\"#\", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"include\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\u003cam.h\u003e\"\n          })]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"hljs-meta\",\n          children: [\"#\", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"include\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\u003cstdarg.h\u003e\"\n          })]\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"void\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"print\"\n        }), _jsxs(_components.span, {\n          className: \"hljs-params\",\n          children: [\"(\", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"const\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"char\"\n          }), \" *s, ...)\"]\n        }), \" {\\n    va_list ap;\\n    va_start(ap, s);\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"while\"\n        }), \" (s) {\\n        \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"for\"\n        }), \" (; *s; s ++) putch(*s);\\n        s = va_arg(ap, \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"char\"\n        }), \" *);\\n    }\\n    va_end(ap);\\n}\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"int\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"main\"\n        }), _jsxs(_components.span, {\n          className: \"hljs-params\",\n          children: [\"(\", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"const\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"char\"\n          }), \" *args)\"]\n        }), \" {\\n    print(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"\\\\\\\"\\\"\"\n        }), \", args, \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"\\\\\\\"\\\"\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\" from \\\"\"\n        }), \" __ISA__ \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\" program!\\\\n\\\"\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"NULL\"\n        }), \");\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"0\"\n        }), \";\\n}\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Makefile:\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-Makefile\",\n        children: [\"NAME := hello\\nSRCS := hello.c\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"include\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"$(AM_HOME)\"\n        }), \"/Makefile.app\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"æˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ª\", _jsx(_components.strong, {\n        children: \"å¯ç§»æ¤\"\n      }), \"åˆ°å¤šä¸ª â€œbare-metalâ€ å¹³å°çš„ Hello World ç¨‹åºï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥åœ¨æ¨¡æ‹Ÿå™¨é‡Œè¿è¡Œï¼Œç”šè‡³ç›´æ¥åœ¨å¼€å‘æ¿ä¸Šè¿è¡Œï¼å½“ç„¶äº†ï¼Œç°åœ¨ç¼–è¯‘ã€é“¾æ¥ã€è¿è¡Œéƒ½ä¼šäº¤ç»™ AbstractMachine ä¸­çš„ä»£ç å¸®å¿™æå®šã€‚\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä¸ºäº†ç¼–è¯‘è¿è¡Œï¼ŒAbstractMachine éœ€è¦çŸ¥é“ç›®æ ‡çš„å¹³å°/ä½“ç³»ç»“æ„ï¼Œé€šè¿‡ \", _jsx(_components.code, {\n        children: \"ARCH\"\n      }), \" ç¯å¢ƒå˜é‡æŒ‡å®šã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›ç¼–è¯‘å‡ºèƒ½åœ¨ x86-64 (QEMU) ä¸‹è¿è¡Œçš„é•œåƒï¼š\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-text\",\n        children: \"$ make ARCH=x86_64-qemu\\n# Building hello-image [x86_64-qemu]\\n+ CC hello.c\\n...\\n+ CREATE -\u003e build/hello-x86_64-qemu\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä¼šè‡ªåŠ¨å®Œæˆç¼–è¯‘ï¼Œå¾—åˆ° \", _jsx(_components.code, {\n        children: \"build/\"\n      }), \" ç›®å½•ä¸‹çš„è‹¥å¹²æ–‡ä»¶ï¼š\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-text\",\n        children: \"build\\nâ”œâ”€â”€ hello-x86_64-qemu    // å¯è¿è¡Œã€åŒ…å« bootloader ç­‰çš„ç£ç›˜é•œåƒ\\nâ”œâ”€â”€ hello-x86_64-qemu.o  // hello é¡¹ç›®çš„äºŒè¿›åˆ¶æ–‡ä»¶\\nâ””â”€â”€ x86_64-qemu\\n    â”œâ”€â”€ hello.d          // hello.c ä¾èµ–çš„å¤´æ–‡ä»¶ (gcc -MMD ç”Ÿæˆ)\\n    â””â”€â”€ hello.o          // ç¼–è¯‘ hello.c å¾—åˆ°çš„ç›®æ ‡æ–‡ä»¶\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä¸å¦¨ç”¨ \", _jsx(_components.code, {\n        children: \"objdump -d\"\n      }), \" å‘½ä»¤æŸ¥çœ‹ \", _jsx(_components.code, {\n        children: \"hello-x86_64-qemu.o\"\n      }), \" åæ±‡ç¼–åçš„ä»£ç ï¼Œæ˜¯ç›´æ¥è¿è¡Œåœ¨è£¸æœºä¸Šçš„ C ç¨‹åºä»£ç ï¼Œç¨‹åºçš„å…¥å£æ˜¯ \", _jsx(_components.code, {\n        children: \"_start\"\n      }), \"ã€‚Makefile ä¹Ÿè‡ªå¸¦äº†è¿è¡ŒåŠŸèƒ½ï¼Œä¼ å…¥ \", _jsx(_components.code, {\n        children: \"mainargs\"\n      }), \" ç¯å¢ƒå˜é‡ï¼Œå³å¯å°†å‚æ•°ä¼ é€’ç»™ \", _jsx(_components.code, {\n        children: \"main\"\n      }), \" å‡½æ•°ï¼š\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-text\",\n        children: \"$ make run ARCH=x86_64-qemu mainargs=\\\"Hello World\\\"\\n...\\n\\\"Hello World\\\" from x86_64 program!\\nCPU #0 Halt (00).\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ä½ å¯ä»¥å°è¯•å…¶ä»–çš„ \", _jsx(_components.code, {\n        children: \"ARCH\"\n      }), \" ç¯å¢ƒå˜é‡ï¼š\", _jsx(_components.code, {\n        children: \"x86-qemu\"\n      }), \", \", _jsx(_components.code, {\n        children: \"native\"\n      }), \"ï¼Œåœ¨ä¸åŒå¹³å°ä¸‹è¿è¡Œã€‚ä½ ä¹Ÿå¯ä»¥ export é»˜è®¤çš„ \", _jsx(_components.code, {\n        children: \"ARCH=x86_64-qemu\"\n      }), \" (ç”šè‡³å†™åˆ° Makefile ä¸­)ï¼Œé¿å…æ¯æ¬¡é”®å…¥ã€‚\"]\n    }), \"\\n\", _jsxs(Box, {\n      logo: \"â˜•ï¸\",\n      title: \"ç†è§£ç¨‹åºä¸­çš„å®\",\n      children: [_jsxs(_components.p, {\n        children: [\"æˆ‘ä»¬çš„ Hello World ç¨‹åºå¼•ç”¨äº†ä¸€äº›å¥‡æ€ªçš„å®ï¼Œä¾‹å¦‚ \", _jsx(_components.code, {\n          children: \"__ISA__\"\n        }), \"ï¼›æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚è¿™ä¸ªå®ä¸æ˜¯ C æ ‡å‡†é‡Œå®šä¹‰çš„ï¼Œé‚£ä¹ˆæ˜¯è°å®šä¹‰çš„ï¼Ÿå½“æˆ‘ä»¬è®¾ç½®ä¸åŒçš„ \", _jsx(_components.code, {\n          children: \"ARCH\"\n        }), \"ï¼Œæ‰“å°çš„ \", _jsx(_components.code, {\n          children: \"__ISA__\"\n        }), \" ä¹Ÿå„ä¸ç›¸åŒã€‚è¿™ä¸€å®šæ˜¯ Makefile åšçš„ã€‚æ€ä¹ˆçŸ¥é“å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¯¹ AbstractMachine ä»£ç åšä¸€ä¸ªå…¨æ–‡æŸ¥æ‰¾ â€œ\", _jsx(_components.code, {\n          children: \"__ISA__\"\n        }), \"â€â€”â€”æˆ‘ä»¬èƒ½å®šä½åˆ° \", _jsx(_components.code, {\n          children: \"Makefile\"\n        }), \" ä¸­çš„ä¸€è¡Œä»£ç ï¼Œå°† \", _jsx(_components.code, {\n          children: \"__ISA__\"\n        }), \" çš„å®šä¹‰ä½¿ç”¨ gcc çš„ \", _jsx(_components.code, {\n          children: \"-D\"\n        }), \" é€‰é¡¹åŠ å…¥äº† \", _jsx(_components.code, {\n          children: \"CFLAGS\"\n        }), \"ã€‚\"]\n      }), _jsx(_components.p, {\n        children: \"æ²¡é”™ï¼Œè®¡ç®—æœºç³»ç»Ÿæ²¡æœ‰é­”æ³•ï¼Œâ€œç¥å¥‡â€ çš„äº‹æƒ…åªæ˜¯å› ä¸ºä½ å¯¹æœ‰äº›è¯­è¨€æœºåˆ¶/ç”¨æ³•å¹¶ä¸ç†Ÿæ‚‰ã€‚\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"img/full-system.webp\",\n        alt: \"\"\n      })\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error(\"Expected \" + (component ? \"component\" : \"object\") + \" `\" + id + \"` to be defined: you likely forgot to import, pass, or provide it.\");\n}\n","frontmatter":{},"scope":{}},"frontmatter":{}},"__N_SSG":true},"page":"/[[...index]]","query":{"index":["AbstractMachine"]},"buildId":"a2FwJzUPGFGc0QcwaUr13","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body>
</html>