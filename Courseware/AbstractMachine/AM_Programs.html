<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../static/katex/katex.min.css">
  <script defer src="../static/katex/katex.min.js"></script>
  <script defer src="../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>&#20026; Bare-Metal &#32534;&#31243;&#65306;&#32534;&#35793;&#12289;&#38142;&#25509;&#19982;&#21152;&#36733;</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="../index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="../OS/2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="bare-metal" class=" text-2xl mt-2 font-sans">&#20026; Bare-Metal &#32534;&#31243;&#65306;&#32534;&#35793;&#12289;&#38142;&#25509;&#19982;&#21152;&#36733;</h1>
<h2 id="1" class=" text-xl mt-2 pb-2 font-sans">1. &#20174;&#19968;&#20010;&#20363;&#23376;&#35828;&#36215;</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">&#38405;&#35835;&#26412;&#25991;&#26723;&#38656;&#35201;&#33021;&#22815;&#38405;&#35835;&#27719;&#32534;&#35821;&#35328;&#8212;&#8212;&#19981;&#29992;&#24597;&#65292;&#23427;&#20204;&#20195;&#34920;&#20102;&#29366;&#24577;&#26426;&#30340;&#36801;&#31227;&#20989;&#25968;&#12290;&#22312;&#36935;&#21040;&#19981;&#29087;&#24713;&#30340;&#22320;&#26041;&#65292;&#35831; STFW/RTFM&#12290;</p>
</blockquote>
<p class=" font-serif my-1">Bare-metal &#36816;&#34892;&#30340;&#31243;&#24207;&#21644;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#31243;&#24207;&#19981;&#19968;&#26679;&#8212;&#8212;&#24403;&#25105;&#20204;&#38754;&#23545; bare-metal &#30340;&#26102;&#20505;&#65292;&#20960;&#20046;<strong>&#27599;&#19968;&#34892;</strong>&#20195;&#30721;&#37117;&#26159;&#33258;&#24049;&#32534;&#20889;&#30340;&#65292;&#21253;&#25324;&#24211;&#20989;&#25968;&#65292;&#29978;&#33267;&#36830;&#24110;&#25105;&#20204;&#21152;&#36733; <code>main</code> &#20989;&#25968;&#30340;&#20195;&#30721;&#37117;&#38656;&#35201;&#33258;&#24049;&#20889;&#12290;</p>
<p class=" font-serif my-1">&#22240;&#27492;&#65292;&#24590;&#26679;&#35753; C &#31243;&#24207;&#36816;&#34892;&#36215;&#26469;&#65292;&#26159; &#8220;&#20889;&#25805;&#20316;&#31995;&#32479;&#8221; &#26032;&#25163;&#26368;&#22823;&#30340;&#22256;&#24785;&#20043;&#19968;&#65292;&#22914;&#26524;&#24605;&#32771;&#19968;&#19979;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#20026;&#20102;&#20351;&#31243;&#24207;&#33021;&#36816;&#34892;&#65292;&#24403;&#28982;&#38656;&#35201;&#32463;&#36807;&#32534;&#35793;&#38142;&#25509;&#30340;&#36807;&#31243;&#12290;&#23601;&#20551;&#35774;&#26368;&#31616;&#21333;&#30340;&#24773;&#20917;&#65306;&#29983;&#25104;&#38745;&#24577;&#38142;&#25509;&#30340; ELF &#26684;&#24335;&#30340;&#20108;&#36827;&#21046;&#25991;&#20214;&#22909;&#20102;&#12290;</li>
<li class=" ml-8">&#20108;&#36827;&#21046;&#25991;&#20214;&#20551;&#35774;&#20195;&#30721;&#12289;&#25968;&#25454;&#23384;&#22312;&#20110;&#22320;&#22336;&#31354;&#38388;&#30340;&#25351;&#23450;&#20301;&#32622;&#12290;&#37027;&#20040;&#26159;&#35841;&#26469;&#23436;&#25104;&#36825;&#20214;&#20107;&#65311;</li>
<li class=" ml-8"><code>main</code> &#22312;&#20108;&#36827;&#21046;&#25991;&#20214;&#20013;&#30340;&#22320;&#22336;&#26159;&#19981;&#22266;&#23450;&#30340;&#12290;&#26159;&#35841;&#35843;&#29992;&#30340; <code>main()</code>&#65311;</li>
<li class=" ml-8">&#25105;&#20204;&#38656;&#35201;&#33258;&#24049;&#21160;&#25163;&#23454;&#29616;&#21508;&#31181;&#24211;&#20989;&#25968;&#65292;&#37027; <code>printf</code> (&#36755;&#20986;&#21040;&#23631;&#24149;), <code>malloc</code> (&#21160;&#24577;&#20998;&#37197;&#20869;&#23384;)&#21448;&#26159;&#22914;&#20309;&#23454;&#29616;&#30340;&#65311;</li>
</ul>
<p class=" font-serif my-1">&#20026;&#20102;&#29702;&#35299; C &#31243;&#24207;&#26159;&#22914;&#20309;&#36816;&#34892;&#22312;&#35064;&#26426; (bare-metal) &#19978;&#30340;&#65292;&#25105;&#20204;&#39318;&#20808;&#29702;&#35299; C &#31243;&#24207;&#26159;&#22914;&#20309;&#20174;&#28304;&#20195;&#30721; (&#25991;&#26412;&#25991;&#20214;) &#26368;&#32456;&#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#36816;&#34892;&#36215;&#26469;&#30340;&#12290;&#20026;&#27492;&#65292;&#25105;&#20204;&#35762;&#35299;&#19968;&#20010;&#23567;&#20363;&#23376; (<code>say.c</code> &#21644; <code>main.c</code> &#32452;&#25104;&#30340;&#23567;&#39033;&#30446;) &#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#20197;&#21450; AbstractMachine &#19978;&#30340;&#32534;&#35793;&#12289;&#38142;&#25509;&#21644;&#21152;&#36733;&#36816;&#34892;&#30340;&#36807;&#31243;&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// say.c</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">putch</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">putchar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">say</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#ifdef __ARCH__</span>
<span class="w">    </span><span class="n">putch</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">// AbstractMachine&#65292;&#27809;&#26377; libc&#65292;&#35843;&#29992; TRM API &#25171;&#21360;&#23383;&#31526;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">// &#25805;&#20316;&#31995;&#32479;&#65292;&#35843;&#29992; libc &#25171;&#21360;&#23383;&#31526;</span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// main.c</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">say</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">say</span><span class="p">(</span><span class="s">"hello</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#20197;&#19979;&#23436;&#25972;&#30340;&#27969;&#31243;&#26159;&#25805;&#20316;&#31995;&#32479;&#19978; (hosted) &#21644; bare-metal &#19978;&#20849;&#21516;&#30340;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>main.c  -&gt; &#32534;&#35793; (gcc -c) -&gt; a.o -+ 
                                 \
 say.c  -&gt; &#32534;&#35793; (gcc -c) -&gt; b.o  -&gt; &#38142;&#25509; (ld) -&gt; a.out -&gt; &#21152;&#36733; (loader)
</code></pre></div>

<h2 id="2-c" class=" text-xl mt-2 pb-2 font-sans">2. &#25805;&#20316;&#31995;&#32479;&#19978;&#30340; C &#31243;&#24207;</h2>
<h3 id="21" class=" text-lg mt-2 pb-2 font-sans">2.1. &#32534;&#35793;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#20351;&#29992; gcc &#25226;&#28304;&#20195;&#30721;&#32534;&#35793;&#25104;&#21487;&#37325;&#23450;&#20301;&#30340;&#20108;&#36827;&#21046;&#25991;&#20214;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gcc -c -O2 -o main.o main.c
$ gcc -c -O2 -o say.o say.c
$ file say.o main.o
say.o:  ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped
main.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped
</code></pre></div>

<p class=" font-serif my-1">&#8220;relocatable&#8221; &#30340;&#21547;&#20041;&#26159;&#34429;&#28982;&#29983;&#25104;&#20102;&#25351;&#20196;&#24207;&#21015;&#65292;&#20294;&#26242;&#26102;&#36824;&#19981;&#30830;&#23450;&#23427;&#20204;&#22312;&#20108;&#36827;&#21046;&#25991;&#20214;&#20013;&#30340;&#20301;&#32622;&#12290;&#25105;&#20204;&#21487;&#20197;&#26597;&#30475;&#29983;&#25104;&#30340;&#25351;&#20196;&#24207;&#21015;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ objdump -d main.o
0000000000000000 &lt;main&gt;:
   0:   48 8d 3d 00 00 00 00    lea    0x0(%rip),%rdi        # 7 &lt;main+0x7&gt;
   7:   48 83 ec 08             sub    $0x8,%rsp
   b:   e8 00 00 00 00          callq  10 &lt;main+0x10&gt;
  10:   31 c0                   xor    %eax,%eax
  12:   48 83 c4 08             add    $0x8,%rsp
  16:   c3                      retq   
</code></pre></div>

<p class=" font-serif my-1">&#21487;&#20197;&#30475;&#21040; relocatable &#30340;&#20195;&#30721;&#20174; 0 &#24320;&#22987;&#32534;&#22336;&#65307;&#22240;&#20026; <code>main</code> &#24182;&#19981;&#30693;&#36947; <code>say</code> &#30340;&#20195;&#30721;&#22312;&#20309;&#22788;&#65292;&#25152;&#20197;&#34429;&#28982;&#29983;&#25104;&#20102; opcode &#20026; <code>0xe8</code> &#30340; <code>call</code> &#25351;&#20196; (&#23545;&#24212; <code>say("...")</code> &#30340;&#20989;&#25968;&#35843;&#29992;)&#65292;&#20294;&#27809;&#26377;&#29983;&#25104;&#36339;&#36716;&#30340;&#20559;&#31227;&#37327; (<code>say.c</code> &#20013;&#21521; <code>putchar</code> &#30340;&#35843;&#29992;&#20063;&#29983;&#25104;&#21516;&#26679;&#30340; <code>call</code> &#25351;&#20196;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>   b:   e8 00 00 00 00          callq  10 &lt;main+0x10&gt;
</code></pre></div>

<p class=" font-serif my-1">&#31867;&#20284;&#30340;&#65292;<code>say</code> &#30340;&#31532;&#19968;&#20010;&#21442;&#25968; (&#36890;&#36807; <code>%rdi</code> &#23492;&#23384;&#22120;&#20256;&#36882;) &#26159;&#36890;&#36807;&#22914;&#19979; <code>lea</code> &#25351;&#20196;&#33719;&#21462;&#30340;&#65292;&#23427;&#30340;&#20301;&#32622;&#21516;&#26679;&#26242;&#26102;&#27809;&#26377;&#30830;&#23450;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>   0:   48 8d 3d 00 00 00 00    lea    0x0(%rip),%rdi        # 7 &lt;main+0x7&gt;
</code></pre></div>

<h3 id="22" class=" text-lg mt-2 pb-2 font-sans">2.2 &#38142;&#25509;</h3>
<p class=" font-serif my-1">&#36890;&#24120;&#65292;&#25105;&#20204;&#20351;&#29992; gcc &#24110;&#21161;&#25105;&#20204;&#23436;&#25104;&#38142;&#25509;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gcc main.o say.o
$ ./a.out
hello
</code></pre></div>

<p class=" font-serif my-1">&#22914;&#26524;&#30452;&#25509;&#20351;&#29992; <code>ld</code> &#21629;&#20196;&#38142;&#25509;&#65292;&#21017;&#20250;&#25253;&#38169;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ ld main.o say.o
ld main.o say.o
ld: warning: cannot find entry symbol _start; defaulting to 00000000004000b0
say.o: In function `say':
say.c:(.text+0x15): undefined reference to `putchar'
</code></pre></div>

<p class=" font-serif my-1">&#39318;&#20808;&#65292;&#25105;&#20204;&#30340;&#31243;&#24207;&#27809;&#26377;&#20837;&#21475; (<code>_start</code>)&#65292;&#20854;&#27425;&#65292;&#25105;&#20204;&#38142;&#25509;&#30340;&#23545;&#35937;&#20013;&#27809;&#26377; <code>putchar</code> &#20989;&#25968;&#12290;&#25105;&#20204;&#21487;&#20197;&#32473; gcc &#20256;&#36882;&#39069;&#22806;&#30340;&#21442;&#25968;&#65292;&#26597;&#30475; <code>ld</code> &#30340;&#36873;&#39033;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>gcc -Wl,--verbose main.o say.o
</code></pre></div>

<p class=" font-serif my-1">&#20320;&#20250;&#21457;&#29616;&#38142;&#25509;&#30340;&#36807;&#31243;&#27604;&#24819;&#35937;&#20013;&#22797;&#26434;&#24471;&#22810;&#12290;&#29992;&#20197;&#19979;&#31616;&#21270;&#20102;&#30340;&#21629;&#20196;&#21487;&#20197;&#24471;&#21040;&#21487;&#36816;&#34892;&#30340; hello &#31243;&#24207;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$<span class="w"> </span>ld<span class="w"> </span>-dynamic-linker<span class="w"> </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/usr/lib/x86_64-linux-gnu/crt1.o<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/usr/lib/x86_64-linux-gnu/crti.o<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>main.o<span class="w"> </span>say.o<span class="w"> </span>-lc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/usr/lib/x86_64-linux-gnu/crtn.o
$<span class="w"> </span>./a.out
hello
</code></pre></div>

<p class=" font-serif my-1">&#20026;&#20160;&#20040;&#36825;&#20040;&#22797;&#26434;&#65311;&#36824;&#26377;&#22909;&#22810;&#27809;&#35265;&#36807;&#30340;&#25991;&#20214;&#65281;&#36825;&#26159;&#22240;&#20026;&#25105;&#20204;&#30340;&#20108;&#36827;&#21046;&#25991;&#20214;&#35201;&#36816;&#34892;&#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#65292;&#23601;&#24517;&#39035;&#36981;&#24490;&#25805;&#20316;&#31995;&#32479;&#30340;&#35268;&#21017;&#65292;&#35843;&#29992;&#25805;&#20316;&#31995;&#32479;&#25552;&#20379;&#30340; API &#23436;&#25104;&#21152;&#36733;&#12290;&#21152;&#36733;&#22120;&#20063;&#26159;&#20195;&#30721;&#30340;&#19968;&#37096;&#20998;&#65292;&#24403;&#28982;&#24212;&#35813;&#34987;&#38142;&#25509;&#36827;&#26469;&#12290;&#38142;&#25509;&#25991;&#20214;&#30340;&#20855;&#20307;&#35299;&#37322;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>ld-linux-x86-64.so</code> &#36127;&#36131;&#21160;&#24577;&#38142;&#25509;&#24211;&#30340;&#21152;&#36733;&#65292;&#27809;&#26377;&#23427;&#23601;&#26080;&#27861;&#21152;&#36733;&#21160;&#24577;&#38142;&#25509;&#24211; (libc)&#12290;</li>
<li class=" ml-8"><code>crt*.o</code> &#26159; C Runtime &#30340;&#32553;&#20889;&#65292;&#21363; C &#31243;&#24207;&#36816;&#34892;&#25152;&#24517;&#39035;&#30340;&#19968;&#20123;&#29615;&#22659;&#65292;&#20363;&#22914;&#31243;&#24207;&#30340;&#20837;&#21475;&#20989;&#25968; <code>_start</code> (&#20108;&#36827;&#21046;&#25991;&#20214;&#24182;&#19981;&#26159;&#20174; <code>main</code> &#24320;&#22987;&#25191;&#34892;&#30340;&#65281;)&#12289;<code>atexit</code> &#27880;&#20876;&#22238;&#35843;&#20989;&#25968;&#30340;&#25191;&#34892;&#31561;&#12290;</li>
<li class=" ml-8"><code>-lc</code> &#34920;&#31034;&#38142;&#25509; glibc&#12290;</li>
</ul>
<p class=" font-serif my-1">&#38142;&#25509;&#21518;&#24471;&#21040;&#19968;&#20010; ELF &#26684;&#24335;&#30340;&#21487;&#25191;&#34892;&#25991;&#20214;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ file a.out
a.out: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, for GNU/Linux 3.2.0, not stripped
$ objdump -d a.out
...
0000000000400402 &lt;main&gt;:
  400402:       55                      push   %rbp
  400403:       48 89 e5                mov    %rsp,%rbp
  400406:       48 8d 3d c7 00 00 00    lea    0xc7(%rip),%rdi        # 4004d4 &lt;_IO_stdin_used+0x4&gt;
  40040d:       b8 00 00 00 00          mov    $0x0,%eax
  400412:       e8 07 00 00 00          callq  40041e &lt;say&gt;
  400417:       b8 00 00 00 00          mov    $0x0,%eax
  40041c:       5d                      pop    %rbp
  40041d:       c3                      retq   

000000000040041e &lt;say&gt;:
  40041e:       55                      push   %rbp
  40041f:       48 89 e5                mov    %rsp,%rbp
  400422:       48 83 ec 10             sub    $0x10,%rsp
  400426:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  40042a:       eb 16                   jmp    400442 &lt;say+0x24&gt;
  40042c:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  400430:       0f b6 00                movzbl (%rax),%eax
  400433:       0f be c0                movsbl %al,%eax
  400436:       89 c7                   mov    %eax,%edi
  400438:       e8 83 ff ff ff          callq  4003c0 &lt;putchar@plt&gt;
  40043d:       48 83 45 f8 01          addq   $0x1,-0x8(%rbp)
  400442:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  400446:       0f b6 00                movzbl (%rax),%eax
  400449:       84 c0                   test   %al,%al
  40044b:       75 df                   jne    40042c &lt;say+0xe&gt;
  40044d:       90                      nop
  40044e:       c9                      leaveq 
  40044f:       c3                      retq   
...
</code></pre></div>

<h3 id="23" class=" text-lg mt-2 pb-2 font-sans">2.3. &#21152;&#36733;</h3>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#35686;&#21578;&#65306;&#22823;&#37327;&#30340;&#32454;&#33410;</h4>
<p class=" font-serif my-1">&#31243;&#24207;&#21152;&#36733;&#30340;&#36807;&#31243;&#21313;&#20998;&#22797;&#26434;&#65292;&#29978;&#33267;&#26377;&#19968;&#20123;&#20320;&#30446;&#21069;&#21487;&#33021;&#26242;&#26102;&#38590;&#20197;&#29702;&#35299;&#30340;&#22320;&#26041; (&#20363;&#22914; vvar, vdso, &#21464;&#21270;&#30340; <code>a.out</code> &#31561;)&#12290;&#25105;&#20204;&#20250;&#29992;&#19968;&#23398;&#26399;&#30340;&#35838;&#31243;&#22238;&#31572;&#36825;&#20123;&#38382;&#39064;&#12290;&#25152;&#20197;&#36935;&#21040;&#19981;&#26126;&#30333;&#30340;&#22320;&#26041;&#65292;&#36339;&#36807;&#21363;&#21487;&#12290;&#38543;&#30528;&#35838;&#31243;&#30340;&#36827;&#23637;&#65292;&#20320;&#23545;&#36825;&#20010;&#36807;&#31243;&#30340;&#29702;&#35299;&#20250;&#19981;&#26029;&#21152;&#28145;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#23436;&#25104;&#38142;&#25509;&#21518;&#65292;&#22312;&#25805;&#20316;&#31995;&#32479;&#30340;&#32456;&#31471;&#31243;&#24207;&#20013;&#20351;&#29992; <code>./a.out</code> &#36816;&#34892;&#25105;&#20204;&#30340;&#31243;&#24207;&#65292;&#27969;&#31243;&#22823;&#33268;&#22914;&#19979; (&#23398;&#23436;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#35838;&#21518;&#65292;&#20320;&#23558;&#20250;&#23545;&#36825;&#20010;&#27969;&#31243;&#26377;&#26356;&#28145;&#20837;&#30340;&#35748;&#35782;)&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Shell &#25509;&#25910;&#21040;&#21629;&#20196;&#21518;&#65292;&#22312;&#25805;&#20316;&#31995;&#32479;&#20013;&#20351;&#29992; <code>fork()</code> &#21019;&#24314;&#19968;&#20010;&#26032;&#30340;&#36827;&#31243;&#12290;</li>
<li class=" ml-8">&#22312;&#23376;&#36827;&#31243;&#20013;&#20351;&#29992; <code>execve()</code> &#21152;&#36733; <code>a.out</code>&#12290;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#30340;&#21152;&#36733;&#22120;&#35782;&#21035;&#20986; <code>a.out</code> &#26159;&#19968;&#20010;&#21160;&#24577;&#38142;&#25509;&#25991;&#20214;&#65292;&#20570;&#20986;&#24517;&#35201;&#30340;&#20869;&#23384;&#26144;&#23556;&#65292;&#20174; <code>ld-linux-x86-64.so</code> &#30340;&#20195;&#30721;&#24320;&#22987;&#25191;&#34892;&#65292;&#25226;&#21160;&#24577;&#38142;&#25509;&#24211;&#26144;&#23556;&#21040;&#36827;&#31243;&#30340;&#22320;&#22336;&#31354;&#38388;&#20013;&#65292;&#28982;&#21518;&#36339;&#36716;&#21040; <code>a.out</code> &#30340; <code>_start</code> &#25191;&#34892;&#65292;&#21021;&#22987;&#21270; C &#35821;&#35328;&#36816;&#34892;&#29615;&#22659;&#65292;&#26368;&#32456;&#24320;&#22987;&#25191;&#34892; <code>main</code>&#12290;</li>
<li class=" ml-8">&#31243;&#24207;&#36816;&#34892;&#36807;&#31243;&#20013;&#65292;&#22914;&#38656;&#36827;&#34892;&#36755;&#20837;/&#36755;&#20986;&#31561;&#25805;&#20316; (&#22914; libc &#20013;&#30340; <code>putchar</code>)&#65292;&#21017;&#20250;&#20351;&#29992;&#29305;&#27530;&#30340;&#25351;&#20196; (&#20363;&#22914; x86 &#31995;&#32479;&#19978;&#30340; <code>int</code> &#25110;<code>syscall</code>) &#21457;&#20986;&#31995;&#32479;&#35843;&#29992;&#35831;&#27714;&#25805;&#20316;&#31995;&#32479;&#25191;&#34892;&#12290;&#20856;&#22411;&#30340;&#20363;&#23376;&#26159; <code>printf</code> &#20250;&#35843;&#29992; <code>write</code> &#31995;&#32479;&#35843;&#29992;&#65292;&#21521;&#32534;&#21495;&#20026; <code>1</code> &#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#20889;&#20837;&#25968;&#25454;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#24590;&#20040;&#22312;&#23454;&#38469;&#30340;&#31995;&#32479;&#19978;&#35266;&#23519;&#19978;&#36848;&#30340;&#34892;&#20026;&#65311;&#25105;&#20204;&#26377;&#35843;&#35797;&#22120;&#65281;gdb &#20026;&#25105;&#20204;&#25552;&#20379;&#20102; <code>starti</code> &#25351;&#20196;&#65292;&#21487;&#20197;&#22312;&#31243;&#24207;&#25191;&#34892;&#31532;&#19968;&#26465;&#25351;&#20196;&#26102;&#23601;&#20572;&#19979;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gdb a.out
GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git
...
(gdb) starti  # &#21551;&#21160;&#31243;&#24207;&#65292;&#24182;&#22312;&#31532;&#19968;&#26465;&#25351;&#20196;&#19978;&#26242;&#20572;
Starting program: /tmp/a/a.out 

Program stopped.
0x00007ffff7dd6090 in _start () from /lib64/ld-linux-x86-64.so.2
(gdb) bt f    # backtrace full&#65292;&#25171;&#21360;&#22534;&#26632;&#20449;&#24687;
#0  0x00007ffff7dd6090 in _start () from /lib64/ld-linux-x86-64.so.2
        library_path = 0x0
        version_info = 0
        any_debug = 0
        _dl_rtld_libname = {name = 0x0, next = 0x0, dont_free = 0}
        relocate_time = 0
        _dl_rtld_libname2 = {name = 0x0, next = 0x0, dont_free = 0}
        start_time = 0
        tls_init_tp_called = false
        load_time = 0
        audit_list = 0x0
        preloadlist = 0x0
        __GI__dl_argv = 0x0
        _dl_argc = 0
        audit_list_string = 0x0
        _rtld_global = {_dl_ns = {{_ns_loaded = 0x0, _ns_nloaded = 0,
                       ...
#1  0x0000000000000001 in ?? ()
No symbol table info available.
...
</code></pre></div>

<p class=" font-serif my-1">&#25805;&#20316;&#31995;&#32479;&#30340;&#21152;&#36733;&#22120;&#23436;&#25104;&#20102; <code>ld-linux-x86-64.so.2</code> &#30340;&#21152;&#36733;&#65292;&#24182;&#32473;&#23427;&#20256;&#36882;&#20102;&#30456;&#24212;&#30340;&#21442;&#25968;&#12290;&#25105;&#20204;&#21487;&#20197;&#26597;&#30475;&#27492;&#26102;&#30340;&#36827;&#31243;&#20449;&#24687; (&#36825;&#20123;&#20869;&#23384;&#37117;&#26159;&#25805;&#20316;&#31995;&#32479;&#21152;&#36733;&#30340;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>(gdb) info inferiors  # &#25171;&#21360;&#36827;&#31243;/&#32447;&#31243;&#20449;&#24687;
  Num  Description       Executable        
* 1    process 18137     /tmp/hello/a.out
(gdb) !cat /proc/18137/maps  # &#25171;&#21360;&#36827;&#31243;&#30340;&#20869;&#23384;&#20449;&#24687;
00400000-00401000 r-xp 00000000 08:02 3538982             /tmp/hello/a.out
00600000-00602000 rw-p 00000000 08:02 3538982             /tmp/hello/a.out
7ffff7dd5000-7ffff7dfc000 r-xp 00000000 08:02 4985556     /lib/x86_64-linux-gnu/ld-2.27.so
7ffff7ff7000-7ffff7ffa000 r--p 00000000 00:00 0           [vvar]
7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0           [vdso]
7ffff7ffc000-7ffff7ffe000 rw-p 00027000 08:02 4985556     /lib/x86_64-linux-gnu/ld-2.27.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0 
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0           [stack]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0   [vsyscall]
</code></pre></div>

<p class=" font-serif my-1">&#22914;&#26524;&#25105;&#20204;&#22312; <code>_start</code> &#35774;&#32622;&#26029;&#28857;&#65292;&#20250;&#21457;&#29616;&#27492;&#26102;&#24050;&#32463;&#21152;&#36733;&#23436;&#25104;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>(gdb) b _start  # breakpoint &#35774;&#32622;&#26029;&#28857;
Breakpoint 1 at 0x4003d0
(gdb) c  # continue &#32487;&#32493;&#25191;&#34892;
Continuing.

Breakpoint 1, 0x00000000004003d0 in _start ()
(gdb) !cat /proc/18137/maps
00400000-00401000 r-xp 00000000 08:02 3538982             /tmp/hello/a.out
00600000-00601000 r--p 00000000 08:02 3538982             /tmp/hello/a.out
00601000-00602000 rw-p 00001000 08:02 3538982             /tmp/hello/a.out
7ffff79e4000-7ffff7bcb000 r-xp 00000000 08:02 4985568     /lib/x86_64-linux-gnu/libc-2.27.so
7ffff7bcb000-7ffff7dcb000 ---p 001e7000 08:02 4985568     /lib/x86_64-linux-gnu/libc-2.27.so
7ffff7dcb000-7ffff7dcf000 r--p 001e7000 08:02 4985568     /lib/x86_64-linux-gnu/libc-2.27.so
7ffff7dcf000-7ffff7dd1000 rw-p 001eb000 08:02 4985568     /lib/x86_64-linux-gnu/libc-2.27.so
7ffff7dd1000-7ffff7dd5000 rw-p 00000000 00:00 0 
7ffff7dd5000-7ffff7dfc000 r-xp 00000000 08:02 4985556     /lib/x86_64-linux-gnu/ld-2.27.so
7ffff7fde000-7ffff7fe0000 rw-p 00000000 00:00 0 
7ffff7ff7000-7ffff7ffa000 r--p 00000000 00:00 0           [vvar]
7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0           [vdso]
7ffff7ffc000-7ffff7ffd000 r--p 00027000 08:02 4985556     /lib/x86_64-linux-gnu/ld-2.27.so
7ffff7ffd000-7ffff7ffe000 rw-p 00028000 08:02 4985556     /lib/x86_64-linux-gnu/ld-2.27.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0 
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0           [stack]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0   [vsyscall]
</code></pre></div>

<p class=" font-serif my-1">&#22320;&#22336;&#31354;&#38388;&#20013;&#24050;&#26377; <code>a.out</code>, libc, &#22534;&#21306;&#12289;&#26632;&#21306;&#31561;&#25105;&#20204;&#29087;&#24713;&#30340;&#19996;&#35199;&#65292;libc &#30340; <code>_start</code> &#23436;&#25104;&#21021;&#22987;&#21270;&#21518;&#20250;&#35843;&#29992; <code>main()</code>&#12290;&#36825;&#30495;&#26159;&#19968;&#27573;&#28459;&#38271;&#30340;&#26053;&#36884;&#65281;</p>
<h2 id="3-bare-metal-c" class=" text-xl mt-2 pb-2 font-sans">3. Bare-Metal &#19978;&#30340; C &#31243;&#24207;</h2>
<p class=" font-serif my-1">&#23545;&#20110; AbstractMachine &#19978;&#30340;&#31243;&#24207;&#65292;&#25105;&#20204;&#38656;&#35201;&#19968;&#20010; Makefile&#65292;&#23601;&#33021;&#25226; hello &#31243;&#24207;&#32534;&#35793;&#21040; bare-metal &#25191;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nv">NAME</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>hello
<span class="nv">SRCS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>main.c<span class="w"> </span>say.c
<span class="cp">include $(AM_HOME)/Makefile.app</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#32456;&#31471;&#20013;&#25191;&#34892; <code>make -nB ARCH=x86_64-qemu</code> &#21487;&#20197;&#26597;&#30475;&#23436;&#25972;&#30340;&#32534;&#35793;&#12289;&#38142;&#25509;&#21040; x86-64 &#30340;&#36807;&#31243; (&#19981;&#23454;&#38469;&#36827;&#34892;&#32534;&#35793;)&#12290;</p>
<h3 id="31" class=" text-lg mt-2 pb-2 font-sans">3.1. &#32534;&#35793;</h3>
<p class=" font-serif my-1">&#32534;&#35793;&#22120;&#30340;&#21151;&#33021;&#26159;&#25226; <code>.c</code> &#25991;&#20214;&#32763;&#35793;&#25104;&#21487;&#37325;&#23450;&#20301;&#30340;&#20108;&#36827;&#21046;&#30446;&#26631;&#25991;&#20214; (<code>.o</code>)&#12290;&#36825;&#19968;&#27493;&#23545;&#20110;&#26377;&#26080;&#25805;&#20316;&#31995;&#32479;&#26469;&#35828;&#24046;&#21035;&#24182;&#19981;&#22823;&#65292;&#26368;&#20027;&#35201;&#30340;&#21306;&#21035;&#26159;&#22312; bare-metal &#26159; &#8220;freestanding&#8221; &#30340;&#36816;&#34892;&#29615;&#22659;&#65292;&#27809;&#26377;&#21150;&#27861;&#35843;&#29992;&#20381;&#36182;&#20110;&#25805;&#20316;&#31995;&#32479;&#30340;&#24211;&#20989;&#25968;&#8212;&#8212;&#20320;&#20381;&#28982;&#21487;&#20197;&#22768;&#26126;&#23427;&#20204; (&#20363;&#22914; <code>printf</code>, <code>malloc</code> &#31561;)&#65292;&#20294;&#26368;&#32456;&#23427;&#20204;&#30340;&#20195;&#30721;&#26080;&#27861;&#38142;&#25509;&#12290;</p>
<p class=" font-serif my-1">&#32534;&#35793;&#22120; (gcc) &#25552;&#20379;&#20102;&#36873;&#39033;&#24110;&#25105;&#20204;&#29983;&#25104;&#19981;&#20381;&#36182;&#25805;&#20316;&#31995;&#32479;&#30340;&#30446;&#26631;&#25991;&#20214;&#65292;&#20363;&#22914;&#23545; <code>-ffreestanding</code> (<code>-fno-hosted</code>) &#36873;&#39033;&#30340;&#25991;&#26723;&#65306;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">Assert that compilation targets a freestanding environment.  This implies <code>-fno-builtin</code>.  A freestanding environment is one in which the standard library may not exist, and program startup may not necessarily be at "main".  The most obvious example is an OS kernel.  This is equivalent to <code>-fno-hosted</code>.</p>
</blockquote>
<p class=" font-serif my-1">&#38500;&#20102;&#32534;&#35793;&#22120;&#20570;&#20986;&#19968;&#20123;&#20195;&#30721;&#29983;&#25104;&#30340;&#38480;&#21046;&#20043;&#22806;&#65292;bare-metal &#31243;&#24207;&#30340;&#32534;&#35793;&#21644;&#25805;&#20316;&#31995;&#32479;&#19978;&#31243;&#24207;&#27809;&#26377;&#20219;&#20309;&#21306;&#21035;&#12290;&#20107;&#23454;&#19978;&#65292;&#23545;&#20110;&#25105;&#20204;&#30340;&#31034;&#20363;&#31243;&#24207;&#26469;&#35828;&#65292;<code>main</code> &#21644; <code>say</code> &#32534;&#35793;&#20986;&#30340;&#27719;&#32534;&#20195;&#30721;&#26159;&#23436;&#20840;&#19968;&#33268;&#30340;&#65292;&#38500;&#20102; relocation table &#20013;&#30340;&#37325;&#23450;&#20301;&#20449;&#24687;&#19981;&#21516; (bare-metal &#19978;&#20250;&#35843;&#29992; <code>putch</code> &#32780;&#19981;&#26159; <code>putchar</code>)&#12290;</p>
<h3 id="32" class=" text-lg mt-2 pb-2 font-sans">3.2. &#38142;&#25509;</h3>
<p class=" font-serif my-1">&#21487;&#33021;&#20986;&#20046;&#24847;&#26009;&#65292;&#22240;&#20026;&#27809;&#26377;&#25805;&#20316;&#31995;&#32479;&#65292;bare-metal &#31243;&#24207;&#30340;&#38142;&#25509;&#27604;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#24773;&#20917;&#36824;&#31616;&#21333;&#19968;&#20123;&#65281;&#25105;&#20204;&#20351;&#29992;&#30340;&#38142;&#25509;&#21629;&#20196;&#26159;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ ld -melf_x86_64 -N -Ttext-segment=0x00100000 -o build/hello-x86_64-qemu.o \
  main.o say.o am-x86_64-qemu.a klib-x86_64-qemu.a
</code></pre></div>

<p class=" font-serif my-1">&#21482;&#38142;&#25509;&#20102; <code>main.o</code>, <code>say.o</code> &#21644;&#24517;&#35201;&#30340;&#24211;&#20989;&#25968; (AbstractMachine &#21644; klib&#65307;&#22312;&#36825;&#20010;&#20363;&#23376;&#20013;&#65292;&#25105;&#20204;&#29978;&#33267;&#21487;&#20197;&#19981;&#38142;&#25509; klib &#20063;&#33021;&#27491;&#24120;&#36816;&#34892;)&#12290;&#20351;&#29992;&#30340;&#38142;&#25509;&#36873;&#39033;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>-melf_x86_64</code>&#65306;&#25351;&#23450;&#38142;&#25509;&#20026; x86_64 ELF &#26684;&#24335;&#65307;</li>
<li class=" ml-8"><code>-N</code>&#65306;&#26631;&#35760; <code>.text</code> &#21644; <code>.data</code> &#37117;&#21487;&#20889;&#65292;&#36825;&#26679;&#23427;&#20204;&#21487;&#20197;&#19968;&#36215;&#21152;&#36733; (&#32780;&#19981;&#38656;&#35201;&#23545;&#40784;&#21040;&#39029;&#38754;&#36793;&#30028;)&#65292;&#20943;&#23569;&#21487;&#25191;&#34892;&#25991;&#20214;&#30340;&#22823;&#23567;&#65307;</li>
<li class=" ml-8"><code>-Ttext-segment=0x00100000</code>&#65306;&#25351;&#23450;&#20108;&#36827;&#21046;&#25991;&#20214;&#24212;&#21152;&#36733;&#21040;&#22320;&#22336; <code>0x00100000</code>&#12290;</li>
</ul>
<p class=" font-serif my-1">&#20351;&#29992; <code>readelf</code> &#21629;&#20196;&#26597;&#30475; <code>hello-x86_64-qemu.o</code> &#25991;&#20214;&#30340;&#20449;&#24687;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ readelf -a build/hello-x86_64-qemu.o
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x100100
  Start of program headers:          64 (bytes into file)
  Start of section headers:          65584 (bytes into file)
  ...
</code></pre></div>

<p class=" font-serif my-1">&#20854;&#20013;&#30340; program headers &#25551;&#36848;&#20102;&#38656;&#35201;&#21152;&#36733;&#30340;&#37096;&#20998;&#65306;&#21152;&#36733;&#36825;&#20010;&#25991;&#20214;&#30340;&#21152;&#36733;&#22120;&#38656;&#35201;&#25226;&#25991;&#20214;&#20013;&#20174; <code>0xb0</code> (Offset) &#24320;&#22987;&#30340; <code>0x29ac</code> &#23383;&#33410; (<code>FileSiz</code>) &#21152;&#36733;&#21040;&#20869;&#23384;&#30340; <code>0x1000b0</code> &#34394;&#25311;/&#29289;&#29702;&#22320;&#22336; (VirtAddr/PhysAddr)&#65292;&#20869;&#23384;&#20013;&#30340;&#22823;&#23567; <code>0x23f98</code> &#23383;&#33410; (<code>MemSiz</code>&#65292;&#36229;&#36807; <code>FileSiz</code> &#30340;&#20869;&#23384;&#28165;&#38646;)&#65292;&#26631;&#24535;&#20026; RWE (&#21487;&#35835;&#12289;&#21487;&#20889;&#12289;&#21487;&#25191;&#34892;)&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  LOAD           0x00000000000000b0 0x00000000001000b0 0x00000000001000b0
                 0x00000000000029ac 0x0000000000023f98  RWE    0x20
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RWE    0x10
</code></pre></div>

<p class=" font-serif my-1">&#23454;&#38469;&#19978;&#65292;&#36825;&#20010;&#31243;&#24207;&#21487;&#20197;&#30452;&#25509;&#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#34987;&#36816;&#34892;&#65281;&#22914;&#26524;&#20320;&#35797;&#30528;&#29992; gdb &#35843;&#35797;&#23427;&#65292;&#20250;&#21457;&#29616;&#31243;&#24207;&#20174; <code>_start</code> (<code>0x100100</code>) &#24320;&#22987;&#25191;&#34892;&#65292;&#20294;&#22312;&#25191;&#34892;&#20102;&#33509;&#24178;&#26465;&#25351;&#20196;&#21518;&#65292;&#22312; <code>movabs %eax,0xb900001000</code> &#26102;&#21457;&#29983;&#20102; Segmentation Fault&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_start-movabs" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;"><code>_start</code> &#37324;&#27809;&#26377; <code>movabs</code>&#65311;</h4>
<p class=" font-serif my-1">x86-64 AbstractMachine &#19978;&#31243;&#24207;&#30340;&#20837;&#21475;&#22312; <code>start64.S</code> &#25991;&#20214;&#20013;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="na">.code32</span>
<span class="na">.globl</span><span class="w"> </span><span class="no">_start</span>
<span class="nl">_start:</span>
<span class="w">  </span><span class="nf">movl</span><span class="w">  </span><span class="no">$</span><span class="p">(</span><span class="no">PDPT_ADDR</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">PTE_P</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">PTE_W</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">  </span><span class="nf">cmpl</span><span class="w">  </span><span class="p">(</span><span class="no">PML4_ADDR</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">  </span><span class="nf">je</span><span class="w">    </span><span class="no">.long_mode_init</span>

<span class="w">  </span><span class="nf">movl</span><span class="w">  </span><span class="no">$</span><span class="p">(</span><span class="no">PDPT_ADDR</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">PTE_P</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">PTE_W</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">  </span><span class="nf">movl</span><span class="w">  </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">PML4_ADDR</span><span class="p">)</span>
<span class="na">...</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#26159;&#19968;&#27573; 32-bit &#20195;&#30721;&#8212;&#8212;AbstractMachine &#30340;&#21152;&#36733;&#22120;&#24182;&#27809;&#26377;&#36827;&#20837; 64-bit &#27169;&#24335;&#65307;&#32780; <code>hello-x86_64-qemu.o</code> &#30452;&#25509;&#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#25191;&#34892;&#26102;&#65292;&#23558;&#20195;&#30721;&#35299;&#26512;&#20026; 64-bit &#27719;&#32534;&#65292;&#22240;&#27492;&#38169;&#35823;&#35299;&#26512;&#20102; 32-bit &#25351;&#20196;&#65292;&#35775;&#38382;&#38750;&#27861;&#20869;&#23384;&#20135;&#29983; Segmentation Fault&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#21482;&#19981;&#36807;&#22240;&#20026;&#36816;&#34892;&#29615;&#22659;&#19981;&#21516;&#65292;&#25191;&#34892;&#21040;&#31995;&#32479;&#25351;&#20196;&#26102;&#65292;&#23646;&#20110;&#38750;&#27861;&#25805;&#20316; crash &#20102;&#12290;&#25105;&#20204;&#38656;&#35201;&#22312; bare-metal &#19978;&#21152;&#36733;&#23427;&#12290;&#25152;&#20197;&#25105;&#20204;&#20250;&#21019;&#24314; <code>hello-x86_64-qemu</code> &#30340;&#38236;&#20687;&#25991;&#20214;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="o">(</span><span class="w"> </span>cat<span class="w"> </span>abstract-machine/am/src/x86/qemu/boot/mbr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>head<span class="w"> </span>-c<span class="w"> </span><span class="m">1024</span><span class="w"> </span>/dev/zero<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>cat<span class="w"> </span>build/hello-x86_64-qemu.o<span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>&gt;<span class="w"> </span>/tmp/hello/build/hello-x86_64-qemu
</code></pre></div>

<p class=" font-serif my-1">&#38236;&#20687;&#25991;&#20214;&#26159;&#30001; 512 &#23383;&#33410;&#30340; &#8220;MBR&#8221;&#12289;1024 &#23383;&#33410;&#30340;&#31354;&#30333; (&#29992;&#20110;&#23384;&#25918; <code>main</code> &#20989;&#25968;&#30340;&#21442;&#25968;) &#21644; <code>hello-x86_64-qemu.o</code> &#32452;&#25104;&#30340;&#12290;&#29992; <code>file</code> &#31867;&#22411;&#21487;&#20197;&#35782;&#21035;&#20986;&#23427;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ file hello-x86_64-qemu
hello-x86_64-qemu:   DOS/MBR boot sector
</code></pre></div>

<h3 id="33" class=" text-lg mt-2 pb-2 font-sans">3.3. &#21152;&#36733;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#22312; QEMU &#20840;&#31995;&#32479;&#27169;&#25311;&#22120;&#20013;&#36816;&#34892;&#23436;&#25972;&#30340;&#38236;&#20687; <code>hello-x86_64-qemu</code> (&#21253;&#21547; <code>hello-x86_64-qemu.o</code>)&#12290;&#22914;&#26524;&#29992;&#19968;&#20123;&#29305;&#21035;&#30340;&#36873;&#39033;&#65292;&#23601;&#33021;&#36817;&#36317;&#31163;&#35266;&#23519;&#27169;&#25311;&#22120;&#30340;&#25191;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ qemu-system-x86_64 -S -s -serial none -nographic hello-x86_64-qemu
</code></pre></div>

<p class=" font-serif my-1">&#20854;&#20013;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>-S</code> &#22312;&#27169;&#25311;&#22120;&#21021;&#22987;&#21270;&#23436;&#25104; (CPU Reset) &#21518;&#26242;&#20572;</li>
<li class=" ml-8"><code>-s</code> &#21551;&#21160; gdb &#35843;&#35797;&#26381;&#21153;&#22120;&#65292;&#21487;&#20197;&#20351;&#29992; gdb &#35843;&#35797;&#27169;&#25311;&#22120;&#20013;&#30340;&#31243;&#24207;</li>
<li class=" ml-8"><code>-serial none</code> &#24573;&#30053;&#20018;&#21475;&#36755;&#20837;/&#36755;&#20986;</li>
<li class=" ml-8"><code>-nographics</code> &#19981;&#21551;&#21160;&#22270;&#24418;&#30028;&#38754;</li>
</ul>
<p class=" font-serif my-1">&#25105;&#20204;&#21487;&#20197;&#22312;&#32456;&#31471;&#37324;&#21551;&#21160;&#19968;&#20010; monitor (Online Judge &#23601;&#22788;&#20110;&#36825;&#20010;&#27169;&#24335;)&#12290;&#22312;&#36825;&#37324;&#65292;&#25105;&#20204;&#23601;&#21487;&#20197;&#20687;&#20195;&#30721;&#35838;&#20013;&#35762;&#35299;&#30340;&#37027;&#26679;&#65292;&#30452;&#25509;&#35843;&#35797;&#25972;&#20010; QEMU &#34394;&#25311;&#26426;&#20102;&#65281;</p>
<h4 id="331-cpu-reset" class=" pt-2 pb-2 font-sans">3.3.1 CPU Reset</h4>
<p class=" font-serif my-1">&#23601;&#20687; NEMU &#19968;&#26679;&#35843;&#35797;&#34394;&#25311;&#26426;&#65292;&#25105;&#20204;&#20351;&#29992; <code>info registers</code> &#26597;&#30475; CPU Reset &#21518;&#30340;&#23492;&#23384;&#22120;&#29366;&#24577;&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>QEMU 2.11.1 monitor - type 'help' for more information
(qemu) info registers 
EAX=00000000 EBX=00000000 ECX=00000000 EDX=00000663
ESI=00000000 EDI=00000000 EBP=00000000 ESP=00000000
EIP=0000fff0 EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0000 00000000 0000ffff 00009300
CS =f000 ffff0000 0000ffff 00009b00
SS =0000 00000000 0000ffff 00009300
DS =0000 00000000 0000ffff 00009300
FS =0000 00000000 0000ffff 00009300
GS =0000 00000000 0000ffff 00009300
LDT=0000 00000000 0000ffff 00008200
TR =0000 00000000 0000ffff 00008b00
GDT=     00000000 0000ffff
IDT=     00000000 0000ffff
CR0=60000010 CR2=00000000 CR3=00000000 CR4=00000000
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 
DR6=00000000ffff0ff0 DR7=0000000000000400
EFER=0000000000000000
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000
XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000
XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000
XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000
(qemu) 
</code></pre></div>

<p class=" font-serif my-1">CPU Reset &#21518;&#30340;&#29366;&#24577;&#28041;&#21450;&#24456;&#22810;&#29712;&#30862;&#30340;&#30828;&#20214;&#32454;&#33410;&#65292;&#36825;&#20063;&#26159;&#22823;&#23478;&#24863;&#21040;&#20026; bare-metal &#32534;&#31243;&#24456;&#31070;&#31192;&#30340;&#21407;&#22240;&#12290;&#19981;&#36807;&#31616;&#21333;&#26469;&#35762;&#65292;&#25105;&#20204;&#20851;&#24515;&#30340;&#29366;&#24577;&#21482;&#26377;&#20004;&#20010;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>%cr0 = 0x60000010</code>&#65292;&#26368;&#20302;&#20301; <code>PE</code>-bit &#20026; 0&#65292;&#36816;&#34892;&#22312; 16-bit &#27169;&#24335; (&#29616;&#22312; CPU &#30340;&#34892;&#20026;&#23601;&#20687; 8086)</li>
<li class=" ml-8"><code>%cs = 0xf000</code>, <code>%ip = 0xfff0</code>&#65292;&#30456;&#24403;&#20110; PC &#25351;&#38024;&#20301;&#20110; <code>0xffff0</code></li>
</ul>
<p class=" font-serif my-1">&#20320;&#29978;&#33267;&#21487;&#20197;&#26816;&#26597;&#19978;&#38754;&#25171;&#21360;&#20986;&#30340;&#29366;&#24577;&#21644;&#25163;&#20876;&#30340;&#19968;&#33268;&#24615;&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../pages/OS/img/intel-cpu-reset.png" width="600px"></p>
<p class=" font-serif my-1">CPU Reset &#21518;&#65292;&#25105;&#20204;&#30340;&#35745;&#31639;&#26426;&#31995;&#32479;&#23601;&#26159;&#19968;&#20010;&#29366;&#24577;&#26426;&#65292;&#25353;&#29031; &#8220;&#27599;&#27425;&#25191;&#34892;&#19968;&#26465;&#25351;&#20196;&#8221; &#30340;&#26041;&#24335;&#24037;&#20316;&#12290;</p>
<h4 id="332-firmware-master-boot-record" class=" pt-2 pb-2 font-sans">3.3.2. Firmware: &#21152;&#36733; Master Boot Record</h4>
<p class=" font-serif my-1">&#20301;&#20110; <code>0xffff0</code> &#30340;&#20195;&#30721;&#20197;&#20869;&#23384;&#26144;&#23556;&#30340;&#26041;&#24335;&#26144;&#23556;&#21040;&#21482;&#35835;&#30340;&#23384;&#20648;&#22120; (&#22266;&#20214;&#65292;firmware&#65292;&#20063;&#31216;&#20026; BIOS) &#20013;&#12290;&#22266;&#20214;&#20195;&#30721;&#20250;&#36827;&#34892;&#19968;&#23450;&#30340;&#35745;&#31639;&#26426;&#29366;&#24577;&#26816;&#26597; (&#27604;&#22914;&#33879;&#21517;&#30340; &#8220;Keyboard not found, press any key to continue...&#8221;)&#12290;&#22914;&#26524;&#25105;&#20204;&#22312; gdb &#20013;&#20351;&#29992; <code>target remote localhost:1234</code> &#36830;&#25509;&#21040; qemu (&#40664;&#35748;&#31471;&#21475;&#20026; 1234)&#65292;&#23601;&#21487;&#20197;&#24320;&#22987;&#21333;&#27493;&#35843;&#35797;&#22266;&#20214;&#20195;&#30721;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#27604;&#36739;&#31616;&#21333;&#30340; Legacy BIOS Firmware (Legacy Boot) &#27169;&#24335;&#65292;&#22266;&#20214;&#20250;&#20381;&#27425;&#25195;&#25551;&#31995;&#32479;&#20013;&#30340;&#23384;&#20648;&#35774;&#22791; (&#30913;&#30424;&#12289;&#20248;&#30424;&#31561;&#65292;Boot Order &#36890;&#24120;&#21487;&#20197;&#35774;&#32622;)&#65292;&#28982;&#21518;&#23558;&#31532;&#19968;&#20010;&#21487;&#21551;&#21160;&#30913;&#30424;&#30340;&#21069; 512 &#23383;&#33410; (&#20027;&#24341;&#23548;&#25159;&#21306;, Master Boot Record, MBR) &#21152;&#36733;&#21040;&#29289;&#29702;&#20869;&#23384;&#30340; <code>0x7c00</code> &#22320;&#22336;&#12290;&#20197;&#19979;&#26159; AMI &#20844;&#21496;&#22312; 1990s &#30340; BIOS Firmware &#30028;&#38754;&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../pages/OS/img/bios-firmware.png" width="480px"></p>
<p class=" font-serif my-1">&#20170;&#22825;&#30340; Firmware &#26377;&#20102; <a href="https://wiki.osdev.org/UEFI" class=" text-amber-900">UEFI &#26631;&#20934;</a>&#65292;&#33021;&#26356;&#22909;&#22320;&#25552;&#20379;&#30828;&#20214;&#30340;&#25277;&#35937;&#12289;&#25903;&#25345;&#22266;&#20214;&#24212;&#29992;&#31243;&#24207;&#8212;&#8212;&#20170;&#22825;&#30340; &#8220;BIOS&#8221; &#29978;&#33267;&#26377;&#28843;&#37239;&#30340;&#22270;&#24418;&#30028;&#38754; (&#19981;&#35201;&#23567;&#30475;&#22270;&#24418;&#30028;&#38754;&#65292;&#33021;&#26174;&#31034;&#22270;&#24418;&#24847;&#21619;&#30528;&#20320;&#24471;&#26377;&#24635;&#32447;&#12289;&#38190;&#30424;&#12289;&#40736;&#26631;&#30340;&#39537;&#21160;&#31243;&#24207;&#8230;&#8230;)&#65292;&#22266;&#20214;&#22797;&#26434;&#31243;&#24230;&#21487;&#27604;&#23567;&#22411;&#25805;&#20316;&#31995;&#32479;&#65307;UEFI &#21152;&#36733;&#22120;&#20063;&#19981;&#20877;&#20165;&#20165;&#21152;&#36733;&#26159; 512 &#23383;&#33410;&#30340; MBR&#65292;&#32780;&#26159;&#33021;&#21152;&#36733;&#20219;&#24847; GPT &#20998;&#21306;&#34920;&#19978;&#30340; FAT &#20998;&#21306;&#20013;&#23384;&#20648;&#30340;&#24212;&#29992;&#12290;&#20170;&#22825;&#30340;&#35745;&#31639;&#26426;&#40664;&#35748;&#37117;&#36890;&#36807; UEFI &#24341;&#23548;&#12290;</p>
<p class=" font-serif my-1">&#20174;&#23481;&#26131;&#29702;&#35299;&#30340;&#35282;&#24230;&#65292;&#25105;&#20204;&#32534;&#20889;&#25805;&#20316;&#31995;&#32479;&#26102;&#65292;&#20381;&#28982;&#20174; Legacy Boot &#21551;&#21160;&#65292;&#20320;&#21482;&#38656;&#35201;&#30693;&#36947;&#65292;&#22312; x86 &#31995;&#32479;&#19978;&#65292;AbstractMachine &#21644; Firmware &#30340;&#32422;&#23450;&#26159;&#30913;&#30424;&#38236;&#20687;&#30340;&#21069; 512 &#23383;&#33410;&#23558;&#39318;&#20808;&#20250;&#34987;&#21152;&#36733;&#21040;&#29289;&#29702;&#20869;&#23384;&#20013;&#25191;&#34892;&#12290;</p>
<p class=" font-serif my-1">&#25105;&#20204;&#21487;&#20197;&#36890;&#36807; gdb &#36830;&#25509;&#21040;&#24050;&#32463;&#21551;&#21160; (&#20294;&#26242;&#20572;) &#30340; qemu &#27169;&#25311;&#22120;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gdb
(gdb) target remote localhost:1234
Remote debugging using localhost:1234
0x000000000000fff0 in ?? ()
(gdb) b *0x7c00
Breakpoint 1 at 0x7c00
(gdb) c
Continuing.

Breakpoint 1, 0x0000000000007c00 in ?? ()
(gdb) x/16i $pc
=&gt; 0x7c00:  cli    
   0x7c01:  xor    %eax,%eax
   0x7c03:  mov    %eax,%ds
   0x7c05:  mov    %eax,%es
   0x7c07:  mov    %eax,%ss
   ...
</code></pre></div>

<p class=" font-serif my-1">&#20351;&#29992; <code>layout asm</code> &#36827;&#34892;&#25351;&#20196;&#32423;&#30340;&#35843;&#35797; (&#35843;&#35797; 16-bit code &#26102; disassembler &#20250;&#36935;&#21040;&#19968;&#20123;&#23567;&#40635;&#28902;&#65292;&#20294;&#35843;&#35797;&#30340;&#22522;&#26412;&#21151;&#33021;&#26159;&#27809;&#38382;&#39064;&#30340;&#65307;&#20511;&#21161;&#20854;&#20182;&#24037;&#20855;&#22914; nasm &#21487;&#20197;&#27491;&#30830;&#26597;&#30475;&#20195;&#30721;)&#12290;</p>
<h4 id="33-boot-loader-elf" class=" pt-2 pb-2 font-sans">3.3 Boot Loader: &#35299;&#26512;&#24182;&#21152;&#36733; ELF &#25991;&#20214;</h4>
<p class=" font-serif my-1">&#22312; gdb &#20013;&#30475;&#21040;&#30340; <code>0x7c00</code> &#22320;&#22336;&#30340;&#25351;&#20196;&#24207;&#21015;&#26159;&#25105;&#20204;&#30340; boot loader &#20195;&#30721;&#65292;&#23384;&#20648;&#22312;&#30913;&#30424;&#30340;&#21069; 512 &#23383;&#33410;&#12290;x86-64 &#30340; AbstractMachine &#22312;&#36825; 512 &#23383;&#33410;&#20869;&#23436;&#25104; ELF &#25991;&#20214;&#30340;&#21152;&#36733;&#12290;&#36825;&#37096;&#20998;&#20195;&#30721;&#20301;&#20110; <code>am/src/x86/qemu/boot</code>&#65292;&#30001;&#19968;&#37096;&#20998; 16-bit &#27719;&#32534; (<code>start.S</code>)&#65292;&#20027;&#35201;&#37096;&#20998;&#22914;&#19979;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="o">.</span><span class="n">code16</span>
<span class="o">.</span><span class="n">globl</span><span class="w"> </span><span class="n">_start</span>
<span class="n">_start</span><span class="p">:</span>
<span class="w">  </span><span class="n">cli</span>

<span class="w">  </span><span class="n">xorw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ax</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ds</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">es</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ss</span>

<span class="w">  </span><span class="n">lgdt</span><span class="w">    </span><span class="n">gdtdesc</span>
<span class="w">  </span><span class="n">movl</span><span class="w">    </span><span class="o">%</span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="w">  </span><span class="n">orl</span><span class="w">     </span><span class="o">$</span><span class="n">CR0_PE</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="w">  </span><span class="n">movl</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">cr0</span>
<span class="w">  </span><span class="n">ljmp</span><span class="w">    </span><span class="o">$</span><span class="n">GDT_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">$</span><span class="n">start32</span>

<span class="o">.</span><span class="n">code32</span>
<span class="n">start32</span><span class="p">:</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">$</span><span class="n">GDT_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">ax</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ds</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">es</span>
<span class="w">  </span><span class="n">movw</span><span class="w">    </span><span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ss</span>

<span class="w">  </span><span class="n">movl</span><span class="w">    </span><span class="o">$</span><span class="mh">0xa000</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">esp</span>
<span class="w">  </span><span class="n">call</span><span class="w">    </span><span class="n">load_kernel</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#27573;&#20195;&#30721; (&#19981;&#38656;&#35201;&#29702;&#35299;) &#23601;&#26159;&#20570;&#19968;&#20123;&#24517;&#35201;&#30340;&#22788;&#29702;&#22120;&#35774;&#32622;&#65292;&#20999;&#25442;&#21040; 32-bit &#27169;&#24335;&#65292;&#35774;&#32622;&#21021;&#22987;&#30340;&#26632;&#39030;&#25351;&#38024; (<code>0xa000</code>)&#65292;&#28982;&#21518;&#36339;&#36716;&#21040; 32-bit C &#20195;&#30721; <code>load_kernel</code> &#25191;&#34892;&#12290;<code>load_kernel</code> &#20301;&#20110; <code>main.c</code> (&#26377;&#31616;&#21270;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;elf.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;x86.h&gt;</span>

<span class="c1">// &#35843;&#29992; I/O &#25351;&#20196;&#25226;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#35835;&#21040;&#20869;&#23384;&#25351;&#23450;&#20301;&#32622;&#65307;&#20195;&#30721;&#30465;&#30053;</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copy_from_disk</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nbytes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">disk_offset</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">load_program</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">filesz</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">memsz</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">copy_from_disk</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">filesz</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">bss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">paddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filesz</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filesz</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">memsz</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">bss</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">load_elf64</span><span class="p">(</span><span class="n">Elf64_Ehdr</span><span class="w"> </span><span class="o">*</span><span class="n">elf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf64_Phdr</span><span class="w"> </span><span class="o">*</span><span class="n">ph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Elf64_Phdr</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">elf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">load_program</span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_paddr</span><span class="p">,</span>
<span class="w">      </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">load_kernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Elf32_Ehdr</span><span class="w"> </span><span class="o">*</span><span class="n">elf32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x8000</span><span class="p">;</span>
<span class="w">  </span><span class="n">Elf64_Ehdr</span><span class="w"> </span><span class="o">*</span><span class="n">elf64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x8000</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">is_ap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boot_record</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_ap</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// &#23558; ELF &#25991;&#20214;&#30340;&#22836;&#37096;&#21152;&#36733;&#21040;&#29289;&#29702;&#22320;&#22336; 0x8000</span>
<span class="w">  </span><span class="n">copy_from_disk</span><span class="p">(</span><span class="n">elf32</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elf32</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EM_X86_64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// &#21152;&#36733; ELF &#25991;&#20214;</span>
<span class="w">    </span><span class="n">load_elf64</span><span class="p">(</span><span class="n">elf64</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// &#36339;&#36716;&#21040; ELF &#22836;&#25351;&#23450;&#30340;&#20837;&#21475;&#22320;&#22336;&#25191;&#34892;</span>
<span class="w">    </span><span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">elf64</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">)();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#25105;&#20204;&#29616;&#22312;&#21482;&#38656;&#35201;&#30693;&#36947;&#25105;&#20204;&#32534;&#20889;&#30340;&#36825;&#27573;&#20195;&#30721;&#20250;&#34987;&#32534;&#35793;&#38142;&#25509;&#65292;&#28982;&#21518;&#34987;&#25918;&#32622;&#22312;&#30913;&#30424;&#30340; MBR&#65292;&#20174;&#32780;&#34987;&#22266;&#20214;&#33258;&#21160;&#21152;&#36733;&#25191;&#34892;&#12290;&#22312; <code>load_elf64</code> &#20013;&#65292;&#25105;&#20204;&#26681;&#25454; ELF &#26684;&#24335;&#30340;&#35268;&#23450;&#23558;&#25991;&#20214;&#20869;&#23481;&#36733;&#20837;&#20869;&#23384;&#65292;&#28982;&#21518;&#36339;&#36716;&#21040; ELF &#25991;&#20214;&#30340;&#20837;&#21475;&#65292;&#23601;&#31639;&#23436;&#25104;&#20102; &#8220;hello &#30340;&#21152;&#36733;&#8221;&#12290;</p>
<h4 id="34-_start-64-bit-long-mode" class=" pt-2 pb-2 font-sans">3.4 <code>_start</code>: &#21021;&#22987;&#21270; 64-bit Long Mode</h4>
<p class=" font-serif my-1">&#27492;&#26102;&#25105;&#20204;&#30340; hello (&#20197;&#21450;&#26410;&#26469;&#30340; &#8220;&#25805;&#20316;&#31995;&#32479;&#8221;) &#20195;&#30721;&#24050;&#32463;&#24320;&#22987;&#25191;&#34892;&#20102;&#65292;&#19981;&#36807;&#27492;&#26102;&#36824;&#19981;&#33021;&#31435;&#21363;&#25191;&#34892; <code>main</code> &#20989;&#25968;&#8212;&#8212;&#25105;&#20204;&#36824;&#22788;&#20110; 32-bit &#27169;&#24335;&#12290;<code>am/src/x86/qemu/start64.S</code> &#30340;&#20195;&#30721;&#20250;&#23436;&#25104;&#26368;&#21518;&#30340;&#35774;&#32622;&#65292;&#27604;&#36739;&#37325;&#35201;&#30340;&#26159;&#21551;&#21160;&#20998;&#39029; (&#27491;&#30830;&#35774;&#32622;&#22235;&#32423;&#39029;&#34920;)&#12289;&#20999;&#25442;&#21040; x86-64 Long Mode&#65292;&#28982;&#21518;&#36827;&#20837;&#20197;&#19979; 64-bit &#20195;&#30721;&#25191;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="na">.code64</span>
<span class="nl">_start64:</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="no">$0</span><span class="p">,</span><span class="w">  </span><span class="nv">%ax</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="nv">%ax</span><span class="p">,</span><span class="w"> </span><span class="nv">%ds</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="nv">%ax</span><span class="p">,</span><span class="w"> </span><span class="nv">%es</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="nv">%ax</span><span class="p">,</span><span class="w"> </span><span class="nv">%ss</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="nv">%ax</span><span class="p">,</span><span class="w"> </span><span class="nv">%fs</span>
<span class="w">  </span><span class="nf">movw</span><span class="w">  </span><span class="nv">%ax</span><span class="p">,</span><span class="w"> </span><span class="nv">%gs</span>

<span class="w">  </span><span class="nf">movq</span><span class="w">  </span><span class="no">$MAINARG_ADDR</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>
<span class="w">  </span><span class="nf">pushq</span><span class="w"> </span><span class="no">$0</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w">   </span><span class="no">_start_c</span>
</code></pre></div>

<p class=" font-serif my-1">&#20043;&#21518;&#65292;&#25105;&#20204;&#23601;&#36827;&#20837;&#20102; C &#20195;&#30721;&#30340;&#19990;&#30028;&#65307;&#20294;&#27492;&#26102;&#24182;&#26410;&#23436;&#25104;&#25152;&#26377;&#30340;&#21021;&#22987;&#21270;&#65292;&#22312; <code>trm.c</code> &#20013;&#30340;&#20195;&#30721;&#36824;&#35201;&#23436;&#25104;&#19968;&#31995;&#21015;&#30828;&#20214;/&#36816;&#34892;&#29615;&#22659;&#30340;&#21021;&#22987;&#21270;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">_start_c</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">boot_record</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_ap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// &#31532;&#19968;&#20010;&#22788;&#29702;&#22120;</span>
<span class="w">    </span><span class="n">__am_bootcpu_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">stack_switch_call</span><span class="p">(</span>
<span class="w">      </span><span class="n">stack_top</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CPU</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">),</span><span class="w"> </span><span class="c1">// &#20999;&#25442;&#21040; percpu &#30340;&#26632;&#65307;&#24605;&#32771;&#39064;&#65306;&#20026;&#20160;&#20040;&#65311;&#65311;</span>
<span class="w">      </span><span class="n">call_main</span><span class="p">,</span><span class="w">              </span><span class="c1">// &#25191;&#34892; call_main(args)</span>
<span class="w">      </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">args</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// &#20854;&#20182;&#22788;&#29702;&#22120;</span>
<span class="w">    </span><span class="n">__am_othercpu_entry</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__am_bootcpu_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__am_heap_init</span><span class="p">();</span><span class="w"> </span><span class="c1">// &#33719;&#24471;&#29289;&#29702;&#20869;&#23384;&#22823;&#23567;</span>
<span class="w">  </span><span class="n">__am_lapic_init</span><span class="p">();</span><span class="w">        </span><span class="c1">// &#21021;&#22987;&#21270;&#20013;&#26029;&#25511;&#21046;&#22120;</span>
<span class="w">  </span><span class="n">__am_ioapic_init</span><span class="p">();</span>
<span class="w">  </span><span class="n">__am_percpu_init</span><span class="p">();</span><span class="w">       </span><span class="c1">// &#20854;&#20182;&#22788;&#29702;&#22120;&#30456;&#20851;&#30340;&#21021;&#22987;&#21270;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#26368;&#21518;&#65292;&#23436;&#25104;&#22534;&#26632;&#20999;&#25442;&#65292;&#28982;&#21518;&#35843;&#29992; <code>call_main</code> &#20989;&#25968;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">call_main</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">halt</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">Say hello &#30340; main &#27492;&#26102;&#25165;&#27491;&#24335;&#24320;&#22987;&#25191;&#34892;&#65292;&#30495;&#26159;&#19968;&#27573;&#28459;&#38271;&#30340;&#26053;&#36884;&#65281;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_2" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#25226;&#23427;&#20204;&#37117;&#24536;&#20102;&#21543;&#65281;</h4>
<p class=" font-serif my-1">&#20316;&#20026;&#23545;&#20320;&#35835;&#21040;&#36825;&#37324;&#32784;&#24515;&#30340;&#22025;&#22870;&#65292;&#20801;&#35768;&#20320;&#25226;&#20043;&#21069;&#21457;&#29983;&#30340;&#20107;&#24773;&#37117;&#24536;&#35760;&#12290;&#20320;&#21482;&#38656;&#35201;&#30693;&#36947;&#22312; <code>main</code> &#20989;&#25968;&#36816;&#34892;&#30340;&#26102;&#20505;&#65292;C &#35821;&#35328;&#30340;&#36816;&#34892;&#26102;&#29615;&#22659;&#24050;&#32463;&#23436;&#20840;&#21021;&#22987;&#21270;&#22909; (&#20195;&#30721;&#12289;&#25968;&#25454;&#12289;&#22534;&#21306;&#12289;&#26632;&#21306;)&#65292;&#24182;&#19988; C &#20195;&#30721;&#21487;&#20197;&#35843;&#29992;&#19968;&#20123;&#24211;&#20989;&#25968;&#12290;</p>
</blockquote>
<h3 id="334-bare-metal" class=" text-lg mt-2 pb-2 font-sans">3.3.4. Bare-Metal &#19978;&#30340;&#31243;&#24207;</h3>
<p class=" font-serif my-1">C &#31243;&#24207;&#32534;&#35793;&#21518;&#24471;&#21040;&#30340;&#25351;&#20196;&#24207;&#21015;&#32456;&#20110;&#22312; bare-metal &#19978;&#24320;&#22987;&#36816;&#34892;&#12290;</p>
<p class=" font-serif my-1">&#21644;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340; C &#31243;&#24207;&#19981;&#21516;&#65292;AbstractMachine &#19978;&#30340;&#31243;&#24207;&#23545;&#35745;&#31639;&#26426;&#30828;&#20214;&#31995;&#32479;&#26377;&#23436;&#25972;&#30340;&#25511;&#21046;&#65292;&#29978;&#33267;&#21487;&#20197;&#38142;&#25509;&#27719;&#32534;&#20195;&#30721;&#25110;&#20351;&#29992;&#20869;&#32852;&#27719;&#32534; (inline assembly) &#35775;&#38382;&#31995;&#32479;&#25351;&#20196;&#12290;&#25105;&#20204;&#21487;&#20197;&#22312; bare-metal &#19978;&#32534;&#20889;&#21508;&#31181; non-trival &#30340;&#31243;&#24207;&#65292;&#20363;&#22914;&#20219;&#20309;&#23567;&#28216;&#25103; (&#21442;&#32771; OS Lab 0)&#65292;&#20854;&#20013;&#20351;&#29992; I/O &#25351;&#20196;&#21644; memory-mapped I/O &#30452;&#25509;&#21644;&#29289;&#29702;&#35774;&#22791;&#20132;&#20114;&#65292;&#35835;&#21462;&#31995;&#32479;&#26102;&#38388;&#21644;&#25353;&#38190;&#12289;&#26356;&#26032;&#23631;&#24149;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_3" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#26368;&#21518;&#65292;&#25805;&#20316;&#31995;&#32479;</h4>
<p class=" font-serif my-1">&#22312;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#35838;&#31243;&#23454;&#39564;&#20013;&#65292;&#25805;&#20316;&#31995;&#32479;&#20063;&#26159; AbstractMachine &#19978;&#30340;&#19968;&#20010;&#31243;&#24207;&#12290;&#22312;&#25105;&#20204;&#32456;&#20110;&#21487;&#20197;&#25243;&#20986;&#36825;&#20010;&#21313;&#20998;&#32463;&#20856;&#30340;&#35828;&#27861;&#65306;&#8220;<strong>&#25805;&#20316;&#31995;&#32479;&#23601;&#26159;&#19968;&#20010; C &#31243;&#24207;</strong>&#8221;&#12290;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#30340;&#28304;&#20195;&#30721; (&#33509;&#24178; <code>.c</code> &#25991;&#20214;&#21644; AbstractMachien API &#24211;) &#32463;&#36807; (&#21018;&#25165;&#25551;&#36848;&#30340;&#12289;&#28459;&#38271;&#30340;) &#32534;&#35793;&#21644;&#38142;&#25509;&#29983;&#25104;&#20108;&#36827;&#21046;&#25991;&#20214;&#65292;&#28982;&#21518;&#34987;&#20445;&#23384;&#21040;&#23384;&#20648;&#35774;&#22791;&#20013;&#65292;&#30001;&#21152;&#36733;&#22120;&#21152;&#36733;&#36816;&#34892;&#12290;&#20174;&#21407;&#29702;&#19978;&#35828;&#65292;&#25805;&#20316;&#31995;&#32479;&#19981;&#36807;&#22914;&#27492;&#12290;</p>
</blockquote></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>