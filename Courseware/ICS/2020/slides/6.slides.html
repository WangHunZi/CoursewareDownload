<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>数据的机器级表示</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">数据的机器级表示</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">提醒</h2>
<p class=" font-serif my-1">请大家及时关注课程网站发布的作业</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">HW2/Lab2 已发布</p>
<p class=" font-serif my-1">PA2.2 已临近截止</p>
</blockquote>
<hr>
<p class=" font-serif my-1">以各位的平均水准来看，完成 PA 的时间是长于预估时间的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果还没有开始……</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本讲概述</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">我们已经知道数据是如何在计算机中表示的。但为什么要这样表示？这样的表示有什么好处和用法？</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8">位运算与单指令多数据</li>
<li class=" ml-8">整数溢出与 Undefined Behavior</li>
<li class=" ml-8">IEEE754 浮点数</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">位运算与单指令多数据</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">为什么会有位运算？</h2>
<p class=" font-serif my-1">逻辑门和导线是构成计算机 (组合逻辑电路) 的基本单元</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">位运算是用电路最容易实现的运算<ul class=" list-disc font-serif">
<li class=" ml-8"><code>&</code> (与), <code>|</code> (或), <code>~</code> (非)</li>
<li class=" ml-8"><code>^</code> (异或)</li>
<li class=" ml-8"><code><<</code> (左移位), <code>>></code> (右移位)</li>
<li class=" ml-8">例子：一代传奇处理器 8-bit <a href="https://www.masswerk.at/6502/6502_instruction_set.html" class=" text-amber-900">MOS 6502</a><ul class=" list-disc font-serif">
<li class=" ml-8">3510 晶体管；56 条指令，算数指令仅有加减法和位运算</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">数学上自然的整数需要实现成固定长度的 01 字符串</li>
</ul></div>
        
      
         <div class="fragment"> 
        <div><hr>
<p class=" font-serif my-1">习题：用上述位运算和常数实现 4 位整数的加法运算/Lab1</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">加法比上述运算在电路上实现 fundamentally 更困难 (为什么？)<ul class=" list-disc font-serif">
<li class=" ml-8">“Circuit Complexity”</li>
</ul>
</li>
</ul></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-string" class=" text-xl mt-2 pb-2 font-sans">整数：固定长度的 Bit String</h2>
<p class=" font-serif my-1"><code>142857 -> 0000 0000 0000 0010 0010 1110 0000 1001</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">假设 32-bit 整数；约定 MSB 在左，LSB 在右</li>
</ul>
<hr>
<p class=" font-serif my-1">热身问题：字符串操作</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">分别取出 4 个字节</li>
<li class=" ml-8">交换高/低 16 位</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">单指令多数据</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><code>&</code>, <code>|</code>, <code>~</code>, ... 对于整数里的每一个 bit 来说是<red>独立</red> (并行) 的</p>
</blockquote>
<p class=" font-serif my-1">如果我们操作的对象刚好每一个 bit 是独立的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们在一条指令里就实现了多个操作</li>
<li class=" ml-8">SIMD (Single Instruction, Multiple Data)</li>
</ul>
<hr>
<p class=" font-serif my-1">例子：Bit Set</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">32-bit 整数 $x \to S \subseteq \{0,1,2,\ldots,31\}$</li>
<li class=" ml-8">位运算是对所有 bit <red>同时</red>完成的<ul class=" list-disc font-serif">
<li class=" ml-8">C++ 中有 <code>bitset</code>，性能非常可观</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-set" class=" text-xl mt-2 pb-2 font-sans">Bit Set: 基本操作</h2>
<p class=" font-serif my-1">测试 $x\in S$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>(S >> x) & 1</code></li>
</ul>
<p class=" font-serif my-1">求 $S' = S\cup{x}$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>S | (1 << x)</code></li>
</ul>
<p class=" font-serif my-1">更多习题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">求 $|S|$</li>
<li class=" ml-8">求 $S_1 \cup S_2$, $S_1 \cap S_2$</li>
<li class=" ml-8">求 $S_1 \setminus S_2$</li>
<li class=" ml-8">遍历 $S$ 中的所有元素 (foreach)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-set-s" class=" text-xl mt-2 pb-2 font-sans">Bit Set: 求 $|S|$</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">bitset_size</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bitset_contains</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">bitset_size1</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// SIMD</span>
<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x55555555</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">S</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x55555555</span><span class="p">);</span>
<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x33333333</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">S</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x33333333</span><span class="p">);</span>
<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x0F0F0F0F</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">S</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x0F0F0F0F</span><span class="p">);</span>
<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x00FF00FF</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">S</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x00FF00FF</span><span class="p">);</span>
<span class="w">  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x0000FFFF</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">S</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&</span><span class="w"> </span><span class="mh">0x0000FFFF</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-set-snevarnothing" class=" text-xl mt-2 pb-2 font-sans">Bit Set: 返回 $S\ne\varnothing$ 中的某个元素</h2>
<p class=" font-serif my-1">有二进制数<code>x = 0b+++++100</code>，我们希望得到最后那个<code>100</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">想法：使用基本操作构造一些结果，能把<code>+++++</code>的部分给抵消掉</li>
</ul>
<table>
<thead>
<tr>
<th>表达式</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x</code></td>
<td><code>0b+++++100</code></td>
</tr>
<tr>
<td><code>x-1</code></td>
<td><code>0b+++++011</code></td>
</tr>
<tr>
<td><code>~x</code></td>
<td><code>0b-----011</code></td>
</tr>
<tr>
<td><code>~x+1</code></td>
<td><code>0b-----100</code></td>
</tr>
</tbody>
</table></div>
        
      
         <div class="fragment"> 
        <div><p class=" font-serif my-1">一些有趣的式子：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>x & (x-1)</code> → <code>0b+++++000</code>；<code>x ^ (x-1)</code> → <code>0b00000111</code></li>
<li class=" ml-8"><code>x & (~x+1)</code> → <code>0b00000100</code> (lowbit️)<ul class=" list-disc font-serif">
<li class=" ml-8"><code>x & -x</code>, <code>(~x & (x-1)) + 1</code> 都可以实现 lowbit</li>
<li class=" ml-8">只遍历存在的元素可以加速求 $|S|$</li>
</ul>
</li>
</ul></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-set-lfloor-log_2x-rfloor" class=" text-xl mt-2 pb-2 font-sans">Bit Set: 求 $\lfloor \log_2(x) \rfloor$</h2>
<p class=" font-serif my-1">等同于 $31 - \mathrm{clz}(x)$</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">clz</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="mh">0x0000ffff</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o"><<=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="mh">0x00ffffff</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o"><<=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="mh">0x0fffffff</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o"><<=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="mh">0x3fffffff</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+=</span><span class="w">  </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o"><<=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="mh">0x7fffffff</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">(奇怪的代码) 假设 $x$ 是 <code>lowbit</code> 得到的结果？</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define LOG2(x) \</span>
<span class="cp">  ("-01J2GK-3@HNL;-=47A-IFO?M:<6-E>95D8CB"[(x) % 37] - '0')</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bit-set-lfloor-log_2x-rfloor-contd" class=" text-xl mt-2 pb-2 font-sans">Bit Set: 求 $\lfloor \log_2(x) \rfloor$ (cont'd)</h2>
<p class=" font-serif my-1">用一点点元编程 (meta-programming)；试一试 <a href="../../../pages/ICS/2020/demos/log2.c" class=" text-amber-900">log2.c</a></p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="n">n</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="s1">'0'</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">({</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">})</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">{</span> <span class="n">j</span><span class="p">:</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span> <span class="o">==</span> <span class="n">j</span> <span class="p">}</span>
    <span class="k">break</span>

<span class="n">magic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
  <span class="p">[</span> <span class="n">M</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">]</span>
  <span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'#define LOG2(x) ("</span><span class="si">{</span><span class="n">magic</span><span class="si">}</span><span class="s1">"[(x) % </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">] - </span><span class="se">\'</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="se">\'</span><span class="s1">)'</span><span class="p">)</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">一本有趣的参考书</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">Henry S. Warren, Jr. <em>Hacker's Delight</em> (2ed), Addison-Wesley, 2012.</p>
</blockquote>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/ICS/2020/slides/img/hackers-delight.jpg" width="200px"></p>
<p class=" font-serif my-1">让你理解写出更快的代码并不是 “瞎猜”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">主要内容是各种数学 (带来的代码优化)</li>
<li class=" ml-8">官方网站：<a href="http://hackersdelight.org/" class=" text-amber-900">hackersdelight.org</a></li>
<li class=" ml-8">见识一下真正的 “奇技淫巧”</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="undefined-behavior" class=" text-2xl mt-2 font-sans">整数溢出与 Undefined Behavior</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="undefined-behavior-ub" class=" text-xl mt-2 pb-2 font-sans">Undefined Behavior (UB)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><em>Undefined behavior</em> (UB) is the result of executing computer code whose behavior is not prescribed by the language specification to which the code adheres, for the current state of the program. This happens when the translator of the source code makes certain assumptions, but these assumptions are not satisfied during execution. -- Wikipedia</p>
</blockquote>
<p class=" font-serif my-1">C 对 UB 的行为是不做任何约束的，把<font color="red">电脑炸了</font>都行</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">常见的 UB：非法内存访问 (空指针解引用、数组越界、写只读内存等)、被零除、有符号整数溢出、函数没有返回值……<ul class=" list-disc font-serif">
<li class=" ml-8">通常的后果比较轻微，比如 wrong answer, crash</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cc-ub" class=" text-xl mt-2 pb-2 font-sans">为什么 C/C++ 会有 UB？</h2>
<p class=" font-serif my-1">为了尽可能高效 (zero-overhead)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不合法的事情的后果只好 undefined 了</li>
<li class=" ml-8">Java, js, python, ... 选择所有操作都进行合法性检查</li>
</ul>
<hr>
<p class=" font-serif my-1">为了兼容多种硬件体系结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">有些硬件 <code>/0</code> 会产生处理器异常</li>
<li class=" ml-8">有些硬件啥也不发生</li>
<li class=" ml-8">只好 undefined 了</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="undefined-behavior" class=" text-xl mt-2 pb-2 font-sans">Undefined Behavior: 一个历史性的包袱</h2>
<p class=" font-serif my-1">埋下了灾难的种子</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">CVE: <em>Common Vulnerabilities and Exposures</em>，公开发布软件中的漏洞<ul class=" list-disc font-serif">
<li class=" ml-8">buffer/integer overflow 常年占据 CVE 的一席之地</li>
<li class=" ml-8">高危漏洞让没有修补的机器立马宕🐔/变成肉🐔</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">例子：<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-7445" class=" text-amber-900">CVE-2018-7445</a> (RouterOS), 仅仅是忘记检查缓冲区大小……</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="p">...</span>
<span class="w">  </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="undefined-behavior" class=" text-xl mt-2 pb-2 font-sans">Undefined Behavior: 警惕整数溢出</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">表达式</th>
<th style="text-align: center;">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>UINT_MAX+1</code></td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;"><code>INT_MAX+1; LONG_MAX+1</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
<tr>
<td style="text-align: center;"><code>char c = CHAR_MAX; c++;</code></td>
<td style="text-align: center;"><font color="blue">varies</font> (???)</td>
</tr>
<tr>
<td style="text-align: center;"><code>1 << -1</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
<tr>
<td style="text-align: center;"><code>1 << 0</code></td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;"><code>1 << 31</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
<tr>
<td style="text-align: center;"><code>1 << 32</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
<tr>
<td style="text-align: center;"><code>1 / 0</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
<tr>
<td style="text-align: center;"><code>INT_MAX % -1</code></td>
<td style="text-align: center;"><font color="red">undefined</font></td>
</tr>
</tbody>
</table>
<ul class=" list-disc font-serif">
<li class=" ml-8">W. Dietz, et al. Understanding integer overflow in C/C++. In <em>Proceedings of ICSE</em>, 2012.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">整数溢出和编译优化</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o"><<</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">根据手册，这是个 UB，于是 clang 这样处置……</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>0000000000000000 <f>:
   0:   c3      retq
</code></pre></div>

<hr>
<p class=" font-serif my-1">编译器把这个计算直接删除了</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">W. Xi, et al. Towards optimization-safe systems: Analyzing the impact of undefined behavior. In <em>Proceedings of SOSP</em>, 2013.</p>
</blockquote></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="ieee-754" class=" text-2xl mt-2 font-sans">浮点数：IEEE 754</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">实数的计算机表示</h2>
<p class=" font-serif my-1">实数非常非常多 ($\aleph_0 < \mathfrak c$)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">只能用 32/64-bit 01 串来表示<red>一小部分</red>实数<ul class=" list-disc font-serif">
<li class=" ml-8">确定一种映射方法，把一个 01 串映射到一个实数<ul class=" list-disc font-serif">
<li class=" ml-8">运算起来不太麻烦</li>
<li class=" ml-8">计算误差不太可怕</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">于是有了 IEEE754 (1bit S, 23/52bits Fraction, 8/11bits Exponent)</p>
<p class=" font-serif my-1">$$x = (-1)^S \times (1.F) \times 2^{E - B}$$</p>
<p class=" font-serif my-1"><img alt="" class="center" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e8/IEEE_754_Single_Floating_Point_Format.svg/1200px-IEEE_754_Single_Floating_Point_Format.svg.png"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ieee754" class=" text-xl mt-2 pb-2 font-sans">IEEE754: 你可能不知道的事实</h2>
<p class=" font-serif my-1">一个有关浮点数大小/密度的实验 (<a href="../../../pages/ICS/2020/demos/float.c" class=" text-amber-900">float.c</a>)</p></div>
        
      
         <div class="fragment"> 
        <div><hr>
<p class=" font-serif my-1">越大的数字，距离下一个实数的距离就越大</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可能会带来相当的绝对误差</li>
<li class=" ml-8">因此很多数学库都会频繁做归一化</li>
</ul>
<hr>
<p class=" font-serif my-1">例子：计算 $1 + \frac{1}{2} + \frac{1}{3} + \ldots + \frac{1}{n}$</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define SUM(T, st, ed, d) ({ \</span>
<span class="cp">  T s = 0; \</span>
<span class="cp">  for (int i = st; i != ed + d; i += d) \</span>
<span class="cp">    s += (T)1 / i; \</span>
<span class="cp">  s; \</span>
<span class="cp">})</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">浮点数：$ (a + b) + c \ne a + (b + c)$</li>
</ul></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ieee754-contd" class=" text-xl mt-2 pb-2 font-sans">IEEE754: 你可能不知道的事实 (cont'd)</h2>
<p class=" font-serif my-1">比较</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>a == b</code> 需要谨慎判断 (要假设自带 $\varepsilon$)</li>
</ul>
<hr>
<p class=" font-serif my-1">非规格化数 (Exponent == 0)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$x = (-1)^S \times (0.F) \times 2^{-126}$</li>
</ul>
<hr>
<p class=" font-serif my-1">零</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>+0.0</code>, <code>-0.0</code> 的 $S$ bit 是不一样的，但 <code>+0.0 == -0.0</code></li>
</ul>
<hr>
<p class=" font-serif my-1">Inf/NaN (Not a Number)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Inf: 浮点数溢出很常见，不应该作为 undefined behavior</li>
<li class=" ml-8">NaN (<code>0.0/0.0</code>): 能够满足 <code>x != x</code> 表达式的值</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ieee754" class=" text-xl mt-2 pb-2 font-sans">IEEE754：异常复杂</h2>
<p class=" font-serif my-1">除了 $x = (-1)^S \times (1.F) \times 2^{E - B}$，还要考虑</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">非规格化数, +0.0/-0.0, Inf, NaN<ul class=" list-disc font-serif">
<li class=" ml-8">一度引起了硬件厂商的众怒 (碰到非规格数干脆软件模拟吧)</li>
<li class=" ml-8">很多“对浮点数精度要求不高”硬件厂商选择不兼容 IEEE 754 (比如各种 GPU 制造商)</li>
<li class=" ml-8">Nvidia 从 Fermi 才开始完整支持 IEEE754 (2010)</li>
</ul>
</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><a href="https://people.eecs.berkeley.edu/~wkahan/ieee754status/754story.html" class=" text-amber-900">An interview with the old man of floating-point</a>. Reminiscences elicited from <a href="http://http.cs.berkeley.edu/~wkahan/" class=" text-amber-900">William Kahan </a>by <a href="http://www.dr-chuck.com/" class=" text-amber-900">Charles Severance</a>.</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="frac-b-sqrtb2-4ac2a" class=" text-xl mt-2 pb-2 font-sans">例子：计算 $\frac{-b - \sqrt{b^2-4ac}}{2a}$</h2>
<p class=" font-serif my-1">如果考虑比较极端的数值条件？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">消去误差: $-b$ v.s. $ \sqrt{b^2-4ac} $ (catastrophic cancellation)<ul class=" list-disc font-serif">
<li class=" ml-8">还记得 <code>x + 1.0 == x</code> 的例子吗</li>
</ul>
</li>
<li class=" ml-8">溢出: $b^2$</li>
</ul>
<hr>
<p class=" font-serif my-1">一个更好的一元二次方程求根公式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$\frac{(-b)^2 - (\sqrt{b^2-4ac})^2}{ (-b) + \sqrt{b^2-4ac}} /2a = \frac{4ac}{(-b)+\sqrt{b^2-4ac}}/2a $ ($b < 0$)</li>
<li class=" ml-8">$(-b-\sqrt{b^2-4ac}) \cdot \frac{1}{2a}$ ($0\le b\le 10^{127}$)</li>
<li class=" ml-8">$-\frac{b}{a}+\frac{c}{b}$ ($b > 10^{127}$)<ul class=" list-disc font-serif">
<li class=" ml-8">P. Panchekha, et al. Automatically improving accuracy for floating point expressions. In <em>Proc. of PLDI</em>, 2015.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">凭什么？</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">It looked pretty complicated. On the other hand, we had a rationale for everything. -- <a href="http://http.cs.berkeley.edu/~wkahan/" class=" text-amber-900">William Kahan</a>, 1989 ACM Turing Award Winner for his <em>fundamental contributions to numerical analysis</em>.</p>
</blockquote>
<p class=" font-serif my-1"></p><center>浮点数可以直接当成整数比较大小</center>
<p class=" font-serif my-1"></p><center><code>+0.0/-0.0</code> 和 Inf 保证 $(1/x)/x$ 不会发生 sign shift</center>
<p class=" font-serif my-1"></p><center>……</center>
<p class=" font-serif my-1">IEEE754 天才的设计保证了数值计算的稳定</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果想了解 IEEE754，请阅读 D. Goldberg. <a href="https://dl.acm.org/citation.cfm?id=103163" class=" text-amber-900">What every computer scientist should know about floating-point arithmetic</a>. <em>ACM Computing Surveys</em>, 23(1), 1991.</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">数据的机器级表示：综合案例</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1sqrtx" class=" text-xl mt-2 pb-2 font-sans">案例：计算 $1/\sqrt{x}$</h2>
<p class=" font-serif my-1">应用：Surface Norm</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">平面的法向量<ul class=" list-disc font-serif">
<li class=" ml-8">用于计算光照/反射</li>
<li class=" ml-8"><del>第一次感觉数学派上了用场</del></li>
</ul>
</li>
<li class=" ml-8">计算方法<ul class=" list-disc font-serif">
<li class=" ml-8">幂级数展开</li>
<li class=" ml-8">二分法</li>
<li class=" ml-8">牛顿法……</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">如何不借助硬件指令，快速 (近似) 计算 $f(x)$？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">人眼对像素级的误差并不敏感，因此算错一点也没事</li>
<li class=" ml-8">快 1.5 倍: $ 640 \times 480 \to 800 \times 600 $ (这个推导不严格)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="o1" class=" text-xl mt-2 pb-2 font-sans">神奇的 $O(1)$ 代码</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">float</span><span class="w"> </span><span class="nf">Q_rsqrt</span><span class="p">(</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5F</span><span class="p">;</span>
<span class="w">  </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="p">;</span>
<span class="w">  </span><span class="n">conv</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x5f3759df</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv</span><span class="p">.</span><span class="n">i</span><span class="w"> </span><span class="o">>></span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// ???</span>
<span class="w">  </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mf">1.5F</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">conv</span><span class="p">.</span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">看看别人的毕业设计</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Matthew Robertson. <a href="http://localhost:5001/static/wiki/ics/rsqrt.pdf" class=" text-amber-900">A Brief History of InvSqrt</a>, <em>Bachelor Thesis, The University of New Brunswick</em>, 2012.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="atimes-b-bmod-m" class=" text-xl mt-2 pb-2 font-sans">案例：计算 $(a\times b) \bmod m$</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int64_t</span><span class="w"> </span><span class="nf">multimod_fast</span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)((</span><span class="kt">double</span><span class="p">)</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">令 $a \times b = p \cdot m + q$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>a * b</code> → $(p \cdot m + q) \bmod 2^{64}$</li>
<li class=" ml-8"><code>x</code> → $(\lfloor \frac{p\cdot m+q}{m} \rfloor \cdot m) \bmod 2^{64}$<ul class=" list-disc font-serif">
<li class=" ml-8">如果浮点数的精度是无限的，$x = (p\cdot m) \bmod 2^{64}$</li>
<li class=" ml-8">同余就得到了 $q$</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">数据的机器级表示</h2>
<p class=" font-serif my-1"><em>Everything</em> is a bit-string!</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但却能玩出很多花样来<ul class=" list-disc font-serif">
<li class=" ml-8">bit-set/SIMD</li>
<li class=" ml-8">浮点数的表示</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">PA: 禁止写出不可维护的代码</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果你想玩出花，请做合适的封装和充分的测试</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>