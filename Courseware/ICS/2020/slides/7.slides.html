<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>x86-64 与内联汇编</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="x86-64" class=" text-2xl mt-2 font-sans">x86-64 与内联汇编</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本讲概述</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">课堂上/PA 以 x86 (IA32) 为主授课？</p>
<p class=" font-serif my-1">今天连手机都是 64-bit 了……</p>
</blockquote>
<hr>
<p class=" font-serif my-1">本讲内容</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一些背景</li>
<li class=" ml-8">x86-64 体系结构与汇编语言</li>
<li class=" ml-8">inline assembly</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">机器字长的发展</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="word-size" class=" text-xl mt-2 pb-2 font-sans">字长 (Word Size)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">In computing, a word is the natural unit of data used by a particular processor design. The <em>number of bits in a word</em> (the word size, word width, or word length)...</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8">能直接进行整数/位运算的大小</li>
<li class=" ml-8">指针的大小 (索引内存的范围)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="8-6502" class=" text-xl mt-2 pb-2 font-sans">8 位机 (6502)</h2>
<p class=" font-serif my-1">16 bit PC 寄存器 (64 KiB 寻址能力，KiB 级内存，无乘除法/浮点数)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Apple II; Atari 2600; NES; ...</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="https://cdn.cultofmac.com/wp-content/uploads/2018/12/PaperAppleII001.jpg" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="16-80868088" class=" text-xl mt-2 pb-2 font-sans">16 位机 (8086/8088)</h2>
<p class=" font-serif my-1">我们需要更大的内存！更大的数据宽度！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">20 bit 地址线 (两个寄存器)</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="center" src="https://cdn.arstechnica.net/wp-content/uploads/2017/07/ibm-pc-5150-print-ad-760x380.jpg" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="32-intel-x86" class=" text-xl mt-2 pb-2 font-sans">32 位机 (Intel x86)</h2>
<p class=" font-serif my-1">8086 处理器 4,096 倍的地址空间</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">4 GiB 内存在 1980s 看起来是非常不可思议的</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="https://s1.gaming-cdn.com/images/products/2172/screenshot/assassins-creed-ii-wallpaper-2.jpg" width="720px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="64-x86-64-aarch64-rv64" class=" text-xl mt-2 pb-2 font-sans">64 位机 (x86-64; AArch64; RV64; ...)</h2>
<p class=" font-serif my-1">64 位地址空间能索引 17,179,869,184 GiB 内存</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们的服务器有 128 GiB 内存</li>
<li class=" ml-8">目前看起来是非常够用的 (PML4)<ul class=" list-disc font-serif">
<li class=" ml-8">现在的处理器一般实现 48 bit 物理地址 (256 TiB)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="center" src="https://cdn.dxomark.com/wp-content/uploads/2017/09/apple-iphone-5s-space-gray-3d-model-max-obj.jpg" width="450px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fun-facts" class=" text-xl mt-2 pb-2 font-sans">Fun Facts</h2>
<p class=" font-serif my-1"><code>int</code> 类型的长度</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">8 bit computer: 8 bit</li>
<li class=" ml-8">16 bit computer: 16 bit</li>
<li class=" ml-8">32 bit computer: 32 bit</li>
<li class=" ml-8">64 bit computer: <red>32 bit</red></li>
<li class=" ml-8">JVM (32/64 bit): <red>32 bit</red></li>
</ul>
<hr>
<p class=" font-serif my-1">在逻辑世界里描述日常世界，2,147,483,647 已经足够大了</p></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="abi" class=" text-2xl mt-2 font-sans">概念复习： ABI</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">程序的机器级表示</h2>
<p class=" font-serif my-1">程序经历 .c → .o (编译) 和 .o → a.out (链接)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不同版本、不同编译器、不同语言的二进制文件都可以链接<ul class=" list-disc font-serif">
<li class=" ml-8">他们需要一个 “共同语言”</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">例如我们熟悉的 x86 calling convention</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">cdecl (Linux)</li>
<li class=" ml-8">stdcall (Win32)</li>
<li class=" ml-8">只要遵循标准的函数就可以互相调用</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="application-binary-interface-abi" class=" text-xl mt-2 pb-2 font-sans">Application Binary Interface (ABI)</h2>
<p class=" font-serif my-1">区别于 API (Application Programming Interface)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">程序源代码中的规范</li>
</ul>
<hr>
<p class=" font-serif my-1">ABI：约定 binary 的行为</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">二进制文件的格式</li>
<li class=" ml-8">函数调用、系统调用……<ul class=" list-disc font-serif">
<li class=" ml-8">C 语言规范只定义了运行时内存和内存上的计算</li>
<li class=" ml-8"><code>printf</code> 都无法实现，必须借助外部库函数</li>
</ul>
</li>
<li class=" ml-8">链接、加载的规范</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cdecl" class=" text-xl mt-2 pb-2 font-sans">例子：cdecl 函数调用</h2>
<p class=" font-serif my-1">caller stack frame:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">所有参数以<red>数组</red>的形式保存在堆栈上 (所以才有 “反序压栈”)</li>
<li class=" ml-8">然后是返回地址</li>
<li class=" ml-8">跳转到 callee</li>
</ul>
<hr>
<p class=" font-serif my-1">callee:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">EAX 作为返回值</li>
<li class=" ml-8">其他寄存器都是 callee save</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">bar</span><span class="p">(</span><span class="o">&</span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">阅读汇编代码：“符号执行”</h2>
<p class=" font-serif my-1">试着把内存/寄存器用数学符号表示出来</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">然后假想地 “单步执行” 程序，用符号公式表示当前系统的状态<ul class=" list-disc font-serif">
<li class=" ml-8">James C. King. Symbolic execution and program testing. <em>Communications of the ACM</em>, 19(7), 1976.</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">编译选项：<code>-m32 -O2 -fno-pic</code> (便于大家理解)</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>000004f0 <foo>:
 4f0:   83 ec 18                sub    $0x18,%esp
 4f3:   8d 44 24 1c             lea    0x1c(%esp),%eax
 4f7:   50                      push   %eax
 4f8:   e8 13 00 00 00          call   510 <bar>
 4fd:   8b 44 24 20             mov    0x20(%esp),%eax
 501:   83 c4 1c                add    $0x1c,%esp
 504:   c3                      ret    
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="x86-64" class=" text-2xl mt-2 font-sans">x86-64：寄存器与函数调用</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1-ia32" class=" text-xl mt-2 pb-2 font-sans">寄存器 (1)：继承自 IA32</h2>
<table>
<thead>
<tr>
<th>用途</th>
<th>64b</th>
<th>低32b</th>
<th>低16b</th>
<th>低8b</th>
<th>8-15b</th>
</tr>
</thead>
<tbody>
<tr>
<td>返回值</td>
<td>%rax</td>
<td>%eax</td>
<td>%ax</td>
<td>%al</td>
<td>%ah</td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%rbx</td>
<td>%ebx</td>
<td>%bx</td>
<td>%bl</td>
<td>%bh</td>
</tr>
<tr>
<td>参数4</td>
<td>%rcx</td>
<td>%ecx</td>
<td>%cx</td>
<td>%cl</td>
<td>%ch</td>
</tr>
<tr>
<td>参数3</td>
<td>%rdx</td>
<td>%edx</td>
<td>%dx</td>
<td>%dl</td>
<td>%dh</td>
</tr>
<tr>
<td>参数2</td>
<td>%rsi</td>
<td>%esi</td>
<td>%si</td>
<td>%sil</td>
<td></td>
</tr>
<tr>
<td>参数1</td>
<td>%rdi</td>
<td>%edi</td>
<td>%di</td>
<td>%dil</td>
<td></td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%rbp</td>
<td>%ebp</td>
<td>%bp</td>
<td>%bpl</td>
<td></td>
</tr>
<tr>
<td>栈顶</td>
<td>%rsp</td>
<td>%esp</td>
<td>%sp</td>
<td>%spl</td>
<td><span></span></td>
</tr>
</tbody>
</table></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2" class=" text-xl mt-2 pb-2 font-sans">寄存器 (2)：新增加的寄存器</h2>
<p class=" font-serif my-1">x86-64 扩充了很多寄存器！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">于是再也不用像 IA32 那样，用堆栈传递参数了！！</li>
</ul>
<table>
<thead>
<tr>
<th>用途</th>
<th>64b</th>
<th>低32b</th>
<th>低16b</th>
<th>低8b</th>
<th>8-15b</th>
</tr>
</thead>
<tbody>
<tr>
<td>参数5</td>
<td>%r8</td>
<td>%r8d</td>
<td>%r8w</td>
<td>%r8b</td>
<td></td>
</tr>
<tr>
<td>参数6</td>
<td>%r9</td>
<td>%r9d</td>
<td>%r9w</td>
<td>%r9b</td>
<td></td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%r10</td>
<td>%r10d</td>
<td>%r10w</td>
<td>%r10b</td>
<td></td>
</tr>
<tr>
<td>链接</td>
<td>%r11</td>
<td>%r11d</td>
<td>%r11w</td>
<td>%r11b</td>
<td></td>
</tr>
<tr>
<td>C unsued</td>
<td>%r12</td>
<td>%r12d</td>
<td>%r12w</td>
<td>%r12b</td>
<td></td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%r13</td>
<td>%r13d</td>
<td>%r13w</td>
<td>%r13b</td>
<td></td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%r14</td>
<td>%r14d</td>
<td>%r14w</td>
<td>%r14b</td>
<td></td>
</tr>
<tr>
<td><red>调用者保存</red></td>
<td>%r15</td>
<td>%r15d</td>
<td>%r15w</td>
<td>%r15b</td>
<td>(没有)</td>
</tr>
</tbody>
</table></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="a-b-in-x86-64" class=" text-xl mt-2 pb-2 font-sans">A + B in x86-64</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>00000510 <add_32>:
 510:   8b 44 24 08   mov    0x8(%esp),%eax
 514:   03 44 24 04   add    0x4(%esp),%eax
 518:   c3            ret    
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>0000000000000630 <add_64>:
 630:   8d 04 37  lea    (%rdi,%rsi,1),%eax
 633:   c3        retq   
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="max-in-x86-64" class=" text-xl mt-2 pb-2 font-sans">max in x86-64</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">></span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>00000514 <max_32>:
 514:   8b 44 24 04             mov    0x4(%esp),%eax
 518:   3b 44 24 08             cmp    0x8(%esp),%eax
 51c:   7d 04                   jge    522 <max+0xe>
 51e:   8b 44 24 08             mov    0x8(%esp),%eax
 522:   c3                      ret    
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>0000000000000640 <max_64>:
 640:   39 f7                   cmp    %esi,%edi
 642:   89 f0                   mov    %esi,%eax
 644:   0f 4d c7                cmovge %edi,%eax
 647:   c3                      retq   
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">使用寄存器传递函数参数：优势</h2>
<p class=" font-serif my-1">支持 6 个参数的传递：rdi, rsi, rdx, rcx, r8, r9</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">callee 可以随意修改这 6 个寄存器的值</li>
<li class=" ml-8">编译器有了更大的调度空间 (大幅减少堆栈内存访问)</li>
</ul>
<hr>
<p class=" font-serif my-1">例子：</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">plus</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fprintf" class=" text-xl mt-2 pb-2 font-sans">例子：调用 <code>fprintf</code></h2>
<p class=" font-serif my-1">实际调用的是 <code>__fprintf_chk@plt</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">需要传递的参数：<code>stdout</code>, <code>%d + %d = %d\n</code>, <code>a</code>, <code>b</code>, <code>a + b</code></li>
<li class=" ml-8">calling convention: rdi, rsi, rdx, rcx, r8, r9</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>0000000000000700 <plus>:
 700:   44 8d 0c 37             lea    (%rdi,%rsi,1),%r9d
 704:   89 f9                   mov    %edi,%ecx
 706:   48 8b 3d 03 09 20 00    mov    0x200903(%rip),%rdi        # 201010 <stdout@@GLIBC_2.2.5>
 70d:   48 8d 15 b0 00 00 00    lea    0xb0(%rip),%rdx        # 7c4 <_IO_stdin_used+0x4>
 714:   41 89 f0                mov    %esi,%r8d
 717:   31 c0                   xor    %eax,%eax
 719:   be 01 00 00 00          mov    $0x1,%esi
 71e:   e9 5d fe ff ff          jmpq   580 <__fprintf_chk@plt>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">一些更多的分析</h2>
<p class=" font-serif my-1"><code>plus</code> 的最后一条指令：</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code> 71e:   e9 5d fe ff ff     jmpq   580 <__fprintf_chk@plt>
</code></pre></div>

<hr>
<ul class=" list-disc font-serif">
<li class=" ml-8">并不是调用的 <code>printf</code>，而是调用的<a href="http://refspecs.linuxbase.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/libc---printf-chk-1.html" class=" text-amber-900">有堆栈检查的版本</a><ul class=" list-disc font-serif">
<li class=" ml-8">准备参数时有 <code>mov $0x1, %esi</code></li>
</ul>
</li>
<li class=" ml-8">直接 <code>jmp</code> 是因为函数末尾默认有一条 <code>ret</code> 指令<ul class=" list-disc font-serif">
<li class=" ml-8">借用了 <code>__fprintf_chk@plt</code> 的 <code>ret</code> 指令返回到 <code>plus</code> 的调用者</li>
<li class=" ml-8">如果有返回值，就会生成 <code>call</code> 指令；如果 <code>plus</code> 返回 <code>printf</code> 的结果，依然是 <code>jmp</code></li>
<li class=" ml-8">省的不止是一条指令<ul class=" list-disc font-serif">
<li class=" ml-8">连续的 <code>ret</code> 对分支预测是很大的挑战</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="32-printf" class=" text-xl mt-2 pb-2 font-sans">对比 32 位 <code>printf</code></h2>
<p class=" font-serif my-1">好读，但指令执行起来会稍慢一些</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>000005b4 <plus>:
 5b4:   83 ec 14                sub    $0x14,%esp
 5b7:   8b 44 24 18             mov    0x18(%esp),%eax
 5bb:   8b 54 24 1c             mov    0x1c(%esp),%edx
 5bf:   8d 0c 10                lea    (%eax,%edx,1),%ecx
 5c2:   51                      push   %ecx
 5c3:   52                      push   %edx
 5c4:   50                      push   %eax
 5c5:   68 60 06 00 00          push   $0x660
 5ca:   6a 01                   push   $0x1
 5cc:   ff 35 00 00 00 00       pushl  0x0
 5d2:   e8 fc ff ff ff          call   5d3 <plus+0x1f>
 5d7:   83 c4 2c                add    $0x2c,%esp
 5da:   c3                      ret    
 5db:   90                      nop
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">一个有趣的小问题</h2>
<p class=" font-serif my-1">x86-64 <red>按寄存器传递参数</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>void f(int x) {... &x ...}</code> 会发生什么？</li>
</ul></div>
        
      
         <div class="fragment"> 
        <div><hr>
<p class=" font-serif my-1">编译器会给参数分配内存，保证后续访问合法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">给编译器带来了轻微的负担</li>
<li class=" ml-8">但编译器并不觉得这是负担……</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">bar</span><span class="p">(</span><span class="o">&</span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="x86-64" class=" text-2xl mt-2 font-sans">x86-64 程序：更多的例子</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="swap-in-x86-64" class=" text-xl mt-2 pb-2 font-sans"><code>swap</code> in x86-64</h2>
<p class=" font-serif my-1">总体来说，x86-64 是更<red>现代</red>的体系结构，更精简的指令序列</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>void swap(int *x, int *y);</code> 交换两个指针指向的数字</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>mov    0x8(%esp),%edx
mov    0xc(%esp),%eax
mov    (%edx),%ecx
mov    (%eax),%ebx
mov    %ebx,(%edx)
mov    %ecx,(%eax)
pop    %ebx
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>mov    (%rdi),%eax
mov    (%rsi),%edx
mov    %edx,(%rdi)
mov    %eax,(%rsi)
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">例子：循环</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">fact</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">--</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">></span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="w">      </span><span class="nf">mov</span><span class="w">    </span><span class="no">$0x1</span><span class="p">,</span><span class="nv">%eax</span>
<span class="w">      </span><span class="nf">nopl</span><span class="w">   </span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
<span class="nl">.L1:</span><span class="w">  </span><span class="nf">imul</span><span class="w">   </span><span class="nv">%edi</span><span class="p">,</span><span class="nv">%eax</span>
<span class="w">      </span><span class="nf">sub</span><span class="w">    </span><span class="no">$0x1</span><span class="p">,</span><span class="nv">%edi</span>
<span class="w">      </span><span class="nf">test</span><span class="w">   </span><span class="nv">%edi</span><span class="p">,</span><span class="nv">%edi</span>
<span class="w">      </span><span class="nf">jg</span><span class="w">     </span><span class="no">.L1</span>
<span class="w">      </span><span class="na">repz</span><span class="w"> </span><span class="nf">retq</span>
</code></pre></div>

<p class=" font-serif my-1">两个诡异代码：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>nopl (%rax)</code>：内存对齐 (padding)</li>
<li class=" ml-8"><code>repz retq</code>：防止连续分支指令</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">例子：递归</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>0000000000000704 <fib>:
 704:   55                      push   %rbp
 705:   53                      push   %rbx
 706:   89 fd                   mov    %edi,%ebp
 708:   31 db                   xor    %ebx,%ebx
 70a:   48 83 ec 08             sub    $0x8,%rsp
 70e:   83 fd 01                cmp    $0x1,%ebp
 711:   7e 0f                   jle    722 <fib+0x1e>
 713:   8d 7d ff                lea    -0x1(%rbp),%edi
 716:   83 ed 02                sub    $0x2,%ebp
 719:   e8 e6 ff ff ff          callq  704 <fib>
 71e:   01 c3                   add    %eax,%ebx
 720:   eb ec                   jmp    70e <fib+0xa>
 722:   8d 43 01                lea    0x1(%rbx),%eax
 725:   5a                      pop    %rdx
 726:   5b                      pop    %rbx
 727:   5d                      pop    %rbp
 728:   c3                      retq   
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="inline-assembly" class=" text-2xl mt-2 font-sans">Inline Assembly</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="c" class=" text-xl mt-2 pb-2 font-sans">在 C 代码中嵌入汇编</h2>
<p class=" font-serif my-1">编译器：把 C 代码 “原样翻译” 成汇编代码</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">那我们是不是可以在语句之间插入汇编呢？<ul class=" list-disc font-serif">
<li class=" ml-8">可以！编译器就做个 “复制粘贴”</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"endbr64;"</span>
<span class="w">       </span><span class="s">".byte 0xf3, 0x0f, 0x1e, 0xfa"</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="c" class=" text-xl mt-2 pb-2 font-sans">在汇编中访问 C 世界的表达式</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">  </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">"addl %1, %2; "</span>
<span class="w">    </span><span class="s">"movl %2, %0; "</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">"=r"</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="c1">// output</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="c1">// input</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">与编译器交互</h2>
<p class=" font-serif my-1">实际的编译器可能会</p>
<hr>
<ul class=" list-disc font-serif">
<li class=" ml-8">将某个变量分配给某个寄存器<ul class=" list-disc font-serif">
<li class=" ml-8">inline assembly 改写寄存器就会导致错误<ul class=" list-disc font-serif">
<li class=" ml-8">→ clobber list</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<ul class=" list-disc font-serif">
<li class=" ml-8">代码优化<ul class=" list-disc font-serif">
<li class=" ml-8">例如 assembly 的返回值没有用到，就可以删除<ul class=" list-disc font-serif">
<li class=" ml-8">→ volatile</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">对汇编感到很痛苦？</h2>
<p class=" font-serif my-1">两个建议</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">原理：想一想 YEMU 和 NEMU</li>
<li class=" ml-8">实践：“模拟调试”<ul class=" list-disc font-serif">
<li class=" ml-8">指令不过是 CPU 执行的基本单元</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">同时，付出也是必要的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但你一旦掌握了分析汇编代码的方法<ul class=" list-disc font-serif">
<li class=" ml-8">x86-64 也不可怕</li>
<li class=" ml-8">AArch64 也不可怕</li>
<li class=" ml-8">《计算机系统基础也不可怕》</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End. (你找对手册了吗？)</h1>
<p class=" font-serif my-1"><a href="https://www.cs.cmu.edu/~fp/courses/15213-s07/misc/asm64-handout.pdf" class=" text-amber-900">x86-64 Machine-Level Programming</a></p>
<p class=" font-serif my-1"><a href="https://gcc.gnu.org/onlinedocs/gcc-10.2.0/gcc/Using-Assembly-Language-with-C.html" class=" text-amber-900">How to Use Inline Assembly Language in C Code</a></p></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>