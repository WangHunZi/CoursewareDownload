<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>系统编程与基础设施</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">系统编程与基础设施</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本讲概述</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">感受到 PA 的恶意了吗？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不就是写几行代码么，怎么……怎么写不对啊……</li>
<li class=" ml-8">这就是为什么 PA 要搞那么麻烦：又是 Makefile，又是各种项目/工具</li>
<li class=" ml-8">没有适当的基础设施，PA 的完成率会大幅降低</li>
</ul>
</blockquote>
<hr>
<ul class=" list-disc font-serif">
<li class=" ml-8">开发/调试的基础设施</li>
<li class=" ml-8">系统编程：基础设施</li>
<li class=" ml-8">Differential testing 代码导读</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">开发/调试的基础设施</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">你们是怎么写程序的？</h2>
<p class=" font-serif my-1">虽然很多同学已经配置好了良好的编程环境，但依然有很多同学在 “面向浪费时间编程”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">yzh 推荐 vim/tmux 的原因是大家用 IDE 容易迷失自我 (关注表象，而不知道内在是如何工作的)</li>
<li class=" ml-8">在你搞清楚的前提下，也可以解放自我</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gcc a.c
a.c: In function ‘main’:
a.c:5:1: error: ‘a’ undeclared (first use in this function)
$ vi a.c
$ gcc a.c
$ ./a.out
1 2           // 你输入的
zsh: segmentation fault (core dumped)  ./a.out
...
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基础设施的本质</h2>
<p class=" font-serif my-1">通过适当的配置、脚本减少思维中断的时间，提高连贯性，保持短时记忆活跃</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>make</code> (fresh build) → 4s，已被打断</li>
<li class=" ml-8"><code>make</code> (parallel) → 0.5s</li>
</ul>
<hr>
<p class=" font-serif my-1">基本原则：<red>如果你认为有提高效率的可能性，一定有人已经做了</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">每次都 <code>make -j8</code>?<ul class=" list-disc font-serif">
<li class=" ml-8">或者 <code>alias make='make -j8'</code></li>
<li class=" ml-8">在 Makefile 里加一行 <code>MAKEFLAGS += -j 8</code> (better)<ul class=" list-disc font-serif">
<li class=" ml-8">配置一键编译运行 → 1s 内完成</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">心态分析</h2>
<p class=" font-serif my-1">本质上，这些都不是难事，STFW 随手即来，但大家通常做不好</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">尚未 GET STFW 的技能 <ul class=" list-disc font-serif">
<li class=" ml-8">在 hosts 中屏蔽百度 (或修改默认搜索引擎)</li>
</ul>
</li>
<li class=" ml-8">惰性<ul class=" list-disc font-serif">
<li class=" ml-8">键入 <code>make -j8</code>: 增加 1s 时间</li>
<li class=" ml-8">STFW: 至少需要几分钟，而且有不少失败尝试 (短期收益是负的，尤其是上课 workloads 已经很重的前提下)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">心态分析 (cont'd)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">克服惰性可以使你快速成长。</p>
</blockquote>
<p class=" font-serif my-1">在很多小事上，可能并不带来显著的收益</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">每次键入 <code>make -j8</code> 可能并不显著缩短 PA 完成的时间</li>
<li class=" ml-8">但久而久之成为习惯，你就总是<red>想着改进基础设施</red></li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">系统编程：建立基础设施</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">复习：测试/调试的理论</h2>
<p class=" font-serif my-1">Fault → Error → Failure</p>
<hr>
<p class=" font-serif my-1">对于 PA 来说，failure 是显而易见的：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Segmentation Fault 了，fail</li>
<li class=" ml-8">HIT BAD TRAP 了，fail</li>
<li class=" ml-8">马里奥/仙剑不能跑嘛，fail</li>
</ul>
<hr>
<p class=" font-serif my-1">我已经调了很久了，但就是找不到那个导致 error 的指令啊</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">怎样找到 error 发生的位置？<ul class=" list-disc font-serif">
<li class=" ml-8">二分法似乎还是太麻烦了？</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">抱大腿：一种想法</h2>
<p class=" font-serif my-1">如果学长/同学已经有一份正确的代码，能不能借助这个代码快速诊断出自己代码的问题？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">同学们是非常智慧的，在 ICS-PA 创立的初期发明了替换调试法<ul class=" list-disc font-serif">
<li class=" ml-8">PA 是分模块实现的 (若干个 <code>.c</code>)</li>
<li class=" ml-8">从自己的代码开始，逐个替换进大腿同学的 <code>.c</code> </li>
<li class=" ml-8">第一个替换后通过测试的文件里有 bug</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><blue>Cool!</blue></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可能的改进：以函数级进行替换</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="delta-debugging" class=" text-xl mt-2 pb-2 font-sans">Delta Debugging</h2>
<p class=" font-serif my-1">假设程序 $P$ 会 fail，$P_{大腿}$ 会 pass</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并且假设两份程序所有函数的行为都相同<ul class=" list-disc font-serif">
<li class=" ml-8">将 $P_{大腿}$ 中的函数 $f$ 替换成 $P$ 中的 $f$<ul class=" list-disc font-serif">
<li class=" ml-8">依然通过 → $f$ 实现正确</li>
<li class=" ml-8">否则 $f$ 中有 bug</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">把类似的想法用在输入上</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不断把输入的一部分去掉，直到不能触发 bug 为止<ul class=" list-disc font-serif">
<li class=" ml-8">Anders Zeller and Ralf Hildebrandt. <a href="https://ieeexplore.ieee.org/document/988498" class=" text-amber-900">Simplifying and isolating failure-inducing input</a>. <em>IEEE Transactions on Software Engineering</em>, 28(2), 2002.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">大腿同学代码的另一种用法</h2>
<p class=" font-serif my-1">大腿同学的代码还可以帮助我们直接定位到错误的指令！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">只需要大腿的 compiled binary</li>
<li class=" ml-8">就能指令级定位出错的位置</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">'si'</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'p $</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'eax'</span><span class="p">,</span> <span class="o">...</span><span class="p">]]))</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">然后找到 log 第一个不一致的地方！</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nv">N</span><span class="o">=</span><span class="m">10000</span>
diff<span class="w"> </span><<span class="o">(</span>python3<span class="w"> </span>cmdgen.py<span class="w"> </span><span class="nv">$N</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>./x86-nemu-datui<span class="w"> </span>img<span class="o">)</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span><<span class="o">(</span>python3<span class="w"> </span>cmdgen.py<span class="w"> </span><span class="nv">$N</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>./x86-nemu<span class="w">       </span>img<span class="o">)</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基础设施：其实没那么困难</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">每做的一点自动化都是在给大项目节约维护成本。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">程序员们就是喜欢造轮子</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(日常管理) 效率低 → <red>熟练使用命令行工具/Python</red></li>
<li class=" ml-8">(项目管理) 你已经会 <code>gcc a.c</code> 了，但没法管理几十个文件 → <red>make, 一键编译/运行/测试</red></li>
<li class=" ml-8">(代码编辑) 在代码里跳来跳去很麻烦  → <red>IDE/配置 Vim/装插件</red></li>
<li class=" ml-8">(错误检查) 很容易犯低级错误 → <red><code>-Wall</code>, <code>-Werror</code>, <code>fsanitize=address</code></red></li>
<li class=" ml-8">(代码调试) Segmentation Fault了 → <red>gdb</red></li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="differential-testing" class=" text-2xl mt-2 font-sans">Differential Testing</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="differential-testing" class=" text-xl mt-2 pb-2 font-sans">Differential Testing</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">“同一套接口 (API) 的两个实现应当行为完全一致”</p>
</blockquote>
<p class=" font-serif my-1">大腿同学 & 小腿同学：指令集的两套实现</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">还有什么现实中软件系统的例子？</li>
</ul></div>
        
      
         <div class="fragment"> 
        <div><hr>
<p class=" font-serif my-1">你能找到两份独立实现的东西，都可以测试</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">浏览器 <a href="https://dl.acm.org/citation.cfm?id=1985870" class=" text-amber-900">Mesbah and Prasad, ICSE'11</a></li>
<li class=" ml-8">GCC (vs clang), <a href="https://embed.cs.utah.edu/csmith/" class=" text-amber-900">Yang et al., PLDI'11</a></li>
<li class=" ml-8">文件系统, <a href="https://dl.acm.org/citation.cfm?id=2815422" class=" text-amber-900">Min et al., SOSP'15</a></li>
<li class=" ml-8">数据库 (2020 年时的预言成真) <a href="https://www.usenix.org/conference/osdi20/presentation/rigger" class=" text-amber-900">Rigger and Su, OSDI'20</a></li>
<li class=" ml-8">Gcov (vs llvm-cov), 我们的工作<ul class=" list-disc font-serif">
<li class=" ml-8">真的能在 gcc/llvm 里发现很多 bugs</li>
</ul>
</li>
</ul></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="nemu-differential-testing" class=" text-xl mt-2 pb-2 font-sans">NEMU: 实现 Differential Testing</h2>
<p class=" font-serif my-1">刚才我们已经给大腿的代码实现了一个简单版本的 diff-testing</p>
<p class=" font-serif my-1">真正的大腿：QEMU</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ICS PA = 缩水版 QEMU<ul class=" list-disc font-serif">
<li class=" ml-8">实际上 PA 就是简化 (教学) 版的 QEMU</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">diff-testing 实验</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">以前我们一直都只是自己写自己的程序，调用库函数</li>
<li class=" ml-8">diff-testing 是和其他程序 (QEMU, gdb) 协作/交互的例子</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="nemu-differential-testing" class=" text-xl mt-2 pb-2 font-sans">NEMU Differential Testing: 原理</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1"># gen-cmds: 不断生成 si; p $eax; p $ebx; ...</span>
diff-stream<span class="w"> </span><<span class="o">(</span>gen-cmds<span class="w"> </span><span class="p">|</span><span class="w"> </span>nemu<span class="o">)</span><span class="w"> </span><<span class="o">(</span>gen-cmds<span class="w"> </span><span class="p">|</span><span class="w"> </span>qemu-system-i386<span class="o">)</span><span class="w"> </span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">改进版的 “抱大腿” 代码，不需二分查找</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">同时启动两个 NEMU (QEMU)</li>
<li class=" ml-8">在第一个输出不同时停止</li>
</ul>
<hr>
<p class=" font-serif my-1">(QEMU Monitor 展示)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>-serial mon:stdio</code> 启动 monitor!</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="nemu-differential-testing-contd" class=" text-xl mt-2 pb-2 font-sans">NEMU Differential Testing: 原理 (cont'd)</h2>
<p class=" font-serif my-1">问题分析：我们需要使 QEMU 像 NEMU 一样执行指令！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">QEMU 实现了 gdb 的协议</li>
<li class=" ml-8">协议格式同 monitor</li>
</ul>
<hr>
<p class=" font-serif my-1">qemu-diff 实现：</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">启动 QEMU 并配置它进入与 PA 类似的模式</li>
<li class=" ml-8">用 gdb 连接 QEMU</li>
<li class=" ml-8">用 <code>gdb_si()</code> 在 QEMU 中执行一条指令</li>
<li class=" ml-8">比较指令执行后寄存器是否有区别</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">代码导读</h2>
<p class=" font-serif my-1">首先 PA 代码 (<code>dut.c</code>) 里没有 diff-test 的实际代码，只有一堆函数指针：</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ref_difftest_memcpy_from_dut</span><span class="p">)(</span><span class="n">paddr_t</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ref_difftest_getregs</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ref_difftest_setregs</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ref_difftest_exec</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</code></pre></div>

<p class=" font-serif my-1">这些函数封装了参考实现的功能</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">既可以和 QEMU diff-test，也可以和 NEMU diff-test</li>
<li class=" ml-8"><code>exec_wrapper()</code> 中执行一条指令之后直接对比结果就行</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#if defined(DIFF_TEST)</span>
<span class="w">  </span><span class="n">difftest_step</span><span class="p">(</span><span class="n">ori_pc</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="cp">#endif</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">代码导读 (cont'd)</h2>
<p class=" font-serif my-1">经过 RTFM/RTFSC：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>nemu/tools/qemu-diff</code> 是 differential testing 实际实现的目录</li>
</ul>
<hr>
<p class=" font-serif my-1">然后 RTFSC，看到了若干有用的函数：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>gdb_connect_qemu</code>，看起来就是用来连接到 QEMU 的，创建一个到 127.0.0.1、端口是 1234 的 gdb 连接</li>
<li class=" ml-8"><code>gdb_si</code>，和 monitor 一样，单步执行指令</li>
<li class=" ml-8"><code>gdb_setregs</code>, <code>gdb_getregs</code>，好像复杂一点，不过就是用 <code>gdb_send()</code> 和 <code>gdb_recv()</code> 发送/接收消息</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">代码导读 (cont'd)</h2>
<p class=" font-serif my-1">Differential testing 的初始化</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们可以用 QEMU + gdb 调试<a href="../../../pages/ICS/2020/demos/mbr/index.html" class=" text-amber-900">这段代码</a>！<ul class=" list-disc font-serif">
<li class=" ml-8"><code>-s -S</code> 启动 QEMU; gdb <code>target remote localhost:1234</code></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mbr</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="mh">0xfa</span><span class="p">,</span><span class="w">                         </span><span class="c1">// cli</span>
<span class="w">  </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w">                   </span><span class="c1">// xorw   %ax,%ax</span>
<span class="w">  </span><span class="mh">0x8e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd8</span><span class="p">,</span><span class="w">                   </span><span class="c1">// movw   %ax,%ds</span>
<span class="w">  </span><span class="mh">0x8e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w">                   </span><span class="c1">// movw   %ax,%es</span>
<span class="w">  </span><span class="mh">0x8e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd0</span><span class="p">,</span><span class="w">                   </span><span class="c1">// movw   %ax,%ss</span>
<span class="w">  </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x44</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="c1">// lgdt   gdtdesc</span>
<span class="w">  </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w">             </span><span class="c1">// movl   %cr0,%eax</span>
<span class="w">  </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">       </span><span class="c1">// orl    $CR0_PE,%eax</span>
<span class="w">  </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x22</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w">             </span><span class="c1">// movl   %eax,%cr0</span>
<span class="w">  </span><span class="mh">0xea</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="c1">// ljmp   $GDT_ENTRY(1),$start32</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">系统编程的困难</h2>
<p class=" font-serif my-1">在程序规模到达一定程度的时候，代码既难管理，也难写对</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">即便在项目文件之间浏览就已经非常耗时<ul class=" list-disc font-serif">
<li class=" ml-8">面对不熟悉的模块/API</li>
<li class=" ml-8">需要好的 IDE、代码折叠、第二块屏幕……</li>
</ul>
</li>
<li class=" ml-8">编程经验可以减少 bug，但很难完全消灭它们<ul class=" list-disc font-serif">
<li class=" ml-8">各类肉眼难以发现的低级错误 (<code>i</code> vs. <code>j</code>, <code>0x</code> vs <code>0b</code>, <code>int</code> with <code>unsigned</code>, ...)</li>
<li class=" ml-8">读错了手册 (忘记更新某个 flags, 记错 0/符号扩展, ...)</li>
<li class=" ml-8">逻辑上的错误 (使用一块已经释放的内存, 虚拟/物理内存地址访问错, ...)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">做过 PA 的人就知道，“机器永远是对的”不是开玩笑的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">你折腾一天，两天，可能就是多打了一个空格</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基础设施：帮助你更快更好地生产代码</h2>
<p class=" font-serif my-1">终极梦想：让计算机自动帮我们写程序</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">告诉计算机需求 → 计算机输出正确的代码</li>
<li class=" ml-8">计算机科学的 holy grail 之一</li>
</ul>
<hr>
<p class=" font-serif my-1">现在我们还在软件自动化的初级阶段</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">计算机只能提供有限的自动化 (基础设施)<ul class=" list-disc font-serif">
<li class=" ml-8">集成开发环境 (IDE)</li>
<li class=" ml-8">静态分析</li>
<li class=" ml-8">动态分析</li>
</ul>
</li>
<li class=" ml-8">但这些基础设施已经从本质上改变了我们的开发效率<ul class=" list-disc font-serif">
<li class=" ml-8">你绝对不会愿意用记事本写程序的</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基础设施：小结</h2>
<p class=" font-serif my-1">当轮子都不够用的时候，我们就去造轮子</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">调试困难，有参考实现 → diff-test</li>
<li class=" ml-8">难以贯通多门实验课 → AbstractMachine</li>
</ul>
<hr>
<p class=" font-serif my-1">轮子还不够用呢？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">diff-test 每秒只能检查 ~5000 条指令</li>
<li class=" ml-8">中断和 I/O 具有不确定性</li>
<li class=" ml-8">没有参考实现呢 → 一个新的研究问题在等着你</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>