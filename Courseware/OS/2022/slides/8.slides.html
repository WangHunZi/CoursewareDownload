<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>并发 Bug 和应对</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">并发 Bug 和应对</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="overview" class=" text-xl mt-2 pb-2 font-sans">Overview</h2>
<p class=" font-serif my-1">复习</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并发编程的基本工具：线程库、互斥和同步</li>
<li class=" ml-8">并发编程的应用场景：高性能计算、数据中心、网页/移动应用</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: 并发编程那么难，我写出 bug 怎么办？</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课主要内容</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">应对 bug (和并发 bug) 的方法</li>
<li class=" ml-8">死锁和数据竞争</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">应对 Bug 的方法</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基本思路：否定你自己</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">虽然不太愿意承认，但<red>始终假设自己的代码是错的</red>。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">然后呢？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">做好测试</li>
<li class=" ml-8">检查哪里错了</li>
<li class=" ml-8">再检查哪里错了</li>
<li class=" ml-8">再再检查哪里错了<ul class=" list-disc font-serif">
<li class=" ml-8">(把任何你认为 “不对” 的情况都检查一遍)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bug" class=" text-xl mt-2 pb-2 font-sans">Bug 多的根本原因：编程语言的缺陷</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">软件是需求 (规约) 在计算机数字世界的投影。</p>
</blockquote>
<p class=" font-serif my-1">只管 “翻译” 代码，不管和实际需求 (规约) 是否匹配</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/alipay.c" class=" text-amber-900">alipay.c</a> 的例子<ul class=" list-disc font-serif">
<li class=" ml-8">变量 <code>balance</code> 代表 “余额”</li>
<li class=" ml-8">怎么看 withdraw 以后 0 → 18446744073709551516 都不对</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">三十年后的编程语言和编程方法？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Annotation verifier (<a href="https://dafny-lang.github.io/dafny/" class=" text-amber-900">Dafny</a>)</li>
<li class=" ml-8">Specification mining (<a href="http://plse.cs.washington.edu/daikon/" class=" text-amber-900">Daikon</a>)</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/113446.113468" class=" text-amber-900">Refinement types</a></li>
<li class=" ml-8"><a href="https://link.springer.com/article/10.1007/s10009-012-0249-7" class=" text-amber-900">Program sketching</a>……</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">更实在的方法：防御性编程</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">把程序需要满足的条件用 assert 表达出来。</p>
</blockquote>
<p class=" font-serif my-1">例子：<a href="../../../pages/OS/2022/demos/peterson-barrier.c" class=" text-amber-900">peterson-barrier.c</a>、二叉树的旋转</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/tree-rotate.jpg" width="700px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">防御性编程和规约给我们的启发</h2>
<p class=" font-serif my-1">你知道很多变量的<red>含义</red></p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define CHECK_INT(x, cond) \</span>
<span class="cp">  ({ panic_on(!((x) cond), "int check fail: " #x " " #cond); })</span>
<span class="cp">#define CHECK_HEAP(ptr) \</span>
<span class="cp">  ({ panic_on(!IN_RANGE((ptr), heap)); })</span>
</code></pre></div>

<p class=" font-serif my-1">变量有 “typed annotation”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>CHECK_INT(waitlist->count, >= 0);</code></li>
<li class=" ml-8"><code>CHECK_INT(pid, < MAX_PROCS);</code></li>
<li class=" ml-8"><code>CHECK_HEAP(ctx->rip); CHECK_HEAP(ctx->cr3);</code></li>
<li class=" ml-8">变量含义改变 → 发生奇怪问题 (overflow, memory error, ...)<ul class=" list-disc font-serif">
<li class=" ml-8"><red>不要小看这些检查</red>，它们在底层编程 (M2, L1, ...) 时非常常见</li>
<li class=" ml-8">在虚拟机神秘重启/卡住/...前发出警报</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug-deadlock" class=" text-2xl mt-2 font-sans">并发 Bug：死锁 (Deadlock)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="deadlock" class=" text-xl mt-2 pb-2 font-sans">死锁 (Deadlock)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
</blockquote>
<p class=" font-serif my-1">出现线程 “互相等待” 的情况</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/deadlock-car.jpg" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="aa-deadlock" class=" text-xl mt-2 pb-2 font-sans">AA-Deadlock</h2>
<p class=" font-serif my-1">假设你的 spinlock 不小心发生了中断</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在不该打开中断的时候开了中断</li>
<li class=" ml-8">在不该切换的时候执行了 <code>yield()</code></li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">os_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span><span class="w"> </span><span class="c1">// ---------+</span>
<span class="p">}</span><span class="w">                          </span><span class="c1">//    |</span>
<span class="w">                           </span><span class="c1">//    |</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">on_interrupt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">//    |</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span><span class="w">   </span><span class="c1">// <--+</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="abba-deadlock" class=" text-xl mt-2 pb-2 font-sans">ABBA-Deadlock</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">上锁的顺序很重要……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>swap</code> 本身看起来没有问题<ul class=" list-disc font-serif">
<li class=" ml-8"><code>swap(1, 2)</code>; <code>swap(2, 3)</code>, <code>swap(3, 1)</code> → 死锁</li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/philosopher.c" class=" text-amber-900">philosopher.c</a></li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">避免死锁</h2>
<p class=" font-serif my-1">死锁产生的四个必要条件 (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr." class=" text-amber-900">Edward G. Coffman</a>, 1971):</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">互斥：一个资源每次只能被一个进程使用</li>
<li class=" ml-8">请求与保持：一个进程请求资阻塞时，不释放已获得的资源</li>
<li class=" ml-8">不剥夺：进程已获得的资源不能强行剥夺</li>
<li class=" ml-8">循环等待：若干进程之间形成头尾相接的循环等待资源关系</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">“理解了死锁的原因，尤其是产生死锁的四个必要条件，就可以最大可能地避免、预防和解除死锁。所以，在系统设计、进程调度等方面注意如何不让这四个必要条件成立，如何确定资源的合理分配算法，避免进程永久占据系统资源。此外，也要防止进程在处于等待状态的情况下占用资源。因此，对资源的分配要给予合理的规划。”
——<red>Bullshit</red>.</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">避免死锁 (cont'd)</h2>
<p class=" font-serif my-1">AA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">AA 型的死锁容易检测，及早报告，及早修复</li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/spinlock-xv6.c" class=" text-amber-900">spinlock-xv6.c</a> 中的各种防御性编程<ul class=" list-disc font-serif">
<li class=" ml-8"><code>if (holding(lk)) panic();</code></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ABBA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">任意时刻系统中的锁都是有限的</li>
<li class=" ml-8">严格按照固定的顺序获得所有锁 (lock ordering; 消除 “循环等待”)<ul class=" list-disc font-serif">
<li class=" ml-8">遇事不决可视化：<a href="../../../pages/OS/2022/demos/lock-ordering.py" class=" text-amber-900">lock-ordering.py</a></li>
<li class=" ml-8">进而证明 $T_1: A\to B\to C; T_2: B \to C$ 是安全的<ul class=" list-disc font-serif">
<li class=" ml-8">“在任意时刻总是有获得 “最靠后” 锁的可以继续执行”</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lock-ordering-linux-kernel-rmapc" class=" text-xl mt-2 pb-2 font-sans">Lock Ordering: 应用 (Linux Kernel: rmap.c)</h2>
<p class=" font-serif my-1"><img alt="" src="../../../pages/OS/img/kernel-rmap.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="naive" class=" text-xl mt-2 pb-2 font-sans">但是……你又 Naive 了……</h2>
<p class=" font-serif my-1">Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. <red><em>Practice will tell you that this approach doesn't scale</em></red>: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p class=" font-serif my-1">The best locks are encapsulated: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.</p>
<p class=" font-serif my-1">—— <em><a href="https://www.kernel.org/doc/html/latest/kernel-hacking/locking.html" class=" text-amber-900">Unreliable Guide to Locking</a></em> by Rusty Russell</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们稍后回到这个问题，继续看更多的 bugs</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug-data-race" class=" text-2xl mt-2 font-sans">并发 Bug：数据竞争 (Data Race)</h1>
<p class=" font-serif my-1"><br></p>
<p class=" font-serif my-1">不上锁不就没有死锁了吗？</p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">数据竞争</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><red>不同的线程</red>同时访问<red>同一段内存</red>，且<red>至少有一个是写</red>。</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8">两个内存访问在 “赛跑”，“跑赢” 的操作先执行<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/peterson-barrier.c" class=" text-amber-900">peterson-barrier.c</a>: 内存访问都在赛跑<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.felixcloutier.com/x86/mfence" class=" text-amber-900">MFENCE</a>：<strike>如何留下最少的 fence，依然保证算法正确？</strike></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/race.jpg" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">数据竞争 (cont'd)</h2>
<p class=" font-serif my-1">Peterson 算法告诉大家：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><red>你们写不对无锁的并发程序</red></li>
<li class=" ml-8">所以事情反而简单了</li>
</ul>
<p class=" font-serif my-1"><br></p>
<h1 class="center text-2xl mt-2 font-sans">用互斥锁保护好共享数据</h1>

<p class=" font-serif my-1"><br></p>
<h1 class="center text-2xl mt-2 font-sans">消灭一切数据竞争</h1></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">数据竞争：例子</h2>
<p class=" font-serif my-1">以下代码概括了你们遇到数据竞争的大部分情况</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不要笑，你们的 bug 几乎都是这两种情况的变种</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// Case #1: 上错了锁</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lk1</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lk1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lk2</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lk2</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// Case #2: 忘记上锁</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lk1</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lk1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">更多类型的并发 Bug</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">程序员：花式犯错</h2>
<p class=" font-serif my-1">回顾我们实现并发控制的工具</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">互斥锁 (lock/unlock) - 原子性</li>
<li class=" ml-8">条件变量 (wait/signal) - 同步</li>
</ul>
<hr>
<p class=" font-serif my-1">忘记上锁——原子性违反 (Atomicity Violation, AV)</p>
<p class=" font-serif my-1">忘记同步——顺序违反 (Order Violation, OV)</p>
<hr>
<p class=" font-serif my-1">Empirical study: 在 105 个并发 bug 中 (non-deadlock/deadlock)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
<li class=" ml-8"><red>97% 的非死锁并发 bug 都是 AV 或 OV</red>。</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="av" class=" text-xl mt-2 pb-2 font-sans">原子性违反 (AV)</h2>
<p class=" font-serif my-1">“ABA”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我以为一段代码没啥事呢，但被人强势插入了</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/av-bug.png" width="900px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">原子性违反 (cont'd)</h2>
<p class=" font-serif my-1">有时候上锁也不解决问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“TOCTTOU” - time of check to time of use</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/tocttou.png" width="640px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf" class=" text-amber-900">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a> (FAST'05)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ov" class=" text-xl mt-2 pb-2 font-sans">顺序违反 (OV)</h2>
<p class=" font-serif my-1">“BA”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">怎么就没按我预想的顺序来呢？<ul class=" list-disc font-serif">
<li class=" ml-8">例子：concurrent use after free  </li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ov-bug.png" width="900px"></p></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">应对并发 Bug 的方法</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">完全一样的基本思路：否定你自己</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">还是得<red>始终假设自己的代码是错的</red>。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">然后呢？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">做好测试</li>
<li class=" ml-8">检查哪里错了</li>
<li class=" ml-8">再检查哪里错了</li>
<li class=" ml-8">再再检查哪里错了<ul class=" list-disc font-serif">
<li class=" ml-8">(把任何你认为 “不对” 的情况都检查一遍)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">例如：用 lock ordering 彻底避免死锁？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">你想多了：并发那么复杂，程序员哪能充分测试啊</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lockdep" class=" text-xl mt-2 pb-2 font-sans">Lockdep: 运行时的死锁检查</h2>
<p class=" font-serif my-1">Lockdep 规约 (Specification)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为每一个锁确定唯一的 “allocation site”<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/lock-site.c" class=" text-amber-900">lock-site.c</a></li>
<li class=" ml-8">assert: 同一个 allocation site 的锁存在全局唯一的上锁顺序</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1">检查方法：printf</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">记录所有观察到的上锁顺序，例如 $$[x, y, z] \Rightarrow x \to y, x \to z, y \to z$$</li>
<li class=" ml-8">检查是否存在 $x \rightsquigarrow y \land y \rightsquigarrow x$</li>
</ul>
<hr>
<p class=" font-serif my-1"><a href="../../OS_Lockdep.html" class=" text-amber-900">Lockdep 的实现</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Since Linux Kernel 2.6.17, also in <a href="https://gitee.com/openharmony" class=" text-amber-900">OpenHarmony</a>!</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="threadsanitizer" class=" text-xl mt-2 pb-2 font-sans">ThreadSanitizer: 运行时的数据竞争检查</h2>
<p class=" font-serif my-1">为所有事件建立 happens-before 关系图</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Program-order + release-acquire</li>
<li class=" ml-8">对于发生在不同线程且至少有一个是写的 $x,y$ 检查
  $$x \prec y \lor y \prec x$$<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/359545.359563" class=" text-amber-900">Time, clocks, and the ordering of events in a distributed system</a></li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">更多的检查：动态程序分析</h2>
<p class=" font-serif my-1">在事件发生时记录</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Lockdep: lock/unlock</li>
<li class=" ml-8">ThreadSanitizer: 内存访问 + lock/unlock</li>
</ul>
<hr>
<p class=" font-serif my-1">解析记录检查问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Lockdep: $x \rightsquigarrow y \land y \rightsquigarrow x$</li>
<li class=" ml-8">ThreadSanitizer: $x \not\prec y \land y \not\prec x$</li>
</ul>
<hr>
<p class=" font-serif my-1">付出的代价和权衡</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">程序执行变慢</li>
<li class=" ml-8">但更容易找到 bug (因此在测试环境中常用)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizers" class=" text-xl mt-2 pb-2 font-sans">动态分析工具：Sanitizers</h2>
<p class=" font-serif my-1">没用过 lint/sanitizers？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://clang.llvm.org/docs/AddressSanitizer.html" class=" text-amber-900">AddressSanitizer</a> (asan); <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany" class=" text-amber-900">(paper)</a>: 非法内存访问<ul class=" list-disc font-serif">
<li class=" ml-8">Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, ...</li>
<li class=" ml-8">Demo: <a href="../../../pages/OS/2022/demos/uaf.c" class=" text-amber-900">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html" class=" text-amber-900">kasan</a></li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">ThreadSanitizer</a> (tsan): 数据竞争<ul class=" list-disc font-serif">
<li class=" ml-8">Demo: <a href="../../../pages/OS/2022/demos/fish.c" class=" text-amber-900">fish.c</a>, <a href="../../../pages/OS/2022/demos/sum.c" class=" text-amber-900">sum.c</a>, <a href="../../../pages/OS/2022/demos/peterson-barrier.c" class=" text-amber-900">peterson-barrier.c</a>; <a href="https://github.com/google/ktsan" class=" text-amber-900">ktsan</a></li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/MemorySanitizer.html" class=" text-amber-900">MemorySanitizer</a> (msan): 未初始化的读取</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">UBSanitizer</a> (ubsan): undefined behavior<ul class=" list-disc font-serif">
<li class=" ml-8">Misaligned pointer, signed integer overflow, ...</li>
<li class=" ml-8">Kernel 会带着 <code>-fwrapv</code> 编译</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">这不就是防御性编程吗？</h1>
<p class=" font-serif my-1"><br></p>
<p class=" font-serif my-1">只不过不需要我亲自动手把代码改得乱七八糟了……</p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="buffer-overrun" class=" text-xl mt-2 pb-2 font-sans">我们也可以！Buffer Overrun 检查</h2>
<p class=" font-serif my-1">Canary (金丝雀) 对一氧化碳非常敏感</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">用生命预警矿井下的瓦斯泄露 (since 1911)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/canary_with_miner.jpg" width="400px"></p>
<p class=" font-serif my-1">计算机系统中的 canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“牺牲” 一些内存单元，来预警 memory error 的发生<ul class=" list-disc font-serif">
<li class=" ml-8">(程序运行时没有动物受到实质的伤害)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="canary-m2l2" class=" text-xl mt-2 pb-2 font-sans">Canary 的例子：保护栈空间 (M2/L2)</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define MAGIC 0x55555555</span>
<span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span><span class="w"> </span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"underflow"</span><span class="p">);</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"overflow"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">烫烫烫、屯屯屯和葺葺葺</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/GET.jpg" width="300px"></p>
<p class=" font-serif my-1">msvc 中 debug mode 的 guard/fence/canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">未初始化栈: <code>0xcccccccc</code></li>
<li class=" ml-8">未初始化堆: <code>0xcdcdcdcd</code></li>
<li class=" ml-8">对象头尾: <code>0xfdfdfdfd</code></li>
<li class=" ml-8">已回收内存: <code>0xdddddddd</code></li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\xcc</span><span class="s1">'</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'gb2312'</span><span class="p">)</span>
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">手持两把锟斤拷，口中疾呼烫烫烫</p>
<p class=" font-serif my-1">脚踏千朵屯屯屯，笑看万物锘锘锘</p>
<p class=" font-serif my-1">(它们一直在无形中保护你)</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lockdep" class=" text-xl mt-2 pb-2 font-sans">防御性编程：低配版 Lockdep</h2>
<p class=" font-serif my-1">不必大费周章记录什么上锁顺序</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">统计当前的 spin count<ul class=" list-disc font-serif">
<li class=" ml-8">如果超过某个明显不正常的数值 (1,000,000,000) 就报告</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">spin_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spin_cnt</span><span class="o">++</span><span class="w"> </span><span class="o">></span><span class="w"> </span><span class="n">SPIN_LIMIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Too many spin @ %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">配合调试器和线程 backtrace 一秒诊断死锁</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizer-l1" class=" text-xl mt-2 pb-2 font-sans">防御性编程：低配版 Sanitizer (L1)</h2>
<p class=" font-serif my-1">内存分配要求：已分配内存 $S = [\ell_0, r_0) \cup [\ell_1, r_1) \cup \ldots$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">kalloc($s$) 返回的 $[\ell, r)$ 必须满足 $[\ell, r) \cap S = \varnothing$<ul class=" list-disc font-serif">
<li class=" ml-8">thread-local allocation + 并发的 free 还蛮容易弄错的</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// allocation</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"double-allocation"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// free</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"double-free"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: 如何拯救人类不擅长的并发编程？</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away message</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">常见的并发 bug<ul class=" list-disc font-serif">
<li class=" ml-8">死锁、数据竞争、原子性/顺序违反</li>
</ul>
</li>
<li class=" ml-8">不要盲目相信自己：检查、检查、检查<ul class=" list-disc font-serif">
<li class=" ml-8">防御性编程：检查</li>
<li class=" ml-8">动态分析：打印 + 检查</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>