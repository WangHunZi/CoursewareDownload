<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // â€¢ auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // â€¢ rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>C æ ‡å‡†åº“çš„å®ç°</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="c" class=" text-2xl mt-2 font-sans">C æ ‡å‡†åº“çš„å®ç°</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">è’‹ç‚å²©</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">ã€€ã€€å—äº¬å¤§å­¦ã€€ã€€</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="overview" class=" text-xl mt-2 pb-2 font-sans">Overview</h2>
<p class=" font-serif my-1">å¤ä¹ </p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/sh-xv6.c" class=" text-amber-900">sh-xv6.c</a>: ä»…ä¾èµ–ç³»ç»Ÿè°ƒç”¨çš„ â€œæœ€å°â€ å‘½ä»¤è¡Œ Shell</li>
</ul>
<hr>
<p class=" font-serif my-1">æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: å¦‚ä½•åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸Šæ„å»ºç¨‹åºèƒ½å¤Ÿæ™®éå—æƒ çš„æ ‡å‡†åº“ï¼Ÿ</li>
</ul>
<hr>
<p class=" font-serif my-1">æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">C æ ‡å‡†åº“è®¾è®¡ä¸å®ç°</li>
<li class=" ml-8">åŸºäº libc çš„åº”ç”¨ç¨‹åº</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="libc" class=" text-2xl mt-2 font-sans">ç†Ÿæ‚‰åˆé™Œç”Ÿçš„ libc</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="libc" class=" text-xl mt-2 pb-2 font-sans">ä¸ºä»€ä¹ˆéœ€è¦ libc?</h2>
<p class=" font-serif my-1">â€œè£¸å¥”â€ ç¼–ç¨‹ï¼šèƒ½ç”¨ (è€Œä¸”ç»å¯¹å¤Ÿç”¨)ï¼Œä½†ä¸å¥½ç”¨</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">syscall</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">va_list</span><span class="w"> </span><span class="n">ap</span><span class="p">;</span>
<span class="w">  </span><span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"rax"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"rdi"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"rsi"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"rdx"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a4</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"r10"</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">  </span><span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="w">  </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">"syscall"</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">"+r"</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">a2</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">a3</span><span class="p">),</span><span class="w"> </span><span class="s">"r"</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">"memory"</span><span class="p">,</span><span class="w"> </span><span class="s">"rcx"</span><span class="p">,</span><span class="w"> </span><span class="s">"r8"</span><span class="p">,</span><span class="w"> </span><span class="s">"r9"</span><span class="p">,</span><span class="w"> </span><span class="s">"r11"</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">ä»»ä½•ç¨‹åºéƒ½ç”¨å¾—ä¸Šçš„å®šä¹‰</h2>
<p class=" font-serif my-1"><a href="https://en.cppreference.com/w/cpp/freestanding" class=" text-amber-900">Freestanding ç¯å¢ƒ</a>ä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨çš„å®šä¹‰</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cstddef/" class=" text-amber-900">stddef.h</a> - <code>size_t</code></li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cstdint/" class=" text-amber-900">stdint.h</a> - <code>int32_t</code>, <code>uint64_t</code></li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cstdbool/" class=" text-amber-900">stdbool.h</a> - <code>bool</code>, <code>true</code>, <code>false</code></li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cfloat/" class=" text-amber-900">float.h</a></li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/climits/" class=" text-amber-900">limits.h</a></li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cstdarg/" class=" text-amber-900">stdarg.h</a><ul class=" list-disc font-serif">
<li class=" ml-8">syscall å°±ç”¨åˆ°äº† (ä½† syscall0, syscall1, ... æ›´é«˜æ•ˆ)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cinttypes/" class=" text-amber-900">inttypes.h</a><ul class=" list-disc font-serif">
<li class=" ml-8">å›ç­”äº†ä½ å¤šå¹´æ¥çš„ç–‘é—®ï¼</li>
<li class=" ml-8">åœ¨ä½ è¯»è¿‡äº†å°ç™½é˜¶æ®µä»¥åï¼Œå°±çœŸçš„æ˜¯ friendly manual äº†</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">ç„¶åï¼Œç³»ç»Ÿè°ƒç”¨ä¹Ÿè¦ç”¨å¾—æ–¹ä¾¿ï¼</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">ç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿ â€œç´§å‡‘â€ çš„æœ€å°æ¥å£ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½åƒ fork ä¸€æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p>
</blockquote>
<p class=" font-serif my-1">ä½æƒ…å•† APIï¼š</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">environ</span><span class="p">;</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">"echo"</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">};</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">execve</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">environ</span><span class="p">)</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">perror</span><span class="p">(</span><span class="s">"exec"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">é«˜æƒ…å•† APIï¼š</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">execlp</span><span class="p">(</span><span class="s">"echo"</span><span class="p">,</span><span class="w"> </span><span class="s">"echo"</span><span class="p">,</span><span class="w"> </span><span class="s">"hello"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">system</span><span class="p">(</span><span class="s">"echo hello world"</span><span class="p">);</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="1" class=" text-2xl mt-2 font-sans">å°è£… (1): çº¯ç²¹çš„è®¡ç®—</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="stringh" class=" text-xl mt-2 pb-2 font-sans"><a href="https://www.cplusplus.com/reference/cstring/" class=" text-amber-900">string.h</a>: å­—ç¬¦ä¸²/æ•°ç»„æ“ä½œ</h2>
<p class=" font-serif my-1">ç®€å•ï¼Œä¸ç®€å•</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">memset</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">è®©æˆ‘ä»¬çœ‹çœ‹ clang æŠŠå®ƒç¼–è¯‘æˆäº†ä»€ä¹ˆâ€¦â€¦ </p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä»¥åŠï¼Œçº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ<a href="../../../pages/OS/2022/demos/memset-race.c" class=" text-amber-900">memset-race.c</a></li>
<li class=" ml-8"><red>æ ‡å‡†åº“åªå¯¹ â€œæ ‡å‡†åº“å†…éƒ¨æ•°æ®â€ çš„çº¿ç¨‹å®‰å…¨æ€§è´Ÿè´£</red><ul class=" list-disc font-serif">
<li class=" ml-8">ä¾‹å­ï¼šprintf çš„ buffer</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æ’åºå’ŒæŸ¥æ‰¾</h2>
<p class=" font-serif my-1">ä½æƒ…å•† (ä½é…ç½®) API</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">qsort</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nmemb</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">           </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compar</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">bsearch</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span>
<span class="w">              </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nmemb</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">              </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compar</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">é«˜æƒ…å•† API</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">sort</span><span class="p">(</span><span class="n">xs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">xs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">auto</span><span class="o">&</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{...});</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">xs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">key</span><span class="o">=...</span><span class="p">)</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æ›´å¤šçš„ä¾‹å­</h2>
<p class=" font-serif my-1">RTFM!</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ›´å¤šçš„ <a href="https://www.cplusplus.com/reference/cstdlib/" class=" text-amber-900">stdlib.h</a> ä¸­çš„ä¾‹å­<ul class=" list-disc font-serif">
<li class=" ml-8">atoi, atol, atoll, strtoull, ...</li>
<li class=" ml-8">rand (æ³¨æ„çº¿ç¨‹å®‰å…¨), ...</li>
</ul>
</li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/csetjmp/" class=" text-amber-900">setjmp.h</a><ul class=" list-disc font-serif">
<li class=" ml-8">ä½“ä¼šåˆ°æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡çš„è‰¯è‹¦ç”¨å¿ƒï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸€æ¬¡æ‰é˜Ÿï¼Œç»ˆèº«æ‰é˜Ÿ ğŸ˜‚</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8"><a href="https://www.cplusplus.com/reference/cmath/" class=" text-amber-900">math.h</a><ul class=" list-disc font-serif">
<li class=" ml-8">è¿™ç©æ„å¤æ‚äº†; ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ç›´æ¥æ‘†çƒ‚<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/2737924.2737959" class=" text-amber-900">Automatically improving accuracy for floating point expressions</a> (PLDI'15, Distinguished Paper ğŸ…)</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="2" class=" text-2xl mt-2 font-sans">å°è£… (2): æ–‡ä»¶æè¿°ç¬¦</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="stdioh" class=" text-xl mt-2 pb-2 font-sans"><a href="https://www.cplusplus.com/reference/cstdio/" class=" text-amber-900">stdio.h</a>: ä½ ç†Ÿæ‚‰çš„å‘³é“</h2>
<p class=" font-serif my-1"><code>FILE *</code> èƒŒåå…¶å®æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æˆ‘ä»¬å¯ä»¥ç”¨ gdb æŸ¥çœ‹å…·ä½“çš„ <code>FILE *</code> (ä¾‹å¦‚ stdout)<ul class=" list-disc font-serif">
<li class=" ml-8">å¯ä»¥ â€œçª¥æ¢â€ åˆ° glibc çš„ä¸€äº›å†…éƒ¨å®ç°</li>
<li class=" ml-8">å¯ä»¥åŠ è½½ glibc çš„ debug symbols<ul class=" list-disc font-serif">
<li class=" ml-8">åœ¨è¿™é—¨è¯¾ä¸Šä¸æ¨èï¼šä½ è°ƒè¯•èµ·æ¥ä¼šå¾ˆæµªè´¹æ—¶é—´</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">å°è£…äº†æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ (fseek, fgetpos, ftell, feof, ...)</li>
</ul>
<hr>
<p class=" font-serif my-1">vprintf ç³»åˆ—</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä½¿ç”¨äº† <code>stdarg.h</code> çš„å‚æ•°åˆ—è¡¨</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">vfprintf</span><span class="p">(</span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="kt">va_list</span><span class="w"> </span><span class="n">ap</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">vasprintf</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="kt">va_list</span><span class="w"> </span><span class="n">ap</span><span class="p">);</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="popen-pclose" class=" text-xl mt-2 pb-2 font-sans">popen å’Œ pclose</h2>
<p class=" font-serif my-1">æˆ‘ä»¬åœ¨ <a href="../../../pages/OS/2022/demos/dosbox-hack.c" class=" text-amber-900">dosbox-hack.c</a> ä¸­ä½¿ç”¨äº†å®ƒ</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸€ä¸ªè®¾è®¡æœ‰ç¼ºé™·çš„ API<ul class=" list-disc font-serif">
<li class=" ml-8">Since a pipe is by definition unidirectional, the type argument may specify only reading or writing, <em>not both</em>; the resulting stream is correspondingly read-only or write-only.</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">é«˜æƒ…å•† API (ç°ä»£ç¼–ç¨‹è¯­è¨€)</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">'cat'</span><span class="p">],</span>
  <span class="nb">input</span><span class="o">=</span><span class="sa">b</span><span class="s1">'Hello World'</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">dir_checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Exec</span>::<span class="n">shell</span><span class="p">(</span><span class="s">"find . -type f"</span><span class="p">)</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Exec</span>::<span class="n">cmd</span><span class="p">(</span><span class="s">"sort"</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Exec</span>::<span class="n">cmd</span><span class="p">(</span><span class="s">"sha1sum"</span><span class="p">)</span>
<span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">();</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="3" class=" text-2xl mt-2 font-sans">å°è£… (3): æ›´å¤šçš„è¿›ç¨‹/æ“ä½œç³»ç»ŸåŠŸèƒ½</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="err-error-perror" class=" text-xl mt-2 pb-2 font-sans">err, error, perror</h2>
<p class=" font-serif my-1">æ‰€æœ‰ API éƒ½å¯èƒ½å¤±è´¥</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ gcc nonexist.c
gcc: error: nonexist.c: No such file or directory
</code></pre></div>

<hr>
<p class=" font-serif my-1">è¿™ä¸ª â€œNo such file or directoryâ€ ä¼¼ä¹è§å¾—æœ‰ç‚¹å¤šï¼Ÿ</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>cat nonexist.c, wc nonexist.c</code> éƒ½æ˜¯åŒæ ·çš„ error message</li>
<li class=" ml-8">è¿™ä¸æ˜¯å·§åˆï¼<ul class=" list-disc font-serif">
<li class=" ml-8">æˆ‘ä»¬ä¹Ÿå¯ä»¥ â€œå±±å¯¨â€ å‡ºåŒæ ·çš„æ•ˆæœ</li>
<li class=" ml-8"><code>warn("%s", fname);</code> (è§‚å¯Ÿ strace)<ul class=" list-disc font-serif">
<li class=" ml-8"><code>err</code> å¯ä»¥é¢å¤–é€€å‡ºç¨‹åº</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">errno æ˜¯è¿›ç¨‹å…±äº«è¿˜æ˜¯çº¿ç¨‹ç‹¬äº«ï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">è¿™ä¸‹çŸ¥é“åç¨‹çš„è½»é‡äº†å§</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="environ-7" class=" text-xl mt-2 pb-2 font-sans">environ (7)</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/GET.jpg" width="400px"></p>
<p class=" font-serif my-1">æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„ <a href="../../../pages/OS/2022/demos/env.c" class=" text-amber-900">env.c</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">é—®é¢˜æ¥äº†ï¼šenviron æ˜¯è°èµ‹å€¼çš„ï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">è¿™ä¸ªå‡½æ•°åˆæ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„ï¼Ÿ</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">RTFM å</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¯¹ç¯å¢ƒå˜é‡çš„ç†è§£åˆä¸Šå‡äº†</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="4" class=" text-2xl mt-2 font-sans">å°è£… (4): åœ°å€ç©ºé—´</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="malloc-free" class=" text-xl mt-2 pb-2 font-sans">malloc å’Œ free</h2>
<p class=" font-serif my-1">Specification å¾ˆç®€å• (åŒ <a href="../Labs/L1.html" class=" text-amber-900">Lab1</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">åœ¨å¤§åŒºé—´ $[L, R)$ ä¸­ç»´æŠ¤äº’ä¸ç›¸äº¤çš„åŒºé—´çš„é›†åˆ</li>
</ul>
<p class=" font-serif my-1">$$ M = \big\{ [\ell_0, r_0), [\ell_1, r_1), \ldots, [\ell_n, r_n) \big\}$$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">malloc($s$) - è¿”å›ä¸€æ®µå¤§å°ä¸º $s$ çš„åŒºé—´<ul class=" list-disc font-serif">
<li class=" ml-8">å¿…è¦æ—¶å¯ä»¥å‘æ“ä½œç³»ç»Ÿç”³è¯·é¢å¤–çš„ $[L, R)$ (è§‚å¯Ÿ strace)</li>
<li class=" ml-8">å…è®¸åœ¨å†…å­˜ä¸è¶³æ—¶ â€œæ‹’ç»â€ è¯·æ±‚</li>
</ul>
</li>
<li class=" ml-8">free($\ell, r$) - ç»™å®š $\ell$ï¼Œåˆ é™¤ $[\ell, r) \in M$<ul class=" list-disc font-serif">
<li class=" ml-8">æ˜¯å¦æƒ³èµ·äº†ã€Šç®—æ³•å¯¼è®ºã€‹ï¼Ÿ</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">å¤šçº¿ç¨‹å®‰å…¨</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Scalability å°±æ˜¯ä¸ªå¾ˆå¤§çš„é—®é¢˜äº†</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="mallocfree" class=" text-xl mt-2 pb-2 font-sans">å®ç°é«˜æ•ˆçš„ malloc/free</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">Premature optimization is the root of all evil.</p>
<p class=" font-serif my-1">â€”â€”D. E. Knuth</p>
</blockquote>
<p class=" font-serif my-1">é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼š</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><red>è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“</red></li>
<li class=" ml-8"><red>è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“</red></li>
<li class=" ml-8"><red>è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“</red><ul class=" list-disc font-serif">
<li class=" ml-8">åœ¨å¼€å§‹è€ƒè™‘æ€§èƒ½ä¹‹å‰ï¼Œç†è§£ä½ éœ€è¦è€ƒè™‘ä»€ä¹ˆæ ·çš„æ€§èƒ½</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ç„¶åï¼Œå»å“ªé‡Œæ‰¾ workload?</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å½“ç„¶æ˜¯ paper äº† (é¡ºä¾¿ç™½å¾—ä¸€ä¸ªæ–¹æ¡ˆ)<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.microsoft.com/en-us/research/uploads/prod/2019/06/mimalloc-tr-v1.pdf" class=" text-amber-900">Mimalloc: free list sharding in action</a> (APLAS'19)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload" class=" text-xl mt-2 pb-2 font-sans">Workload åˆ†æ</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">æŒ‡å¯¼æ€æƒ³ï¼š$O(n)$ å¤§å°çš„å¯¹è±¡åˆ†é…åè‡³å°‘æœ‰ $\Omega(n)$ çš„è¯»å†™æ“ä½œï¼Œå¦åˆ™å°±æ˜¯ performance bug (ä¸åº”è¯¥åˆ†é…é‚£ä¹ˆå¤š)ã€‚</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8">è¶Šå°çš„å¯¹è±¡åˆ›å»º/åˆ†é…è¶Šé¢‘ç¹<ul class=" list-disc font-serif">
<li class=" ml-8">å­—ç¬¦ä¸²ã€ä¸´æ—¶å¯¹è±¡ç­‰ (å‡ ååˆ°å‡ ç™¾å­—èŠ‚)ï¼›ç”Ÿå­˜å‘¨æœŸå¯é•¿å¯çŸ­ </li>
</ul>
</li>
<li class=" ml-8">è¾ƒä¸ºé¢‘ç¹åœ°åˆ†é…ä¸­ç­‰å¤§å°çš„å¯¹è±¡<ul class=" list-disc font-serif">
<li class=" ml-8">è¾ƒå¤§çš„æ•°ç»„ã€å¤æ‚çš„å¯¹è±¡ï¼›æ›´é•¿çš„ç”Ÿå­˜å‘¨æœŸ</li>
</ul>
</li>
<li class=" ml-8">ä½é¢‘ç‡çš„å¤§å¯¹è±¡<ul class=" list-disc font-serif">
<li class=" ml-8">å·¨å¤§çš„å®¹å™¨ã€åˆ†é…å™¨ï¼›å¾ˆé•¿çš„ç”Ÿå­˜å‘¨æœŸ</li>
</ul>
</li>
<li class=" ml-8"><red>å¹¶è¡Œã€å¹¶è¡Œã€å†å¹¶è¡Œ</red><ul class=" list-disc font-serif">
<li class=" ml-8">æ‰€æœ‰åˆ†é…éƒ½ä¼šåœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šå‘ç”Ÿ</li>
<li class=" ml-8">ä½¿ç”¨é“¾è¡¨/åŒºé—´æ ‘ (first fit) å¯ä¸æ˜¯ä¸ªå¥½æƒ³æ³•</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="malloc-fast-and-slow" class=" text-xl mt-2 pb-2 font-sans"><code>malloc</code>, Fast and Slow</h2>
<p class=" font-serif my-1">è®¾ç½®ä¸¤å¥—ç³»ç»Ÿï¼š</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">fast path<ul class=" list-disc font-serif">
<li class=" ml-8">æ€§èƒ½æå¥½ã€å¹¶è¡Œåº¦æé«˜ã€è¦†ç›–å¤§éƒ¨åˆ†æƒ…å†µ</li>
<li class=" ml-8">ä½†æœ‰å°æ¦‚ç‡ä¼šå¤±è´¥ (fall back to slow path)</li>
</ul>
</li>
<li class=" ml-8">slow path<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸åœ¨ä¹é‚£ä¹ˆå¿«</li>
<li class=" ml-8">ä½†æŠŠå›°éš¾çš„äº‹æƒ…åšå¥½<ul class=" list-disc font-serif">
<li class=" ml-8">è®¡ç®—æœºç³»ç»Ÿé‡Œæœ‰å¾ˆå¤šè¿™æ ·çš„ä¾‹å­ (æ¯”å¦‚ cache)</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">äººç±»ä¹Ÿæ˜¯è¿™æ ·çš„ç³»ç»Ÿ</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Daniel Kahneman. <em>Thinking, Fast and Slow</em>. Farrar, Straus and Giroux, 2011.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="malloc-fast-path" class=" text-xl mt-2 pb-2 font-sans"><code>malloc</code>: Fast Path è®¾è®¡</h2>
<p class=" font-serif my-1"><red>ä½¿æ‰€æœ‰ CPU éƒ½èƒ½å¹¶è¡Œåœ°ç”³è¯·å†…å­˜</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">çº¿ç¨‹éƒ½äº‹å…ˆç“œåˆ†ä¸€äº› â€œé¢†åœ°â€ (thread-local allocation buffer)</li>
<li class=" ml-8">é»˜è®¤ä»è‡ªå·±çš„é¢†åœ°é‡Œåˆ†é…<ul class=" list-disc font-serif">
<li class=" ml-8">é™¤äº†åœ¨å¦ä¸€ä¸ª CPU é‡Šæ”¾ï¼Œacquire lock å‡ ä¹æ€»æ˜¯æˆåŠŸ</li>
</ul>
</li>
<li class=" ml-8">å¦‚æœè‡ªå·±çš„é¢†åœ°ä¸è¶³ï¼Œå°±ä»å…¨å±€çš„æ± å­é‡Œå€Ÿä¸€ç‚¹</li>
</ul>
<hr>
<p class=" font-serif my-1">ä¸è¦åœ¨ä¹ä¸€ç‚¹å°çš„æµªè´¹</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦å¯¹é½åˆ° $2^k$ å­—èŠ‚</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="segregated-list" class=" text-xl mt-2 pb-2 font-sans">å°å†…å­˜ï¼šSegregated List</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/slabs.jpg" width="400px"></p>
<p class=" font-serif my-1">åˆ†é…: Segregated List (Slab)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ¯ä¸ª slab é‡Œçš„æ¯ä¸ªå¯¹è±¡éƒ½ä¸€æ ·å¤§<ul class=" list-disc font-serif">
<li class=" ml-8">æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰æ¯ä¸ªå¯¹è±¡å¤§å°çš„ slab</li>
<li class=" ml-8">fast path â†’ ç«‹å³åœ¨çº¿ç¨‹æœ¬åœ°åˆ†é…å®Œæˆ</li>
<li class=" ml-8">slow path â†’ pgalloc()</li>
</ul>
</li>
<li class=" ml-8">ä¸¤ç§å®ç°<ul class=" list-disc font-serif">
<li class=" ml-8">å…¨å±€å¤§é“¾è¡¨ v.s. List sharding (per-page å°é“¾è¡¨)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/race.jpg" width="240px"></p>
<p class=" font-serif my-1">å›æ”¶</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ç›´æ¥å½’è¿˜åˆ° slab ä¸­<ul class=" list-disc font-serif">
<li class=" ml-8">æ³¨æ„è¿™å¯èƒ½æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„ slabï¼Œéœ€è¦ per-slab é” (å°å¿ƒæ•°æ®ç«äº‰)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">å¤§å†…å­˜ï¼šä¸€æŠŠå¤§é”ä¿å¹³å®‰</h2>
<p class=" font-serif my-1">Buddy system (1963)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¦‚æœä½ æƒ³åˆ†é… 1, 2, 3, 4, ... $n$ ä¸ªè¿ç»­çš„é¡µé¢ï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">ä¾‹å¦‚ï¼š64 KB/é¡µé¢</li>
</ul>
</li>
<li class=" ml-8">é‚£å°± first fit æˆ–è€… best fit å§â€¦â€¦</li>
</ul>
<hr>
<p class=" font-serif my-1">ä½ åªéœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„è§£å†³é—®é¢˜</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">åŒºé—´æ ‘ï¼›çº¿æ®µæ ‘â€¦â€¦</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="mallocfree" class=" text-xl mt-2 pb-2 font-sans">ç°å®ä¸–ç•Œä¸­çš„ malloc/free</h2>
<p class=" font-serif my-1">ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰ç°ä»£ malloc/free å®ç°çš„åŸºç¡€</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å½“ç„¶ï¼Œå®é™…æƒ…å†µä¼šå¤æ‚ä¸€äº›ï¼Œæ€§èƒ½ä¹Ÿæ˜¯é”±é“¢å¿…è¾ƒ<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://sourceware.org/glibc/wiki/MallocInternals" class=" text-amber-900">glibc</a>: arena â†’ heap â†’ tcache (thread-local)</li>
<li class=" ml-8"><a href="https://google.github.io/tcmalloc/design.html" class=" text-amber-900">tcmalloc</a>: thread-caching malloc, <a href="https://github.com/microsoft/mimalloc" class=" text-amber-900">mimalloc</a>
    <img alt="" class="center" src="../../../pages/OS/img/tcmalloc.png" width="640px"></li>
<li class=" ml-8"><a href="https://wiki.openjdk.java.net/display/zgc/Main" class=" text-amber-900">OpenJDK: ZGC</a>: region based + tlab (thread-local)<ul class=" list-disc font-serif">
<li class=" ml-8">managed memory å…è®¸ object moveï¼Œå› æ­¤å¤æ‚å¾—å¤šâ€¦â€¦</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">æ— æ­¢å¢ƒåœ°å°è£…</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æƒ³çŸ¥é“æœ‰æ²¡æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Ÿ</h2>
<p class=" font-serif my-1">RTFM: <a href="https://www.gnu.org/software/libc/manual/" class=" text-amber-900">The GNU C Library</a>, RTFSC: <a href="https://sourceware.org/newlib/" class=" text-amber-900">Newlib</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">éƒ½ä¸å¤ªé•¿ (glibc çš„æ‰‹å†Œå’Œ newlib çš„æºç ) ä¹Ÿå¥½è¯»</li>
<li class=" ml-8">Computer System ç³»åˆ—è¯¾ç¨‹çš„é‡è¦ç›®æ ‡ï¼šæ‘†æ­£çœ‹æ‰‹å†Œçš„å¿ƒæ€</li>
</ul>
<hr>
<p class=" font-serif my-1">ä½ ä¼šå‘ç°å¾ˆå¤šå®è—</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Globbing</li>
<li class=" ml-8">Regex</li>
<li class=" ml-8">Shell-style word expansion</li>
<li class=" ml-8">â€¦â€¦</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æˆ‘ä»¬è¿˜å¯ä»¥â€¦â€¦</h2>
<p class=" font-serif my-1">èµ°å‡º C çš„é¢†åŸŸï¼ŒåŸºäº libc å®ç°</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">C++ ç¼–è¯‘å™¨<ul class=" list-disc font-serif">
<li class=" ml-8">ç»§ç»­å®ç° C++ Standard Library</li>
<li class=" ml-8">ç»§ç»­å®ç° <a href="https://openjdk.java.net/groups/hotspot/" class=" text-amber-900">OpenJDK (HotSpot)</a></li>
<li class=" ml-8">ç»§ç»­å®ç° <a href="https://v8.dev" class=" text-amber-900">V8</a> (JavaScript)</li>
</ul>
</li>
<li class=" ml-8">CPython</li>
<li class=" ml-8">Go<ul class=" list-disc font-serif">
<li class=" ml-8">å†ä¹‹å Go å°±å¯ä»¥è‡ªå·±ç¼–è¯‘è‡ªå·±äº† (Goodbye, C!)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">Eventually, (åƒç–®ç™¾å­”) çš„æ•´ä¸ªè®¡ç®—æœºä¸–ç•Œï¼</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/pdf/10.1145/3209212" class=" text-amber-900">C is not a low-level language</a> (CACM'18)</li>
<li class=" ml-8"><a href="https://gankra.github.io/blah/c-isnt-a-language/" class=" text-amber-900">C isn't a programming language any more</a> (Gankra's Blog)</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">æ€»ç»“</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æ€»ç»“</h2>
<p class=" font-serif my-1">æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: å¦‚ä½•åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸Šæ„å»ºç¨‹åºèƒ½å¤Ÿæ™®éå—æƒ çš„æ ‡å‡†åº“ï¼Ÿ</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">libc<ul class=" list-disc font-serif">
<li class=" ml-8">RTFM; RTFSC: å……æ»¡äº†å®è—</li>
<li class=" ml-8">æ€§èƒ½ä¼˜åŒ–ä¸­çš„ fast/slow path</li>
</ul>
</li>
<li class=" ml-8">ç„¶åï¼Œä½ æ‹¥æœ‰äº†æ•´ä¸ªä¸–ç•Œï¼</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>4 æœˆ 2 æ—¥ (å‘¨å…­) çº¿ä¸Šæµ‹éªŒ</red></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>