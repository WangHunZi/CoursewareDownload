<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>持久数据的可靠性</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">持久数据的可靠性</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="overview" class=" text-xl mt-2 pb-2 font-sans">Overview</h2>
<p class=" font-serif my-1">复习</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统实现：bread/bwrite 上的数据结构<ul class=" list-disc font-serif">
<li class=" ml-8">balloc/bfree</li>
<li class=" ml-8">文件：FAT (链表)/UNIX 文件系统 (索引)</li>
<li class=" ml-8">目录文件</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">数据结构的另一个假设：<red>内存可靠且可以接受断电数据丢失</red></li>
<li class=" ml-8"><strong>Q</strong>: 持久数据是不能接受丢失的，如何保证持久数据的可靠性？</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课主要内容</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RAID (Redundant Array of Inexpensive Disks)</li>
<li class=" ml-8">崩溃一致性</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="redundant-array-of-inexpensive-disks-raid" class=" text-2xl mt-2 font-sans">Redundant Array of Inexpensive Disks (RAID)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1" class=" text-xl mt-2 pb-2 font-sans">日渐增长的持久存储需求 (1)——性能</h2>
<p class=" font-serif my-1">存储：只要 CPU (DMA) 能处理得过来，我就能提供足够的带宽！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Computer System 的 “industry” 传统——做真实有用的系统</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/emc-vnx5300.jpg" width="480px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2" class=" text-xl mt-2 pb-2 font-sans">日渐增长的持久存储需求 (2)——可靠性</h2>
<p class=" font-serif my-1">任何物理存储介质都有失效的可能</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">你依然希望在存储设备失效的时候能保持数据的完整<ul class=" list-disc font-serif">
<li class=" ml-8">极小概率事件：战争爆发/三体人进攻地球/世界毁灭 😂</li>
<li class=" ml-8">小概率事件：硬盘损坏<ul class=" list-disc font-serif">
<li class=" ml-8">大量重复 = 必然发生 (但我们还是希望系统能照常运转)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/datacenter.jpg" width="700px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid" class=" text-xl mt-2 pb-2 font-sans">RAID: 存储设备的虚拟化</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">那么，性能和可靠性，我们能不能全都要呢？</p>
</blockquote>
<p class=" font-serif my-1">Redundant Array of Inexpensive (<em>Independent</em>) Disks (RAID)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">把多个 (不可靠的) 磁盘虚拟成一块<red>非常可靠且性能极高</red>的虚拟磁盘<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/971701.50214" class=" text-amber-900">A case for redundant arrays of inexpensive disks (RAID)</a> (SIGMOD'88)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">RAID 是一个 “反向” 的虚拟化</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">进程：把一个 CPU 分时虚拟成多个虚拟 CPU</li>
<li class=" ml-8">虚存：把一份内存通过 MMU 虚拟成多个地址空间</li>
<li class=" ml-8">文件：把一个存储设备虚拟成多个虚拟磁盘</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-fault-model-fail-stop" class=" text-xl mt-2 pb-2 font-sans">RAID 的 Fault Model: Fail-Stop</h2>
<p class=" font-serif my-1">磁盘可能在某个时刻忽然彻底无法访问</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">机械故障、芯片故障……<ul class=" list-disc font-serif">
<li class=" ml-8">磁盘好像就 “忽然消失” 了 (数据完全丢失)</li>
<li class=" ml-8">假设磁盘能报告这个问题 (如何报告？)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://www.usenix.org/conference/fast-08/analysis-data-corruption-storage-stack" class=" text-amber-900">An analysis of data corruption in the storage stack</a> (FAST'08)</li>
</ul>
<hr>
<p class=" font-serif my-1">在那个遍地是黄金的年代</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">1988: 凑几块盘，掀翻整个产业链！<ul class=" list-disc font-serif">
<li class=" ml-8">“Single Large Expensive Disks” (IBM 3380), v.s.</li>
<li class=" ml-8">“Redundant Array of Inexpensive Disks”</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">一个最简单的想法</h2>
<p class=" font-serif my-1">在系统里多接入一块硬盘用于 Fault Tolerance (RAID-1)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">假设有两块盘 $A$, $B$<ul class=" list-disc font-serif">
<li class=" ml-8">同样规格，共有 $n$ 块</li>
</ul>
</li>
<li class=" ml-8">“镜像” 虚拟磁盘 $V$<ul class=" list-disc font-serif">
<li class=" ml-8">$V_i \to \{ A_i, B_i \}$ ($1 \le i \le n$)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">块读写</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">bread($i$)<ul class=" list-disc font-serif">
<li class=" ml-8">可以从 $A$ 或 $B$ 中的任意一个读取</li>
</ul>
</li>
<li class=" ml-8">bwrite($i$)<ul class=" list-disc font-serif">
<li class=" ml-8">同时将同样的数据写入 $A$, $B$ 的同一位置  </li>
</ul>
</li>
<li class=" ml-8">容错，且读速度翻倍 (假设内存远快于磁盘)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">RAID (虚拟化) = 虚拟磁盘块到物理磁盘块的 “映射”。</p>
</blockquote>
<p class=" font-serif my-1">两块磁盘的其他拼接方法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">顺序拼接<ul class=" list-disc font-serif">
<li class=" ml-8">$V_1 \to A_1$, $V_2 \to A_2$, $\ldots$, $V_{n} \to A_{n}$</li>
<li class=" ml-8">$V_{n+1} \to B_1$, $V_{n+2} \to B_2$, $\ldots$, $V_{2n} \to B_{n}$</li>
</ul>
</li>
<li class=" ml-8">交错排列 (RAID-0)<ul class=" list-disc font-serif">
<li class=" ml-8">$V_1 \to A_1$, $V_2 \to B_1$</li>
<li class=" ml-8">$V_3 \to A_2$, $V_4 \to B_2$</li>
<li class=" ml-8">$V_{2i-1} \to A_{i}$, $V_{2i} \to B_i$</li>
</ul>
</li>
<li class=" ml-8">虽然不能容错，但可以利用好磁盘的带宽</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space-contd" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space (cont'd)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">RAID: 允许 “多对多” 的映射 (一组映射称为 “条带”, stripe)</p>
</blockquote>
<p class=" font-serif my-1">RAID-10 = RAID-0 over RAID-1</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$A, B$ 组成 RAID-1 $X$ (容错)<ul class=" list-disc font-serif">
<li class=" ml-8">$X_1 \to \{ A_1, B_1 \}$</li>
<li class=" ml-8">$X_2 \to \{ A_2, B_2 \}$</li>
</ul>
</li>
<li class=" ml-8">$C, D$ 组成 RAID-1 $Y$ (容错)<ul class=" list-disc font-serif">
<li class=" ml-8">$Y_1 \to \{ C_1, D_1 \}$</li>
<li class=" ml-8">$Y_2 \to \{ C_2, D_2 \}$</li>
</ul>
</li>
<li class=" ml-8">$X, Y$ 组成 RAID-0 (性能翻倍)<ul class=" list-disc font-serif">
<li class=" ml-8">$V_1 \to X_1 \to \{ A_1, B_1 \}$, $V_2 \to Y_1 \to \{ A_2, B_2 \}$</li>
<li class=" ml-8">$V_3 \to X_2 \to \{ A_2, B_2 \}$, $V_4 \to Y_2 \to \{ C_2, D_2 \}$</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space-contd" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space (cont'd)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">RAID-10：有时能容忍两块盘坏，有时候却不能。如果我们有很多块盘，能否减少浪费？</p>
</blockquote>
<p class=" font-serif my-1">换一个问法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">给你 $n$ 个 bits $b_1, b_2, \ldots, b_n$</li>
<li class=" ml-8">至少需要存储多少 bit 信息，使得我们可以在任意 $b_i$ 丢失 (已知 $i$) 的情况下，都可以恢复出 $b_i$？<ul class=" list-disc font-serif">
<li class=" ml-8">纠错码！</li>
<li class=" ml-8">$x \oplus x = 0$</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-4-parity-disk" class=" text-xl mt-2 pb-2 font-sans">RAID-4: Parity Disk</h2>
<p class=" font-serif my-1">专门留一块磁盘作为奇偶校验盘。</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$\{V_1, V_2, V_3\} \to \{A_1, B_1, C_1, D_1\}$<ul class=" list-disc font-serif">
<li class=" ml-8">$V_1 \to A_1$, $V_2 \to B_1$, $V_3 \to C_1$ (不容错)</li>
<li class=" ml-8">$D_1 = V_1 \oplus V_2 \oplus V_3$ (奇偶校验)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">性能分析</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Sequential/random read: 3x (75% 总带宽)</li>
<li class=" ml-8">Sequential write: 3x (75% 总带宽)</li>
<li class=" ml-8">Random write (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">$D_1 = V_1 \oplus V_2 \oplus V_3$</li>
<li class=" ml-8">写入任意 $V_1, V_2, V_3$ 都需要更新 $D_1$<ul class=" list-disc font-serif">
<li class=" ml-8">更新 $V_1$ 需要 readb($\{A_1,D_1\})$, writeb($\{A_1,D_1\}$)</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-5-rotating-parity" class=" text-xl mt-2 pb-2 font-sans">RAID-5: Rotating Parity</h2>
<p class=" font-serif my-1">“交错排列” parity block!</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/raid5.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-5" class=" text-xl mt-2 pb-2 font-sans">RAID-5: 性能分析</h2>
<p class=" font-serif my-1">让每一块盘都有均等的机会存储 parity</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Sequential read/write: 3x (75% 总带宽)</li>
<li class=" ml-8">Random read (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">(read 足够大，所有磁盘都可以提供数据) 4x (100% 总带宽)</li>
</ul>
</li>
<li class=" ml-8">Random write (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">$D_1 = V_1 \oplus V_2 \oplus V_3$; 写入任意 $V_1, V_2, V_3$ 都需要更新 $D_1$</li>
<li class=" ml-8">奇偶校验依然严重拖慢了随机写入<ul class=" list-disc font-serif">
<li class=" ml-8">但至少 $n$ 块盘可以获得 $n/4$ 的随机写性能</li>
<li class=" ml-8">有一定的 scalability</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid" class=" text-xl mt-2 pb-2 font-sans">RAID: 讨论</h2>
<p class=" font-serif my-1">更快、更可靠、近乎免费的大容量磁盘</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">革了 “高可靠性磁盘” 的命<ul class=" list-disc font-serif">
<li class=" ml-8">成为今天服务器的标准配置</li>
</ul>
</li>
<li class=" ml-8">类似的里程碑<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/1165389.945450" class=" text-amber-900">The Google file system</a> (SOSP'03) 和 <a href="https://dl.acm.org/doi/10.5555/1251254.1251264" class=" text-amber-900">MapReduce: Simplified data processing on large clusters</a> (OSDI'04) 开启 “大数据” 时代</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">RAID 的可靠性</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RAID 系统发生断电？<ul class=" list-disc font-serif">
<li class=" ml-8">例子：RAID-1 镜像盘出现不一致的数据</li>
</ul>
</li>
<li class=" ml-8">检测到磁盘坏？<ul class=" list-disc font-serif">
<li class=" ml-8">自动重组</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">崩溃一致性与崩溃恢复</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fault-model" class=" text-xl mt-2 pb-2 font-sans">另一种 Fault Model</h2>
<p class=" font-serif my-1">磁盘并没有故障</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但操作系统内核可能 crash，系统可能断电</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/cat-crash-consistency.jpg" width="400px"></p>
<p class=" font-serif my-1">文件系统：设备上的树结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">即便只是 append 一个字节，也涉及多处磁盘的修改<ul class=" list-disc font-serif">
<li class=" ml-8">FAT、目录文件 (文件大小) 和数据</li>
<li class=" ml-8">磁盘本身不提供 “all or nothing” 的支持</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="crash-consistency" class=" text-xl mt-2 pb-2 font-sans">崩溃一致性 (Crash Consistency)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><strong>Crash Consistency</strong>: Move the file system from one consistent state (e.g., before the file got appended to) to another atomically (e.g., after the inode, bitmap, and new data block have been written to disk).</p>
</blockquote>
<p class=" font-serif my-1"></p><center>(你们平时编程时假设不会发生的事，操作系统都要给你兜底)</center>
<hr>
<p class=" font-serif my-1">磁盘不提供多块读写 “all or nothing” 的支持</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">甚至为了性能，没有顺序保证<ul class=" list-disc font-serif">
<li class=" ml-8">bwrite 可能被乱序</li>
<li class=" ml-8">所以磁盘还提供了 bflush 等待已写入的数据落盘</li>
<li class=" ml-8">回到被并发编程支配的恐惧？<a href="../../../pages/OS/2022/demos/peterson-barrier.c" class=" text-amber-900">peterson-barrier.c</a></li>
</ul>
</li>
<li class=" ml-8"><del>那我们也可以考虑提供啊：<a href="https://dl.acm.org/doi/10.5555/1855741.1855752" class=" text-amber-900">Transactional flash</a> (OSDI'08)</del></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">磁盘乱序的后果</h2>
<p class=" font-serif my-1">为 FAT 文件追加写入一个 cluster (4KB) 需要更新</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">目录项中的文件大小 (100 → 4196)</li>
<li class=" ml-8">FAT 表中维护的链表 (EOF → cluster-id, FREE → EOF)</li>
<li class=" ml-8">实际数据</li>
</ul>
<hr>
<p class=" font-serif my-1">这麻烦了……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">任何一个子集的写入丢失都可能出现</li>
<li class=" ml-8">文件系统就进入了 “不一致” 的状态<ul class=" list-disc font-serif">
<li class=" ml-8">可能违反 FAT 的基本假设<ul class=" list-disc font-serif">
<li class=" ml-8">链表无环且长度和文件大小一致</li>
<li class=" ml-8">FREE 的 cluster 不能有入边</li>
<li class=" ml-8">……</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="file-system-checking-fsck" class=" text-xl mt-2 pb-2 font-sans">File System Checking (FSCK)</h2>
<p class=" font-serif my-1">根据磁盘上已有的信息，恢复出 “最可能” 的数据结构</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fsck-recovery.png" width="750px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.5555/1855741.1855751" class=" text-amber-900">SQCK: A declarative file system checker</a> (OSDI'08)</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/3281031" class=" text-amber-900">Towards robust file system checkers</a> (FAST'18)<ul class=" list-disc font-serif">
<li class=" ml-8">“widely used file systems (EXT4, XFS, BtrFS, and F2FS) may leave the file system in an uncorrectable state if the repair procedure is interrupted unexpectedly” 😂</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">针对 crash，我们需要更可靠的方法我们需要一个更可靠的方法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统不一致的根本原因是<red>存储设备无法提供多次写入的原子性</red></li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="journaling" class=" text-2xl mt-2 font-sans">日志 (Journaling)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">重新思考数据结构的存储</h2>
<p class=" font-serif my-1">两个 “视角”</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">存储实际<red>数据结构</red><ul class=" list-disc font-serif">
<li class=" ml-8">文件系统的 “直观” 表示</li>
<li class=" ml-8">crash unsafe</li>
</ul>
</li>
<li class=" ml-8">Append-only 记录所有<red>历史操作</red><ul class=" list-disc font-serif">
<li class=" ml-8">“重做” 所有操作得到数据结构的当前状态</li>
<li class=" ml-8">容易实现崩溃一致性</li>
</ul>
</li>
</ol>
<hr>
<p class=" font-serif my-1">二者的融合</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">数据结构操作发生时，用 (2) append-only 记录日志</li>
<li class=" ml-8">日志落盘后，用 (1) 更新数据结构</li>
<li class=" ml-8">崩溃后，重放日志并清除 (称为 redo log；相应也可以 undo log)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="atomic-append" class=" text-xl mt-2 pb-2 font-sans">实现 Atomic Append</h2>
<p class=" font-serif my-1">用 bread, bwrite 和 bflush 实现 append()</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fs-journaling.png" width="800px"></p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">定位到 journal 的末尾 (bread)</li>
<li class=" ml-8">bwrite TXBegin 和所有数据结构操作</li>
<li class=" ml-8">bflush 等待数据落盘</li>
<li class=" ml-8">bwrite TXEnd</li>
<li class=" ml-8">bflush 等待数据落盘</li>
<li class=" ml-8">将数据结构操作写入实际数据结构区域</li>
<li class=" ml-8">等待数据落盘后，删除 (标记) 日志</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="journaling" class=" text-xl mt-2 pb-2 font-sans">Journaling: 优化</h2>
<p class=" font-serif my-1">现在磁盘需要写入双份的数据</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">批处理 (xv6; jbd)<ul class=" list-disc font-serif">
<li class=" ml-8">多次系统调用的 Tx 合并成一个，减少 log 的大小</li>
<li class=" ml-8">jbd: 定期 write back</li>
</ul>
</li>
<li class=" ml-8">Checksum (ext4)<ul class=" list-disc font-serif">
<li class=" ml-8">不再标记 TxBegin/TxEnd</li>
<li class=" ml-8">直接标记 Tx 的长度和 checksum</li>
</ul>
</li>
<li class=" ml-8">Metadata journaling (ext4 default)<ul class=" list-disc font-serif">
<li class=" ml-8">数据占磁盘写入的绝大部分<ul class=" list-disc font-serif">
<li class=" ml-8">只对 inode 和 bitmap 做 journaling 可以提高性能</li>
</ul>
</li>
<li class=" ml-8">保证文件系统的目录结构是一致的；但数据可能丢失</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="metadata-journaling" class=" text-xl mt-2 pb-2 font-sans">Metadata Journaling</h2>
<p class=" font-serif my-1">从应用视角来看，文件系统的行为可能很怪异</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">各类系统软件 (git, sqlite, gdbm, ...) 不幸中招<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://cn.bing.com/search?q=All+file+systems+are+not+created+equal%3A+On+the+complexity+of+crafting+crash-consistent+applications&form=APMCS1&PC=APMC" class=" text-amber-900">All file systems are not created equal: On the complexity of crafting crash-consistent applications</a> (OSDI'14)</li>
<li class=" ml-8">(os-workbench 里的小秘密)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://zhuanlan.zhihu.com/p/25188921" class=" text-amber-900">更多的应用程序可能发生 data loss</a><ul class=" list-disc font-serif">
<li class=" ml-8">我们的工作: GNU coreutils, gmake, gzip, ... 也有问题</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/2950290.2950327" class=" text-amber-900">Crash consistency validation made easy</a> (FSE'16)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">更为一劳永逸的方案：TxOS</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">xbegin/xend/xabort 系统调用实现跨 syscall 的 “all-or-nothing”<ul class=" list-disc font-serif">
<li class=" ml-8">应用场景：数据更新、软件更新、check-use……</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/1629575.1629591" class=" text-amber-900">Operating systems transactions</a> (SOSP'09)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: 如何保证持久数据的可靠性？<ul class=" list-disc font-serif">
<li class=" ml-8">硬件冗余：RAID</li>
<li class=" ml-8">软件容错：fsck 和 journaling</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">Takeaway messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">多个 bwrite 不保证顺序和原子性</li>
<li class=" ml-8">Journaling: 数据结构的两个视角<ul class=" list-disc font-serif">
<li class=" ml-8">真实的数据结构</li>
<li class=" ml-8">执行的历史操作</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>