<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>处理器调度</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">处理器调度</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="overview" class=" text-xl mt-2 pb-2 font-sans">Overview</h2>
<p class=" font-serif my-1">复习</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">机制 (mechanism)：上下文切换<ul class=" list-disc font-serif">
<li class=" ml-8">在中断/系统调用时执行操作系统代码</li>
<li class=" ml-8">操作系统实现所有状态机 (进程) 一视同仁的 “封存”</li>
<li class=" ml-8">从而可以恢复任意一个状态机 (进程) 执行</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: 策略 (policy)：那我们到底选哪个进程执行呢？</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课主要内容</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">常见调度算法：Round-Robin, 优先级, MLFQ, CFS</li>
<li class=" ml-8">告诉大家为什么我们这门课不讲 “调度算法”</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="1" class=" text-2xl mt-2 font-sans">处理器调度 (1)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">简化的处理器调度问题</h2>
<p class=" font-serif my-1">中断机制</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">处理器以固定的频率被中断<ul class=" list-disc font-serif">
<li class=" ml-8">Linux Kernel 可以配置：100/250/300/1000Hz</li>
</ul>
</li>
<li class=" ml-8">中断/系统调用返回时可以自由选择进程/线程执行</li>
</ul>
<hr>
<p class=" font-serif my-1">处理器调度问题的简化假设</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">系统中有一个处理器 (1970s)</li>
<li class=" ml-8">系统中有多个进程/线程共享 CPU<ul class=" list-disc font-serif">
<li class=" ml-8">包括系统调用 (进程/线程的一部分代码在 syscall 中执行)</li>
<li class=" ml-8">偶尔会等待 I/O 返回，不使用 CPU (通常时间较长)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="round-robin" class=" text-xl mt-2 pb-2 font-sans">策略: Round-Robin</h2>
<p class=" font-serif my-1">假设当前 $T_i$ 运行</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">中断后试图切换到下一个线程 $T_{(i+1)\,\textrm{mod}\,n}$</li>
<li class=" ml-8">如果下一个线程正在等待 I/O 返回，继续尝试下一个<ul class=" list-disc font-serif">
<li class=" ml-8">如果系统所有的线程都不需要 CPU，就调度 idle 线程执行</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">我们的 <a href="../../../pages/OS/2022/demos/thread-os.c" class=" text-amber-900">thread-os.c</a> 实际上实现了 Round-Robin 的调度器</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">中断之间的线程执行称为 “时间片” (time-slicing)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/sched-rr.png" width="650px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">策略：引入优先级</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/haorenka.jpg" width="250px"></p>
<p class=" font-serif my-1">UNIX niceness</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">-20 .. 19 的整数，越 nice 越让别人得到 CPU<ul class=" list-disc font-serif">
<li class=" ml-8">-20: 极坏; most favorable to the process</li>
<li class=" ml-8">19: 极好; least favorable to the process</li>
</ul>
</li>
<li class=" ml-8">基于优先级的调度策略<ul class=" list-disc font-serif">
<li class=" ml-8">RTOS: 坏人躺下好人才能上<ul class=" list-disc font-serif">
<li class=" ml-8"><del>好人流下了悔恨的泪水</del></li>
</ul>
</li>
<li class=" ml-8">Linux: nice 相差 10, CPU 资源获得率相差 10 倍</li>
</ul>
</li>
<li class=" ml-8">不妨试一试: nice/renice<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>taskset -c 0 nice -n 19 yes > /dev/null &
taskset -c 0 nice -n  9 yes > /dev/null &
</code></pre></div>

</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="1" class=" text-2xl mt-2 font-sans">真实的处理器调度 (1)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="round-robin" class=" text-xl mt-2 pb-2 font-sans">Round-Robin 的问题</h2>
<p class=" font-serif my-1">系统里有两个进程</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">交互式的 Vim，单线程</li>
<li class=" ml-8">纯粹计算的 <a href="../../../pages/OS/2022/demos/mandelbrot.c" class=" text-amber-900">mandelbrot.c</a>, 32 个线程</li>
</ul>
<hr>
<p class=" font-serif my-1">Round-Robin</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Vim 花 0.1ms 处理完输入就又等输入了<ul class=" list-disc font-serif">
<li class=" ml-8">主动让出 CPU</li>
</ul>
</li>
<li class=" ml-8">Mandelbrot 使 Vim 在有输入可以处理的时候被延迟<ul class=" list-disc font-serif">
<li class=" ml-8">必须等当前的 Mandelbrot 转完一圈</li>
<li class=" ml-8">数百 ms 的延迟就会使人感到明显卡顿</li>
</ul>
</li>
<li class=" ml-8">你们会在 L2 里遇到这样的问题 <ul class=" list-disc font-serif">
<li class=" ml-8">表现形式：tty 卡顿</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="mlfq" class=" text-xl mt-2 pb-2 font-sans">策略：动态优先级 (MLFQ)</h2>
<p class=" font-serif my-1">不会设置优先级？让系统自动设定！</p>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/MLFQ.png" width="400px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">设置若干个 Round-Robin 队列<ul class=" list-disc font-serif">
<li class=" ml-8">每个队列对应一个优先级</li>
</ul>
</li>
<li class=" ml-8">动态优先级调整策略<ul class=" list-disc font-serif">
<li class=" ml-8">优先调度高优先级队列</li>
<li class=" ml-8">用完时间片 → 坏人<ul class=" list-disc font-serif">
<li class=" ml-8">Mandelbrot: 请你变得更好</li>
</ul>
</li>
<li class=" ml-8">让出 CPU I/O → 好人<ul class=" list-disc font-serif">
<li class=" ml-8">Vim: 你可以变得更坏</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">阅读教科书</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="complete-fair-scheduling-cfs" class=" text-xl mt-2 pb-2 font-sans">策略：Complete Fair Scheduling (CFS)</h2>
<p class=" font-serif my-1">试图去模拟一个 “Ideal Multi-Tasking CPU”: </p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“Ideal multi-tasking CPU” is a (non-existent :-)) CPU that has 100% physical power and which can run each task at precise equal speed, in parallel, each at <math>1/n</math>. For example: if there are 2 tasks running, then it runs each at 50% physical power — i.e., actually in parallel.</li>
</ul>
<hr>
<p class=" font-serif my-1">“让系统里的所有进程尽可能公平地共享处理器”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为每个进程记录精确的运行时间</li>
<li class=" ml-8">中断/异常发生后，切换到运行时间最少的进程执行<ul class=" list-disc font-serif">
<li class=" ml-8">下次中断/异常后，当前进程的可能就不是最小的了</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cfs" class=" text-xl mt-2 pb-2 font-sans">CFS: 实现优先级</h2>
<p class=" font-serif my-1">操作系统具有对物理时钟的 “绝对控制”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">每人执行 1ms，但好人的钟快一些，坏人的钟慢一些<ul class=" list-disc font-serif">
<li class=" ml-8">vruntime (virtual runtime)</li>
<li class=" ml-8">vrt[i] / vrt[j] 的增加比例 = wt[j] / wt[i]</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sched_prio_to_weight</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* -20 */</span><span class="w"> </span><span class="mi">88761</span><span class="p">,</span><span class="w"> </span><span class="mi">71755</span><span class="p">,</span><span class="w"> </span><span class="mi">56483</span><span class="p">,</span><span class="w"> </span><span class="mi">46273</span><span class="p">,</span><span class="w"> </span><span class="mi">36291</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/* -15 */</span><span class="w"> </span><span class="mi">29154</span><span class="p">,</span><span class="w"> </span><span class="mi">23254</span><span class="p">,</span><span class="w"> </span><span class="mi">18705</span><span class="p">,</span><span class="w"> </span><span class="mi">14949</span><span class="p">,</span><span class="w"> </span><span class="mi">11916</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/* -10 */</span><span class="w">  </span><span class="mi">9548</span><span class="p">,</span><span class="w">  </span><span class="mi">7620</span><span class="p">,</span><span class="w">  </span><span class="mi">6100</span><span class="p">,</span><span class="w">  </span><span class="mi">4904</span><span class="p">,</span><span class="w">  </span><span class="mi">3906</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/*  -5 */</span><span class="w">  </span><span class="mi">3121</span><span class="p">,</span><span class="w">  </span><span class="mi">2501</span><span class="p">,</span><span class="w">  </span><span class="mi">1991</span><span class="p">,</span><span class="w">  </span><span class="mi">1586</span><span class="p">,</span><span class="w">  </span><span class="mi">1277</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/*   0 */</span><span class="w">  </span><span class="mi">1024</span><span class="p">,</span><span class="w">   </span><span class="mi">820</span><span class="p">,</span><span class="w">   </span><span class="mi">655</span><span class="p">,</span><span class="w">   </span><span class="mi">526</span><span class="p">,</span><span class="w">   </span><span class="mi">423</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/*   5 */</span><span class="w">   </span><span class="mi">335</span><span class="p">,</span><span class="w">   </span><span class="mi">272</span><span class="p">,</span><span class="w">   </span><span class="mi">215</span><span class="p">,</span><span class="w">   </span><span class="mi">172</span><span class="p">,</span><span class="w">   </span><span class="mi">137</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/*  10 */</span><span class="w">   </span><span class="mi">110</span><span class="p">,</span><span class="w">    </span><span class="mi">87</span><span class="p">,</span><span class="w">    </span><span class="mi">70</span><span class="p">,</span><span class="w">    </span><span class="mi">56</span><span class="p">,</span><span class="w">    </span><span class="mi">45</span><span class="p">,</span>
<span class="w">  </span><span class="cm">/*  15 */</span><span class="w">    </span><span class="mi">36</span><span class="p">,</span><span class="w">    </span><span class="mi">29</span><span class="p">,</span><span class="w">    </span><span class="mi">23</span><span class="p">,</span><span class="w">    </span><span class="mi">18</span><span class="p">,</span><span class="w">    </span><span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cfs-1" class=" text-xl mt-2 pb-2 font-sans">CFS 的复杂性 (1): 新进程/线程</h2>
<p class=" font-serif my-1">子进程继承父进程的 vruntime</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并且从 2.6.32 开始，<a href="https://lkml.org/lkml/2009/9/11/411" class=" text-amber-900">parent run first</a></li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">task_fork_fair</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_entity</span><span class="w"> </span><span class="o">*</span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&</span><span class="n">p</span><span class="o">-></span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">rq_lock</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="o">&</span><span class="n">rf</span><span class="p">);</span>
<span class="w">  </span><span class="n">update_rq_clock</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">  </span><span class="n">cfs_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_cfs_rq</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">  </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-></span><span class="n">curr</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">update_curr</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
<span class="w">    </span><span class="n">se</span><span class="o">-></span><span class="n">vruntime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-></span><span class="n">vruntime</span><span class="p">;</span><span class="w"> </span><span class="c1">// 继承父进程的 vruntime</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">place_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cfs-2-io" class=" text-xl mt-2 pb-2 font-sans">CFS 的复杂性 (2): I/O</h2>
<p class=" font-serif my-1">I/O (例如 1 分钟) 以后回来 vruntime 严重落后</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为了赶上，CPU 会全部归它所有</li>
</ul>
<hr>
<p class=" font-serif my-1">Linux 的实现</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">被唤醒的进程获得 “最小” 的 vruntime (可以立即被执行)<ul class=" list-disc font-serif">
<li class=" ml-8">曾经会给唤醒的进程一些额外的 vruntime</li>
<li class=" ml-8">现在没有了</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">renorm</span><span class="w"> </span><span class="o">&&</span><span class="w"> </span><span class="n">curr</span><span class="p">)</span>
<span class="w">  </span><span class="n">se</span><span class="o">-></span><span class="n">vruntime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cfs_rq</span><span class="o">-></span><span class="n">min_vruntime</span><span class="p">;</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cfs-3" class=" text-xl mt-2 pb-2 font-sans">CFS 的复杂性 (3): 整数溢出</h2>
<p class=" font-serif my-1">vruntime 有优先级的 “倍数”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果溢出了 64-bit 整数怎么办……？<ul class=" list-disc font-serif">
<li class=" ml-8"><code>a < b</code> 不再代表 “小于”！</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">假设：系统中最近、最远的时刻差不超过数轴的一半</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们可以比较它们的相对大小</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">less</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">i64</span><span class="p">)(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="cfs" class=" text-xl mt-2 pb-2 font-sans">实现 CFS 的数据结构</h2>
<p class=" font-serif my-1">用什么数据结构维护所有进程的 vruntime?</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">任何有序集合 (例如 binary search tree) 维护线程 $t$ 的 $vrt(t)$<ul class=" list-disc font-serif">
<li class=" ml-8">更新 $vrt(t) \leftarrow vrt(t) + \Delta_t / w$</li>
<li class=" ml-8">取最小的 $vrt$</li>
<li class=" ml-8">进程创建/退出/睡眠/唤醒时插入/删除 $t$</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">道理还挺简单的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">代码实现有困难</li>
<li class=" ml-8">还不能有并发 bug……</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">小结：是否解决了问题？</h2>
<p class=" font-serif my-1">考虑三种情况：Producer, Consumer, <code>while (1)</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Round-Robin (L2)<ul class=" list-disc font-serif">
<li class=" ml-8">Producer/Consumer 获得非常少比例的 CPU</li>
</ul>
</li>
<li class=" ml-8">MLFQ<ul class=" list-disc font-serif">
<li class=" ml-8">Producer/Consumer 获得最高优先级 Round-Robin</li>
<li class=" ml-8"><code>while (1)</code> 完全饥饿 → 需要定期把所有人优先级 “拉平”</li>
</ul>
</li>
<li class=" ml-8">CFS<ul class=" list-disc font-serif">
<li class=" ml-8">线程有精确的 accounting 信息</li>
<li class=" ml-8">这些信息可以指导 Round-Robin<ul class=" list-disc font-serif">
<li class=" ml-8">适当使用 uptime (不必太精确) 可以大幅缓解 L2</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="2" class=" text-2xl mt-2 font-sans">真实的处理器调度 (2)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">不要高兴得太早</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">xiao_zhang</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 高优先级</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 休息一下先</span>
<span class="w">  </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&</span><span class="n">wc</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">xi_zhu_ren</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 中优先级</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">jyy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 最低优先级</span>
<span class="w">  </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&</span><span class="n">wc</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">jyy 在持有互斥锁的时候被赶下了处理器……</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">这个故事在火星上发生过一次</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/mpf-sojourner.jpg" width="850px"></p>
<p class=" font-serif my-1"></p><center>Sojourner “探路者” (PathFinder)，1997 年 7 月 4 日登陆火星</center></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="the-first-bug-on-mars" class=" text-xl mt-2 pb-2 font-sans"><a href="https://news.ycombinator.com/item?id=13210478" class=" text-amber-900">The First Bug on Mars</a></h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/PATHCOV.jpg" width="300px"></p>
<p class=" font-serif my-1">Sojourner “探路者” (PathFinder)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Lander (登陆舱)<ul class=" list-disc font-serif">
<li class=" ml-8">IBM Rad6000 SC (20 MIPS), 128 MiB RAM, 6 MiB EEPROM</li>
<li class=" ml-8">VxWorks “实时” 任务操作系统<ul class=" list-disc font-serif">
<li class=" ml-8">ASI/MET task: 大气成分监测 (低)</li>
<li class=" ml-8"><code>bc_dist</code> task: 分发任务 (中)</li>
<li class=" ml-8"><code>bc_sched</code> task: 总线调度 (高)</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">Rover (火星车)<ul class=" list-disc font-serif">
<li class=" ml-8">Intel 80C85 (0.1 MIPS), 512K RAM, 176K Flash SSD</li>
</ul>
</li>
<li class=" ml-8">着陆后开始出现系统重启</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="the-first-bug-on-mars-contd" class=" text-xl mt-2 pb-2 font-sans">The First Bug on Mars (cont'd)</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/marsbot.png" width="750px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(低优先级) <code>select -> pipeIoctl -> selNodeAdd -> mutex_lock</code></li>
<li class=" ml-8">(高优先级) <code>pipeWrite -> mutex_lock</code></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">解决优先级反转问题</h2>
<p class=" font-serif my-1">Linux: CFS 凑合用吧</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">实时系统：火星车在 CPU Reset 啊喂？？<ul class=" list-disc font-serif">
<li class=" ml-8">优先级继承 (Priority Inheritance)/优先级提升 (Priority Ceiling)<ul class=" list-disc font-serif">
<li class=" ml-8">持有 mutex 的线程/进程会继承 block 在该 mutex 上进程的最高优先级</li>
<li class=" ml-8">但也不是万能的 (例如条件变量唤醒)</li>
</ul>
</li>
<li class=" ml-8">在系统中动态维护资源依赖关系<ul class=" list-disc font-serif">
<li class=" ml-8">优先级继承是它的特例</li>
<li class=" ml-8">似乎更困难了……</li>
</ul>
</li>
<li class=" ml-8">避免高/低优先级的任务争抢资源<ul class=" list-disc font-serif">
<li class=" ml-8">对潜在的优先级反转进行预警 (lockdep)</li>
<li class=" ml-8">TX-based: 冲突的 TX 发生时，总是低优先级的 abort</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="3" class=" text-2xl mt-2 font-sans">真实的处理器调度 (3)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">多处理器调度</h2>
<p class=" font-serif my-1">还没完：我们的计算机系统可是多核心、多线程的！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们的老服务器：2 Socket x 24 Cores x 2 Threads = 96T</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/2S-motherboard.jpg" width="700px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">多处理器调度：被低估的复杂性</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">“And you have to realize that there are not very many things that have aged as well as the scheduler. Which is just another proof that scheduling is easy.”
——Linus Torvalds, 2001</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Linus 以为调度是个挺简单的问题？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">As a central part of resource management, the OS thread scheduler must maintain the following, simple, invariant: <em>make sure that ready threads are scheduled on available cores</em>... this invariant is often broken in Linux. Cores may stay idle for seconds while ready threads are waiting in runqueues.<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/2901318.2901326" class=" text-amber-900">The Linux scheduler: A decade of wasted cores</a>. (EuroSys'16)<ul class=" list-disc font-serif">
<li class=" ml-8">作者在狂黑 Linus 😂</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">多处理器调度的困难所在</h2>
<p class=" font-serif my-1">既不能简单地 “分配线程到处理器”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">线程退出，瞬间处理器开始围观</li>
</ul>
<hr>
<p class=" font-serif my-1">也不能简单地 “谁空丢给谁”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在处理器之间迁移会导致 cache/TLB 全都白给</li>
</ul>
<hr>
<p class=" font-serif my-1">多处理器调度的两难境地</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">迁移？可能过一会儿还得移回来</li>
<li class=" ml-8">不迁移？造成处理器的浪费</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1" class=" text-xl mt-2 pb-2 font-sans">实际情况 (1): 多用户、多任务</h2>
<p class=" font-serif my-1">还是刚才服务器的例子</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">马上要到 paper deadline 了，A 和 B 要在服务器上跑实验<ul class=" list-disc font-serif">
<li class=" ml-8">A 要跑一个任务，因为要调用一个库，只能单线程跑</li>
<li class=" ml-8">B 跑并行的任务，创建 1000 个线程跑<ul class=" list-disc font-serif">
<li class=" ml-8">B 获得几乎 100% 的 CPU</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">更糟糕的是，优先级解决不了这个问题……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">B 不能随便提高自己进程的优先级<ul class=" list-disc font-serif">
<li class=" ml-8">“An unprivileged user can only increase the nice value and such changes are irreversible...”</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="linux-namespaces-control-groups-cgroups" class=" text-xl mt-2 pb-2 font-sans">Linux Namespaces Control Groups (cgroups)</h2>
<p class=" font-serif my-1">namespaces (7), cgroups (7)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">轻量级虚拟化，创造 “操作系统中的操作系统”<ul class=" list-disc font-serif">
<li class=" ml-8">Mount, pid, network, IPC, user, cgroup namespace, time</li>
<li class=" ml-8">cgroup 允许以进程组为单位管理资源<ul class=" list-disc font-serif">
<li class=" ml-8">Docker 就变得很容易实现了</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/cgroups.jpg" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2-biglittle" class=" text-xl mt-2 pb-2 font-sans">实际情况 (2): Big.LITTLE/能效比</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/Snapdragon-888.png" width="400px"></p>
<p class=" font-serif my-1">Snapdragon 888</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">1X Prime Cortex-X1 (2.84GHz)</li>
<li class=" ml-8">3X Performance Cortex-A78 (2.4GHz)</li>
<li class=" ml-8">4X Efficiency Cortex-A55 (1.8GHz)</li>
</ul>
<hr>
<p class=" font-serif my-1">“Dark silicon” 时代的困境</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">功率无法支撑所有电路同时工作</li>
<li class=" ml-8">总得有一部分是停下的</li>
<li class=" ml-8">Linux Kernel <a href="https://www.kernel.org/doc/html/latest/scheduler/sched-energy.html" class=" text-amber-900">EAS</a> (Energy Aware Scheduler)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2-biglittle-contd" class=" text-xl mt-2 pb-2 font-sans">实际情况 (2): Big.LITTLE/能耗 (cont'd)</h2>
<p class=" font-serif my-1">软件可以配置 CPU 的工作模式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">开/关/工作频率 (频率越低，能效越好)</li>
<li class=" ml-8">如何在给定功率下平衡延迟 v.s. 吞吐量？</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/power-curve.png" width="550px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="3-non-uniform-memory-access" class=" text-xl mt-2 pb-2 font-sans">实际情况 (3): Non-Uniform Memory Access</h2>
<p class=" font-serif my-1">共享内存只是假象</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">L1 Cache 花了巨大的代价才让你感到内存是共享的</li>
<li class=" ml-8">Producer/Consumer 位于同一个/不同 module 性能差距可能很大</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/EPYC-NUMA.png" width="640px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">程序执行比你想象得复杂</h2>
<p class=" font-serif my-1">基本的假设可能不再成立</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">例子: more CPU time, more progress<ul class=" list-disc font-serif">
<li class=" ml-8">我们课堂上的例子就可以 challenge 这一点</li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/sum-atomic.c" class=" text-amber-900">sum-atomic.c</a></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ time taskset -c 0   ./a.out
$ time taskset -c 0,1 ./a.out
</code></pre></div>

<hr>
<p class=" font-serif my-1">分配了 1/2 的处理器资源，反而速度更快了</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">系统里进程的行为和交互是非常复杂的……<ul class=" list-disc font-serif">
<li class=" ml-8">NUMA 里尤其重要 (当然上面的例子是个 performance bug)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="4-cpu-hot-plug" class=" text-xl mt-2 pb-2 font-sans">实际情况 (4): CPU Hot-plug</h2>
<p class=" font-serif my-1">😂😂😂 我讲不下去了</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">实在是太复杂了</li>
<li class=" ml-8">我不是代码的维护者，并不清楚这些细节<ul class=" list-disc font-serif">
<li class=" ml-8">把上面都加起来<ul class=" list-disc font-serif">
<li class=" ml-8">这得考虑多少情况，写多少代码……</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">复杂的系统无人可以掌控</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" class=" text-amber-900">The battle of the schedulers: FreeBSD ULE vs. Linux CFS</a>. (ATC'18)<ul class=" list-disc font-serif">
<li class=" ml-8">结论：在现实面前，没有绝对的赢家和输家</li>
<li class=" ml-8">如果你追求极致的性能，就不能全指望一个调度算法</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">回到处理器调度</h2>
<p class=" font-serif my-1">调度是复杂、有着深远考虑的困难问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">下个时间片有 10,000,000 个时钟周期，分配给哪个线程？</li>
<li class=" ml-8">学校预算 10,000,000 经费，怎么分给院系？</li>
<li class=" ml-8">发改委下拨 1000,000,000,000 经费，怎么分给大家？</li>
</ul>
<hr>
<p class=" font-serif my-1">巨大的设计空间</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">建模 (理解和总结 “过去发生了什么”)<ul class=" list-disc font-serif">
<li class=" ml-8">profiling 和 trace; PMU</li>
</ul>
</li>
<li class=" ml-8">预测 (试图预知未来可能发生什么)</li>
<li class=" ml-8">决策 (应该如何调整系统行为)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="-" class=" text-xl mt-2 pb-2 font-sans">谁来完成建模-预测-决策？</h2>
<p class=" font-serif my-1">操作系统不 (完全) 背这个锅</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">让程序提供 scheduling hints</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/3477132.3483542" class=" text-amber-900">ghOSt: Fast & flexible user-space delegation of Linux scheduling</a> (SOSP'21)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ghost-sched.png" width="800px"></p></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q</strong>: 中断后到底应该把哪个进程/线程调度到处理器上？</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">机制 (做出来) 和策略 (做得好)<ul class=" list-disc font-serif">
<li class=" ml-8">构建复杂系统的常用方法</li>
</ul>
</li>
<li class=" ml-8">真实世界的处理器调度<ul class=" list-disc font-serif">
<li class=" ml-8">异构处理器 + Non-Uniform Memory Access</li>
<li class=" ml-8">优先级翻转</li>
<li class=" ml-8">教科书上的内容随时可能会被改写</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>