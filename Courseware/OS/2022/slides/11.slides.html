<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>操作系统上的进程</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">操作系统上的进程</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="overview" class=" text-xl mt-2 pb-2 font-sans">Overview</h2>
<p class=" font-serif my-1">复习</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">操作系统内核的启动：CPU Reset → Firmware → Boot loader → Kernel <code>_start()</code> → ...</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q1</strong>: 操作系统启动后到底做了什么？</li>
<li class=" ml-8"><strong>Q2</strong>: 操作系统如何管理程序 (进程)？</li>
</ul>
<hr>
<p class=" font-serif my-1">本次课主要内容</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">虚拟化：操作系统上的进程</li>
<li class=" ml-8">进程管理 API</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">操作系统启动后到底做了什么？</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">从系统启动到第一个进程</h2>
<p class=" font-serif my-1">回顾 <a href="../../../pages/OS/2022/demos/thread-os.c" class=" text-amber-900">thread-os.c</a> 的加载过程</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">CPU Reset → Firmware → Boot loader → Kernel <code>_start()</code></li>
</ul>
<hr>
<p class=" font-serif my-1">操作系统会加载 “第一个程序”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://elixir.bootlin.com/linux/latest/source/init/main.c#L1555" class=" text-amber-900">RTFSC</a> (latest Linux Kernel)<ul class=" list-disc font-serif">
<li class=" ml-8">如果没有指定启动选项 <code>init=</code>，按照 “默认列表” 尝试一遍</li>
<li class=" ml-8">从此以后，Linux Kernel 就进入后台，成为 “中断/异常处理程序”</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">程序：状态机</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">C 代码视角：语句</li>
<li class=" ml-8">汇编/机器代码视角：指令</li>
<li class=" ml-8">与操作系统交互的方式：syscall</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="linux" class=" text-xl mt-2 pb-2 font-sans">定制最小的 Linux</h2>
<p class=" font-serif my-1">没有存储设备，只有包含两个文件的 “initramfs”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://box.nju.edu.cn/f/3f67e092e1ba441187d9/?dl=1" class=" text-amber-900">linux-minimal.zip</a></li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ tree .
.
├── bin
│   └── busybox (可以在我们的Linux里直接执行)
└── init
</code></pre></div>

<p class=" font-serif my-1">加上 vmlinuz (内核镜像) 就可以在 QEMU 里启动了</p>
<hr>
<p class=" font-serif my-1">可以直接在文件系统中添加静态链接的二进制文件</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/minimal.S" class=" text-amber-900">minimal.S</a></li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/logisim.c" class=" text-amber-900">logisim.c</a></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">变魔术时间到</h2>
<p class=" font-serif my-1">BusyBox: The Swiss Army Knife of embedded Linux</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/busybox.png"></p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>c1="arch ash base64 cat chattr chgrp chmod chown conspy cp cpio cttyhack date dd df dmesg dnsdomainname dumpkmap echo ed egrep false fatattr fdflush fgrep fsync getopt grep gunzip gzip hostname hush ionice iostat ipcalc kbd_mode kill link linux32 linux64 ln login ls lsattr lzop makemime mkdir mknod mktemp more mount mountpoint mpstat mt mv netstat nice nuke pidof ping ping6 pipe_progress printenv ps pwd reformime resume rev rm rmdir rpm run-parts scriptreplay sed setarch setpriv setserial sh sleep stat stty su sync tar touch true umount uname usleep vi watch zcat"
c2="[ [[ awk basename bc beep blkdiscard bunzip2 bzcat bzip2 cal chpst chrt chvt cksum clear cmp comm crontab cryptpw cut dc deallocvt diff dirname dos2unix dpkg dpkg-deb du dumpleases eject env envdir envuidgid expand expr factor fallocate fgconsole find flock fold free ftpget ftpput fuser groups hd head hexdump hexedit hostid id install ipcrm ipcs killall last less logger logname lpq lpr lsof lspci lsscsi lsusb lzcat lzma man md5sum mesg microcom mkfifo mkpasswd nc nl nmeter nohup nproc nsenter nslookup od openvt passwd paste patch pgrep pkill pmap printf pscan"
c3="pstree pwdx readlink realpath renice reset resize rpm2cpio runsv runsvdir rx script seq setfattr setkeycodes setsid setuidgid sha1sum sha256sum sha3sum sha512sum showkey shred shuf smemcap softlimit sort split ssl_client strings sum sv svc svok tac tail taskset tcpsvd tee telnet test tftp time timeout top tr traceroute traceroute6 truncate ts tty ttysize udhcpc6 udpsvd unexpand uniq unix2dos unlink unlzma unshare unxz unzip uptime users uudecode uuencode vlock volname w wall wc wget which who whoami whois xargs xxd xz xzcat yes"
for cmd in $c1 $c2 $c3; do
  /bin/busybox ln -s /bin/busybox /bin/$cmd
done
mkdir -p /proc && mount -t proc  none /proc
mkdir -p /sys  && mount -t sysfs none /sys
export PS1='(linux) '
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">试试 adb shell (<a href="https://landley.net/toybox/" class=" text-amber-900">toybox</a>)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="noilinux-lite" class=" text-xl mt-2 pb-2 font-sans">例子：NOILinux-lite</h2>
<p class=" font-serif my-1">2021 年，CCF 以迅雷不及掩耳盗铃之势发布了 NOILinux 2.0</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Ubuntu 20.04 Desktop (x86-64 only)</li>
<li class=" ml-8">真就不管那些 32-bit 的老爷机和老爷系统的死活了？</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/noilinux-lite.jpg" width="450px">
和刚才的 “最小” 系统但本质一样</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">有更多设备 (磁盘、网卡等)</li>
<li class=" ml-8">initramfs 里挂载了磁盘</li>
<li class=" ml-8">磁盘里安装了最少的编译运行环境 (g++, ...) 和一个 Web 服务</li>
<li class=" ml-8"><code>switch_root</code> (<code>pivot_root</code> 系统调用) 完成 “启动”</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">小结：应用程序视角的操作系统</h2>
<p class=" font-serif my-1">Linux 操作系统启动流程</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">CPU Reset → Firmware → Loader → Kernel <code>_start()</code> → 第一个程序 <code>/bin/init</code> → 程序 (状态机) 执行 + 系统调用</li>
</ul>
<hr>
<p class=" font-serif my-1">操作系统为 (所有) 程序提供 API</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">进程 (状态机) 管理<ul class=" list-disc font-serif">
<li class=" ml-8"><red>fork, execve, exit - 状态机的创建/改变/删除 ← 今天的主题</red></li>
</ul>
</li>
<li class=" ml-8">存储 (地址空间) 管理<ul class=" list-disc font-serif">
<li class=" ml-8">mmap - 虚拟地址空间管理</li>
</ul>
</li>
<li class=" ml-8">文件 (数据对象) 管理<ul class=" list-disc font-serif">
<li class=" ml-8">open, close, read, write - 文件访问管理</li>
<li class=" ml-8">mkdir, link, unlink - 目录管理</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="fork" class=" text-2xl mt-2 font-sans">fork()</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">操作系统：状态机的管理者</h2>
<p class=" font-serif my-1">C 程序 = 状态机</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">初始状态：<code>main(argc, argv)</code></li>
<li class=" ml-8">程序可以直接在处理器上执行</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>虚拟化：操作系统在物理内存中保存多个状态机</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">通过虚拟内存实现每次 “拿出来一个执行”</li>
<li class=" ml-8">中断后进入操作系统代码，“换一个执行”</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">状态机管理：创建状态机</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">如果要创建状态机，我们应该提供什么样的 API？</p>
</blockquote>
<p class=" font-serif my-1">UNIX 的答案: fork</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">做一份状态机完整的复制 (内存、寄存器现场)</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/2-fork.jpg" width="300px">
<code>int fork();</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">立即复制状态机 (完整的内存)</li>
<li class=" ml-8">新创建进程返回 0</li>
<li class=" ml-8">执行 fork 的进程返回子进程的进程号</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork-bomb" class=" text-xl mt-2 pb-2 font-sans">Fork Bomb</h2>
<p class=" font-serif my-1">模拟状态机需要资源</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">只要不停地创建进程，系统还是会挂掉的</li>
<li class=" ml-8">Don't try it (or try it in docker)<ul class=" list-disc font-serif">
<li class=" ml-8">你们交这个到 Online Judge 是不会挂的</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fork-bomb-bash.jpg" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork-bomb" class=" text-xl mt-2 pb-2 font-sans">代码解析: Fork Bomb</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>:<span class="o">(){</span>:<span class="p">|</span>:<span class="p">&</span><span class="o">}</span><span class="p">;</span>:<span class="w">   </span><span class="c1"># 刚才的一行版本</span>

:<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w">         </span><span class="c1"># 格式化一下</span>
<span class="w">  </span>:<span class="w"> </span><span class="p">|</span><span class="w"> </span>:<span class="w"> </span><span class="p">&</span>
<span class="o">}</span><span class="p">;</span><span class="w"> </span>:

fork<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w">      </span><span class="c1"># bash: 允许冒号作为标识符……</span>
<span class="w">  </span>fork<span class="w"> </span><span class="p">|</span><span class="w"> </span>fork<span class="w"> </span><span class="p">&</span>
<span class="o">}</span><span class="p">;</span><span class="w"> </span>fork
</code></pre></div>

<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fork-bomb.png" width="300px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork" class=" text-xl mt-2 pb-2 font-sans">这次你们记住 Fork 了！</h2>
<p class=" font-serif my-1">因为状态机是复制的，因此总能找到 “父子关系”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">因此有了进程树 (pstree)</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>systemd-+-accounts-daemon---2*[{accounts-daemon}]
        |-agetty
        |-atd
        |-automount---2*[{automount}]
        |-avahi-daemon---avahi-daemon
        |-cron
        |-dbus-daemon
        |-irqbalance---{irqbalance}
        |-lxcfs---7*[{lxcfs}]
        ...
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork-1" class=" text-xl mt-2 pb-2 font-sans">理解 fork: 习题 (1)</h2>
<p class=" font-serif my-1">试着拿出一张纸，写出以下程序的输出结果</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/fork-demo.c" class=" text-amber-900">fork-demo.c</a><ul class=" list-disc font-serif">
<li class=" ml-8">你心里可能立即想，运行一下不就完了吗？</li>
<li class=" ml-8">记得用 “状态机” 去理解它</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="kt">pid_t</span><span class="w"> </span><span class="n">pid2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="kt">pid_t</span><span class="w"> </span><span class="n">pid3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Hello World from (%d, %d, %d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">pid1</span><span class="p">,</span><span class="w"> </span><span class="n">pid2</span><span class="p">,</span><span class="w"> </span><span class="n">pid3</span><span class="p">);</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork-2" class=" text-xl mt-2 pb-2 font-sans">理解 fork: 习题 (2)</h2>
<p class=" font-serif my-1">问以下程序的输出结果</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一个更好的版本: <a href="../../../pages/OS/2022/demos/fork-printf.c" class=" text-amber-900">fork-printf.c</a><ul class=" list-disc font-serif">
<li class=" ml-8">用状态机的视角再试一次</li>
<li class=" ml-8">试一试：<code>./a.out</code> v.s. <code>./a.out | cat</code></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Hello</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">计算机系统里没有魔法。机器永远是对的。</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fork-3" class=" text-xl mt-2 pb-2 font-sans">理解 fork: 习题 (3)</h2>
<p class=" font-serif my-1">多线程程序的某个线程执行 <code>fork()</code>，应该发生什么？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">这是个很有趣的问题：创造 fork 时创始人并没有考虑线程</li>
</ul>
<hr>
<p class=" font-serif my-1">我们可能作出以下设计：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">仅有执行 fork 的线程被复制，其他线程 “卡死”</li>
<li class=" ml-8">仅有执行 fork 的线程被复制，其他线程退出</li>
<li class=" ml-8">所有的线程都被复制并继续执行<ul class=" list-disc font-serif">
<li class=" ml-8">这三种设计分别会带来什么问题？</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="execve" class=" text-2xl mt-2 font-sans">execve()</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">状态机管理：替换状态机</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">光有 fork 还不够，怎么 “执行别的程序”？</p>
</blockquote>
<p class=" font-serif my-1">UNIX 的答案: execve</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">将当前运行的状态机重置成成另一个程序的初始状态</li>
</ul>
<p class=" font-serif my-1"><code>int execve(const char *filename, char * const argv, char * const envp);</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">执行名为 <code>filename</code> 的程序</li>
<li class=" ml-8">允许对新状态机设置参数 <code>argv</code> (v) 和环境变量 <code>envp</code> (e)<ul class=" list-disc font-serif">
<li class=" ml-8">刚好对应了 <code>main()</code> 的参数！</li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/execve-demo.c" class=" text-amber-900">execve-demo.c</a></li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">环境变量</h2>
<p class=" font-serif my-1">“应用程序执行的环境”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">使用 <code>env</code> 命令查看<ul class=" list-disc font-serif">
<li class=" ml-8"><code>PATH</code>: 可执行文件搜索路径</li>
<li class=" ml-8"><code>PWD</code>: 当前路径</li>
<li class=" ml-8"><code>HOME</code>: home 目录</li>
<li class=" ml-8"><code>DISPLAY</code>: 图形输出</li>
<li class=" ml-8"><code>PS1</code>: shell 的提示符</li>
</ul>
</li>
<li class=" ml-8"><code>export</code>: 告诉 shell 在创建子进程时设置环境变量<ul class=" list-disc font-serif">
<li class=" ml-8">小技巧：<code>export ARCH=x86_64-qemu</code> 或 <code>export ARCH=native</code></li>
<li class=" ml-8">上学期的 <code>AM_HOME</code> 终于破案了</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="path" class=" text-xl mt-2 pb-2 font-sans">环境变量：<code>PATH</code></h2>
<p class=" font-serif my-1">可执行文件搜索路径</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">还记得 gcc 的 strace 结果吗？</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>[pid 28369] execve("/usr/local/sbin/as", ["as", "--64", ...
[pid 28369] execve("/usr/local/bin/as", ["as", "--64", ...
[pid 28369] execve("/usr/sbin/as", ["as", "--64", ...
[pid 28369] execve("/usr/bin/as", ["as", "--64", ...
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">这个搜索顺序恰好是 <code>PATH</code> 里指定的顺序</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ PATH="" /usr/bin/gcc a.c
gcc: error trying to exec 'as': execvp: No such file or directory
$ PATH="/usr/bin/" gcc a.c
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">计算机系统里没有魔法。机器永远是对的。</p>
</blockquote></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_exit" class=" text-2xl mt-2 font-sans">_exit()</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">状态机管理：终止状态机</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">有了 fork, execve 我们就能自由执行任何程序了，最后只缺一个销毁状态机的函数！</p>
</blockquote>
<p class=" font-serif my-1">UNIX 的答案: <code>_exit</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">立即摧毁状态机</li>
</ul>
<p class=" font-serif my-1"><code>void _exit(int status)</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">销毁当前状态机，并允许有一个返回值</li>
<li class=" ml-8">子进程终止会通知父进程 (后续课程解释)</li>
</ul>
<hr>
<p class=" font-serif my-1">这个简单……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但问题来了：多线程程序怎么办？</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">结束程序执行的三种方法</h2>
<p class=" font-serif my-1">exit 的几种写法 (它们是<red>不同</red>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>exit(0)</code> - <code>stdlib.h</code> 中声明的 libc 函数<ul class=" list-disc font-serif">
<li class=" ml-8">会调用 <code>atexit</code></li>
</ul>
</li>
<li class=" ml-8"><code>_exit(0)</code> - glibc 的 syscall wrapper<ul class=" list-disc font-serif">
<li class=" ml-8">执行 “<code>exit_group</code>” 系统调用终止整个进程 (所有线程)<ul class=" list-disc font-serif">
<li class=" ml-8">细心的同学已经在 strace 中发现了</li>
</ul>
</li>
<li class=" ml-8">不会调用 <code>atexit</code></li>
</ul>
</li>
<li class=" ml-8"><code>syscall(SYS_exit, 0)</code><ul class=" list-disc font-serif">
<li class=" ml-8">执行 “<code>exit</code>” 系统调用终止当前线程</li>
<li class=" ml-8">不会调用 <code>atexit</code></li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">不妨试一试</h2>
<p class=" font-serif my-1">结束当前进程执行的四种方式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>return</code>, <code>exit</code>, <code>_exit</code>, <code>syscall</code></li>
<li class=" ml-8"><a href="../../../pages/OS/2022/demos/exit-demo.c" class=" text-amber-900">exit-demo.c</a><ul class=" list-disc font-serif">
<li class=" ml-8">用 strace 观察程序的执行</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课回答的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><strong>Q1</strong>: 操作系统启动后到底做了什么？</li>
<li class=" ml-8"><strong>Q2</strong>: 操作系统如何管理程序 (进程)？</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">对 “操作系统” 的完整理解<ul class=" list-disc font-serif">
<li class=" ml-8">CPU Reset → Firmware → Loader → Kernel <code>_start()</code> → 执行第一个程序 <code>/bin/init</code> → 中断/异常处理程序</li>
<li class=" ml-8">一个最小的 Linux 系统的例子</li>
</ul>
</li>
<li class=" ml-8">进程管理 API<ul class=" list-disc font-serif">
<li class=" ml-8">fork, execve, exit: 状态机的复制、重置、销毁</li>
<li class=" ml-8">理论上就可以实现 “各种功能” 了！</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="end" class=" text-2xl mt-2 font-sans">End.</h1></div></div></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>