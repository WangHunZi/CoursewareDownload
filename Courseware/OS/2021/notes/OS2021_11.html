<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>I/O &#35774;&#22791;&#19982;&#39537;&#21160;</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="../../../index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="../../2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="io" class=" text-2xl mt-2 font-sans">I/O &#35774;&#22791;&#19982;&#39537;&#21160;</h1>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#26412;&#35762;&#38405;&#35835;&#26448;&#26009;</h4>
<p class=" font-serif my-1"><a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" class=" text-amber-900">&#25945;&#31185;&#20070; (Operating Systems: Three Easy Pieces, OSTEP)</a> &#31532; 36 &#31456;&#12290;</p>
</blockquote>
<h2 id="1-io" class=" text-xl mt-2 pb-2 font-sans">1. I/O &#35774;&#22791;</h2>
<p class=" font-serif my-1">&#22788;&#29702;&#22120;&#30340;&#25351;&#20196;&#33021;&#22815;&#35775;&#38382; I/O &#35774;&#22791;&#65292;&#20027;&#35201;&#26159;&#36890;&#36807;&#20004;&#31181;&#26041;&#24335;&#23454;&#29616;&#30340;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#31471;&#21475; I/O (Port IO, PIO)&#65292;&#30456;&#24403;&#20110;&#26159;&#20026; I/O &#35774;&#22791;&#25552;&#20379;&#20102;&#19968;&#20010;&#21333;&#29420;&#30340;&#22320;&#22336;&#31354;&#38388;&#65292;&#36890;&#36807;&#35835;/&#20889;&#31471;&#21475;&#30340;&#26041;&#24335;&#23454;&#29616;&#35774;&#22791;&#25511;&#21046;&#12290;&#36890;&#24120;&#65292;&#19968;&#20010; I/O &#35774;&#22791;&#30340;&#23492;&#23384;&#22120;&#20998;&#20026;&#19977;&#31867;&#65306;&#29366;&#24577;&#23492;&#23384;&#22120;&#12289;&#25511;&#21046;&#23492;&#23384;&#22120;&#12289;&#25968;&#25454;&#23492;&#23384;&#22120;&#12290;&#39038;&#21517;&#24605;&#20041;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#25511;&#21046;&#23492;&#23384;&#22120;&#23454;&#29616;&#35774;&#22791;&#25511;&#21046;(&#20363;&#22914;&#35774;&#32622;&#35774;&#22791;&#30340;&#27169;&#24335;&#31561;)&#65292;&#20174;&#25968;&#25454;&#23492;&#23384;&#22120;&#35835;&#20889;&#25968;&#25454;&#65292;&#24182;&#19988;&#35835;&#21462;&#29366;&#24577;&#23492;&#23384;&#22120;&#26469;&#26597;&#30475;&#35774;&#22791;&#25191;&#34892;&#21629;&#20196;&#30340;&#29366;&#24577;&#12290;</li>
<li class=" ml-8">&#20869;&#23384;&#26144;&#23556; I/O (Memory-Mapped I/O, MMIO)&#12290;&#32473;&#29305;&#23450;&#30340;&#20869;&#23384;&#22320;&#22336;&#36171;&#20104;&#29305;&#27530;&#30340;&#21547;&#20041;&#65292;&#20174;&#32780;&#35835;/&#20889;&#20869;&#23384;&#22320;&#22336;&#23601;&#33021;&#23454;&#29616;&#35774;&#22791;&#30340;&#35775;&#38382;&#12290;&#22312;&#12298;&#35745;&#31639;&#26426;&#31995;&#32479;&#12299;&#30340;&#35838;&#31243;&#20316;&#19994;&#20013;&#65292;&#26174;&#23384;&#23601;&#26159;&#36890;&#36807;&#36825;&#31181;&#26041;&#24335;&#23454;&#29616;&#30340;&#12290;&#19968;&#26041;&#38754;&#65292;&#20869;&#23384;&#26144;&#23556; I/O &#23436;&#20840;&#21487;&#20197;&#29992;&#26469;&#23454;&#29616;&#29366;&#24577;/&#25511;&#21046;/&#25968;&#25454;&#23492;&#23384;&#22120;&#65292;&#21478;&#19968;&#26041;&#38754;&#65292;&#22312;&#35774;&#22791;&#20174;&#22806;&#37096;&#30475;&#26469;&#26159;&#19968;&#27573;&#36830;&#32493;&#25968;&#25454;&#26102; (&#20363;&#22914;&#26174;&#23384;)&#65292;MMIO &#33021;&#20943;&#23569;&#19981;&#24517;&#35201;&#30340;&#20869;&#23384;&#25644;&#36816;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#20174;&#36947;&#29702;&#19978;&#26469;&#35828;&#65292;I/O &#35774;&#22791;&#26080;&#38750;&#23601;&#26159;&#19968;&#32452;&#25509;&#21475;&#65292;&#33021;&#22815;&#35835;&#21462;/&#20889;&#20837;&#25968;&#25454;&#65292;I/O &#35774;&#22791;&#20250;&#26681;&#25454;&#33258;&#24049;&#30340;&#21327;&#35758;&#35299;&#35835;&#36825;&#20123;&#25968;&#25454;&#65292;&#24182;&#19988;&#21453;&#26144;&#21040;&#29289;&#29702;&#19990;&#30028;&#20013;&#21435;&#12290;&#25105;&#20204;&#27599;&#20010;&#20154;&#20351;&#29992;&#35745;&#31639;&#26426;&#65292;&#20351;&#29992;&#30340;&#37117;&#26159;&#23427;&#30340; I/O &#35774;&#22791;&#65292;&#22240;&#27492;&#23545; &#8220;&#35745;&#31639;&#26426;&#8221; &#30340;&#31532;&#19968;&#21360;&#35937;&#20854;&#23454;&#37117;&#26469;&#33258;&#36825;&#20123;&#35774;&#22791;&#8212;&#8212;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#25353;&#38190;&#12289;&#31227;&#21160;&#40736;&#26631;&#65292;&#26469;&#25913;&#21464;&#23631;&#24149;&#19978;&#30340;&#20869;&#23481;&#12290;&#36825;&#19968;&#20999;&#37117;&#26159;&#29992;<strong>&#35745;&#31639;</strong>&#23454;&#29616;&#30340;&#8212;&#8212;&#22788;&#29702;&#22120;&#35835;&#21462;&#20108;&#36827;&#21046;&#30340;&#25968;&#25454;&#12289;&#36827;&#34892;&#35745;&#31639;&#65292;&#20877;&#20197;&#20108;&#36827;&#21046;&#30340;&#24418;&#24335;&#36755;&#20986;&#12290;</p>
<p class=" font-serif my-1">&#22240;&#27492;&#65292;&#19968;&#20010; I/O &#35774;&#22791;&#21487;&#20197;&#30475;&#20570;&#26159;&#33509;&#24178;&#21487;&#20197;&#35835;&#20889;&#30340; &#8220;&#23492;&#23384;&#22120;&#8221;&#8212;&#8212;&#25105;&#20204;&#21482;&#38656;&#33021;&#21644;&#35774;&#22791;&#20132;&#25442;&#29366;&#24577;&#12289;&#21629;&#20196;&#12289;&#25968;&#25454;&#65292;&#23601;&#33021;&#23436;&#25104;&#21508;&#31867;&#35774;&#22791;&#30340;&#35775;&#38382;&#12290;</p>
<h3 id="11" class=" text-lg mt-2 pb-2 font-sans">1.1. &#38190;&#30424;&#25511;&#21046;&#22120;</h3>
<p class=" font-serif my-1">&#38190;&#30424;&#25511;&#21046;&#22120;&#20869;&#37096;&#26377;&#19968;&#20010;&#32531;&#20914;&#21306;&#65292;&#22312;&#25353;&#38190;&#20043;&#21518;&#20250;&#23558;&#38190;&#30424;&#30340;&#25195;&#25551;&#30721;&#20445;&#23384;&#21040;&#32531;&#20914;&#21306;&#20869;&#8212;&#8212;&#36825;&#23601;&#26159;&#20026;&#20160;&#20040;&#32769;&#24335;&#30340;&#35745;&#31639;&#26426;&#22914;&#26524;&#27809;&#33021;&#36827;&#20837;&#25805;&#20316;&#31995;&#32479;&#65292;&#21453;&#22797;&#25353;&#38190;&#20250;&#23548;&#33268;&#25253;&#35686;&#8212;&#8212;&#32531;&#20914;&#21306;&#28385;&#21518;&#65292;&#38190;&#30424;&#30340;&#25353;&#38190;&#23558;&#20002;&#22833;&#65292;&#38190;&#30424;&#29992;&#25253;&#35686;&#30340;&#26041;&#24335;&#25552;&#37266;&#29992;&#25143;&#12290;CPU &#21487;&#20197;&#36890;&#36807; I/O &#25351;&#20196; (&#26681;&#25454;&#31995;&#32479;&#23454;&#29616;&#65292;&#31471;&#21475; I/O &#25110;&#20869;&#23384;&#26144;&#23556; I/O)&#35835;&#21462;&#38190;&#30424;&#25511;&#21046;&#30340;&#20449;&#24687;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// no input</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// mouse</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// &#25353;&#38190;&#30340;&#8220;&#25195;&#25551;&#30721;&#8221;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#40736;&#26631;&#21644;&#38190;&#30424;&#26159;&#38750;&#24120;&#31867;&#20284;&#30340;&#65292;&#40736;&#26631;&#21521;&#25511;&#21046;&#22120;&#21457;&#36865;&#30340;&#26159;&#25353;&#38190;&#30340;&#20449;&#24687;&#65292;&#20197;&#21450;&#40736;&#26631;&#36317;&#31163;&#19978;&#19968;&#20010;&#26102;&#21051;&#21457;&#29983;&#30340;&#20301;&#31227; $(x, y)$ &#22352;&#26631;&#12290;</p>
<h3 id="12" class=" text-lg mt-2 pb-2 font-sans">1.2. &#30913;&#30424;&#25511;&#21046;&#22120;</h3>
<p class=" font-serif my-1">&#30913;&#30424;&#25511;&#21046;&#22120;&#19982;&#38190;&#30424;&#25511;&#21046;&#22120;&#30456;&#20284;&#65292;&#36890;&#36807;&#29366;&#24577;&#12289;&#25511;&#21046;&#12289;&#25968;&#25454;&#35775;&#38382;&#12290;&#22240;&#20026;&#30913;&#30424;&#30456;&#23545;&#20110; CPU &#26159;&#24456;&#24930;&#30340;&#35774;&#22791; (&#30913;&#30424;&#22312;&#19977;&#32500;&#31354;&#38388;&#20013;&#23384;&#20648;&#20449;&#24687;&#8212;&#8212;&#30424;&#29255;&#12289;&#36890;&#36807;&#35835;&#20889;&#22836;&#23450;&#20301;&#30340;&#26609;&#38754;&#12289;&#26059;&#36716;&#30340;&#25159;&#21306;&#65292;&#20854;&#20013;&#26377;&#26426;&#26800;&#35013;&#32622;&#65292;&#36890;&#24120;&#38656;&#35201; ms &#32423;&#21035;&#30340;&#26102;&#38388;&#25165;&#33021;&#23436;&#25104;&#25805;&#20316;)&#65292;&#22240;&#27492;&#35753; CPU &#19981;&#26029;&#36718;&#35810; status &#23492;&#23384;&#22120;&#20250;&#28010;&#36153;&#24456;&#22810; CPU &#36164;&#28304;&#12290;&#22240;&#27492;&#65292;&#30913;&#30424;&#39537;&#21160;&#22120;&#21487;&#20197;&#37197;&#32622;&#25104;&#20013;&#26029;&#27169;&#24335;&#65292;&#22312;&#30913;&#30424;&#20934;&#22791;&#23436;&#27605;&#21518;&#21457;&#36865;&#20013;&#26029;&#12290;</p>
<p class=" font-serif my-1">&#19982;&#30913;&#30424;&#20132;&#20114;&#30340;&#20195;&#30721;&#35831;&#21442;&#32771; xv6 (x86) &#30340; <a href="https://github.com/mit-pdos/xv6-public/blob/master/ide.c" class=" text-amber-900">ide.c</a>&#12290;</p>
<h3 id="13" class=" text-lg mt-2 pb-2 font-sans">1.3. &#26174;&#21345;</h3>
<p class=" font-serif my-1">&#26174;&#21345;&#26159;&#22823;&#23478;&#26368;&#24863;&#20852;&#36259;&#30340;&#35774;&#22791;&#8212;&#8212;&#27809;&#26377;&#23427;&#65292;&#23601;&#27809;&#26377;&#37027;&#20040;&#22810;&#22909;&#29609;&#30340;&#28216;&#25103;&#20102;&#12290;&#19981;&#36807;&#24403;&#25105;&#20204;&#20171;&#32461;&#26174;&#21345; (GPU) &#30340;&#26102;&#20505;&#65292;&#24182;&#27809;&#26377;&#36890;&#36807; &#8220;&#22270;&#24418;&#26174;&#31034;&#8221; &#36825;&#20010;&#21151;&#33021;&#26469;&#20171;&#32461;&#23427;&#12290;&#26174;&#21345;&#20854;&#23454;&#26159;&#31995;&#32479;&#37324;&#30340;&#21478;&#19968;&#20010; &#8220;&#22810;&#22788;&#29702;&#22120;&#35745;&#31639;&#26426;&#8221;&#65292;&#23427;&#25317;&#26377;&#33258;&#24049;&#30340;&#20869;&#23384;&#31995;&#32479;&#21644;&#35745;&#31639;&#31995;&#32479;&#65292;&#20294;&#25509;&#21463; CPU &#30340;&#25511;&#21046;&#12290;&#20197;&#19979;&#26159;&#19968;&#27573;&#20026;GPU&#32534;&#20889;&#30340;&#31243;&#24207;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// handle the data at this index if (tid &lt; N)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">c</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#21487;&#20197;&#30475;&#21040;&#65292;GPU&#19978;&#31243;&#24207;&#26368;&#37325;&#35201;&#30340;&#29305;&#24615;&#23601;&#26159;<strong>&#24182;&#34892;</strong>&#12290;&#19968;&#20010; GPU &#19978;&#26377;&#25968;&#20197;&#21315;&#35745;&#30340;&#26680;&#24515;&#65292;&#24182;&#19988;&#21487;&#20197;&#34987;&#37197;&#32622;&#25104;&#19977;&#32500; &#8220;&#31435;&#26041;&#20307;&#8221; &#30340;&#24418;&#24577;&#65292;&#32534;&#20889;&#19968;&#20221;&#31243;&#24207;&#21487;&#20197;&#22312;&#31435;&#26041;&#20307;&#30340;&#33410;&#28857;&#19978;&#21516;&#26102;&#36816;&#34892; (&#36825;&#20010;&#20363;&#23376;&#21482;&#29992;&#21040;&#20102;&#19968;&#20010;&#32500;&#24230;)&#8212;&#8212;&#34429;&#28982;&#27599;&#20010; GPU (&#20363;&#22914; CUDA) &#26680;&#24515;&#30340;&#36816;&#31639;&#36895;&#24230;&#19981;&#24517;&#20081;&#24207;&#22810;&#21457;&#23556;&#30340; CPU &#26356;&#24555;&#65292;&#20294;&#22312;&#36816;&#31639;&#37327;&#26497;&#22823;&#30340;&#22330;&#26223;&#19978;&#65292;&#22810;&#26680;&#24515;&#30340;&#20248;&#21183;&#23601;&#20307;&#29616;&#20986;&#26469;&#20102;&#12290;</p>
<p class=" font-serif my-1">CPU &#19982; GPU &#24037;&#20316;&#30340;&#27169;&#24335;&#22823;&#33268;&#22914;&#19979;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">CPU &#25226;&#38656;&#35201;&#30340;&#25968;&#25454;&#20256;&#36865;&#32473; GPU&#12290;&#23545;&#20110;&#19978;&#19968;&#20010;&#20363;&#23376;&#65292;GPU &#38656;&#35201;&#30340;&#25968;&#25454;&#26159;&#20004;&#20010;&#25968;&#32452;&#65307;&#23545;&#20110;&#28216;&#25103;&#25110;&#22270;&#24418;&#26174;&#31034;&#30340;&#20363;&#23376;&#65292;GPU &#38656;&#35201;&#39030;&#28857;&#20449;&#24687;&#12289;&#26448;&#36136;&#12289;&#36148;&#22270;&#12289;&#26144;&#23556;&#31561;&#20449;&#24687;&#65307;</li>
<li class=" ml-8">&#36890;&#30693; GPU &#24320;&#22987;&#36816;&#31639;&#24182;&#31561;&#24453;&#36816;&#31639;&#32467;&#26463;&#65307;</li>
<li class=" ml-8">&#20174; GPU &#22788;&#21462;&#22238;&#36816;&#31639;&#32467;&#26524;&#12290;&#24403;&#28982;&#65292;&#22914;&#26524;&#36816;&#31639;&#30340;&#32467;&#26524;&#26368;&#32456;&#30340;&#30446;&#30340;&#26159;&#26174;&#31034;&#22312;&#23631;&#24149;&#19978; (&#20363;&#22914;&#31639;&#20986; 1920x1080 &#20010;&#20687;&#32032;&#28857;&#30340;&#39068;&#33394;)&#65292;GPU &#21487;&#20197;&#24110;&#21161;&#25105;&#20204;&#25226;&#26174;&#23384;&#20013;&#30340;&#19968;&#37096;&#20998;&#21516;&#27493;&#21040;&#29289;&#29702;&#25509;&#21475; (&#20363;&#22914; HDMI) &#19978;&#65292;&#36825;&#26679; CPU &#23601;&#23436;&#20840;&#19981;&#24517;&#36807;&#38382;&#22270;&#24418;&#30340;&#26174;&#31034;&#20102;&#12290;</li>
</ul>
<p class=" font-serif my-1"></p><center><img alt="" src="../../../pages/OS/img/gpu.png" width="640px"></center>
<p class=" font-serif my-1">&#22240;&#27492;&#65292;&#21018;&#25165;&#30340; <code>add</code> &#31243;&#24207;&#36824;&#38656;&#35201;&#25105;&#20204;&#30340; CPU &#22312; GPU &#19978;&#25918;&#32622;&#21512;&#36866;&#30340;&#25968;&#25454;&#24182; &#8220;&#21551;&#21160;&#8221;&#12290;&#20026;&#20102;&#22312; GPU &#19978;&#36816;&#34892; <code>add()</code>&#65292;&#25105;&#20204;&#21487;&#20197;&#20351;&#29992;&#22914;&#19979;&#30340; main &#20989;&#25968;&#12290;&#36825;&#27573; main &#20989;&#25968;&#36816;&#34892;&#22312;CPU&#19978;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dev_a</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_b</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_c</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// allocate the memory on the GPU</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_a</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_b</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_c</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>

<span class="w">  </span><span class="c1">// fill the arrays 'a' and 'b' on the CPU</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// copy the arrays 'a' and 'b' to the GPU</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dev_a</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dev_b</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>

<span class="w">  </span><span class="n">add</span><span class="o">&lt;&lt;&lt;</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="w"> </span><span class="n">dev_a</span><span class="p">,</span><span class="w"> </span><span class="n">dev_b</span><span class="p">,</span><span class="w"> </span><span class="n">dev_c</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// copy the array 'c' back from the GPU to the CPU</span>
<span class="w">  </span><span class="n">HANDLE_ERROR</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">dev_c</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>

<span class="w">  </span><span class="c1">// display the results</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// free the memory allocated on the GPU</span>
<span class="w">  </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_a</span><span class="p">);</span>
<span class="w">  </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_b</span><span class="p">);</span>
<span class="w">  </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_c</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#19978;&#38754;&#30340;&#20195;&#30721;&#20250;&#34987; &#8220;&#26174;&#21345;&#32534;&#31243;&#8221; &#30340;&#24037;&#20855;&#38142; (&#20363;&#22914; nvcc) &#32534;&#35793;&#12290;&#36816;&#34892;&#22312; GPU &#19978;&#30340;&#31243;&#24207; (<code>__global__</code> &#26631;&#35760;&#30340;&#20989;&#25968;) &#23558;&#20250;&#32534;&#35793;&#25104; GPU &#25903;&#25345;&#30340;&#25351;&#20196;&#38598;&#65292;&#29978;&#33267;&#26377;&#20004;&#31181;&#26041;&#24335;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#30452;&#25509;&#29983;&#25104; GPU &#25351;&#20196; .cubin &#25991;&#20214;&#65292;&#30456;&#24403;&#20110;&#29983;&#25104;&#27719;&#32534;&#20195;&#30721;&#21040;&#26426;&#22120;&#20195;&#30721;&#12290;</li>
<li class=" ml-8">&#29983;&#25104;&#20013;&#38388;&#20195;&#30721; .ptx &#25991;&#20214; (&#21487;&#20197;&#24819;&#35937;&#25104;&#26159; NEMU &#20013;&#30340; RTL)&#65292;&#28982;&#21518;&#20877;&#30001;&#26174;&#21345;&#39537;&#21160;&#36827;&#34892; just-in-time &#32534;&#35793;&#65292;&#26368;&#32456;&#21040; GPU &#19978;&#36816;&#34892;&#12290;&#36825;&#30456;&#24403;&#20110;&#29983;&#25104;&#19968;&#31181; &#8220;&#20013;&#38388;&#20195;&#30721;&#8221; (&#23383;&#33410;&#30721;)&#12290;</li>
</ul>
<p class=" font-serif my-1">&#32780;&#20854;&#20182;&#30340;&#37096;&#20998;&#21017;&#20250;&#34987;&#32534;&#35793;&#25104;&#26222;&#36890;&#30340; ELF &#20108;&#36827;&#21046;&#25991;&#20214;&#65292;&#32473;GPU&#21457;&#36865;&#27491;&#30830;&#30340;&#25351;&#20196;&#65292;&#25191;&#34892;&#31243;&#24207;&#24182;&#31561;&#24453;&#25191;&#34892;&#23436;&#25104;&#12290;</p>
<p class=" font-serif my-1">&#20026;&#20102;&#26174;&#31034;&#22270;&#24418;&#65292;&#27969;&#31243;&#21644;&#19978;&#36848;&#20195;&#30721;&#26159;&#21313;&#20998;&#31867;&#20284;&#30340;&#65292;&#20294;GPU&#27605;&#31455;&#20174;&#23427;&#35806;&#29983;&#30340;&#37027;&#19968;&#21051;&#36215;&#30340;&#26681;&#26412;&#20351;&#21629;&#23601;&#26159;&#26174;&#31034;&#22270;&#20687;&#65292;&#22240;&#27492;&#26377;&#19987;&#38376;&#30340;&#26680;&#24515;&#12289;&#25351;&#20196;&#31561;&#29992;&#20110;<a href="https://en.wikipedia.org/wiki/Rendering_pipeline" class=" text-amber-900">&#22270;&#20687;&#26174;&#31034;</a>&#65292;&#21018;&#25165;&#29992;&#20110;&#36890;&#29992;&#35745;&#31639;&#30340;&#31243;&#24207;&#23601;&#26159;&#33073;&#32974;&#20110;&#20854;&#20013;&#30340; &#8220;&#30528;&#33394;&#22120;&#8221; (shader)&#12290;&#36825;&#20123;&#30693;&#35782;&#24050;&#32463;&#36229;&#36807;&#25805;&#20316;&#31995;&#32479;&#35838;&#31243;&#30340;&#33539;&#30068;&#8212;&#8212;&#25805;&#20316;&#31995;&#32479;&#25226; GPU &#30475;&#25104;&#26159;&#24635;&#32447;&#19978;&#30340;&#19968;&#20010;&#35774;&#22791;&#65292;&#21097;&#19979;&#30340;&#24037;&#20316;&#23601;&#37117;&#20132;&#32473;&#35774;&#22791;&#39537;&#21160;&#31243;&#24207;&#20102;&#12290;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/gpu-1.png" width="480px"></p>
<h3 id="14-dma" class=" text-lg mt-2 pb-2 font-sans">1.4. DMA</h3>
<p class=" font-serif my-1">&#26368;&#21518;&#19968;&#31867;&#35774;&#22791;&#21313;&#20998;&#29305;&#27530;&#65306;&#23427;&#24182;&#19981;&#36127;&#36131;&#19982;&#35745;&#31639;&#26426;&#31995;&#32479;&#22806;&#30340; I/O&#65292;&#23427;&#30340;&#20986;&#29616;&#20027;&#35201;&#26159;&#20026;&#20102;&#35299;&#20915;&#35774;&#22791;&#35775;&#38382;&#36895;&#24230;&#24930;&#30340;&#19968;&#20010;&#32570;&#28857;&#65306;&#35797;&#24819;&#25105;&#20204;&#24076;&#26395;&#20174;&#30913;&#30424;&#20013;&#35835;&#20986;&#28023;&#37327;&#30340;&#25968;&#25454;&#12290;&#22312;&#30913;&#30424;&#20934;&#22791;&#22909;&#21518;&#65292;&#25105;&#20204;&#23601;&#21487;&#20197;&#20351;&#29992;&#19968;&#20010;&#24490;&#29615;&#36827;&#34892;&#35835;&#21462;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nbytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inl</span><span class="p">(</span><span class="n">DISK_PORT</span><span class="p">);</span><span class="w"> </span><span class="c1">// or</span>
<span class="w">  </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmio_readl</span><span class="p">(</span><span class="n">DISK_MMIO_ADDR</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#20877;&#27604;&#22914;&#21018;&#25165;&#25105;&#20204;&#30340; <code>cudaMemcpy</code>&#65292;&#22914;&#26524;&#35201;&#20256;&#36865;&#24456;&#22823;&#30340;&#25968;&#25454; (&#20363;&#22914;&#22312;&#28216;&#25103;&#24320;&#22987;&#26102;&#21521;&#26174;&#21345;&#20256;&#36865;&#30340;&#39640;&#28165;&#36148;&#22270;)&#65292;&#23601;&#38750;&#24120;&#32791;&#26102;&#20102;&#12290;&#20026;&#20102;&#25226; CPU &#20174;&#36825;&#20123;&#32321;&#37325;&#30340;&#24037;&#20316;&#20013;&#35299;&#33073;&#20986;&#26469;&#65292;&#23601;&#26377;&#20102; DMA &#36825;&#20010;&#35774;&#22791;&#12290;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/dma.png" width="640px"></p>
<p class=" font-serif my-1">DMA &#35774;&#22791;&#21487;&#20197;&#30475;&#25104;&#26159;&#19968;&#20010;&#21482;&#33021;&#25191;&#34892; memcpy &#25805;&#20316;&#30340;&#22788;&#29702;&#22120;&#8212;&#8212;&#27809;&#38169;&#65281;&#20320;&#24403;&#28982;&#21487;&#20197;&#22312;&#31995;&#32479;&#20013;&#22686;&#21152;&#19968;&#20010; CPU &#26680;&#24515;&#65292;&#23427;&#19987;&#38376;&#36127;&#36131;&#35774;&#22791;&#21644;&#20869;&#23384;&#20043;&#38388;&#30340; <code>memcpy</code>&#12290;&#19981;&#36807;&#20320;&#19981;&#35273;&#24471;&#36825;&#26679;&#20351;&#29992;&#19968;&#20010;&#36890;&#29992;&#22788;&#29702;&#22120;&#22826;&#28010;&#36153;&#20102;&#21527;&#65311;&#27809;&#38169;&#8212;&#8212;&#20320;&#21487;&#20197;&#25226;&#23427;&#20570;&#24471;&#23567;&#19968;&#20123;&#65292;&#21482;&#35201;&#33021;&#25191;&#34892; <code>memcpy</code> &#23601;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// &#35774;&#22791;&#23492;&#23384;&#22120;&#65307;&#21487;&#20197;&#36890;&#36807;I/O&#36827;&#34892;&#35774;&#32622;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">incr_src</span><span class="p">,</span><span class="w"> </span><span class="n">incr_dst</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">do_dma</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// &#25910;&#21040;DMA&#24320;&#22987;&#25351;&#20196;&#21518;&#24320;&#22987;&#25191;&#34892;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#21487;&#20197;&#26159;PIO/MMIO; &#21487;&#20197;&#22312;&#35774;&#22791;-&#20869;&#23384;&#65307;&#20869;&#23384;-&#20869;&#23384;&#20043;&#38388;&#20256;&#36882;&#25968;&#25454;</span>
<span class="w">    </span><span class="n">src</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">incr_src</span><span class="p">;</span>
<span class="w">    </span><span class="n">dst</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">incr_dst</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">send_interrupt</span><span class="p">();</span><span class="w"> </span><span class="c1">// &#23436;&#25104;&#21518;&#21521;&#22788;&#29702;&#22120;&#21457;&#36865;&#20013;&#26029;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#26377;&#20102;&#36825;&#26679;&#30340;&#19968;&#20010;&#29305;&#27530;&#30340;&#35774;&#22791;&#65292;CPU&#23601;&#19981;&#20877;&#38656;&#35201;&#33457;&#36153;&#26102;&#38388;&#22312;&#20256;&#36865;&#22823;&#37327;I/O&#35774;&#22791;&#25968;&#25454;&#19978;&#65292;&#32780;&#26159;&#21482;&#38656;&#35201;&#20256;&#36865;&#23569;&#37327;&#25511;&#21046;&#25968;&#25454;(&#20363;&#22914;&#65292;&#32473;DMA&#35774;&#32622;<code>src</code>, <code>dst</code>&#31561;&#25968;&#20540;)&#12290;</p>
<h2 id="2" class=" text-xl mt-2 pb-2 font-sans">2. &#35774;&#22791;&#39537;&#21160;&#31243;&#24207;</h2>
<p class=" font-serif my-1">I/O &#35774;&#22791;&#20116;&#33457;&#20843;&#38376;&#12290;&#22240;&#27492;&#25805;&#20316;&#31995;&#32479;&#38656;&#35201;&#23545;&#35774;&#22791;&#36827;&#34892;&#39069;&#22806;&#30340;&#25277;&#35937;&#65292;&#20351;&#24471;&#26356;&#19978;&#23618;&#30340;&#37096;&#20998; (&#36890;&#24120;&#26159;&#25991;&#20214;&#31995;&#32479;&#65292;&#22823;&#23478;&#20043;&#21069;&#24050;&#32463;&#30475;&#21040; &#8220;everything is a file&#8221;&#65292;&#27599;&#20010;&#35774;&#22791;&#22312;&#25991;&#20214;&#31995;&#32479;&#20013;&#37117;&#26377;&#19968;&#20010;&#19982;&#20043;&#23545;&#24212;&#30340;&#25991;&#20214;&#65292;&#24182;&#19988;&#21487;&#20197;&#25191;&#34892;&#25991;&#20214;&#25805;&#20316;) &#33021;&#22815;&#20197;&#32479;&#19968;&#30340;&#25509;&#21475;&#35775;&#38382;&#36825;&#20123;&#35774;&#22791;&#12290;</p>
<p class=" font-serif my-1">I/O &#35774;&#22791;&#30340;&#20960;&#31181;&#24120;&#35265;&#31867;&#22411;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#25353;&#29031;&#23383;&#33410;&#27969;&#35775;&#38382;&#30340;&#35774;&#22791;&#12290;&#38190;&#30424;&#12289;&#40736;&#26631;&#12289;&#32456;&#31471;&#12289;&#26174;&#21345;&#31561;&#37117;&#26159;&#27492;&#31867;&#35774;&#22791;&#12290;</li>
<li class=" ml-8">&#25353;&#29031;&#8220;&#25968;&#25454;&#22359;&#8221;&#20026;&#21333;&#20301;&#35775;&#38382;&#30340;&#35774;&#22791;&#12290;&#23384;&#20648;&#35774;&#22791; (&#30913;&#30424;&#12289;SSD) &#26159;&#20856;&#22411;&#30340;&#22359;&#35774;&#22791;&#12290;</li>
<li class=" ml-8">&#21457;&#36865;&#32593;&#32476;&#25253;&#25991;&#30340;&#35774;&#22791;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#26681;&#25454;&#35774;&#22791;&#31867;&#22411;&#19981;&#21516;&#65292;&#25105;&#20204;&#32473;&#27599;&#19968;&#31867;&#35774;&#22791;&#20197;&#32479;&#19968;&#30340;&#25509;&#21475;&#35775;&#38382;&#65292;&#23454;&#29616;&#36825;&#20123;&#25509;&#21475;&#30340;&#23601;&#26159;&#35774;&#22791;&#39537;&#21160;&#31243;&#24207;&#12290;&#20363;&#22914;&#22312; Lab2 &#20013;&#65292;&#25105;&#20204;&#26377;&#38750;&#24120;&#31616;&#26131;&#30340;&#35774;&#22791;&#39537;&#21160;&#23618;&#65292;&#27599;&#20010;&#35774;&#22791;&#37117;&#26377; init, read, write &#19977;&#31181;&#25805;&#20316; (&#20551;&#35774;&#35774;&#22791;&#22312;&#35745;&#31639;&#26426;&#21551;&#21160;&#30340;&#25972;&#20010;&#36807;&#31243;&#20013;&#22343;&#21487;&#29992;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">devops</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">devops_t</span><span class="p">;</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#23454;&#38469;&#30340;&#31995;&#32479;&#20013;&#65292;&#35774;&#22791;&#23454;&#29616;&#30340;&#25805;&#20316;&#35201;&#26356;&#22810;&#19968;&#20123; (&#20363;&#22914; Linux &#31995;&#32479;&#35774;&#22791;&#23454;&#29616;&#23436;&#25972;&#30340; <code>struct file_operations</code>)&#65292;&#36825;&#26679;&#19978;&#23618;&#30340;&#24212;&#29992;&#23601;&#21487;&#20197;&#29992;&#32479;&#19968;&#30340;&#25509;&#21475;&#26469;&#35775;&#38382;&#35774;&#22791;&#20102;&#12290;</p>
<p class=" font-serif my-1">&#35774;&#22791;&#39537;&#21160;&#31243;&#24207;&#20250;&#23558;&#23545;&#36825;&#20123;&#25509;&#21475;&#30340;&#35843;&#29992;&#32763;&#35793;&#25104;&#35774;&#22791;&#30340;&#25351;&#20196;&#21457;&#36865;&#32473;&#35774;&#22791;&#65292;&#24182;&#31561;&#35774;&#22791;&#23436;&#25104;&#65292;&#22240;&#27492;&#65292;&#30913;&#30424;&#30340;read&#25805;&#20316;&#21487;&#33021;&#26159;&#36825;&#26679;&#23454;&#29616;&#30340;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">disk_read</span><span class="p">(</span><span class="n">deivce_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// assume everything is valid</span>
<span class="w">  </span><span class="n">P</span><span class="p">(</span><span class="n">disk_ready</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_disk_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">  </span><span class="n">P</span><span class="p">(</span><span class="n">disk_ready</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">on_disk_irq</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &#20013;&#26029;&#26102;&#35843;&#29992;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">did_becomes_ready</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">disk_ready</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#35774;&#22791;&#39537;&#21160;&#23618;&#24110;&#21161;&#25105;&#20204;&#23631;&#34109;&#20102;&#24213;&#23618;&#35774;&#22791;&#30340;&#20855;&#20307;&#23454;&#29616;&#32454;&#33410;(&#20363;&#22914;&#23492;&#23384;&#22120;&#30340;&#21547;&#20041;)&#12290;&#21516;&#29702;&#65292;&#22914;&#26524;&#25105;&#20204;&#24819;&#21019;&#24314;&#8220;&#34394;&#25311;&#8221;&#35774;&#22791;&#65292;&#20063;&#26159;&#38750;&#24120;&#23481;&#26131;&#30340;&#65292;&#21482;&#38656;&#35201;&#20026;&#23427;&#32534;&#20889;&#19968;&#20010;&#39537;&#21160;&#31243;&#24207;&#21363;&#21487;&#12290;&#20363;&#22914;&#25105;&#20204;&#24076;&#26395;&#23454;&#29616;&#38543;&#26426;&#25968;&#29983;&#25104;&#22120;&#35774;&#22791;&#65292;&#23601;&#21482;&#38656;&#35201;&#23454;&#29616;&#35774;&#22791;&#30340;&#35835;&#25509;&#21475;&#65292;&#19981;&#38656;&#35201;&#26377;&#23454;&#38469;&#30340;&#35774;&#22791;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">random_read</span><span class="p">(</span><span class="n">deivce_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">((</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random_byte</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">Linux&#31995;&#32479;&#20013;&#23601;&#26377;&#19968;&#20123;&#34394;&#25311;&#30340;&#35774;&#22791;&#65306;<code>/dev/random</code>, <code>/dev/null</code> &#26159;&#22823;&#23478;&#29087;&#30693;&#19988;&#32463;&#24120;&#20351;&#29992;&#30340;&#65292;&#23427;&#20204;&#34987;&#23454;&#29616;&#20026;&#20102; &#8220;&#23383;&#31526;&#35774;&#22791;&#8221;&#65292;&#25105;&#20204;&#29978;&#33267;&#21487;&#20197;&#22312; <code>ls</code> &#20013;&#30475;&#21040;&#36825;&#20010;&#35774;&#22791;&#25991;&#20214;&#30340;&#23646;&#24615;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ ls -l /dev/null
crw-rw-rw- 1 root root 1, 3 May 28 13:24 /dev/null
</code></pre></div>

<p class=" font-serif my-1">&#20320;&#33021;&#30693;&#36947; <code>ls</code> &#20351;&#29992;&#20102;&#21738;&#20010;&#31995;&#32479;&#35843;&#29992;&#33719;&#24471;&#20102;&#36825;&#20010;&#20449;&#24687;&#21527;&#65311;</p></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../../../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../../../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>