<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>&#24182;&#21457;&#25511;&#21046;&#65306;&#20114;&#26021; (1)</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="../../../index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="../../2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="1" class=" text-2xl mt-2 font-sans">&#24182;&#21457;&#25511;&#21046;&#65306;&#20114;&#26021; (1)</h1>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#26412;&#35762;&#38405;&#35835;&#26448;&#26009;</h4>
<p class=" font-serif my-1"><a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" class=" text-amber-900">&#25945;&#31185;&#20070; (Operating Systems: Three Easy Pieces, OSTEP)</a> &#31532; 28-29 &#31456;&#12290;&#35838;&#21518;&#23567;&#32451;&#20064;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#22312; <code>threads.h</code> &#19978;&#65292;&#20351;&#29992; <a href="https://github.com/remzi-arpacidusseau/ostep-code/tree/master/threads-locks" class=" text-amber-900"><code>compare-and-swap</code> (x86 &#25552;&#20379;&#30340; <code>cmpxchg</code> &#25351;&#20196;)</a> &#23454;&#29616;&#33258;&#26059;&#38145;&#26367;&#25442; <a href="../../../pages/OS/2021/demos/spinlock.c" class=" text-amber-900"><code>spinlock.c</code></a> &#20013;&#38145;&#30340;&#23454;&#29616;&#24182;&#27979;&#35797;&#12290;</li>
<li class=" ml-8">&#35774;&#35745;&#21512;&#29702;&#30340; fast/slow path&#65292;&#20351;&#29992; CPU-local &#32531;&#23384; + &#20840;&#23616;&#39029;&#38754;&#20998;&#37197;&#23436;&#25104; <a href="../labs/L1.html" class=" text-amber-900">L1 (pmm)</a> &#23454;&#39564;</li>
</ul>
</blockquote>
<h2 id="1_1" class=" text-xl mt-2 pb-2 font-sans">1. &#20114;&#26021;</h2>
<h3 id="11" class=" text-lg mt-2 pb-2 font-sans">1.1. &#20114;&#26021;&#30340;&#23450;&#20041;</h3>
<p class=" font-serif my-1">&#26377;&#20123;&#26102;&#20505;&#65292;&#25105;&#20204;&#24182;&#19981;&#24076;&#26395;&#20195;&#30721;&#24182;&#21457;&#8212;&#8212;&#24403;&#20004;&#20010; <code>sum++</code> &#21487;&#20197;&#24182;&#21457;&#25191;&#34892;&#26102;&#65292;&#32467;&#26524;&#24050;&#32463;&#36229;&#20986;&#20102;&#25105;&#20204;&#33021;&#22815;&#25484;&#25511;&#30340;&#33539;&#22260;&#12290;&#8220;&#20114;&#26021;&#38145;&#8221; (mutual exclusion, mutex) API &#24110;&#21161;&#25105;&#20204;&#23454;&#29616;&#36825;&#19968;&#28857;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span><span class="w"> </span><span class="n">lock_t</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">);</span><span class="w">   </span><span class="c1">// &#35797;&#22270;&#33719;&#24471;&#38145;&#30340;&#29420;&#21344;&#35775;&#38382;&#65292;&#25104;&#21151;&#33719;&#24471;&#21518;&#36820;&#22238;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">);</span><span class="w"> </span><span class="c1">// &#37322;&#25918;&#38145;&#30340;&#29420;&#21344;&#35775;&#38382;</span>
</code></pre></div>

<p class=" font-serif my-1">&#19981;&#22952;&#25226;&#32447;&#31243;&#24819;&#35937;&#25104;&#20154;&#65292;&#20195;&#30721;&#30340;&#25191;&#34892;&#23601;&#26159;&#20154;&#22312;&#29289;&#29702;&#19990;&#30028;&#20013;&#30340;&#34892;&#21160; (&#29289;&#29702;&#19990;&#30028;&#23601;&#26159;&#20849;&#20139;&#20869;&#23384;)&#12290;<code>lock_t</code> &#21487;&#20197;&#29702;&#35299;&#25104;&#26159;&#19968;&#20010; &#8220;&#38145;&#23545;&#35937;&#8221;&#65292;&#31867;&#20284;&#20110;&#21397;&#25152;&#37324;&#30340; &#8220;&#21253;&#38388;&#8221;&#8212;&#8212;&#19968;&#26086;&#25105;&#20204; (&#32447;&#31243;) &#36827;&#20837;&#65292;&#20854;&#20182;&#20154;&#23601;&#19981;&#24471;&#20877;&#36827;&#20837;&#12290;&#26356;&#24688;&#24403;&#30340;&#27604;&#26041; (&#31995;&#32479;&#20013;&#21487;&#20197;&#26377;&#24456;&#22810;&#38145;&#23545;&#35937;) &#26159;&#27599;&#19968;&#25226;&#38145;&#37117;&#26159;&#31995;&#32479;&#20013;&#21807;&#19968;&#30340;&#19968;&#20221; &#8220;&#35768;&#21487;&#8221;&#12290;&#24403;&#26377;&#22810;&#20010;&#20154; (&#20808;&#21518;&#25110;&#21516;&#26102;) &#24819;&#35201;&#33719;&#24471;&#35768;&#21487;&#26102;&#65292;&#21482;&#26377;&#19968;&#20010;&#20154;&#33021;&#24471;&#21040;&#23427;&#65292;&#24471;&#21040;&#30340;&#20154;&#21487;&#20197;&#32487;&#32493;&#65292;&#32780;&#20854;&#20182;&#24819;&#35201;&#35768;&#21487;&#30340;&#20154;&#21017;&#24517;&#39035;&#31561;&#24453;&#65292;&#30452;&#21040;&#24471;&#21040;&#35768;&#21487;&#30340;&#20154;&#23558;&#35768;&#21487;&#24402;&#36824; (&#19968;&#20010;&#20154;&#21487;&#20197;&#21516;&#26102;&#24471;&#21040;&#22810;&#20221;&#35768;&#21487;&#65292;&#21363;&#21487;&#20197;&#25345;&#26377;&#22810;&#25226;&#38145;)&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_2" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#20114;&#26021;&#30340;&#23450;&#20041;</h4>
<p class=" font-serif my-1">&#26356;&#20005;&#35880;&#22320;&#35828;&#65292;lock/unlock&#65292;&#20445;&#35777;<red>&#22312;&#20219;&#20309;&#21487;&#33021;&#30340;&#32447;&#31243;&#35843;&#24230;&#19979;</red>&#65292;&#33509;&#26576;&#20010;&#32447;&#31243;&#25345;&#26377;&#38145; (<code>lock(lk)</code> &#36820;&#22238;&#19988;&#26410;&#37322;&#25918;)&#65292;&#21017;&#20219;&#20309;&#20854;&#20182;&#32447;&#31243;&#30340; <code>lock(lk)</code> &#37117;&#19981;&#33021;&#36820;&#22238;&#12290;&#20174;&#29366;&#24577;&#26426;&#30340;&#35270;&#35282;&#65292;&#20551;&#35774;&#31995;&#32479;&#27599;&#27425;&#36873;&#25321;&#19968;&#20010;&#32447;&#31243;&#25191;&#34892;&#19968;&#26465;&#25351;&#20196; (&#34429;&#28982;&#36825;&#20010;&#20551;&#35774;&#24182;&#19981;&#20005;&#26684;&#25104;&#31435;)&#65292;&#25105;&#20204;&#35748;&#20026; <code>lock(lk)</code> &#36820;&#22238;&#26102;&#65292;&#32447;&#31243;&#23601;&#36827;&#20837;&#20102; &#8220;&#25345;&#26377; <code>lk</code>&#8221; &#30340;&#29366;&#24577;&#12290;&#32780;&#20174;&#21021;&#22987;&#29366;&#24577;&#24320;&#22987;&#65292;&#19981;&#23384;&#22312;&#20219;&#20309;&#29366;&#24577;&#26426;&#30340;&#25191;&#34892;&#36335;&#24452;&#65292;&#20351;&#24471;&#20004;&#20010;&#32447;&#31243;&#21516;&#26102;&#25345;&#26377; <code>lk</code>&#12290;</p>
</blockquote>
<h3 id="12" class=" text-lg mt-2 pb-2 font-sans">1.2. &#20114;&#26021;&#38145;&#30340;&#20351;&#29992;</h3>
<p class=" font-serif my-1">&#20114;&#26021;&#38145;&#30340;&#20351;&#29992;&#24456;&#31616;&#21333;&#65292;&#20320;&#21487;&#20197;&#25226;&#19968;&#27573;&#20195;&#30721;&#29992; lock-unlock &#21253;&#35065;&#36215;&#26469;&#65292;&#23427;&#23601;&#19981;&#20877;&#20250;&#21644;&#20854;&#20182;&#25345;&#26377;&#21516;&#19968;&#25226;&#38145;&#30340;&#32447;&#31243;&#24182;&#21457;&#12290;&#20363;&#22914;&#65292;&#22914;&#26524;&#20320;&#20026; <code>withdraw</code> &#19978;&#20102;&#38145;&#65292;&#37027;&#20040;&#22810;&#20010;&#32447;&#31243;&#23601;&#21487;&#20197;&#23433;&#20840;&#22320;&#25191;&#34892; <code>withdraw</code>&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">withdraw</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FAIL</span><span class="p">;</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deposit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deposit</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#27492;&#22806;&#65292;&#20320;&#21487;&#20197;&#29992;&#21516;&#19968;&#25226;&#38145;&#20445;&#25252;&#21478;&#19968;&#20010;&#20989;&#25968;&#65292;&#36825;&#26679;&#21487;&#20197;&#38459;&#27490; <code>withdraw</code> &#21644; <code>deposit</code> &#20043;&#38388;&#30340;&#24182;&#21457;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">deposit</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#30475;&#20284;&#31616;&#21333;&#65311;&#20889;&#20195;&#30721;&#21487;&#24471;&#21315;&#19975;&#23567;&#24515;&#65292;&#20363;&#22914;&#19979;&#38754;&#30340;&#20195;&#30721;&#23601;&#26377; bug (&#20320;&#21457;&#29616;&#20102;&#21527;)&#65311;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">withdraw_buggy</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deposit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deposit</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">FAIL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#34429;&#28982;&#19978;&#38754;&#30340;&#20195;&#30721;&#21151;&#33021;&#30475;&#36215;&#26469;&#27809;&#38382;&#39064;&#65292;&#20294;&#22312; <code>withdraw</code> &#25104;&#21151;&#36820;&#22238;&#30340;&#26102;&#20505;&#30452;&#25509; return &#24536;&#35760;&#37322;&#25918; <code>bank_lock</code>&#8212;&#8212;&#36825;&#21487;&#26159;&#20010;&#38750;&#24120;&#20005;&#37325;&#30340;&#38382;&#39064;&#12290;C &#35821;&#35328;&#26356;&#20687;&#26159;&#27719;&#32534;&#65292;&#24182;&#19981;&#38750;&#24120;&#36866;&#21512;&#34920;&#36798;&#20154;&#31867;&#23545;&#20195;&#30721;&#30340;&#35748;&#35782;&#8212;&#8212;&#29616;&#20195;&#35821;&#35328;&#22312;&#36825;&#19968;&#28857;&#19978;&#20570;&#24471;&#22909;&#24471;&#22810;&#65292;&#25903;&#25345; RAII (Resource Acquisition Is Initialization)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HoldLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock_</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">HoldLock</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">lock_</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span><span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="o">~</span><span class="n">HoldLock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#32534;&#35793;&#22120;&#20250;&#24110;&#21161;&#25105;&#20204;&#20445;&#35777;&#22312;&#20989;&#25968;&#35843;&#29992;&#26102;&#19978;&#38145;&#12289;&#20989;&#25968;&#36820;&#22238;&#26102;&#35299;&#38145;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">withdraw_raii</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">HoldLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bank_lock</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deposit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deposit</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">FAIL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#20123;&#35774;&#35745;&#22823;&#24133;&#22686;&#21152;&#20102;&#20195;&#30721;&#30340;&#23433;&#20840;&#24615;&#21644;&#21487;&#38752;&#24615; (&#24403;&#28982;&#36824;&#26377;&#23545;&#23433;&#20840;&#24615;&#35774;&#35745;&#30340;&#26356;&#24443;&#24213;&#30340;&#35821;&#35328;&#65292;&#20363;&#22914; Rust&#65292;&#25105;&#20204;&#24456;&#21487;&#33021;&#20250;&#22312;&#26410;&#26469;&#25226;&#25805;&#20316;&#31995;&#32479;&#35838;&#30340;&#19968;&#37096;&#20998;&#36801;&#21040; Rust &#19978;)&#65292;&#20294;&#19968;&#23450;&#31243;&#24230;&#19978;&#22686;&#21152;&#20102;&#25105;&#20204;&#30452;&#25509;&#25226;&#20195;&#30721;&#26144;&#23556;&#21040;&#26426;&#22120;&#25351;&#20196;&#26102;&#30340;&#38405;&#35835;&#22256;&#38590;&#12290;</p>
<h2 id="2" class=" text-xl mt-2 pb-2 font-sans">2. &#23454;&#29616;&#20114;&#26021;&#30340;&#25361;&#25112;</h2>
<h3 id="21-peterson" class=" text-lg mt-2 pb-2 font-sans">2.1. Peterson &#31639;&#27861;</h3>
<p class=" font-serif my-1">&#22312;&#20043;&#21069;&#30340;&#35838;&#19978;&#65292;&#25105;&#20204;&#32473;&#20986;&#20102;&#19968;&#20010;&#33021;&#22815;&#23454;&#29616;&#20004;&#20010;&#32447;&#31243;&#20114;&#26021;&#30340; Peterson &#31639;&#27861;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">turn</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">T2</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="c1">// critical section</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T1</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">T1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="c1">// critical section</span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#22823;&#23478;&#24212;&#35813;&#36824;&#35760;&#24471;&#25105;&#20204;&#22312;&#35838;&#22530;&#19978;&#29992;&#25163;&#24037; (&#21644;&#29992; model checker) &#35777;&#26126;&#20102;&#23427;&#30340;&#27491;&#30830;&#24615; (&#20004;&#20010;&#32447;&#31243;&#19981;&#33021;&#21516;&#26102;&#36827;&#20837;&#20020;&#30028;&#21306;)&#12290;</p>
<h3 id="22-peterson" class=" text-lg mt-2 pb-2 font-sans">2.2. Peterson &#31639;&#27861;&#65306;&#27700;&#38754;&#19979;&#30340;&#20912;&#23665;</h3>
<p class=" font-serif my-1">&#20294;&#26159;&#65292;Peterson &#31639;&#27861; (&#20195;&#30721;&#23454;&#29616;) &#30340;&#27491;&#30830;&#24615;&#26159;&#26377;&#20551;&#35774;&#30340;&#8212;&#8212;Model checking &#20043;&#25152;&#20197;&#31216;&#20043;&#20026; model checking&#65292;&#26159;&#22240;&#20026;&#25105;&#20204;&#20570;&#20986;&#20102;&#19968;&#20010;&#38750;&#24120;&#37325;&#35201;&#30340;&#31616;&#21270;&#65306;&#25105;&#20204;&#30340;&#35777;&#26126;&#22522;&#20110; <red>&#8220;&#27599;&#27425;&#36873;&#25321;&#19968;&#20010;&#32447;&#31243;&#25191;&#34892;&#19968;&#26465;&#35821;&#21477;&#8221; &#30340;&#26426;&#22120;&#27169;&#22411;</red>&#12290;Peterson &#31639;&#27861;&#20195;&#30721;&#23454;&#29616;&#30340;&#27491;&#30830;&#24615;&#36824;&#20381;&#36182;&#20110;<red>&#25105;&#20204;&#23454;&#38469;&#36816;&#34892;&#23427;&#30340;&#35745;&#31639;&#26426;&#31995;&#32479;&#30340;&#34892;&#20026;&#19982;&#36825;&#20010;&#27169;&#22411;&#31561;&#20215;</red>&#12290;</p>
<p class=" font-serif my-1">&#36951;&#25022;&#30340;&#26159;&#65292;&#25105;&#20204;&#37117;&#30693;&#36947;&#29616;&#20195;&#22810;&#22788;&#29702;&#22120;&#31995;&#32479;&#20026;&#20102;&#39034;&#24207;&#31243;&#24207;&#25191;&#34892;&#30340;&#36895;&#24230;&#65292;&#36890;&#24120;&#20351;&#29992;&#20102; store buffer&#12289;&#22810;&#32423;&#32531;&#23384;&#12289;&#20081;&#24207;&#25191;&#34892;&#30340;&#35774;&#35745;&#12290;&#22312;&#36825;&#20123;&#26426;&#21046;&#30340;&#20849;&#21516;&#20316;&#29992;&#19979;&#65292;&#25105;&#20204;&#23601;&#26377;&#20102; &#8220;&#24182;&#21457;&#32534;&#31243;&#65306;&#20174;&#20837;&#38376;&#21040;&#25918;&#24323;&#8221; &#20013;&#30340;&#20363;&#23376;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">x_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">y_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">      </span><span class="c1">// store(x)</span>
<span class="w">  </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="n">y_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">  </span><span class="c1">// load(y)</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">      </span><span class="c1">// store(y)</span>
<span class="w">  </span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="n">x_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">  </span><span class="c1">// load(x)</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">check_result</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">x_val</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y_val</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">          </span><span class="p">(</span><span class="n">x_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="c1">// assert fail: x_val == 0 &amp;&amp; y_val == 0</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#20320;&#35835;&#23436;&#19978;&#38754;&#30340;&#20195;&#30721;&#21518;&#65292;&#20877;&#22238;&#26469;&#30475; Peterson &#31639;&#27861; (&#25105;&#20204;&#25552;&#20379;&#20102;&#19968;&#20010; <a href="../../../pages/OS/2021/demos/peterson.c" class=" text-amber-900">peterson.c</a>)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">turn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">turn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">T2</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#19981;&#23601;&#26159;&#19978;&#38754;&#30340;&#20363;&#23376;&#21527;&#65311;&#20808;&#20889;&#20837; <code>x</code> &#21644; <code>turn</code>&#65292;&#28982;&#21518;&#35835; <code>y</code>&#8230;&#8230;&#25152;&#20197;&#20320;&#39044;&#26399; <code>y</code> &#30340; load &#21487;&#20197;&#34987;&#25552;&#21069;&#21040;&#20004;&#20010; store &#20043;&#21069;&#65292;&#23545;&#21478;&#19968;&#20010;&#32447;&#31243;&#20063;&#26159;&#8230;&#8230;&#36825;&#19981;&#23601;&#38169;&#20102;&#8230;&#8230;&#21527;&#65311;&#12290;&#27809;&#38169;&#65281;&#20320;&#24212;&#35813;&#30041;&#24847;&#21040;&#25105;&#20204;&#22312;&#20195;&#30721;&#20013;&#22686;&#21152;&#20102;&#24456;&#22810; &#8220;&#26629;&#26639;&#8221;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define FENCE asm volatile ("mfence")</span>
</code></pre></div>

<p class=" font-serif my-1"><red>&#22914;&#26524;&#25226; fences &#21024;&#38500;&#65292;&#20320;&#23558;&#20250;&#22312;&#31243;&#24207;&#36816;&#34892;&#19968;&#27573;&#26102;&#38388;&#20197;&#21518;&#30475;&#21040; assert fail &#30340;&#35302;&#21457;</red>&#12290;&#31616;&#21333;&#26469;&#35828;&#65292;&#23601;&#26159; Peterson &#31639;&#27861;&#38500;&#38750;&#20511;&#21161;&#19968;&#20123;&#25351;&#20196;&#38598;&#30340;&#24110;&#21161;&#65292;&#22312;&#20170;&#22825;&#30340;&#35745;&#31639;&#26426;&#31995;&#32479;&#19978;&#26080;&#27861;&#30452;&#25509;&#23454;&#29616;&#12290;</p>
<h3 id="23-memory-model" class=" text-lg mt-2 pb-2 font-sans">2.3. &#20869;&#23384;&#27169;&#22411; (Memory Model)</h3>
<p class=" font-serif my-1">&#26082;&#28982;&#25105;&#20204;&#30340;&#26426;&#22120;&#19981;&#31526;&#21512; (&#36807;&#24230;) &#31616;&#21270;&#30340; &#8220;&#39034;&#24207;&#8221; &#27169;&#22411; (&#20063;&#31216;&#20026; sequential consistency)&#12290;&#19979;&#22270;&#26159;&#31526;&#21512; x86 &#22788;&#29702;&#22120;&#23454;&#38469;&#34892;&#20026;&#30340;&#19968;&#20010;&#27169;&#22411; (&#26377;&#20852;&#36259;&#30340;&#21516;&#23398;&#21487;&#20197;&#21442;&#32771; x86-TSO &#30340;&#35770;&#25991; &#8220;<a href="https://cacm.acm.org/magazines/2010/7/95048-x86-tso-a-rigorous-and-usable-programmers-model-for-x86-multiprocessors/fulltext" class=" text-amber-900">x86-TSO: A rigorous and &#173;usable programmer's model for x86 multiprocessors</a>&#8221;)&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/2021/slides/img/x86-tso.png" width="400px"></p>
<p class=" font-serif my-1">&#27492;&#22806;&#65292;ARMv8 &#30340; <a href="https://developer.arm.com/documentation/102376/latest/" class=" text-amber-900">memory model</a> &#20063;&#26159;&#24456;&#19981;&#38169;&#30340;&#25991;&#26723;&#12290;&#22312;&#30828;&#20214;&#35268;&#23450;&#30340;&#22522;&#30784;&#19978;&#65292;&#31243;&#24207;&#35774;&#35745;&#35821;&#35328;&#20063;&#21516;&#26679;&#23450;&#20041;&#20102;&#20174; &#8220;&#30452;&#25509;&#35299;&#37322;&#31243;&#24207;&#25191;&#34892;&#8221; &#24847;&#20041;&#19978;&#30340;&#24182;&#21457;&#34892;&#20026; (&#22823;&#23478;&#24212;&#35813;&#36824;&#35760;&#24471;&#25105;&#20204;&#22312;&#32534;&#20889;&#38750;&#36882;&#24402;&#30340; Tower of Hanoi &#20195;&#30721;&#26102;&#65292;&#29992;&#21040;&#20102; C &#35821;&#35328;&#30340;&#25805;&#20316;&#35821;&#20041;&#27169;&#22411;)&#65292;&#20363;&#22914; C/C++11 Memory Model &#21644; Java Memory Model&#12290;</p>
<p class=" font-serif my-1">&#24635;&#30340;&#26469;&#35828;&#65292;&#36825;&#20123;&#35805;&#39064;&#24182;&#19981;&#36866;&#21512;&#22312;&#36825;&#38376;&#35838;&#19978;&#35752;&#35770;&#12290;&#22823;&#23478;&#38656;&#35201;&#35760;&#20303;&#30340;&#26159;&#65306;<red>&#20114;&#26021;&#23601;&#26159;&#20026;&#20102;&#31616;&#21270;&#22823;&#23478;&#23545;&#20869;&#23384;&#27169;&#22411;&#30340;&#29702;&#35299;&#32780;&#29983;&#30340;</red>&#12290;</p>
<h3 id="24" class=" text-lg mt-2 pb-2 font-sans">2.4. &#25968;&#25454;&#31454;&#20105;</h3>
<p class=" font-serif my-1">&#38750;&#27491;&#24335;&#22320;&#35828;&#65292;&#25968;&#25454;&#31454;&#20105;&#23601;&#26159;&#20004;&#20010; &#8220;<red>&#21516;&#26102;&#21457;&#29983;</red>&#8221; &#30340;&#20849;&#20139;&#20869;&#23384;&#35775;&#38382;&#65292;&#20854;&#20013;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">&#23427;&#20204;&#20301;&#20110;&#19981;&#21516;&#30340;&#32447;&#31243;&#65307;</li>
<li class=" ml-8">&#23427;&#20204;&#35775;&#38382;&#20102;&#21516;&#19968;&#20010;&#20869;&#23384;&#22320;&#22336;&#65307;</li>
<li class=" ml-8">&#23427;&#20204;&#20013;&#33267;&#23569;&#26377;&#19968;&#20010;&#26159;&#20889;&#12290;</li>
</ol>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/race.jpg" width="400px"></p>
<p class=" font-serif my-1">&#25152;&#35859; &#8220;&#31454;&#20105;&#8221;&#65292;&#20004;&#20010;&#21487;&#20197;&#21516;&#26102;&#21457;&#29983;&#30340;&#20849;&#20139;&#20869;&#23384;&#35775;&#38382;&#21487;&#33021;&#21457;&#29983; &#8220;&#36187;&#36305;&#8221;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">do_something</span><span class="p">();</span>
<span class="w">  </span><span class="k">else</span><span class="w">        </span><span class="n">do_something_else</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#26681;&#25454;&#20004;&#20010;&#32447;&#31243;&#20849;&#20139;&#20869;&#23384;&#35775;&#38382; &#8220;&#21521;&#21069;&#36305;&#8221; &#30340;&#36895;&#24230;&#65292;&#36305;&#24471;&#24555;&#30340;&#35775;&#38382;&#23558;&#20808;&#34987;&#25191;&#34892;&#12290;&#22240;&#27492;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#25353;&#29031; $T_1 \to T_2$ &#30340;&#39034;&#24207;&#25191;&#34892;&#65292;load &#23558;&#20250;&#24471;&#21040; $t = 0$&#65292;</li>
<li class=" ml-8">&#25353;&#29031; $T_2 \to T_1$ &#30340;&#39034;&#24207;&#25191;&#34892;&#65292;load &#23558;&#20250;&#24471;&#21040; $t = 1$&#12290;</li>
</ul>
<p class=" font-serif my-1">&#36825;&#23601;&#26159;&#20026;&#20160;&#20040;&#25968;&#25454;&#31454;&#20105;&#20013;&#30340;&#20869;&#23384;&#35775;&#38382;&#33267;&#23569;&#26377;&#19968;&#20010;&#20250;&#26159;&#20889;&#8212;&#8212;&#20889;&#25805;&#20316;&#20250;&#23545;&#31995;&#32479;&#29366;&#24577;&#20135;&#29983;&#24433;&#21709;&#65292;&#20174;&#32780;&#24341;&#21457;&#24494;&#22937;&#30340;&#21518;&#26524;&#65306;&#36890;&#24120;&#25105;&#20204;&#30340;&#31243;&#24207;&#20013;&#21487;&#33021;&#20250;&#36830;&#32493;&#36827;&#34892;&#22810;&#27425;&#20869;&#23384;&#35775;&#38382;&#65292;&#20363;&#22914;&#20043;&#21069; <code>withdraw</code> &#30340;&#20363;&#23376;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deposit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">deposit</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#23545;&#20110;&#32447;&#31243;&#26469;&#35828;&#65292;&#23427;&#20250;&#25191;&#34892; &#8220;&#35835;&#20313;&#39069;&#8221; &#8594; &#8220;&#21028;&#26029;&#20313;&#39069;&#26159;&#21542;&#19981;&#36275;&#8221; &#8594; &#8220;&#26356;&#26032;&#20313;&#39069;&#8221; &#19977;&#20214;&#20107;&#12290;&#22914;&#26524;&#21457;&#29983;&#25968;&#25454;&#31454;&#20105;&#65292;&#37027;&#20040;&#25105;&#20204;&#22312; &#8220;&#21028;&#26029;&#20313;&#39069;&#26159;&#21542;&#19981;&#36275;&#8221; &#26102;&#65292;&#25152;&#29992;&#30340;&#20313;&#39069;&#25968;&#20540;&#23601;&#19981;&#20877;&#26159;&#24403;&#21069;&#26368;&#26032;&#30340;&#25968;&#20540;&#65292;&#23548;&#33268;&#36923;&#36753;&#38169;&#35823;&#12290;&#19968;&#27573;&#20195;&#30721;&#21487;&#33021;&#34987;&#25171;&#26029;&#24182;&#23384;&#22312; &#8220;&#22810;&#31181;&#36816;&#34892;&#32467;&#26524;&#8221;&#65292;&#21152;&#19978;&#22788;&#29702;&#22120;&#21487;&#33021;&#20081;&#24207;&#25191;&#34892;&#20869;&#23384;&#35775;&#38382;&#65292;&#25968;&#25454;&#31454;&#20105;&#30340;&#21518;&#26524;&#26159;&#38750;&#24120;&#21361;&#38505;&#30340;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="ub" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#31616;&#32780;&#35328;&#20043;&#65292;&#25968;&#25454;&#31454;&#20105; = UB</h4>
<p class=" font-serif my-1">&#25105;&#20204;&#19981;&#22952;&#25226;&#25968;&#25454;&#31454;&#20105;&#23450;&#20041;&#25104; undefined behavior&#65292;&#31243;&#24207;&#19968;&#26086;&#20986;&#29616;&#25968;&#25454;&#31454;&#20105;&#65292;&#20043;&#21518; &#8220;&#21457;&#29983;&#20219;&#20309;&#20107;&#8221; &#37117;&#34987;&#35748;&#20026;&#26159;&#21487;&#33021;&#30340;&#12290;&#25968;&#25454;&#31454;&#20105;&#22312;&#26412;&#23398;&#26399;&#30340;&#32534;&#31243;&#20013;&#32477;&#23545;&#31105;&#27490;&#12290;&#24456;&#24555;&#20320;&#20204;&#23601;&#20250;&#22312;&#25805;&#20316;&#31995;&#32479;&#23454;&#39564;&#20013;&#36935;&#21040;&#25968;&#25454;&#31454;&#20105;&#24341;&#21457;&#30340;&#33268;&#21629; bug&#8212;&#8212;&#28982;&#21518;&#23601;&#20250;&#20307;&#20250;&#21040;&#36825;&#20010;&#23450;&#20041;&#30340;&#33391;&#33510;&#29992;&#24515;&#12290;</p>
<p class=" font-serif my-1">&#37027;&#20040;&#20160;&#20040;&#21487;&#20197;&#38459;&#27490;&#25968;&#25454;&#31454;&#20105;&#21602;&#65311;<red>&#20114;&#26021;</red>&#65281;&#22823;&#23478;&#19981;&#22952;&#22238;&#21040;&#20114;&#26021;&#30340;&#23450;&#20041;&#12290;&#34987;&#21516;&#19968;&#25226;&#38145;&#20445;&#25252;&#30340;&#20004;&#26465;&#25351;&#20196;&#65292;&#26159;&#32477;&#23545;&#19981;&#21487;&#33021; &#8220;&#21516;&#26102;&#21457;&#29983;&#8221; &#30340;&#12290;&#24403;&#28982;&#20102;&#65292;&#21018;&#25165;&#30340; Peterson &#31639;&#27861;&#37324;&#26412;&#36523;&#23601;&#26377;&#25968;&#25454;&#31454;&#20105;&#8230;&#8230;</p>
</blockquote>
<h2 id="3" class=" text-xl mt-2 pb-2 font-sans">3. &#23454;&#29616;&#20114;&#26021;</h2>
<h3 id="31" class=" text-lg mt-2 pb-2 font-sans">3.1. &#38382;&#39064;&#20998;&#26512;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#23545;&#20114;&#26021;&#38145; (lock/unlock) &#30340;&#39069;&#22806;&#26399;&#26395;&#26159;&#33021;&#25937;&#22238;&#22810;&#22788;&#29702;&#22120;&#20849;&#20139;&#20869;&#23384;&#31243;&#24207;&#19978;&#30340;&#21407;&#23376;&#24615;&#12289;&#39034;&#24207;&#21644;&#21487;&#35265;&#24615; (&#24403;&#28982;&#26159;&#20381;&#38752;&#30828;&#20214;&#25552;&#20379;&#30340;&#26426;&#21046;&#23454;&#29616;)&#8212;&#8212;&#25105;&#20204;&#24076;&#26395;&#21516;&#19968;&#20010; lock/unlock &#20445;&#25252;&#30340;&#19968;&#27573;&#20195;&#30721;&#25191;&#34892; (&#21487;&#20197;&#22312;&#29366;&#24577;&#26426;&#19978;&#26631;&#20986;) &#26159;&#19981;&#21487;&#20998;&#21106;&#30340; &#8220;&#30418;&#23376;&#8221;&#12290;&#38459;&#27490; &#8220;&#30418;&#23376;&#8221; &#24182;&#21457;&#24847;&#21619;&#30528;&#22914;&#26524;&#25105;&#20204;&#32771;&#34385;&#29366;&#24577;&#26426;&#19978;&#30340;&#25152;&#26377;&#36335;&#24452;&#65292;&#30418;&#23376;&#30340;&#25191;&#34892;&#37117;&#33021;&#25490;&#20986;&#19968;&#20010;&#39034;&#24207; (&#32780;&#19981;&#33021;&#24182;&#21457;&#25191;&#34892;)&#65306;</p>
<p class=" font-serif my-1">&#20363;&#22914;&#65292;&#20004;&#20010;&#30418;&#23376; ($B_1$ &#21644; $B_2$) &#35201;&#20040;&#25353;&#29031; $B_1 \to B_2$ &#30340;&#39034;&#24207;&#25191;&#34892;&#65292;&#35201;&#20040;&#25353;&#29031; $B_2 \to B_1$ &#25191;&#34892;&#12290;&#36825;&#28385;&#36275;&#20102;&#25105;&#20204; &#8220;<red>&#21407;&#23376;&#24615;</red>&#8221; &#30340;&#35201;&#27714;&#12290;&#38500;&#27492;&#20043;&#22806;&#65292;&#25105;&#20204;&#36824;&#39069;&#22806;&#22320; (&#22312;&#26426;&#22120;&#25191;&#34892;&#30340;&#24847;&#20041;&#19978;) &#35201;&#27714;&#28385;&#36275;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><red>&#39034;&#24207;</red>&#65306;&#30418;&#23376;&#20013;&#23545;&#20849;&#20139;&#20869;&#23384;&#30340;&#20081;&#24207;&#35835;&#20889;&#19981;&#33021;&#36234;&#36807; <code>lock</code>/<code>unlock</code> &#30340;&#36793;&#30028;&#65292;&#36825;&#38480;&#21046;&#20102;&#23454;&#38469;&#22788;&#29702;&#22120;&#25191;&#34892;&#25351;&#20196;&#26102;&#30340;&#20081;&#24207;&#34892;&#20026;&#21482;&#33021;&#22312;&#30418;&#23376; (&#21516;&#19968;&#20010;&#32447;&#31243;) &#20013;&#21457;&#29983;&#12290;</li>
<li class=" ml-8"><red>&#21487;&#35265;&#24615;</red>&#65306;&#22914;&#26524;&#20004;&#20010;&#30418;&#23376;&#25353;&#29031; $B_1 \to B_2$ &#30340;&#39034;&#24207;&#25191;&#34892;&#65292;&#37027;&#20040; $B_1$ &#20013;&#25152;&#26377;&#30340;&#20889;&#25805;&#20316;&#65292;&#37117;&#24517;&#39035;&#22312; $B_2$ &#20013;&#21487;&#35265;&#65292;&#21453;&#20043;&#20134;&#28982;&#12290;&#36825;&#20445;&#35777;&#20102;&#30418;&#23376;&#20043;&#38388;&#20849;&#20139;&#20869;&#23384;&#35775;&#38382;&#30340;&#21487;&#35265;&#24615;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#24403;&#28982;&#38459;&#27490; &#8220;&#25351;&#20196;&#25191;&#34892;&#30340;&#20081;&#24207;&#8221; &#21644; &#8220;&#30830;&#20445;&#25351;&#20196;&#25928;&#26524;&#30340;&#21487;&#35265;&#24615;&#8221; &#36825;&#20004;&#20214;&#20107;&#22312; &#8220;&#20849;&#20139;&#20869;&#23384;&#8221; &#30340;&#29366;&#24577;&#26426;&#27169;&#22411;&#20013;&#21387;&#26681;&#23601;&#27809;&#26377;&#23450;&#20041;&#36807;&#21834;&#65281;&#27492;&#22806;&#65292;&#22312;&#29616;&#20195;&#22810;&#22788;&#29702;&#22120;&#31995;&#32479;&#19978;&#32431;&#31929;&#20351;&#29992; load/store &#25351;&#20196;&#23454;&#29616;&#20114;&#26021;&#26159; (&#29702;&#35770;&#19978;) &#19981;&#21487;&#33021;&#30340;&#65306;Consensus Number &#23567;&#30340;&#25805;&#20316; (&#20363;&#22914; load/store) &#23454;&#29616;&#26356;&#22797;&#26434;&#30340;&#25805;&#20316; (&#20363;&#22914;&#24182;&#21457;&#38431;&#21015;) &#26681;&#26412;&#23601;&#26159;&#19981;&#21487;&#33021;&#30340;&#65281;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Maurice Herlihy. Wait-free synchronization. <em>ACM Transactions on Programming Languages and Systems</em>, 11(1), 124-149, 1991.</li>
</ul>
<h3 id="32" class=" text-lg mt-2 pb-2 font-sans">3.2. &#36719;&#20214;&#19981;&#22815;&#65292;&#30828;&#20214;&#26469;&#20945;</h3>
<p class=" font-serif my-1">&#20107;&#21040;&#22914;&#20170;&#65292;&#38382;&#39064;&#21453;&#32780;&#31616;&#21333;&#20102;&#8212;&#8212;&#25105;&#20204;<red>&#24443;&#24213;&#25918;&#24323;&#22312;&#36719;&#20214;&#19978;&#25552;&#20986;&#24039;&#22937;&#30340;&#31639;&#27861;&#26469;&#35299;&#20915;&#20114;&#26021;&#38382;&#39064;</red>&#65292;&#19981;&#22914;&#23601;&#35753;&#30828;&#20214;&#24110;&#25105;&#20204;&#25552;&#20379;&#19968;&#26465;&#26032;&#30340;&#25351;&#20196;&#65292;&#33021;&#24110;&#25105;&#20204;&#23454;&#29616; &#8220;&#21407;&#23376;&#8221; &#30340;&#25805;&#20316;&#65292;&#21516;&#26102;&#24110;&#21161;&#25105;&#20204;&#20445;&#35777;&#25351;&#20196;&#25191;&#34892;&#30340;&#39034;&#24207;&#21644;&#20869;&#23384;&#30340;&#21487;&#35265;&#24615;&#12290;</p>
<p class=" font-serif my-1">&#35831;&#22823;&#23478;&#38405;&#35835;&#25945;&#31185;&#20070; 28 &#31456;&#20851;&#20110;&#21407;&#23376;&#25351;&#20196;&#20197;&#21450;&#22914;&#20309;&#29992;&#21407;&#23376;&#25351;&#20196;&#23454;&#29616;&#22522;&#20110;&#33258;&#26059;&#30340;&#20114;&#26021;&#38145;&#12290;&#25105;&#20204;&#22312;&#36825;&#37324;&#35201;&#34917;&#20805;&#30340;&#26159;&#65292;&#21407;&#23376;&#25351;&#20196;&#19981;&#20165;&#33021;&#38459;&#27490;&#25351;&#20196;&#20081;&#24207;&#65292;&#36824;&#21487;&#20197;&#30830;&#20445;&#25351;&#20196;&#30340;&#25928;&#26524;&#22312;&#22810;&#22788;&#29702;&#22120;&#20043;&#38388;&#21487;&#35265;&#12290;</p>
<h3 id="33" class=" text-lg mt-2 pb-2 font-sans">3.3. &#20114;&#26021;&#38145;&#65306;&#20026;&#25105;&#20204;&#25552;&#20379;&#30340;&#20445;&#35777;</h3>
<p class=" font-serif my-1">&#20511;&#21161;&#21407;&#23376;&#25351;&#20196;&#65292;&#23545;&#20110;&#25353;&#26102;&#38388;&#39034;&#24207;&#30340;&#30418;&#23376;&#25191;&#34892; $B_1 \to B_2$&#65292;&#20551;&#35774; $B_1$ &#20013;&#26377;&#23545; <code>x</code> &#30340;&#20889;&#65292;$B_2$ &#20013;&#26377;&#23545; <code>x</code> &#30340;&#35835;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$B_1$ &#20869;&#37096; <code>store(x)</code> &#21487;&#33021;&#34987;&#20081;&#24207;&#25191;&#34892; (&#30001;&#22788;&#29702;&#22120;&#20445;&#35777; $B_1$ &#20869;&#37096; <code>load(x)</code> &#30340;&#19968;&#33268;&#24615;)&#65292;&#20294;&#19981;&#33021;&#36234;&#36807; <code>unlock</code> &#20013;&#30340; <code>xchg</code>&#65307;</li>
<li class=" ml-8">$B_2$ &#20013;&#65292;<code>load(x)</code> &#21487;&#33021;&#34987;&#20081;&#24207;&#25191;&#34892; (&#21516;&#29702; $B_2$ &#20869;&#37096;&#30340;&#19968;&#33268;&#24615;&#30001;&#22788;&#29702;&#22120;&#20445;&#35777;)&#65292;&#20294;&#19981;&#33021;&#36234;&#36807; <code>lock</code> &#20013;&#30340; <code>xchg</code>&#65307;</li>
<li class=" ml-8">&#22312; $B_1$ &#20013; <code>unlock</code> &#20013;&#30340; <code>xchg</code> &#23436;&#25104;&#21069;&#65292;&#20445;&#35777;&#25152;&#26377;&#30340;&#25968;&#20540;&#21040;&#36798;&#20869;&#23384;&#65292;&#22240;&#27492; $B_2$ &#30340; <code>lock</code> &#20043;&#21518;&#30340; <code>load(x)</code> &#33021;&#30830;&#20445;&#35835;&#21040; $B_1$ &#20013;&#20889;&#20837;&#30340;&#25968;&#20540;&#12290;</li>
</ul>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_3" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#20114;&#26021;&#38145;&#20026;&#25105;&#20204;&#25552;&#20379;&#30340;&#20445;&#35777;</h4>
<p class=" font-serif my-1">&#34987;&#21516;&#19968;&#20010;&#20114;&#26021;&#38145;&#20445;&#25252;&#30340;&#25152;&#26377;&#20195;&#30721;&#65292;&#19968;&#23450;&#33021;&#22312;&#20840;&#23616; (&#19978;&#24093;&#35270;&#35282;) &#19978;&#25490;&#20986;&#19968;&#20010;&#25191;&#34892;&#39034;&#24207; $B_1 \to B_2 \to \ldots \to B_n$&#65292;&#24182;&#19988;&#25105;&#20204;<red><strong>&#31616;&#21270;&#30340;&#29366;&#24577;&#26426;&#27169;&#22411;&#20381;&#28982;&#33021;&#23545; $B_i$ &#20013;&#25191;&#34892;&#30340;&#25351;&#20196;&#25104;&#31435;</strong></red>&#12290;&#36825;&#19968;&#37325;&#35201;&#29305;&#24615;&#26497;&#22823;&#22320;&#31616;&#21270;&#20102;&#25105;&#20204;&#29702;&#35299;&#24182;&#21457;&#31243;&#24207;&#30340;&#38590;&#24230;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#21516;&#19968;&#20010;&#30418;&#23376; ($B$) &#20013;&#30340;&#20195;&#30721;&#23646;&#20110;&#21516;&#19968;&#20010;&#32447;&#31243;&#65292;&#21333;&#32447;&#31243;&#31243;&#24207;&#21487;&#20197;&#20551;&#35774;&#25351;&#20196;&#25353;&#39034;&#24207;&#25191;&#34892;&#12290;</li>
<li class=" ml-8">&#34429;&#28982; $B_i, B_{i+1}$ &#21487;&#33021;&#36816;&#34892;&#22312;&#19981;&#21516;&#30340;&#22788;&#29702;&#22120;&#19978;&#65292;&#20294; $B_i$ &#20013;&#30340; unlock &#21644; $B_{i+1}$ &#20013;&#30340; lock &#20445;&#35777;&#20102;&#25351;&#20196;&#25191;&#34892;&#30340;&#39034;&#24207;&#21644;&#21487;&#35265;&#24615;&#12290;</li>
</ul>
</blockquote>
<h2 id="4" class=" text-xl mt-2 pb-2 font-sans">4. &#24182;&#21457;&#25968;&#25454;&#32467;&#26500;</h2>
<h3 id="41" class=" text-lg mt-2 pb-2 font-sans">4.1. &#25968;&#25454;&#32467;&#26500;</h3>
<p class=" font-serif my-1">&#24403;&#25105;&#20204;&#35848;&#25968;&#25454;&#32467;&#26500;&#30340;&#26102;&#20505;&#65292;&#20854;&#23454;&#20998;&#25104;&#20004;&#20010;&#37096;&#20998;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#25277;&#35937;&#25968;&#25454;&#31867;&#22411; (ADT)&#65292;&#21363;&#25105;&#20204;&#20351;&#29992;&#25968;&#25454;&#32467;&#26500;&#26102;&#35843;&#29992;&#30340;&#25509;&#21475;&#65292;&#20363;&#22914;&#19968;&#20010;&#25972;&#25968;&#30340;&#38598;&#21512;&#65292;&#25903;&#25345; <code>insert(x)</code>, <code>delete(x)</code> &#21644; <code>rank(x)</code> &#36820;&#22238;&#38598;&#21512;&#20013;&#23567;&#20110;&#31561;&#20110; <code>x</code> &#30340;&#20803;&#32032;&#20010;&#25968;&#12290;</li>
<li class=" ml-8">&#25968;&#25454;&#23384;&#20648;&#21644;&#25805;&#20316;&#30340;&#23454;&#29616;&#65292;&#20363;&#22914;&#25968;&#25454;&#23384;&#20648;&#22312;&#20869;&#23384;&#20013;&#30340; layout&#12289;&#25805;&#20316;&#23454;&#29616;&#30340;&#26041;&#27861;&#31561;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#25105;&#20204;&#24050;&#32463;&#23398;&#36807;&#24456;&#22810;&#32463;&#20856;&#30340;&#25277;&#35937;&#25968;&#25454;&#31867;&#22411;&#65306;&#26632;&#12289;&#38431;&#21015;&#12289;&#38598;&#21512;&#8230;&#8230;&#65307;&#20063;&#23398;&#20064;&#36807;&#24456;&#22810;&#23427;&#20204;&#30340;&#39640;&#25928;&#23454;&#29616;&#65306;&#25968;&#32452;&#12289;&#38142;&#34920;&#12289;&#32418;&#40657;&#26641;&#12289;Fibonacci &#22534;&#8230;&#8230;&#65292;&#25105;&#20204;&#19981;&#22952;&#23601;&#28151;&#31216;&#20026;&#25968;&#25454;&#32467;&#26500;&#12290;&#25105;&#20204;&#22312;&#25551;&#36848;&#23427;&#20204;&#30340;&#26102;&#20505;&#65292;&#37117;&#20351;&#29992;&#31867;&#20284;&#20110;&#21333;&#22788;&#29702;&#22120;&#35745;&#31639;&#26426;&#25191;&#34892;&#25351;&#20196;&#30340;&#20266;&#20195;&#30721;&#65307;&#24182;&#19988;&#25105;&#20204;&#22312;&#20998;&#26512;&#25968;&#25454;&#32467;&#26500;&#30340;&#24615;&#33021;&#26102;&#65292;&#36890;&#24120;&#20063;&#37319;&#29992;&#20851;&#38190;&#30340;&#25805;&#20316;&#25968;&#37327; (&#20363;&#22914;&#27604;&#36739;&#12289;&#36171;&#20540;&#31561;) &#34913;&#37327;&#23427;&#30340;&#26102;&#38388;&#22797;&#26434;&#24230;&#12289;&#29992;&#20351;&#29992;&#30340;&#20869;&#23384;&#22823;&#23567;&#34913;&#37327;&#31354;&#38388;&#22797;&#26434;&#24230;&#12290;</p>
<h3 id="42" class=" text-lg mt-2 pb-2 font-sans">4.2. &#21487;&#20018;&#34892;&#21270;&#30340;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;</h3>
<p class=" font-serif my-1">&#22914;&#26524;&#25105;&#20204;&#30340;&#22810;&#32447;&#31243;&#24182;&#21457;&#31243;&#24207; (&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#22810;&#32447;&#31243;&#31243;&#24207;&#25110;&#32773;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#30340;&#32447;&#31243;) &#24076;&#26395;&#35775;&#38382;&#25968;&#25454;&#32467;&#26500;&#65292;&#20250;&#24590;&#20040;&#26679;&#21602;&#65311;&#36890;&#36807;&#20869;&#23384;&#23454;&#29616;&#30340;&#25968;&#25454;&#32467;&#26500;&#20013;&#30340;&#19968;&#20010;&#25805;&#20316;&#36890;&#24120;&#28041;&#21450;&#22810;&#27425;&#20869;&#23384;&#30340;&#35775;&#38382;&#8212;&#8212;&#22823;&#23478;&#19968;&#23450;&#22238;&#24819;&#36215; Peterson &#31639;&#27861;&#22312;&#29616;&#20195;&#22810;&#22788;&#29702;&#22120;&#31995;&#32479;&#19978;&#30340;&#27491;&#30830;&#24615;&#65292;&#31435;&#21363;&#26126;&#30333;&#23454;&#29616;&#21151;&#33021;&#27491;&#30830;&#30340;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#26159;&#24456;&#22256;&#38590;&#30340;&#20107;&#24773;&#12290;</p>
<p class=" font-serif my-1">&#23601;&#36830;&#23450;&#20041;&#20160;&#20040;&#26159; &#8220;&#27491;&#30830;&#8221; &#30340;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#20063;&#24182;&#19981;&#26174;&#28982;&#12290;&#22312;&#36825;&#37324;&#65292;&#25105;&#20204;&#24076;&#26395;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#28385;&#36275; &#8220;&#21487;&#20018;&#34892;&#21270;&#8221; (serializability)&#65292;&#21363;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#30340;&#19968;&#27425;&#24182;&#21457;&#25191;&#34892;&#19978;&#35266;&#23519;&#21040;&#30340;&#25191;&#34892;&#32467;&#26524; (&#25968;&#25454;&#32467;&#26500;&#22312;&#27599;&#20010;&#32447;&#31243;&#19978;&#25191;&#34892;&#30340;&#25805;&#20316;&#21644;&#25805;&#20316;&#30340;&#36820;&#22238;&#32467;&#26524;) &#33021;&#22815;&#21644;&#26576;&#19968;&#20010;&#39034;&#24207;&#31243;&#24207;&#19978;&#23545;&#30340;&#25968;&#25454;&#32467;&#26500;&#30340;&#25805;&#20316;&#31561;&#20215;&#12290;&#21487;&#20018;&#34892;&#21270;&#24182;&#19981;&#26159;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#27491;&#30830;&#30340;&#21807;&#19968;&#26631;&#20934;&#8212;&#8212;&#22312;&#23545;&#24615;&#33021;&#35201;&#27714;&#26356;&#39640;&#30340;&#39046;&#22495; (&#20027;&#35201;&#26159;&#20998;&#24067;&#24335;&#31995;&#32479;)&#65292;&#29978;&#33267;&#21487;&#33021;&#20250;&#20801;&#35768;&#19981;&#21487;&#20018;&#34892;&#21270;&#30340;&#25968;&#25454;&#32467;&#26500;&#12290;</p>
<p class=" font-serif my-1">&#20570;&#19968;&#20010;&#22909;&#30340;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500; (&#21738;&#24597;&#26159;&#20010; &#8220;&#31616;&#21333;&#8221; &#30340;&#25968;&#25454;&#32467;&#26500;) &#37117;&#19981;&#26159;&#19968;&#20214; trivial &#30340;&#20107;&#24773;&#65292;&#20363;&#22914;<a href="https://www.cs.princeton.edu/~mfreed/docs/cuckoo-eurosys14.pdf" class=" text-amber-900">&#36825;&#31687;&#25991;&#31456;</a>&#37324;&#65292;&#36830;&#30828;&#20214;&#30340;&#25903;&#25345;&#37117;&#29992;&#19978;&#20102;&#12290;&#24456;&#37239;&#26159;&#19981;&#26159;&#65311;&#22240;&#27492;&#22312;&#30452;&#21040;&#20320;&#23545;&#36825;&#20010;&#38382;&#39064;&#26377;&#20102;&#26356;&#28145;&#20837;&#30340;&#35748;&#35782;&#20043;&#21069;&#65292;&#36981;&#24490;&#25945;&#31185;&#20070;&#19978;&#30340;&#24314;&#35758;&#65292;&#29992;&#31616;&#21333;&#30340;&#38145;&#26469;&#20445;&#25252;&#20320;&#30340;&#25968;&#25454;&#32467;&#26500;&#65306;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">Many operating systems utilized a single lock when first transitioning to multiprocessors, including Sun OS and Linux. In the latter, this lock even had a name, the big kernel lock (BKL).</p>
</blockquote>
<p class=" font-serif my-1">&#23454;&#29616;&#21487;&#20018;&#34892;&#21270;&#30340;&#26368;&#31616;&#21333;&#26041;&#24335;&#23601;&#26159;&#25226;&#25152;&#26377;&#30340;&#35775;&#38382;&#30495;&#27491;&#22320;&#20018;&#34892;&#21270;&#8212;&#8212;&#35760;&#24471;&#25105;&#20204;&#30340;&#33258;&#26059;&#38145;/&#20114;&#26021;&#38145;&#20445;&#35777;&#20102;&#20020;&#30028;&#21306;&#30340;&#21407;&#23376;&#24615;&#12289;&#39034;&#24207;&#12289;&#21487;&#35265;&#24615;&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">set_insert</span><span class="p">(</span><span class="n">Set</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_insert_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_remove</span><span class="p">(</span><span class="n">Set</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_remove_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#22823;&#37096;&#20998;&#26102;&#20505;&#65292;&#36825;&#26679;&#30340;&#22788;&#29702;&#37117;&#26159;&#23433;&#20840;&#19988;&#26377;&#25928;&#30340;&#8212;&#8212;&#21482;&#35201;&#36825;&#20010;&#25968;&#25454;&#32467;&#26500;&#27809;&#26377;&#34987;&#38750;&#24120;&#39057;&#32321;&#22320;&#35775;&#38382;&#12290;&#35831;&#22823;&#23478;&#38405;&#35835;&#25945;&#35838;&#20070;&#31532; 29 &#31456; &#8220;locked data structures&#8221;&#12290;</p>
<h2 id="43-mallocfree" class=" text-xl mt-2 pb-2 font-sans">4.3. &#23454;&#29616;&#39640;&#24615;&#33021;&#30340; malloc/free</h2>
<p class=" font-serif my-1">&#22914;&#26524;&#22810;&#20010;&#22788;&#29702;&#22120;&#19978;&#30340;&#32447;&#31243;&#23545;&#25968;&#25454;&#32467;&#26500;&#30340;&#35775;&#38382;&#38750;&#24120;&#39057;&#32321;&#65292;&#27492;&#26102;&#20877;&#20351;&#29992;&#38145;&#65292;&#23601;&#20250;&#23548;&#33268; &#8220;&#19968;&#26680;&#20986;&#21147;&#65292;&#20182;&#20154;&#22260;&#35266;&#8221; &#30340;&#24773;&#20917;&#12290;&#25552;&#39640;&#22810;&#22788;&#29702;&#22120;&#19978;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#24615;&#33021;&#30340;&#20851;&#38190;&#20043;&#19968;&#26159;&#20943;&#23569;&#22312;&#38145;&#19978;&#25317;&#22622; (contention) &#30340;&#26102;&#38388;&#8212;&#8212;&#22914;&#26524;&#23453;&#36149;&#30340;&#26102;&#38388;&#37117;&#33457;&#22312;&#20102; spin &#19978;&#21364;&#27809;&#26377;&#23454;&#36136;&#30340;&#36827;&#23637;&#65292;&#37027;&#23601;&#26159;&#30333;&#30333;&#28010;&#36153;&#20102;&#22810;&#22788;&#29702;&#22120;&#30340;&#35745;&#31639;&#21147;&#20102;&#12290;&#26356;&#31967;&#31957;&#30340;&#26159;&#65292;&#35774;&#35745;&#19981;&#24403;&#30340;&#31639;&#27861;&#29978;&#33267;&#26377;&#21487;&#33021;&#35753; cache line &#22312;&#22788;&#29702;&#22120;&#20043;&#38388;&#26469;&#22238;&#8220;&#24377;&#36339;&#8221;&#65292;&#23548;&#33268;&#22810;&#22788;&#29702;&#22120;&#19979;&#30340;&#24615;&#33021;&#29978;&#33267;&#20302;&#20110;&#21333;&#22788;&#29702;&#22120;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#36825;&#37324;&#65292;&#25105;&#20204;&#20171;&#32461;&#22914;&#20309;&#20998;&#26512;&#22522;&#20110;&#31995;&#32479;&#35843;&#29992;&#23454;&#29616; malloc/free &#30340;&#38382;&#39064;&#65292;&#35774;&#35745;&#21512;&#29702;&#30340;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#23454;&#29616;&#23427;&#20204;&#12290;malloc/free &#22823;&#23478;&#26159; libc &#26631;&#20934;&#24211;&#30340;&#19968;&#37096;&#20998;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</code></pre></div>

<p class=" font-serif my-1">&#35831;&#22823;&#23478;&#38405;&#35835;&#25163;&#20876; (man 3 malloc)&#65292;&#28201;&#20064;&#19968;&#19979;&#20854;&#20013;&#30340;&#37325;&#35201;&#32454;&#33410;&#12290;</p>
<h3 id="431-mallocfree" class=" text-lg mt-2 pb-2 font-sans">4.3.1. malloc/free: &#31354;&#38386;&#30340;&#20869;&#23384;&#20174;&#21738;&#37324;&#26469;&#65311;</h3>
<p class=" font-serif my-1">&#24819;&#35201;&#23454;&#29616; malloc &#20998;&#37197;&#20869;&#23384;&#65292;&#25105;&#20204;&#24517;&#39035;&#24471;&#35201;&#33021;&#24471;&#21040;&#19968;&#23450;&#25968;&#37327; &#8220;&#31354;&#38386;&#8221; &#30340;&#20869;&#23384;&#25165;&#34892;&#12290;&#20869;&#23384;&#30340;&#20998;&#37197;&#21644;&#37322;&#25918;&#21033;&#29992;&#24213;&#23618;&#31995;&#32479;&#25552;&#20379;&#30340;&#26426;&#21046; (&#36890;&#24120;&#33021;&#22815;&#29992;&#26469;&#20998;&#37197;&#24456;&#22823;&#30340;&#20869;&#23384;)&#65292;&#23454;&#29616;&#21508;&#31181;&#22823;&#23567;&#12289;&#31867;&#22411;&#23545;&#35937;&#30340;&#20998;&#37197;&#21644;&#37322;&#25918;&#12290;&#22823;&#23478;&#24102;&#30528; &#8220;&#29366;&#24577;&#26426;&#27169;&#22411;&#8221; &#26469;&#29702;&#35299;&#19968;&#19979;&#19979;&#38754;&#30340;&#19968;&#34892;&#20195;&#30721;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">30</span><span class="p">);</span>
<span class="n">ptr</span><span class="p">[</span><span class="mi">123456</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</code></pre></div>

<p class=" font-serif my-1">&#20551;&#35774; <code>malloc</code> &#20998;&#37197;&#25104;&#21151;&#65292;&#36820;&#22238;&#30340;&#25351;&#38024; <code>ptr</code> &#23601;&#21487;&#20197;&#35775;&#38382;&#8212;&#8212;&#20294;&#25105;&#20204;&#20960;&#20046;&#21487;&#20197;&#30830;&#20449;&#30340;&#26159;&#65292;&#22914;&#26524;&#22312; <code>malloc</code> &#36820;&#22238;&#20043;&#21069;&#65292;&#36825;&#20010;&#22320;&#22336;&#19968;&#23450;&#26159;&#19981;&#21487;&#35775;&#38382;&#30340;&#12290;&#22240;&#20026;<red>&#29366;&#24577;&#26426;&#26159;&#25351;&#20196;&#39537;&#21160;</red>&#30340;&#65292;&#25152;&#20197;&#19968;&#23450;&#26377;&#19968;&#26465;&#25351;&#20196;&#25913;&#21464;&#20102;&#29366;&#24577;&#26426;&#29366;&#24577; $(M, R)$ &#20013;&#30340;&#20869;&#23384;&#65281;&#36825;&#19968;&#26465;&#25351;&#20196;&#26159;&#20160;&#20040;&#21602;&#8230;&#8230;&#65311;&#20320;&#24050;&#32463;&#30693;&#36947;&#20102;&#65306;&#21807;&#19968;&#33021;&#20570;&#21040;&#36825;&#19968;&#28857;&#30340;&#23601;&#26159;&#31995;&#32479;&#35843;&#29992; (syscall)&#12290;</p>
<p class=" font-serif my-1">&#22914;&#26524;&#24819;&#30693;&#36947; Linux &#31995;&#32479;&#26159;&#22914;&#20309;&#20026;&#25105;&#20204;&#20998;&#37197;&#20869;&#23384;&#30340;&#65292;&#22823;&#23478;&#19981;&#22952;&#21487;&#20197;&#33258;&#24049;&#20889;&#19968;&#20010;&#23567;&#30340; <a href="../../../pages/OS/2021/demos/malloc-workload.c" class=" text-amber-900">malloc-workload.c</a>&#65292;&#28982;&#21518;&#29992; strace &#35266;&#23519;&#25191;&#34892;&#30340;&#31995;&#32479;&#35843;&#29992;&#24207;&#21015;&#65292;&#28982;&#21518;&#20320;&#20250;&#21457;&#29616; Linux &#25805;&#20316;&#31995;&#32479;&#20026;&#25105;&#20204;&#25552;&#20379;&#20102; brk &#21644; mmap &#20004;&#20010;&#31995;&#32479;&#35843;&#29992;&#65292;&#21487;&#20197;&#29992;&#26469;&#30003;&#35831;&#36830;&#32493;&#30340;&#20869;&#23384;&#12290;&#22240;&#20026;&#31995;&#32479;&#35843;&#29992;&#26377;&#19968;&#23450;&#30340;&#24320;&#38144;&#65292;&#22240;&#27492;&#25105;&#20204;&#36890;&#24120;&#19968;&#27425;&#24615;&#38382;&#25805;&#20316;&#31995;&#32479;&#35831;&#27714;&#36739;&#22823;&#30340;&#20869;&#23384;&#65292;&#32780;&#22312;&#36827;&#31243;&#26412;&#22320;&#36827;&#34892;&#20013;&#23567;&#20869;&#23384;&#30340;&#20998;&#37197;&#12290;&#32780;&#22312;&#35745;&#31639;&#26426;&#30828;&#20214; (&#25105;&#20204;&#30340;&#23454;&#39564;) &#19978;&#65292;&#25805;&#20316;&#31995;&#32479;&#21487;&#20197;&#30452;&#25509;&#35775;&#38382;&#29289;&#29702;&#20869;&#23384;&#65292;&#22240;&#27492;&#25805;&#20316;&#31995;&#32479;&#30452;&#25509;&#31649;&#29702;&#31995;&#32479;&#20013;&#21487;&#29992;&#30340;&#29289;&#29702;&#20869;&#23384;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="libc-malloc" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#26356;&#36827;&#19968;&#27493;&#65306;libc &#37324;&#30340; malloc &#26159;&#24590;&#26679;&#20351;&#29992;&#31995;&#32479;&#35843;&#29992;&#30340;&#65311;</h4>
<p class=" font-serif my-1">&#22914;&#26524;&#20320;&#24819;&#30693;&#36947; libc &#37324;&#30340; malloc/free &#26159;&#22914;&#20309;&#20351;&#29992;&#31995;&#32479;&#35843;&#29992;&#30340;&#65292;&#20320;&#21487;&#20197;&#20889;&#19968;&#20123;&#20856;&#22411;&#30340; workloads:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#22823;&#37327;&#20998;&#37197;&#22823;&#20869;&#23384;</li>
<li class=" ml-8">&#22823;&#37327;&#20998;&#37197;&#23567;&#20869;&#23384;</li>
<li class=" ml-8">&#28151;&#21512;&#20869;&#23384;&#20998;&#37197;</li>
<li class=" ml-8">&#20998;&#37197;&#22823;&#37327;&#20869;&#23384;&#21518;&#20840;&#37096;&#22238;&#25910;</li>
<li class=" ml-8">&#8230;&#8230;</li>
</ul>
<p class=" font-serif my-1">&#32534;&#35793;&#36816;&#34892;&#21518;&#65292;&#20351;&#29992; strace &#24037;&#20855;&#26597;&#30475;&#31995;&#32479;&#35843;&#29992;&#30340;&#24207;&#21015;&#12290;&#22914;&#27492;&#65292;&#20320;&#23601;&#21487;&#20197;&#22312;&#19968;&#23450;&#31243;&#24230;&#19978; &#8220;&#36870;&#21521;&#24037;&#31243;&#8221; &#20986; libc &#20998;&#37197;&#20869;&#23384;&#30340;&#19968;&#20123;&#22522;&#26412;&#31574;&#30053;&#12290;&#22312;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#35838;&#19978;&#21160;&#25163;&#23454;&#36341;&#65292;&#29609;&#19968;&#29609;&#23454;&#38469;&#30340;&#25805;&#20316;&#31995;&#32479;&#33021;&#22686;&#36827;&#22823;&#23478;&#23545;&#25805;&#20316;&#31995;&#32479;&#30340;&#29702;&#35299;&#12290;</p>
</blockquote>
<h3 id="432-mallocfree" class=" text-lg mt-2 pb-2 font-sans">4.3.2. malloc/free: &#24182;&#21457;&#25968;&#25454;&#32467;&#26500;</h3>
<p class=" font-serif my-1">&#22312;&#19968;&#23450;&#30340;&#25277;&#35937;&#23618;&#38754;&#19978;&#23545;&#38656;&#27714;&#36827;&#34892;&#20998;&#26512;&#26377;&#21161;&#20110;&#25105;&#20204;&#26356;&#22909;&#22320;&#29702;&#35299;&#38382;&#39064;&#12290;&#20854;&#23454;&#65292;malloc/free &#30340;&#26412;&#36136;&#23601;&#26159;&#32500;&#25252;&#19968;&#20010;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#12290;&#19968;&#26041;&#38754;&#65292;&#25105;&#20204;&#33021;&#20174;&#25805;&#20316;&#31995;&#32479; (&#35745;&#31639;&#26426;&#30828;&#20214;) &#19978;&#20998;&#37197;&#24471;&#21040;&#36739;&#22823;&#30340;&#20869;&#23384;&#31354;&#38388;&#8212;&#8212;&#19968;&#27573;&#36830;&#32493;&#12289;&#21487;&#29992;&#30340;&#20869;&#23384;&#65292;&#21487;&#20197;&#30475;&#25104;&#21306;&#38388;&#30340;&#38598;&#21512;</p>
<p class=" font-serif my-1">$$M = \big\{ [L_0, R_0) \cup [L_1, R_1) \cup \ldots \cup [L_m, R_m) \big\} $$</p>
<p class=" font-serif my-1">&#21516;&#26102;&#65292;&#24050;&#34987;&#20998;&#37197;&#30340;&#20869;&#23384; (&#22534;&#21306;) &#20063;&#21487;&#20197;&#30475;&#25104;&#26159;&#21306;&#38388;&#30340;&#38598;&#21512;&#65306;</p>
<p class=" font-serif my-1">$$ H = \big\{ [\ell_0, r_0), [\ell_1, r_1), \ldots, [\ell_n, r_n) \big\} \subseteq M$$</p>
<p class=" font-serif my-1">&#25152;&#35859; malloc($s$) &#23601;&#26159;&#32473;&#23450;&#22823;&#23567; <math>s</math> &#20174; $ M\setminus H$ &#20013;&#25214;&#21040;&#19968;&#20010;&#21306;&#38388; $[\ell, r)$ &#28385;&#36275; $r - \ell \ge s$&#65292;&#26356;&#26032;</p>
<p class=" font-serif my-1">$$ H' = H \cup \{ [\ell, r) \} $$</p>
<p class=" font-serif my-1">&#22312;&#25214;&#19981;&#21040;&#26102;&#65292;&#25105;&#20204;&#19968;&#26041;&#38754;&#21487;&#20197;&#21521;&#25805;&#20316;&#31995;&#32479;&#30003;&#35831; $M$ &#20013;&#30340;&#20869;&#23384;&#65292;&#20063;&#21487;&#20197;&#36820;&#22238;&#20998;&#37197;&#22833;&#36133;&#65307;&#32780; free &#23601;&#26159;&#32473;&#23450;&#19968;&#20010;&#21306;&#38388;&#30340;&#24038;&#31471;&#28857; $\ell_i$&#65292;&#23558;&#20998;&#37197;&#30340;&#20869;&#23384;&#22238;&#25910;&#65306;</p>
<p class=" font-serif my-1">$$H' = H \setminus \{ [\ell_i, r_i) \}$$</p>
<p class=" font-serif my-1">&#36825;&#26679;&#30475;&#36215;&#26469; &#8220;&#22797;&#26434;&#8221; &#30340;&#38382;&#39064;&#19968;&#19979;&#23601;&#21464;&#24471;&#24178;&#20928;&#20102;&#8212;&#8212;&#36890;&#36807;&#36866;&#24403;&#30340;&#25277;&#35937; (&#36825;&#26159;&#35299;&#20915;&#35745;&#31639;&#26426;&#31185;&#23398;&#38382;&#39064;&#30340;&#24120;&#35265;&#26041;&#27861;)&#65292;&#20320;&#21487;&#20197;&#25552;&#20986;&#33258;&#24049;&#30340;&#20998;&#37197;&#31574;&#30053;&#65292;&#20363;&#22914;&#31354;&#38386;&#30340;&#31354;&#38388; $M \setminus H$ &#20063;&#21487;&#20197;&#20889;&#25104;&#26159;&#21306;&#38388;&#30340;&#38598;&#21512;&#65307;&#25105;&#20204;&#21487;&#20197;&#29992;&#38142;&#34920;&#25226;&#36825;&#20123;&#31354;&#38386;&#30340;&#21306;&#38388; (&#38142;&#34920;&#30340;&#25351;&#38024;&#21487;&#20197;&#30452;&#25509;&#20301;&#20110;&#21306;&#38388;&#20013;) &#38142;&#25509;&#36215;&#26469; (&#30456;&#24403;&#20110;&#29992;&#38142;&#34920;&#32500;&#25252; $M \setminus A$ &#20013;&#30340;&#21306;&#38388;)&#65292;&#20998;&#37197;&#26102;&#36941;&#21382;&#38142;&#34920;&#65292;&#25214;&#21040;&#26576;&#20010;&#31354;&#38388;&#19981;&#23569;&#20110; $s$ &#30340;&#21306;&#38388;&#65292;&#28982;&#21518;&#26356;&#26032;&#38142;&#34920;&#12290;&#26356;&#22797;&#26434;&#30340;&#65292;&#20320;&#29978;&#33267;&#21487;&#20197;&#29992;&#24179;&#34913;&#20108;&#21449;&#26641;&#22312; $O(\log n)$ &#30340;&#26102;&#38388;&#37324;&#23436;&#25104;&#20869;&#23384;&#20998;&#37197;&#12290;</p>
<h3 id="433-mallocfree" class=" text-lg mt-2 pb-2 font-sans">4.3.3. malloc/free &#30340;&#24615;&#33021;&#20998;&#26512;</h3>
<p class=" font-serif my-1">&#22522;&#20110;&#38142;&#34920;&#30340; malloc/free &#33021;&#21542;&#28385;&#36275;&#24212;&#29992;&#31243;&#24207;&#23545;&#20869;&#23384;&#20998;&#37197;&#21508;&#26041;&#38754;&#30340;&#38656;&#27714;&#21602;&#65311;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="workload" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#25243;&#24320; workload &#35848;&#20248;&#21270;&#23601;&#26159;&#32781;&#27969;&#27667;</h4>
<p class=" font-serif my-1">&#23545;&#20110;&#21516;&#19968;&#20010;&#38598;&#21512;&#25968;&#25454;&#32467;&#26500;&#26469;&#35828;&#65292;99% &#35835; 1% &#20889;&#65307;1% &#35835; 99% &#20889;&#65292;&#36825;&#20004;&#31181;&#24773;&#20917;&#19979;&#30340;&#31639;&#27861;&#35774;&#35745;&#33021;&#19968;&#26679;&#21527;&#65311;&#19981;&#21516;&#30340;&#24212;&#29992;&#22330;&#26223;&#24456;&#21487;&#33021;&#26377;&#19981;&#21516;&#30340;&#38656;&#27714;&#8212;&#8212;&#29978;&#33267;&#26377;&#26102;&#20505;&#24635;&#26159;&#19968;&#20010;&#32447;&#31243;&#20889;&#65292;&#24456;&#22810;&#32447;&#31243;&#35835;&#12290;&#22914;&#26524;&#24076;&#26395;&#35843;&#20248;&#31243;&#24207;&#30340;&#24615;&#33021;&#65292;&#19968;&#23450;&#35201;&#20808;&#20102;&#35299; workloads&#12290;</p>
<p class=" font-serif my-1">&#36825;&#20063;&#26159;&#20026;&#20160;&#20040;&#24456;&#22810;&#30740;&#31350;&#37117;&#38656;&#35201;<a href="https://en.wikipedia.org/wiki/Benchmark_(computing)" class=" text-amber-900">&#22522;&#20934;&#31243;&#24207;</a>&#65292;&#23427;&#20204;&#20195;&#34920;&#20102;&#21508;&#31181;&#20856;&#22411;&#24212;&#29992;&#22330;&#26223;&#19979;&#30340; workloads&#12290;&#8220;&#19981;&#26381;&#36305;&#20010;&#20998;&#8221; &#23545;&#21543;&#65311;</p>
</blockquote>
<p class=" font-serif my-1">&#37027;&#24590;&#20040;&#20174;&#31243;&#24207;&#30340;&#36816;&#34892;&#25110;&#32773;&#22522;&#20934;&#31243;&#24207;&#24471;&#21040;workloads&#21602;&#65311;&#35838;&#22530;&#19978;&#25105;&#20204;&#32473;&#20102; <a href="../../../pages/OS/2021/demos/mtrace.c" class=" text-amber-900">mtrace.c</a>&#65292;&#37324;&#38754;&#23450;&#20041;&#20102;&#19968;&#20010;&#20266;&#35013;&#30340; malloc&#65292;&#23427;&#20250;&#20599;&#20599;&#35843;&#29992;&#31995;&#32479;&#20013;&#30495;&#27491;&#30340; malloc (&#36890;&#36807; <code>dlsym</code> &#24471;&#21040;)&#65292;&#20294;&#21516;&#26102;&#21487;&#20197;&#35760;&#24405;&#19968;&#20123;&#39069;&#22806;&#30340;&#20449;&#24687;&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">real_malloc</span><span class="p">)(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">real_malloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atexit</span><span class="p">(</span><span class="n">print_stats</span><span class="p">);</span>
<span class="w">    </span><span class="n">real_malloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsym</span><span class="p">(</span><span class="n">RTLD_NEXT</span><span class="p">,</span><span class="w"> </span><span class="s">"malloc"</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">buf</span><span class="p">[</span><span class="n">LOG2</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">// profile</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">real_malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#20511;&#21161;&#21160;&#24577;&#38142;&#25509;&#24211;&#26426;&#21046;&#65292;&#25105;&#20204;&#21482;&#38656;&#35201;&#25226; <code>mtrace</code> &#32534;&#35793;&#25104;&#20849;&#20139;&#24211;&#65292;&#24182;&#19988;&#25250;&#22312; libc &#20043;&#21069;&#21152;&#36733;&#65292;&#23601;&#21487;&#20197;&#25226; malloc &#36825;&#20010;&#31526;&#21495; &#8220;&#21344;&#22353;&#8221; (&#21160;&#24577;&#38142;&#25509;&#26102;&#65292;&#20840;&#23616;&#31526;&#21495;&#20808;&#21040;&#20808;&#24471;)&#65292;&#36825;&#26679;&#23601;&#21487;&#20197;&#26597;&#30475;&#31243;&#24207; malloc &#30340;&#32479;&#35745;&#21862;&#65281;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="trace-mallocfree" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#24605;&#32771;&#39064;&#65306;trace malloc/free&#22815;&#21527;&#65311;</h4>
<p class=" font-serif my-1">&#19981;&#27490;&#19968;&#20010;&#24211;&#20989;&#25968;&#21487;&#33021;&#20250;&#20998;&#37197;&#20869;&#23384;&#65292;&#20363;&#22914; <code>strdup</code>, <code>asprintf</code>... &#22914;&#20309;&#30417;&#25511;&#25152;&#26377;&#30340;&#20869;&#23384;&#20998;&#37197;&#65311;</p>
</blockquote>
<h3 id="434" class=" text-lg mt-2 pb-2 font-sans">4.3.4. &#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#35774;&#35745;</h3>
<p class=" font-serif my-1">&#22312;&#29702;&#35299;&#20102; workload &#20197;&#21518;&#65292;&#25105;&#20204;&#21487;&#20197;&#25972;&#29702;&#20986; malloc/free &#30340;&#20027;&#35201;&#30683;&#30462;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#23613;&#37327;&#35753;&#32447;&#31243;&#33021;&#20114;&#19981;&#24433;&#21709;&#22320;&#29420;&#31435;&#20998;&#37197;&#65292;&#21542;&#21017;&#20998;&#37197;&#39057;&#32321;&#30340;&#31243;&#24207;&#20250;&#36935;&#21040;&#29942;&#39048;&#8212;&#8212;&#20170;&#22825;&#25105;&#20204;&#24050;&#32463;&#33021;&#20080;&#21040;&#26377; 128, 256 &#29978;&#33267;&#26356;&#22810;&#32447;&#31243;&#30340;&#22788;&#29702;&#22120;&#12290;</li>
<li class=" ml-8">&#22823;&#20869;&#23384;/&#23567;&#20869;&#23384;&#30340;&#20998;&#37197;&#39057;&#29575;&#36890;&#24120;&#26159;&#24456;&#19981;&#30456;&#21516;&#30340;&#65292;&#24212;&#24403;&#20998;&#24320;&#32771;&#34385;&#12290;&#20998;&#37197;&#19968;&#27573;&#30456;&#23545;&#36739;&#22823;&#30340;&#20869;&#23384;&#65292;&#21183;&#24517;&#38656;&#35201;&#20351;&#29992;&#19968;&#27573;&#26102;&#38388;&#25165;&#33021; &#8220;&#22238;&#26412;&#8221;&#65292;&#21482;&#20998;&#37197;&#19981;&#20351;&#29992;&#19981;&#26159;&#20856;&#22411;&#30340;&#24212;&#29992;&#22330;&#26223;&#12290;&#36825;&#20063;&#27880;&#23450;&#20102;&#22823;&#20869;&#23384;&#30340;&#20998;&#37197;&#39057;&#29575;&#20250;&#36828;&#36828;&#23567;&#20110;&#23567;&#20869;&#23384;&#12290;</li>
<li class=" ml-8">&#26681;&#25454;&#20855;&#20307;&#24773;&#20917;&#20855;&#20307;&#20998;&#26512;&#8212;&#8212;&#22312; C &#24212;&#29992;&#31243;&#24207;&#12289;&#20869;&#26680;&#12289;JVM &#19977;&#20010;&#20856;&#22411;&#30340;&#22330;&#26223;&#37324;&#65292;workloads &#21448;&#26377;&#32454;&#24494;&#30340;&#21306;&#21035;&#65306;C &#31243;&#24207;&#30340;&#20998;&#37197;&#19981;&#22826;&#35268;&#24459;&#65292;&#35201;&#36991;&#20813;&#20869;&#23384;&#30340;&#28010;&#36153;&#21644;&#30862;&#29255;&#65307;&#20869;&#26680;&#20013;&#22266;&#23450;&#22823;&#23567;&#20869;&#23384;&#30340;&#20998;&#37197;&#30456;&#23545;&#27604;&#36739;&#39057;&#32321;&#65307;JVM &#26377;&#22823;&#37327;&#30340;&#20869;&#23384;&#20998;&#37197;&#65292;&#20294;&#32477;&#22823;&#37096;&#20998;&#29983;&#23384;&#21608;&#26399;&#24456;&#30701;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#22312; malloc/free &#31639;&#27861;&#30340;&#35774;&#35745;&#19978;&#65292;&#25105;&#20204;&#20351;&#29992;&#20102;&#35745;&#31639;&#26426;&#31995;&#32479;&#20013;&#24120;&#35265;&#30340;&#19968;&#31181;&#25216;&#26415;&#65306;&#21306;&#20998; fast/slow paths&#12290;&#22312;&#20043;&#21069;&#30340;&#35838;&#31243;&#20013;&#65292;&#25105;&#20204;&#23398;&#20064;&#21040;&#20856;&#22411;&#30340;&#26377; fast/slow path &#30340;&#31995;&#32479;&#26159;&#35745;&#31639;&#26426;&#30828;&#20214;&#20013;&#30340; memory hierarchy: &#22522;&#20110;&#20869;&#23384;&#35775;&#38382;&#30340;&#23616;&#37096;&#24615;&#65292;cache hit &#21344;&#32477;&#22823;&#37096;&#20998;&#24773;&#20917;&#65292;&#22240;&#27492;&#22788;&#29702;&#22120;&#21487;&#20197;&#24555;&#36895;&#22320;&#33719;&#24471;&#20869;&#23384;&#37324;&#30340;&#25968;&#25454;&#65292;&#21482;&#22312; cache miss &#26102;&#25165;&#21435;&#20869;&#23384;&#21462;&#25968;&#25454;&#12290;&#22312;&#35745;&#31639;&#26426;&#30828;&#20214;&#20013;&#65292;branch prediction, speculative execution &#20063;&#37117;&#26159;&#36825;&#26679;&#30340;&#20363;&#23376;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="thinking-fast-and-slow" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">Thinking: Fast and Slow</h4>
<p class=" font-serif my-1">&#26377;&#36259;&#30340;&#26159;&#65292;&#20154;&#31867;&#20063;&#26159;&#36825;&#26679;&#30340;&#31995;&#32479;&#65306;&#25105;&#20204;&#26377;&#19968;&#22871;&#24555;&#36895;&#31616;&#21333;&#30340;&#21453;&#24212;&#31995;&#32479;&#33021;&#39640;&#25928;&#22320;&#22788;&#29702;&#26085;&#24120;&#20107;&#21153;&#65306;&#21507;&#39277;&#12289;&#30561;&#35273;&#31561;&#31616;&#21333;&#20107;&#21153;&#30340;&#22788;&#29702;&#20284;&#20046; &#8220;&#24182;&#19981;&#32463;&#36807;&#22823;&#33041;&#8221;&#12290;&#19982;&#27492;&#21516;&#26102;&#65292;&#22312;&#25105;&#20204;&#38754;&#20020;&#22797;&#26434;&#20915;&#31574;&#12289;&#20570;&#25968;&#23398;&#39064;&#30340;&#26102;&#20505;&#65292;&#21448;&#26377;&#19968;&#22871;&#32791;&#33021;&#26356;&#39640;&#12289;&#36923;&#36753;&#26356;&#20005;&#23494;&#30340;&#25512;&#29702;&#31995;&#32479;&#65292;&#21482;&#26377;&#25105;&#20204;&#35273;&#24471;&#38382;&#39064;&#27809;&#27861;&#31616;&#21333;&#35299;&#20915;&#26102;&#65292;&#25165;&#20250;&#35843;&#29992;&#36825;&#22871;&#31995;&#32479;&#12290;</p>
<p class=" font-serif my-1">&#24403;&#28982;&#20102;&#65292;&#22823;&#23478;&#22312;&#32534;&#31243;&#30340;&#26102;&#20505;&#26368;&#22909;&#19981;&#35201;&#20351;&#29992; &#8220;&#19981;&#32463;&#22823;&#33041;&#8221; &#30340;&#31995;&#32479;&#8212;&#8212;&#34429;&#28982;&#26681;&#25454;&#25105;&#20204;&#30340;&#32463;&#39564;&#65292;&#24456;&#22810;&#21516;&#23398;&#20250;&#22788;&#20110;&#27169;&#31946;&#30340; &#8220;&#26080;&#33041;&#32534;&#31243;&#8221; &#29366;&#24577;&#65292;&#38543;&#20415;&#20889;&#19968;&#20123;&#20195;&#30721;&#65292;&#28982;&#21518;&#20877;&#32993;&#20081;&#35843;&#35797;&#12290;&#27491;&#30830;&#30340;&#26041;&#24335;&#26159;&#19968;&#36793;&#32534;&#20889;&#65292;&#19968;&#36941;&#35797;&#22270;&#29702;&#35299;&#27599;&#19968;&#34892;&#20195;&#30721;&#30340;&#34892;&#20026;&#21644;&#27599;&#19968;&#22359;&#20195;&#30721;&#30340; specifications&#8212;&#8212;&#36825;&#20960;&#20046;&#24635;&#26159;&#38656;&#35201;&#22823;&#33041;&#30340; slow system&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#25105;&#20204;&#35797;&#22270;&#25226;&#20869;&#23384;&#20998;&#37197;&#38382;&#39064;&#20998;&#25104;&#20004;&#31181;&#24773;&#20917;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">(fast/common path) &#30452;&#25509;&#20174;&#32447;&#31243;&#26412;&#22320;&#31435;&#21363;&#24471;&#21040;&#20869;&#23384;&#65292;&#20960;&#20046;&#19981;&#28041;&#21450;&#22797;&#26434;&#30340;&#21516;&#27493;&#25110;&#38145;&#30340;&#20105;&#25250;&#12290;&#22240;&#27492; fast path &#21487;&#20197;&#24456;&#24555;&#25191;&#34892;&#23436;&#25104;&#65292;&#20294;&#26377;&#19968;&#23450;&#30340;&#27010;&#29575;&#22833;&#36133;&#12290;</li>
<li class=" ml-8">(slow/uncommon path) &#22312; fast path &#22833;&#36133;&#26102;&#65292;&#20801;&#35768;&#25105;&#20204;&#20184;&#20986;&#39069;&#22806;&#30340;&#20195;&#20215; &#8220;&#32416;&#27491;&#8221; &#20043;&#21069;&#30340;&#22833;&#36133;&#12290;&#21482;&#35201;&#19968;&#27425;&#32416;&#27491;&#30340;&#20195;&#20215;&#22343;&#25674;&#21040; fast path &#19978;&#27604;&#36739;&#23567; (&#21738;&#24597;&#20351;&#29992;&#20840;&#23616;&#30340;&#38145;)&#65292;&#25972;&#20010;&#31995;&#32479;&#30340;&#24615;&#33021;&#23601;&#20381;&#28982;&#24456;&#39640;&#12290;</li>
</ol>
<p class=" font-serif my-1">&#20363;&#22914;&#65292;&#25105;&#20204;&#19981;&#22952;&#25226;&#21487;&#29992;&#30340;&#20869;&#23384;&#20998;&#25104;&#19968;&#20010;&#19968;&#20010;&#30340; &#8220;&#39029;&#38754;&#8221; (page)&#65292;&#35774;&#23450;&#19968;&#20010;&#36739;&#20026;&#21487;&#35266;&#30340;&#22823;&#23567;&#65292;&#20363;&#22914; 8 KiB, 32 KiB &#31561;&#12290;&#27599;&#20010;&#32447;&#31243;&#37117;&#25317;&#26377;&#19968;&#20010;&#29992;&#20110;&#20998;&#37197;&#30340;&#39029;&#38754;&#65307;&#20110;&#26159;&#65292;&#24403; malloc &#21457;&#29983;&#26102;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">
<p class=" font-serif my-1">(fast path) &#39318;&#20808;&#35797;&#22270;&#22312;&#32447;&#31243;&#33258;&#24049;&#25317;&#26377;&#30340; page &#24403;&#20013;&#36827;&#34892;&#20998;&#37197;&#65292;&#20998;&#37197;&#26102;&#19981;&#22952;&#20026;&#36825;&#20010; page &#19978;&#38145; (&#22240;&#20026;&#21487;&#33021;&#26377;&#26469;&#33258;&#20854;&#20182;&#32447;&#31243;&#24182;&#21457;&#30340; free&#65307;&#31995;&#32479;&#20801;&#35768;&#22312;&#19968;&#20010;&#32447;&#31243;&#20998;&#37197;&#30340;&#20869;&#23384;&#22312;&#21478;&#19968;&#20010;&#32447;&#31243;&#22238;&#25910;)&#12290;&#34429;&#28982;&#19978;&#20102;&#38145;&#65292;&#20294;&#19981;&#21516;&#30340;&#32447;&#31243;&#30340; page &#26159;&#19981;&#21516;&#30340;&#65292;&#22240;&#27492;&#32447;&#31243;&#20381;&#28982;&#21487;&#20197;&#24182;&#34892;&#22320;&#20998;&#37197;&#20869;&#23384;&#12290;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#30456;&#23545;&#24212;&#30340; free &#26102;&#65292;&#33719;&#24471;&#23545;&#35937;&#23545;&#24212;&#39029;&#38754;&#30340;&#38145;&#21518;&#22238;&#25910;&#8212;&#8212;&#22914;&#26524; page &#30340;&#20998;&#37197;&#20445;&#35777;&#23545;&#40784;&#21040; page &#36793;&#30028;&#65292;&#25105;&#20204;&#21487;&#20197;&#30452;&#25509;&#20351;&#29992; <code>ptr &amp; (PAGESIZE - 1)</code> &#33719;&#24471;&#39029;&#38754;&#30340;&#39318;&#22320;&#22336;&#12290;</li>
<li class=" ml-8">&#36825;&#37324;&#26377;&#19968;&#20010;&#23567;&#25216;&#24039;&#65292;&#25105;&#20204;&#21487;&#20197;&#27963;&#29992; C &#35821;&#35328;&#25552;&#20379;&#30340;&#29305;&#24615;&#65292;&#23450;&#20041;&#32467;&#26500;&#20307;&#31649;&#29702;&#39029;&#38754;&#12290;&#36825;&#20250;&#20351;&#20320;&#20889;&#20986;&#26356;&#24178;&#20928;&#28165;&#29245;&#30340; L1 &#20195;&#30721;&#65306;<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#38145;&#65292;&#29992;&#20110;&#20018;&#34892;&#21270;&#20998;&#37197;&#21644;&#24182;&#21457;&#30340; free</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">obj_cnt</span><span class="p">;</span><span class="w">     </span><span class="c1">// &#39029;&#38754;&#20013;&#24050;&#20998;&#37197;&#30340;&#23545;&#35937;&#25968;&#65292;&#20943;&#23569;&#21040; 0 &#26102;&#22238;&#25910;&#39029;&#38754;</span>
<span class="w">    </span><span class="n">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">  </span><span class="c1">// &#23646;&#20110;&#21516;&#19968;&#20010;&#32447;&#31243;&#30340;&#39029;&#38754;&#30340;&#38142;&#34920;</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">};</span><span class="w"> </span><span class="c1">// &#21311;&#21517;&#32467;&#26500;&#20307;</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">header</span><span class="p">[</span><span class="n">HDR_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">HDR_SIZE</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="p">}</span><span class="w"> </span><span class="n">page_t</span><span class="p">;</span>
</code></pre></div>

</li>
</ul>
</li>
<li class=" ml-8">
<p class=" font-serif my-1">(slow path 1) &#24403; fast path &#22833;&#36133;&#26102;&#65292;&#25105;&#20204;&#20351;&#29992;&#20840;&#23616;&#30340;&#38145;&#20998;&#37197;&#19968;&#20010;&#26032;&#30340;&#39029;&#38754;&#65292;&#24182;&#22312;&#26032;&#30340;&#39029;&#38754;&#20013;&#20998;&#37197;&#20869;&#23384;&#8212;&#8212;&#27492;&#26102;&#20998;&#37197;&#24635;&#26159;&#20250;&#25104;&#21151;&#12290;&#24403;&#28982;&#65292;&#20998;&#37197;&#26032;&#30340;&#39029;&#38754;&#24847;&#21619;&#30528;&#32447;&#31243;&#23558;&#20250; &#8220;&#25317;&#26377;&#8221; &#19981;&#27490;&#19968;&#20010; pages&#12290;&#25105;&#20204;&#21487;&#20197;&#29992;&#21512;&#29702;&#30340;&#25968;&#25454;&#32467;&#26500;&#25226;&#36825;&#20123;&#39029;&#38754;&#32500;&#25252;&#36215;&#26469;&#65292;&#20363;&#22914;&#38142;&#34920;&#12290;</p>
</li>
<li class=" ml-8">(slow path 2) &#24403;&#30003;&#35831;&#24040;&#22823;&#30340;&#20869;&#23384; (&#20363;&#22914;&#19968;&#20010;&#25110;&#22810;&#20010;&#39029;&#38754;&#22823;&#23567;&#30340;&#20869;&#23384;) &#26102;&#65292;&#25105;&#20204;&#21516;&#26679;&#25345;&#26377;&#20840;&#23616;&#30340;&#38145;&#36827;&#34892;&#20998;&#37197;&#12290;&#22240;&#20026;&#22823;&#20869;&#23384;&#30340;&#20998;&#37197;&#24635;&#26159;&#24847;&#21619;&#30528;&#36825;&#20123;&#20998;&#37197;&#30340;&#20869;&#23384;&#38656;&#35201; &#8220;&#20351;&#29992;&#8221;&#65292;&#25152;&#20197;&#20840;&#23616;&#30340;&#38145;&#22312;&#23454;&#38469;&#20013;&#39044;&#26399;&#24212;&#35813;&#19981;&#20250;&#25104;&#20026;&#20005;&#37325;&#30340;&#24615;&#33021;&#29942;&#39048;&#12290;</li>
</ol>
<p class=" font-serif my-1">&#21487;&#20197;&#35828;&#65292;&#25152;&#26377;&#29616;&#20195;&#30340; malloc/free &#31639;&#27861;&#37117;&#26159;&#22522;&#20110;&#19978;&#36848;&#30340; fast/slow path &#35774;&#35745;&#30340;&#12290;&#20363;&#22914;&#22312; <a href="https://google.github.io/tcmalloc/" class=" text-amber-900">TCMalloc</a> &#20013;&#65292;&#27599;&#20010; thread (&#29616;&#22312;&#26356;&#20808;&#36827;&#30340;&#23454;&#29616;&#26159;&#27599;&#20010; cpu) &#26377; 88 &#20010;&#24120;&#35265;&#22823;&#23567;&#30340;&#20998;&#37197;&#22120;&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/per-thread-structure.png" width="430px"></p>
<p class=" font-serif my-1">&#20998;&#37197;&#23567;&#20869;&#23384;&#23545;&#35937;&#26102;&#65292;&#25105;&#20204;&#30340; fast path &#30452;&#25509;&#25214;&#21040;&#27604;&#25105;&#20204;&#24453;&#30003;&#35831;&#23545;&#35937;&#22823;&#19968;&#20123;&#30340; size-class&#65292;&#20854;&#20013;&#25152;&#26377;&#30340;&#31354;&#38386;&#23545;&#35937;&#32452;&#32455;&#25104;&#21333;&#21521;&#38142;&#34920;&#65292;&#19968;&#26465;&#21407;&#23376;&#25351;&#20196;&#23601;&#33021;&#23436;&#25104;&#20998;&#37197;/&#22238;&#25910;&#12290;&#24403; fast path &#26080;&#27861;&#25214;&#21040;&#31354;&#38386;&#30340;&#23545;&#35937;&#26102;&#65292;&#36827;&#20837; slow path &#20998;&#37197;&#19968;&#20010;&#26032;&#30340; per-thread (per-cpu) page&#12290;</p>
<p class=" font-serif my-1">&#22312; slow path &#20013;&#65292;&#8220;central free list&#8221; &#23454;&#38469;&#26159;&#19968;&#20010;&#22810;&#21449;&#30340;&#32447;&#27573;&#26641; (radix tree)&#65292;&#33021;&#22815;&#25903;&#25345;&#24555;&#36895;&#22320;&#12289;&#20197; page &#20026;&#21333;&#20301;&#30340;&#20869;&#23384;&#20998;&#37197;&#12290;&#22240;&#20026;&#20197; page &#20026;&#21333;&#20301;&#65292;&#25968;&#25454;&#32467;&#26500;&#30340;&#24320;&#38144;&#23601;&#34987;&#24456;&#22823;&#31243;&#24230;&#22320;&#22343;&#25674;&#20102;&#12290;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/pagemap.png" width="640px"></p>
<p class=" font-serif my-1">&#38500;&#27492;&#20043;&#22806;&#65292;TCMalloc &#36824;&#20026;&#27599;&#20010; class-size &#37117;&#25552;&#20379;&#20102;&#19968;&#20010; central free list&#65292;&#36827;&#19968;&#27493;&#22686;&#21152;&#24182;&#34892;&#24230; (&#20294;&#20250;&#28010;&#36153;&#19968;&#20123;&#31354;&#38388;&#8212;&#8212;&#20294;&#22312;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#36827;&#31243;&#37324;&#65292;&#20998;&#37197;&#20294;&#19981;&#35775;&#38382;&#30340;&#39029;&#38754;&#21482;&#26159;&#34987;&#26631;&#35760;&#65292;&#22240;&#27492;&#23454;&#38469;&#24341;&#36215;&#30340;&#20195;&#20215;&#26159;&#20302;&#24471;&#22810;&#30340;)&#12290;&#22312;&#19968;&#20010;&#24037;&#19994;&#32423;&#30340; malloc/free &#20013;&#65292;&#35832;&#22914;&#27492;&#31867;&#30340;&#32454;&#33410;&#25968;&#19981;&#32988;&#25968;&#65292;&#20363;&#22914;&#20854;&#20182;&#22686;&#21152; cache/TLB friendliness &#30340;&#32454;&#33410;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_4" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#20026;&#20160;&#20040;&#37117;&#26159;&#22806;&#22269;&#20154;&#12289;&#22806;&#22269;&#20844;&#21496;&#65311;</h4>
<p class=" font-serif my-1">&#22797;&#26434;&#12289;&#39640;&#25928;&#12289;&#21487;&#38752;&#30340;&#31995;&#32479;&#24456;&#38590;&#22312;&#23567;&#20316;&#22346;&#37324;&#29983;&#20135;&#20986;&#26469;&#65292;&#36825;&#20063;&#26159;&#20026;&#20160;&#20040;&#22823;&#23478;&#19968;&#35848;&#21450; &#8220;&#22269;&#20135;&#36719;&#20214;&#8221;&#12289;&#8220;&#22269;&#20135;&#33455;&#29255;&#8221;&#12289;&#8220;&#22269;&#20135;&#25805;&#20316;&#31995;&#32479;&#8221;&#65292;&#24635;&#26159;&#32852;&#24819;&#21040;&#21508;&#31181;&#39575;&#23376;&#20844;&#21496; (&#8220;&#22269;&#20135;&#33455;&#29255;&#8221; &#30340; flag &#23621;&#28982;&#25104;&#20102;&#31070;&#39044;&#35328;) &#21644;&#27969;&#20135;&#30340;&#22269;&#23478;&#39033;&#30446;&#12290;&#22914;&#26524;&#21315;&#21315;&#19975;&#19975;&#22823;&#23398;&#29983;&#23398;&#20064;&#30340;&#37117;&#26159; &#8220;&#23567;&#20316;&#22346;&#8221; &#24335;&#30340;&#24037;&#20316;&#26041;&#24335;&#65292;&#25351;&#26395;&#23569;&#25968;&#20960;&#20010;&#20154;&#25903;&#25745;&#36215;&#20013;&#22269;&#30340;&#31995;&#32479;&#30828;&#20214;/&#36719;&#20214;&#20135;&#19994;&#65292;&#26681;&#26412;&#23601;&#26159;&#22825;&#26041;&#22812;&#35885;&#12290;</p>
<p class=" font-serif my-1">&#29616;&#20195;&#31995;&#32479;&#35774;&#35745;&#26377;&#25104;&#29087;&#30340;&#29702;&#35770;&#12289;&#25216;&#26415;&#12289;&#37197;&#22871;&#30340;&#29616;&#20195;&#21270;&#24037;&#20855;&#65292;&#36951;&#25022;&#30340;&#26159;&#65292;&#25105;&#20204;&#22269;&#23478;&#25484;&#25569;&#36825;&#20123;&#24037;&#20855;&#30340;&#20154;&#32676;&#22826;&#23569;&#12290;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#31561;&#31995;&#21015;&#35838;&#31243;&#20316;&#20026;&#22823;&#23478;&#23398;&#20064; &#8220;&#31995;&#32479;&#8221; &#30340;&#36215;&#28857; (&#34429;&#28982;&#25105;&#20204;&#35762;&#35299;&#30340;&#37117;&#26159;&#31616;&#21270;&#30340;&#29256;&#26412;&#65292;&#20294;&#22522;&#26412;&#21407;&#29702;&#21644;&#24605;&#24819;&#26041;&#27861;&#21644;&#29616;&#20195;&#36719;&#20214;&#31995;&#32479;&#19968;&#33268;)&#65292;&#24076;&#26395;&#24110;&#21161;&#22823;&#23478;&#19981;&#20877;&#30031;&#24807;&#26597;&#38405;&#25163;&#20876;&#21644;&#20351;&#29992;&#24037;&#20855;&#65292;&#20063;&#19981;&#20877;&#30031;&#24807;&#20284;&#20046;&#26377;&#20123;&#22256;&#38590;&#30340;&#31995;&#32479;&#32534;&#31243;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#22914;&#26524;&#20320;&#23545;&#23454;&#38469;&#31995;&#32479;&#30340; malloc/free &#26377;&#20852;&#36259;&#65292;&#21487;&#20197;&#38405;&#35835;&#21442;&#32771;&#36164;&#26009;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.geeksforgeeks.org/operating-system-allocating-kernel-memory-buddy-system-slab-system/" class=" text-amber-900">buddy &#21644; slab</a>;</li>
<li class=" ml-8"><a href="https://google.github.io/tcmalloc/" class=" text-amber-900">TCMalloc: Thread-Caching Malloc</a>;</li>
<li class=" ml-8"><a href="https://sourceware.org/glibc/wiki/MallocInternals" class=" text-amber-900">malloc Internals</a>;</li>
<li class=" ml-8"><a href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html" class=" text-amber-900">OpenJDK G1 Garbage Collector</a>&#12290;</li>
</ul></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../../../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../../../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>