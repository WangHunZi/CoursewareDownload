<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>&#24182;&#21457;&#25511;&#21046;&#65306;&#20114;&#26021; (2)</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="../../../index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="../../2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="2" class=" text-2xl mt-2 font-sans">&#24182;&#21457;&#25511;&#21046;&#65306;&#20114;&#26021; (2)</h1>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#26412;&#35762;&#38405;&#35835;&#26448;&#26009;</h4>
<p class=" font-serif my-1">&#26412;&#35762;&#38405;&#35835;&#26448;&#26009;&#20026;&#26412;&#35762;&#20041;&#12290;&#35831;&#22823;&#23478;&#19979;&#36733; xv6 &#30340;&#20195;&#30721;&#65292;&#24182;&#21442;&#32771;&#35838;&#22530;&#24405;&#20687;&#36827;&#34892;&#35843;&#35797;&#12290;</p>
</blockquote>
<h2 id="1" class=" text-xl mt-2 pb-2 font-sans">1. &#35299;&#20915;&#33258;&#26059;&#36896;&#25104;&#30340;&#28010;&#36153;</h2>
<h3 id="11" class=" text-lg mt-2 pb-2 font-sans">1.1. &#33258;&#26059;&#38145;&#21644;&#28010;&#36153;&#38382;&#39064;</h3>
<p class=" font-serif my-1">&#33258;&#26059;&#38145;&#22312;&#33719;&#24471;&#38145;&#22833;&#36133;&#20043;&#21518;&#26377;&#19968;&#20010; &#8220;&#36718;&#35810;&#8221; &#30340;&#24490;&#29615;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// &#33719;&#24471;&#38145;&#22833;&#36133;&#65292;&#38656;&#35201;&#20877;&#27425;&#23581;&#35797;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#24102;&#26469;&#22823;&#40635;&#28902;&#30340;&#26159;&#65292;&#25105;&#20204;&#30340;&#19968;&#20010; CPU &#19978;&#36816;&#34892;&#30340;&#32447;&#31243;&#24182;&#19981;&#21482;&#26377;&#19968;&#20010;&#8212;&#8212;&#31995;&#32479;&#37324;&#21487;&#20197;&#26377;&#25968;&#21315;&#12289;&#25968;&#19975;&#29978;&#33267;&#26356;&#22810;&#30340;&#32447;&#31243;&#65292;&#23427;&#20204;&#22312;&#20013;&#26029;&#30340;&#39537;&#21160;&#19979;&#20849;&#20139;&#19968;&#20010; CPU&#12290;&#36825;&#23601;&#36896;&#25104;&#22823;&#40635;&#28902;&#20102;&#65306;&#20551;&#35774;&#19968;&#20010;&#32447;&#31243;&#22312;&#33719;&#24471;&#33258;&#26059;&#38145;&#20197;&#21518;&#34987;&#20013;&#26029;&#65292;&#20999;&#25442;&#21040;&#21478;&#22806;&#19968;&#20010;&#32447;&#31243;&#25191;&#34892; (&#20551;&#35774;&#36825;&#20010;&#32447;&#31243;&#20063;&#38656;&#35201;&#33719;&#24471;&#21516;&#19968;&#20010;&#33258;&#26059;&#38145;)&#65292;&#24182;&#19988;&#20854;&#20182;&#22788;&#29702;&#22120;&#19978;&#30340;&#32447;&#31243;&#20063;&#38656;&#35201;&#33719;&#24471;&#21516;&#19968;&#20010;&#33258;&#26059;&#38145;&#8212;&#8212;&#25105;&#20204;&#23601;&#20986;&#29616;&#20102; &#8220;&#25345;&#26377;&#38145;&#30340;&#32447;&#31243;&#22312;&#30561;&#35273;&#12289;&#27809;&#26377;&#38145;&#30340;&#32447;&#31243;&#22312; CPU &#19978;&#22260;&#35266;&#8221; &#30340;&#23604;&#23596;&#22330;&#38754;&#12290;&#22914;&#26524;&#25345;&#26377;&#38145;&#30340;&#32447;&#31243;&#22312;&#31561;&#24453;&#38271;&#26102;&#38388;&#30340;&#25805;&#20316; (&#20363;&#22914; I/O)&#65292;&#28010;&#36153;&#22914;&#27492;&#22810;&#23453;&#36149;&#30340; CPU &#36164;&#28304;&#23436;&#20840;&#26159;&#38590;&#20197;&#25509;&#21463;&#30340;&#12290;</p>
<h3 id="12" class=" text-lg mt-2 pb-2 font-sans">1.2. &#20114;&#26021;&#38145;</h3>
<p class=" font-serif my-1">&#22914;&#20309;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#21602;&#65311;&#35831;&#22823;&#23478;&#38405;&#35835;&#25945;&#31185;&#20070; 28.14 &#21040;&#31456;&#33410;&#26411;&#23614;&#30340;&#20869;&#23481;&#12290;</p>
<h2 id="2_1" class=" text-xl mt-2 pb-2 font-sans">2. &#25805;&#20316;&#31995;&#32479;&#20013;&#30340;&#20114;&#26021;</h2>
<p class=" font-serif my-1">&#22914;&#20309;&#22312;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#23454;&#29616;&#20114;&#26021;&#21602;&#65311;&#35753;&#25105;&#20204;&#39318;&#20808;&#22238;&#39038;&#19968;&#19979;&#20160;&#20040;&#26159; &#8220;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#8221;&#12290;&#22312;&#36825;&#37324;&#65292;<a href="../../AbstractMachine/index.html" class=" text-amber-900">AbstractMachine &#25991;&#26723;</a>&#24212;&#35813;&#23545;&#22823;&#23478;&#24456;&#26377;&#24110;&#21161;&#12290;&#22312;&#25509;&#19979;&#26469;&#30340;&#37096;&#20998;&#65292;&#25105;&#20204;&#20551;&#35774;&#20320;&#24050;&#32463;&#22312; Lab0 &#20013;&#29087;&#24713;&#20102; &#8220;&#20026; bare-metal &#32534;&#31243;&#8221; &#30340;&#22522;&#26412;&#27010;&#24565;&#12290;</p>
<h3 id="21" class=" text-lg mt-2 pb-2 font-sans">2.1. &#35745;&#31639;&#26426;&#30828;&#20214;&#31995;&#32479;&#30340;&#29366;&#24577;&#26426;&#27169;&#22411;</h3>
<p class=" font-serif my-1">&#23454;&#38469;&#19978;&#65292;bare-metal &#19978;&#30340;&#25805;&#20316;&#31995;&#32479;&#21644;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#31243;&#24207;&#19968;&#26679;&#65292;&#21487;&#20197;&#30475;&#25104;&#26159;<a href="OS2021_3.html" class=" text-amber-900">&#29366;&#24577;&#26426;</a>&#12290;&#22312;&#35838;&#22530;&#19978;&#65292;&#25105;&#20204;&#21453;&#22797;&#28436;&#31034; (&#21644;&#24378;&#35843;) &#24182;&#21457;&#31243;&#24207;&#30340;&#22810;&#20010;&#32447;&#31243;&#25317;&#26377;&#29420;&#31435;&#30340;&#23492;&#23384;&#22120;&#12289;&#22534;&#26632; (&#20294;&#19981;&#21516;&#32447;&#31243;&#30340;&#22534;&#26632;&#20301;&#20110;&#21516;&#19968;&#20010;&#22320;&#22336;&#31354;&#38388;&#20013;&#65292;&#25105;&#20204;&#24050;&#32463;&#22312;&#35838;&#22530;&#19978;&#23637;&#31034;&#36807;)&#65292;&#20849;&#20139;&#20195;&#30721;&#21644;&#25968;&#25454;&#12290;&#24182;&#21457;&#31243;&#24207;&#20013;&#26377;&#19968;&#20221;&#20849;&#20139;&#30340;&#20869;&#23384;&#65292;&#20294;&#27599;&#20010;&#32447;&#31243;&#37117;&#26377;&#29420;&#31435;&#30340;&#23492;&#23384;&#22120;&#12290;&#22240;&#27492;&#20551;&#35774;&#31995;&#32479;&#20013;&#26377; $n$ &#20010;&#32447;&#31243;&#65292;&#37027;&#20040;&#29366;&#24577;&#30475;&#36215;&#26469;&#23601;&#26159;$$(M, R_1, R_2, \ldots, R_n).$$</p>
<p class=" font-serif my-1">&#32780;&#23454;&#38469;&#19978;&#65292;&#35745;&#31639;&#26426;&#31995;&#32479;&#26412;&#36523;&#23436;&#20840;&#20063;&#21487;&#20197;&#30475;&#25104;&#29366;&#24577;&#26426;&#12290;&#36825;&#20010;&#27010;&#24565;&#23545;&#23398;&#20064;&#36807;&#12298;&#35745;&#31639;&#26426;&#31995;&#32479;&#22522;&#30784;&#12299;&#30340;&#21516;&#23398;&#26469;&#35828;&#24212;&#35813;&#19968;&#28857;&#20063;&#19981;&#38476;&#29983;&#8212;&#8212;&#25105;&#20204;&#30340;&#35745;&#31639;&#26426;&#23436;&#20840;&#21487;&#20197;&#30475;&#25104;&#26159;&#19968;&#20010;&#25968;&#23383;&#30005;&#36335;&#65292;&#31867;&#20284;&#20110;&#22823;&#23478;&#22312;&#12298;&#25968;&#23383;&#36923;&#36753;&#30005;&#36335;&#12299;&#35838;&#31243;&#20013;&#23398;&#20064;/&#23454;&#39564;&#36807;&#30340; &#8220;&#35745;&#25968;&#22120;&#8221;&#65292;&#32780;&#22312;&#12298;&#35745;&#31639;&#26426;&#31995;&#32479;&#22522;&#30784;&#12299;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#32534;&#20889;&#20102;&#19968;&#20010; &#8220;&#25968;&#23383;&#30005;&#36335;&#27169;&#25311;&#22120;&#8221;&#12290;</p>
<h4 id="211" class=" pt-2 pb-2 font-sans">2.1.1. &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#8221; &#30340;&#29366;&#24577;</h4>
<p class=" font-serif my-1">&#20351;&#29992; QEMU &#27169;&#25311;&#22120;&#30340; monitor&#65292;&#25105;&#20204;&#21487;&#20197;&#26597;&#30475; x86 &#22788;&#29702;&#22120;&#19978;&#25152;&#26377;&#23492;&#23384;&#22120;&#30340;&#29366;&#24577;&#8212;&#8212;&#27880;&#24847;&#24456;&#22810;&#23492;&#23384;&#22120;&#22312;&#36827;&#31243;&#30340;&#35282;&#24230;&#26159;&#19981;&#21487;&#35265;&#30340;&#65292;&#26377;&#20123;&#37096;&#20998;&#21363;&#20415;&#36827;&#31243;&#21487;&#35265;&#65292;&#20294;&#19981;&#33021;&#20462;&#25913; (&#20363;&#22914;&#36827;&#31243;&#25191;&#34892; <code>cli</code> &#25351;&#20196;&#35797;&#22270;&#28165;&#38500; <code>%eflags</code> &#20013;&#30340; <code>FL_IF</code> &#23558;&#20250;&#23548;&#33268; segmentation fault)&#12290;</p>
<p class=" font-serif my-1">&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#29992;&#19968;&#32452;&#36873;&#39033;&#21551;&#21160; QEMU:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>-nographic</code> &#19981;&#21551;&#21160;&#22270;&#24418;&#30028;&#38754; (&#25152;&#20197;&#20570;&#25805;&#20316;&#31995;&#32479;&#23454;&#39564;&#20854;&#23454;&#24182;&#19981;&#38656;&#35201;&#20219;&#20309;&#22270;&#24418;&#30028;&#38754;&#8230;&#8230;)</li>
<li class=" ml-8"><code>-S</code> &#20351; QEMU &#22312; CPU Reset &#20043;&#21518;&#26242;&#20572;&#19981;&#20877;&#25191;&#34892;&#25351;&#20196;</li>
</ul>
<p class=" font-serif my-1">&#28982;&#21518;&#65292;&#25105;&#20204;&#25353; <red>[&#26576;&#20010;&#24555;&#25463;&#38190;]</red> &#36827;&#20837; monitor (&#35831; RTFM/STFW&#65292;&#36825;&#20010;&#29305;&#24615;&#23545;&#22823;&#23478;&#38750;&#24120;&#26377;&#29992;&#65292;&#25152;&#20197;&#24378;&#36843;&#22823;&#23478;&#35835;&#19968;&#19979;&#25163;&#20876;)&#65292;&#25191;&#34892; monitor &#21629;&#20196; <code>info registers</code>:</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>(qemu) info registers 
EAX=00000000 EBX=00000000 ECX=00000000 EDX=00000663
ESI=00000000 EDI=00000000 EBP=00000000 ESP=00000000
EIP=0000fff0 EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0000 00000000 0000ffff 00009300
CS =f000 ffff0000 0000ffff 00009b00
SS =0000 00000000 0000ffff 00009300
DS =0000 00000000 0000ffff 00009300
FS =0000 00000000 0000ffff 00009300
GS =0000 00000000 0000ffff 00009300
LDT=0000 00000000 0000ffff 00008200
TR =0000 00000000 0000ffff 00008b00
GDT=     00000000 0000ffff
IDT=     00000000 0000ffff
CR0=60000010 CR2=00000000 CR3=00000000 CR4=00000000
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 
DR6=00000000ffff0ff0 DR7=0000000000000400
EFER=0000000000000000
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000
XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000
XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000
XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000
</code></pre></div>

<p class=" font-serif my-1">&#27492;&#26102;&#31995;&#32479;&#22788;&#20110; 16-bit &#27169;&#24335; (<code>CR0 = 60000010</code>)&#65292;&#24182;&#19988;&#33021;&#30475;&#21040; 32-bit &#27169;&#24335;&#19979;&#30340;&#19968;&#20123;&#23492;&#23384;&#22120;&#12290;&#23492;&#23384;&#22120;&#30340;&#21021;&#22987;&#20540;&#24050;&#25353;&#29031;&#25163;&#20876;&#30340;&#35201;&#27714;&#21021;&#22987;&#21270; (&#20363;&#22914; <code>CS:IP = 0xffff0</code>)&#12290;&#36825;&#23601;&#26159; QEMU &#30524;&#20013; &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#8221; &#38500;&#20102;&#20869;&#23384;&#37096;&#20998;&#20197;&#22806;&#30340;&#29366;&#24577;&#12290;&#22914;&#26524;&#25105;&#20204;&#35843;&#35797;&#36827;&#20837; 64-bit &#27169;&#24335;&#20197;&#21518;&#30340;&#20195;&#30721;&#65292;QEMU &#21487;&#35265;&#30340;&#23492;&#23384;&#22120;&#20063;&#21457;&#29983;&#20102;&#21464;&#21270;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>RAX=00000000000048af RBX=0000000000103520 RCX=0000000000000001 RDX=00000000000003f8
RSI=0000000000000001 RDI=0000000000000000 RBP=0000000000103527 RSP=0000000000106f30
R8 =0000000000000000 R9 =0000000000000000 R10=0000000000000000 R11=0000000000000000
R12=0000000000000000 R13=0000000000000000 R14=0000000000000000 R15=0000000000000000
RIP=00000000001001d0 RFL=00000283 [--S---C] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0000 0000000000000000 00000000 00000000
CS =0008 0000000000000000 00000000 00209a00 DPL=0 CS64 [-R-]
SS =0000 0000000000000000 ffffffff 00c09300 DPL=0 DS   [-WA]
DS =0000 0000000000000000 00000000 00000000
FS =0000 0000000000000000 00000000 00000000
GS =0000 0000000000000000 00000000 00000000
LDT=0000 0000000000000000 0000ffff 00008200 DPL=0 LDT
TR =0028 0000000000108060 00000067 00408900 DPL=0 TSS64-avl
GDT=     0000000000108028 00000038
IDT=     0000000000106fc0 00001000
CR0=80000011 CR2=0000000000000000 CR3=0000000000001000 CR4=00000020
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 
DR6=00000000ffff0ff0 DR7=0000000000000400
EFER=0000000000000500
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000
XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000
XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000
XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000
XMM08=00000000000000000000000000000000 XMM09=00000000000000000000000000000000
XMM10=00000000000000000000000000000000 XMM11=00000000000000000000000000000000
XMM12=00000000000000000000000000000000 XMM13=00000000000000000000000000000000
XMM14=00000000000000000000000000000000 XMM15=00000000000000000000000000000000
</code></pre></div>

<p class=" font-serif my-1">&#22823;&#23478;&#19981;&#24517;&#29702;&#35299;&#23427;&#20204;&#30340;&#21547;&#20041;&#65292;&#21482;&#38656;&#30693;&#36947;&#31995;&#32479;&#23492;&#23384;&#22120;&#27604; gdb &#35843;&#35797;&#36827;&#31243;&#26102;&#21487;&#35265;&#30340;&#23492;&#23384;&#22120;&#23569;&#24471;&#22810;&#8212;&#8212;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#36827;&#31243;&#26080;&#26435;&#35775;&#38382;&#20854;&#20013;&#30456;&#24403;&#30340;&#19968;&#37096;&#20998;&#12290;&#20551;&#35774;&#24403;&#21069;&#35745;&#31639;&#26426;&#31995;&#32479;&#30340;&#29366;&#24577;&#26159; $(M, SR)$ ($SR$ &#26159;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;&#23492;&#23384;&#22120;)&#12290;&#23545;&#20110;&#19968;&#20010;&#21333;&#22788;&#29702;&#22120;&#31995;&#32479;&#65292;&#23427;&#30340;&#34892;&#20026;&#23601;&#26159;&#25353;&#29031;&#25163;&#20876;&#21462;&#25351;&#20196; &#8594; &#35793;&#30721; &#8594; &#25191;&#34892; &#8594; &#20889;&#22238;&#23492;&#23384;&#22120;/&#20869;&#23384;&#30340;&#29366;&#24577;&#65292;&#24471;&#21040;&#25351;&#20196;&#25191;&#34892;&#23436;&#25104;&#21518;&#30340;&#29366;&#24577; $(M', SR')$&#65292;&#22914;&#27492;&#24448;&#22797;&#8212;&#8212;&#35745;&#31639;&#26426;&#31995;&#32479;&#23601;&#21487;&#20197;&#30475;&#25104;&#26159;&#19968;&#20010;&#29366;&#24577;&#26426;&#12290;</p>
<h4 id="212" class=" pt-2 pb-2 font-sans">2.1.2. &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#8221; &#20316;&#20026;&#29366;&#24577;&#26426;&#30340;&#25191;&#34892;</h4>
<p class=" font-serif my-1">&#21644;&#25805;&#20316;&#31995;&#32479;&#36827;&#31243;&#20013;&#30340;&#32447;&#31243;&#19968;&#26679;&#65292;&#35745;&#31639;&#26426;&#31995;&#32479;&#21487;&#20197;&#26377;&#22810;&#20010;&#20849;&#20139;&#20869;&#23384;&#30340;&#22788;&#29702;&#22120;&#65292;&#27599;&#20010;&#22788;&#29702;&#22120;&#37117;&#26377;&#19968;&#20221;&#29420;&#31435;&#30340;&#23492;&#23384;&#22120;&#29616;&#22330; (&#21253;&#25324;&#21018;&#25165;&#30475;&#21040;&#30340;&#25152;&#26377;&#23492;&#23384;&#22120;&#29616;&#22330;&#65281;)&#12290;&#31995;&#32479;&#20013;&#30340;&#22788;&#29702;&#22120;&#21487;&#20197;&#24182;&#34892;&#25191;&#34892;&#65292;&#20063;&#22914;&#21516;&#36827;&#31243;&#20013;&#30340;&#32447;&#31243;&#19968;&#26679;&#12290;&#20174;&#29366;&#24577;&#26426;&#30340;&#35282;&#24230;&#65292;&#26576;&#19968;&#26102;&#21051;&#31995;&#32479;&#30340;&#29366;&#24577;&#22788;&#20110; $(M, SR_1, SR_2, \ldots, SR_n)$&#65292;&#37027;&#20040;&#25105;&#20204;&#21487;&#20197; &#8220;&#36873;&#25321;&#19968;&#20010;&#22788;&#29702;&#22120;&#8221; $i$ &#25191;&#34892;&#65292;&#21363;&#25226;&#24403;&#21069;&#30340;&#35745;&#31639;&#26426;&#31995;&#32479;&#30475;&#25104;&#26159; $(M, SR_i)$&#65292;&#25191;&#34892;&#19968;&#26465;&#25351;&#20196;&#24471;&#21040; $(M', SR_i')$&#65292;&#23558;&#27492;&#26102;&#31995;&#32479;&#30340;&#29366;&#24577;&#26356;&#26032;&#20026; $$(M, SR_1, SR_2, \ldots, SR_i', SR_{i+1}, \ldots, SR_n).$$</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="simultaneous-multi-threading-smt" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">Simultaneous Multi-Threading (SMT)</h4>
<p class=" font-serif my-1">&#22312;&#25105;&#20204;&#33021;&#36141;&#20080;&#21040;&#30340;&#22788;&#29702;&#22120;&#20013;&#65292;&#32463;&#24120;&#33021;&#35265;&#21040;&#26680;&#24515;&#25968;&#19982;&#32447;&#31243;&#25968;&#19981;&#21516;&#65292;&#20363;&#22914; 24C/48T &#30340;&#22788;&#29702;&#22120;&#12290;&#27492;&#26102;&#30340; &#8220;&#32447;&#31243;&#8221; &#20027;&#35201;&#23601;&#26159;&#25351;&#23492;&#23384;&#22120;&#29616;&#22330;&#12290;24C/48T &#30340;&#22788;&#29702;&#22120;&#23558;&#26377; 48 &#20221;&#29420;&#31435;&#30340;&#23492;&#23384;&#22120; (&#21644;&#30456;&#24212;&#30340;&#20195;&#30721;&#25191;&#34892;&#30005;&#36335;)&#65292;&#20294;&#35832;&#22914;&#36816;&#31639;&#22120;&#12289;L1 &#32531;&#23384;&#31561;&#65292;&#37117;&#21482;&#26377; 24 &#20221;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#36816;&#31639;&#22120;/&#32531;&#23384;&#23545;&#19968;&#20010;&#23492;&#23384;&#22120;&#29616;&#22330;&#26469;&#35828;&#26174;&#24471;&#26377;&#20123;&#23500;&#20313;&#26102;&#65292;&#35753;&#20004;&#20010;&#32447;&#31243; (&#23492;&#23384;&#22120;&#29616;&#22330;) &#20849;&#20139;&#23427;&#20204;&#23601;&#26377;&#24847;&#20041;&#20102;&#8212;&#8212;&#22312;&#21516;&#19968;&#20010;&#26680;&#24515;&#19978;&#30340;&#20004;&#20010;&#32447;&#31243;&#20013;&#65292;&#20854;&#20013;&#19968;&#20010;&#21457;&#29983; cache miss &#26102;&#65292;&#21478;&#19968;&#20010;&#32447;&#31243;&#20381;&#28982;&#21487;&#20197;&#32487;&#32493;&#20351;&#29992;&#26680;&#24515;&#20013;&#30340;&#36164;&#28304;&#25191;&#34892;&#12290;&#22240;&#27492;&#65292;&#22312;&#25805;&#20316;&#31995;&#32479;&#30475;&#26469;&#65292;48 &#20010;&#32447;&#31243;&#23601;&#20687;&#26159; 48 &#20010;&#36923;&#36753;&#22788;&#29702;&#22120;&#65292;&#22240;&#27492;&#22312; <code>/proc/cpuinfo</code> &#20013;&#65292;24C/48T &#30340;&#22788;&#29702;&#22120;&#23558;&#30475;&#21040; 48 &#20010;&#36923;&#36753; CPU&#12290;</p>
<p class=" font-serif my-1">&#22312;&#20026;&#22810;&#22788;&#29702;&#22120;&#21534;&#21520;&#37327;&#20248;&#21270;&#30340;&#22330;&#26223;&#19979;&#65292;&#19968;&#20010;&#29289;&#29702;&#26680;&#24515;&#21487;&#33021;&#25317;&#26377;&#26356;&#22810;&#25968;&#37327;&#30340;&#32447;&#31243;&#12290;&#20363;&#22914; IBM Power 8 &#20351;&#29992;&#20102; 12 &#26680;&#24515; 96 &#32447;&#31243;&#30340;&#35774;&#35745; (&#27599;&#20010;&#26680;&#24515; 8 &#32447;&#31243;&#65292;&#27599;&#20010;&#26680;&#24515;&#26377; 16 &#20010;&#25351;&#20196;&#25191;&#34892;&#27969;&#27700;&#32447;)&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#38500;&#20102;&#21487;&#20197; &#8220;&#36873;&#25321;&#19968;&#20010; CPU &#25191;&#34892;&#19968;&#26465;&#25351;&#20196;&#8221;&#65292;&#19982;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#36827;&#31243;&#19981;&#21516;&#65292;&#35745;&#31639;&#26426;&#31995;&#32479;&#26159;&#25152;&#26377;&#30828;&#20214;&#20013;&#26029;&#30340;&#31649;&#29702;&#32773; (&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#36827;&#31243;&#26080;&#27861;&#30452;&#25509;&#30475;&#21040;&#20013;&#26029;)&#12290;&#22312; x86-64 &#31995;&#32479;&#19978;&#65292;&#24403; <code>%rflags</code> &#30340; <code>FL_IF</code> bit &#20026; 1 &#26102;&#65292;&#22788;&#29702;&#22120;&#22312;&#22806;&#37096;&#20013;&#26029;&#21040;&#26469;&#21518;&#65292;&#20250;&#25191;&#34892;&#20197;&#19979; (&#31616;&#21270;&#30340;) &#27969;&#31243;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#22914;&#26524;&#36816;&#34892;&#22312; ring 3&#65292;&#20999;&#25442;&#21040; TSS &#20013;&#39044;&#35774;&#30340;&#22534;&#26632;&#22320;&#22336; (<code>%ss, %rsp</code>)&#65307;</li>
<li class=" ml-8">&#23558;&#20013;&#26029;&#21069;&#30340;&#33509;&#24178;&#23492;&#23384;&#22120;&#20445;&#23384;&#21040;&#22534;&#26632;&#19978;&#65306;<code>%ss, %rsp, %cs, %rip, %rflags</code>&#65307;</li>
<li class=" ml-8">&#36339;&#36716;&#21040; IDT &#20013;&#25351;&#23450;&#30340;&#20837;&#21475;&#22320;&#22336;&#25191;&#34892;&#12290;</li>
</ul>
<p class=" font-serif my-1">AbstractMachine &#23545;&#20013;&#26029;&#30340;&#24213;&#23618;&#34892;&#20026;&#36827;&#34892;&#20102;&#23553;&#35013;&#65292;&#22312;&#20013;&#26029;&#21040;&#26469;&#21518;&#20250;&#23492;&#23384;&#22120;&#29616;&#22330; (<code>Context</code>) &#21040;&#22534;&#26632;&#19978;&#65292;&#26368;&#21518;&#35843;&#29992;&#27880;&#20876;&#30340; callback (&#36825;&#37324;&#24314;&#35758;&#20320;&#20877;&#27425;&#38405;&#35835; AbstractMachine &#25991;&#26723;)&#12290;&#22312;&#29992;&#29366;&#24577;&#26426;&#27169;&#22411;&#20998;&#26512;&#30452;&#25509;&#36816;&#34892;&#22312;&#35745;&#31639;&#26426;&#30828;&#20214;&#19978;&#30340;&#31243;&#24207; (&#20363;&#22914;&#25805;&#20316;&#31995;&#32479;) &#26102;&#35201;&#26684;&#22806;&#23567;&#24515;&#65292;&#22240;&#20026;&#22810;&#22788;&#29702;&#22120;&#31995;&#32479;&#30340;&#29366;&#24577;&#26426;&#27169;&#22411;&#19978;&#65292;&#29366;&#24577;&#26426;&#30340;&#27599;&#19968;&#27493;&#37117;&#26377;&#24456;&#22823;&#30340;&#19981;&#30830;&#23450;&#24615;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#21487;&#20197;&#36873;&#25321;&#31995;&#32479;&#20013;&#20219;&#24847;&#19968;&#20010;&#22788;&#29702;&#22120;&#25191;&#34892;&#19968;&#26465;&#25351;&#20196;&#65307;</li>
<li class=" ml-8">&#20219;&#24847;&#19968;&#20010;&#22788;&#29702;&#22120;&#22312;&#20013;&#26029;&#25171;&#24320;&#26102;&#37117;&#21487;&#20197;&#21709;&#24212;&#31995;&#32479;&#20013;&#30340;&#20013;&#26029;&#12290;</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/real-fsm.png" width="400px"></p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_2" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#29992;&#35843;&#35797;&#22120;&#29702;&#35299;&#29366;&#24577;&#26426;&#27169;&#22411;</h4>
<p class=" font-serif my-1">&#22312;&#35838;&#22530;&#19978;&#65292;&#25105;&#20204;&#20171;&#32461;&#36807;&#20351;&#29992; gdb &#30340; <code>set scheduler-locking on</code> &#21487;&#20197;&#22312;&#26242;&#20572;&#20854;&#20182;&#32447;&#31243;&#25191;&#34892;&#30340;&#21069;&#25552;&#19979;&#36827;&#34892;&#21333;&#27493;&#35843;&#35797;&#12290;&#22312;&#27492;&#24773;&#24418;&#19979;&#35843;&#35797; xv6&#65292;&#24182;&#20351;&#29992; QEMU monitor &#26597;&#30475;&#21333;&#27493;&#25191;&#34892;&#21069;&#21518;&#31995;&#32479;&#23492;&#23384;&#22120;&#30340;&#20540;&#65292;&#33021;&#20351;&#20320;&#26356;&#22909;&#22320;&#29702;&#35299; (&#21644;&#36866;&#24212;) &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#26159;&#29366;&#24577;&#26426;&#8221; &#30340;&#27010;&#24565;&#12290;</p>
</blockquote>
<h2 id="22" class=" text-xl mt-2 pb-2 font-sans">2.2. &#22312;&#25805;&#20316;&#31995;&#32479;&#20013;&#23454;&#29616;&#20114;&#26021;</h2>
<p class=" font-serif my-1">&#25105;&#20204;&#24403;&#28982;&#21487;&#20197;&#31616;&#21333;&#22320;&#25226;&#20043;&#21069;&#23398;&#20064;&#30340;&#33258;&#26059;&#38145;&#23454;&#29616;&#25644;&#21040;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#8212;&#8212;&#22240;&#20026; xchg &#25351;&#20196;&#30340;&#21407;&#23376;&#24615;&#65292;&#21482;&#26377;&#33719;&#24471; &#8220;&#38053;&#21273;&#8221; &#30340;&#32447;&#31243;&#25165;&#33021;&#36827;&#20837;&#20020;&#30028;&#21306;&#25191;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#24102;&#30528;&#21018;&#25165;&#25105;&#20204;&#23545; &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#26159;&#29366;&#24577;&#26426;&#8221; &#30340;&#29702;&#35299;&#65292;&#20320;&#24456;&#24555;&#23601;&#20250;&#24819;&#21040;&#65292;&#23454;&#29616;&#25805;&#20316;&#31995;&#32479;&#19978;&#20114;&#26021;&#30340;&#20027;&#35201;&#38590;&#39064;&#22312;&#20110;&#31995;&#32479;&#20013;&#21487;&#33021;&#21457;&#29983;&#20013;&#26029;&#8212;&#8212;&#22312; <a href="../../../pages/OS/2021/demos/thread-os.c" class=" text-amber-900">thread-os.c</a> &#20013;&#65292;&#25805;&#20316;&#31995;&#32479;&#20250;&#22312;&#20013;&#26029;&#30340;&#39537;&#21160;&#19979;&#22312;&#32447;&#31243;&#20043;&#38388;&#20999;&#25442;&#25191;&#34892;&#12290;&#36825;&#23601;&#24102;&#26469;&#20102;&#21644;&#25805;&#20316;&#31995;&#32479;&#19978;&#30340;&#33258;&#26059;&#38145;&#21516;&#26679;&#30340;&#38382;&#39064;&#65306;</p>
<p class=" font-serif my-1"></p><center><strong>&#25345;&#26377;&#38145;&#30340;&#32447;&#31243;&#22914;&#26524;&#34987;&#20999;&#25442;&#65292;&#23558;&#20250;&#23548;&#33268; &#8220;&#38598;&#20307;&#25720;&#40060;&#8221; &#30340;&#24773;&#20917;&#21457;&#29983;&#12290;</strong></center>
<p class=" font-serif my-1">&#20294;&#36825;&#27425;&#27809;&#26377; syscall &#25351;&#20196;&#21487;&#20197;&#24110;&#21161;&#25105;&#20204;&#20102;&#8212;&#8212;&#20316;&#20026; &#8220;&#35745;&#31639;&#26426;&#31995;&#32479;&#8221; &#30340;&#29366;&#24577;&#26426;&#23601;<red>&#21482;&#33021;&#25191;&#34892;&#25351;&#20196;&#25110;&#34987;&#36843;&#20013;&#26029;</red>&#12290;&#35201;&#24819;&#21046;&#27490; &#8220;&#38598;&#20307;&#25720;&#40060;&#8221;&#65292;&#20320;&#24212;&#35813;&#24050;&#32463;&#24819;&#21040;&#35299;&#20915;&#21150;&#27861;&#20102;&#12290;</p>
<h3 id="221-stop-the-world" class=" text-lg mt-2 pb-2 font-sans">2.2.1. &#21333;&#22788;&#29702;&#22120;&#65306;&#20851;&#20013;&#26029; = Stop the World</h3>
<p class=" font-serif my-1">&#20026;&#20102;&#23454;&#29616;&#20114;&#26021;&#65292;&#25105;&#20204;&#19981;&#22952;&#32771;&#34385;&#31616;&#21333;&#19968;&#28857;&#30340;&#24773;&#20917;&#8212;&#8212;&#25105;&#20204;&#21482;&#26377;&#19968;&#20010;&#22788;&#29702;&#22120;&#12290;&#36825;&#26102;&#20505;&#27809;&#26377;&#22810;&#22788;&#29702;&#22120;&#36896;&#25104;&#30340;&#19981;&#30830;&#23450;&#24615;&#65292;&#26082;&#28982;&#32618;&#39745;&#31096;&#39318;&#26159;&#20013;&#26029;&#39537;&#21160;&#30340;&#19978;&#19979;&#25991;&#20999;&#25442;&#65292;&#19981;&#22914;&#25105;&#20204;&#30452;&#25509;&#20851;&#20013;&#26029;&#20102;&#20107;&#8212;&#8212;&#20851;&#38381;&#20013;&#26029;&#20197;&#21518;&#65292;&#23601;&#19981;&#21487;&#33021;&#20877;&#21457;&#29983;&#19978;&#19979;&#25991;&#20999;&#25442;&#65292;&#25972;&#20010;&#22788;&#29702;&#22120;&#23601;&#21644;&#24403;&#21069;&#25191;&#34892;&#30340;&#32447;&#31243;&#32465;&#23450;&#20102; (&#24403;&#28982;&#65292;&#22914;&#26524;&#32447;&#31243;&#27515;&#24490;&#29615;&#65292;&#25805;&#20316;&#31995;&#32479;&#20063;&#30452;&#25509;&#21345;&#27515;&#20102;&#12290;&#22823;&#23478;&#21487;&#20197;&#21442;&#32771; xv6 &#30340; panic: &#22788;&#29702;&#22120;&#22312;&#20851;&#38381;&#20013;&#26029;&#21518;&#23601;&#36827;&#20837;&#27515;&#24490;&#29615;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cli</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sti</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#27809;&#38169;&#65292;&#20851;&#38381;&#20013;&#26029;&#23601;&#30456;&#24403;&#20110;&#21333;&#22788;&#29702;&#22120;&#19978;&#30340; stop the world&#65292;&#23454;&#38469;&#19978;&#65292;&#22312;&#32769;&#26087;&#30340;&#25805;&#20316;&#31995;&#32479;&#20070;&#19978;&#65292;&#20851;&#20013;&#26029;&#23601;&#26159;&#23454;&#29616;&#20114;&#26021;&#30340;&#22522;&#26412;&#26041;&#27861; (&#32780;&#19981;&#26159;&#21407;&#23376;&#25351;&#20196;)&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_3" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#24605;&#32771;&#39064;&#65306;&#20309;&#26102;&#24320;&#20013;&#26029;&#65311;</h4>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>lock(&amp;lk1);
lock(&amp;lk2);
unlock(&amp;lk2); // 1
unlock(&amp;lk1); // 2
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#20160;&#20040;&#26102;&#20505;&#24320;&#20013;&#26029;&#65311;&#35831;&#22823;&#23478;&#32467;&#21512; xv6 &#30340;&#20195;&#30721;&#22238;&#31572;&#36825;&#20010;&#38382;&#39064;&#12290;</p>
</blockquote>
<h3 id="222-stop-the-world" class=" text-lg mt-2 pb-2 font-sans">2.2.2. &#22810;&#22788;&#29702;&#22120;&#65306;Stop the World + &#33258;&#26059;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#25226;&#20851;&#20013;&#26029;&#21644;&#33258;&#26059;&#32467;&#21512;&#36215;&#26469;&#65292;&#23601;&#33021;&#24471;&#21040;&#22810;&#22788;&#29702;&#22120;&#31995;&#32479;&#36866;&#29992;&#30340;&#26041;&#26696;&#20102;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cli</span><span class="p">();</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sti</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_4" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#24605;&#32771;&#39064;&#65306;&#25805;&#20316;&#39034;&#24207;</h4>
<p class=" font-serif my-1">&#20808; <code>cli</code> &#36824;&#26159;&#20808;&#33258;&#26059;&#65311;&#20808;&#37322;&#25918;&#38145;&#36824;&#26159;&#20808; <code>sti</code>&#65311;&#27880;&#24847;&#25105;&#20204;&#24517;&#39035;&#20445;&#35777;&#22312;&#33719;&#24471;&#38145;&#26399;&#38388;&#22788;&#29702;&#22120;&#19981;&#20250;&#34987;&#20013;&#26029;&#12290;&#22312; <code>cli()</code> &#36820;&#22238;&#21069;&#30340;&#20219;&#24847;&#26102;&#21051;&#65292;&#22788;&#29702;&#22120;&#37117;&#20250;&#34987;&#20013;&#26029;&#65307;&#22312; <code>sti()</code> &#21518;&#30340;&#19968;&#30636;&#38388;&#65292;&#22788;&#29702;&#22120;&#20063;&#21487;&#33021;&#34987;&#20013;&#26029;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#22823;&#23478;&#19981;&#22952;&#32771;&#34385;&#19968;&#19979;&#36825;&#20010;&#31639;&#27861;&#30340;&#27491;&#30830;&#24615;&#65292;&#24182;&#29992;&#29366;&#24577;&#26426;&#35777;&#26126;&#65292;&#36825;&#37324;&#30340;&#29366;&#24577;&#24182;&#19981;&#22810;&#8212;&#8212;&#20320;&#21482;&#38656;&#35201;&#20551;&#35774;&#20013;&#26029;&#20250;&#20999;&#25442;&#21040;&#20854;&#20182;&#32447;&#31243;&#25191;&#34892;&#21363;&#21487; (&#20063;&#21487;&#20197;&#29992;&#29366;&#24577;&#26426;&#26469;&#20998;&#26512;&#24212;&#35813;&#20808;&#20851;&#20013;&#26029;&#36824;&#26159;&#20808;&#33258;&#26059;)&#12290;&#22312;&#19990;&#30028;&#19978;&#21482;&#26377;&#19968;&#25226;&#38145;&#30340;&#24773;&#20917;&#19979;&#65292;&#31639;&#27861;&#26159;&#27809;&#38382;&#39064;&#30340;&#12290;&#19981;&#36807;&#29616;&#23454;&#19990;&#30028;&#23545;&#38145;&#30340;&#20351;&#29992;&#65292;&#35201;&#31245;&#24494;&#32771;&#34385;&#22797;&#26434;&#19968;&#20123;&#30340;&#24773;&#24418;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">case1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">read_eflags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FL_IF</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">)</span><span class="o">:</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">read_eflags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FL_IF</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// &#19978;&#38145;/&#35299;&#38145;&#21069;&#21518;IF&#26631;&#24535;&#20301;&#19981;&#21464;&#65292;&#19981;&#24471;&#38543;&#24847;&#25171;&#24320;&#20013;&#26029;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">case2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">read_eflags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FL_IF</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// &#21021;&#22987;&#26102;&#20013;&#26029;&#25171;&#24320;</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
<span class="w">  </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk2</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">read_eflags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FL_IF</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// &#25345;&#26377;&#38145;&#26102;&#19981;&#24471;&#24320;&#20013;&#26029;</span>
<span class="w">  </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk1</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">read_eflags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FL_IF</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// &#22312;&#37322;&#25918;&#25152;&#26377;&#38145;&#21518;&#24320;&#20013;&#26029;</span>
<span class="p">}</span>
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="assertions" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#21892;&#29992;&#26029;&#35328; (assertions)</h4>
<p class=" font-serif my-1">&#26029;&#35328;&#25551;&#36848;&#20102;<strong>&#20320;&#39044;&#26399;&#24517;&#23450;&#20250;&#21457;&#29983;&#30340;&#20107;</strong>&#65292;&#21363;&#20320;&#23545;&#23454;&#29616;&#24212;&#35813;&#28385;&#36275;&#35268;&#32422; (specification) &#30340;&#29702;&#35299;&#12290;&#27809;&#38169;&#65292;&#26029;&#35328;&#23601;&#26159;&#19968;&#21477; &#8220;&#24223;&#35805;&#8221;&#12290;&#37027;&#24223;&#35805;&#26377;&#20160;&#20040;&#29992;&#21602;&#65311;&#24403;&#28982;&#26377;&#29992;&#20102;&#65281;&#22240;&#20026;&#20320;&#30340;&#20195;&#30721;&#20250;&#26377; bug&#12290;&#26029;&#35328;&#25104;&#31435;&#30340;&#21069;&#25552;&#26159;&#31243;&#24207;&#31526;&#21512;&#35268;&#32422;&#65292;&#20294;&#36890;&#24120;&#22823;&#23478;&#30340;&#31243;&#24207;&#26159;&#19981;&#21487;&#33021;&#36731;&#26131;&#31526;&#21512;&#35268;&#32422;&#30340; (&#31505;&#65292;&#22240;&#27492;&#36825;&#20123;&#30475;&#36215;&#26469;&#27809;&#29992;&#30340;&#26029;&#35328;&#65292;&#33021;&#24110;&#21161;&#22823;&#23478;&#36805;&#36895;&#23450;&#20301;&#21040;&#38382;&#39064;&#25152;&#22312;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#24182;&#21457;&#32534;&#31243;&#20013;&#65292;&#36825;&#20123;&#26029;&#35328;&#26356;&#26174;&#24471;&#21487;&#36149;&#8212;&#8212;&#20363;&#22914;&#22312;&#26576;&#20010;&#20363;&#23376;&#37324;&#65292;&#20320;&#21482;&#22312;&#20960;&#26465;&#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;&#20013;&#38169;&#35823;&#22320; (case 2) &#25171;&#24320;&#20102;&#20013;&#26029;&#12290;&#22240;&#27492;&#65292;&#24819;&#35201;&#26292;&#38706;&#36825;&#20010;&#38382;&#39064;&#30340;&#21487;&#33021;&#24615;&#26159;&#24494;&#20046;&#20854;&#24494;&#30340;&#65292;&#20294;&#26029;&#35328;&#21364;&#33021;&#24110;&#21161;&#20320;&#20197; 100% &#30340;&#27010;&#29575;&#25429;&#33719;&#36825;&#20010;&#38382;&#39064;&#12290;</p>
<p class=" font-serif my-1">xv6 &#30340; spinlock &#23454;&#29616;&#26159;&#36825;&#26041;&#38754;&#30340;&#20856;&#33539;&#12290;&#36825;&#20063;&#26159;&#25105;&#20204;&#24378;&#28872;&#25512;&#33616; xv6 &#20195;&#30721;&#30340;&#21407;&#22240;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#20026;&#20102;&#20462;&#22797;&#19978;&#36848;&#20004;&#20010; case&#65292;&#25105;&#20204;&#21487;&#20197;&#25226; lock &#21644; unlock &#24819;&#35937;&#25104;&#26159;&#20837;&#26632;&#21644;&#20986;&#26632;&#30340;&#36807;&#31243;&#8212;&#8212;lock &#26102;&#65292;&#25226; eflags &#21387;&#20837;&#22534;&#26632;&#20013;&#65292;&#28982;&#21518;&#20851;&#38381;&#20013;&#26029;&#65307;unlock &#26102;&#65292;&#20174;&#26632;&#20013;&#24674;&#22797;&#20986; eflags &#30340;&#25968;&#20540;&#12290;&#19981;&#36807;&#36825;&#37324;&#20173;&#28982;&#26377;&#19968;&#20010;&#38382;&#39064;&#65306;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_5" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#35841;&#32500;&#25252;&#36825;&#20010;&#22534;&#26632;&#65311;</h4>
<p class=" font-serif my-1">&#32447;&#31243; or &#38145; or &#22788;&#29702;&#22120;&#65311;&#20998;&#21035;&#32771;&#34385;&#36825;&#19977;&#31181;&#24773;&#20917;&#12290;&#20197;&#21450;&#65292;&#25105;&#20204;&#24182;&#19981;&#38656;&#35201;&#30495;&#27491;&#32500;&#25252;&#19968;&#20010;&#22534;&#26632;&#8212;&#8212;&#22240;&#20026;&#31532;&#19968;&#27425; lock &#20043;&#21518;&#65292;&#21040;&#19982;&#20043;&#37197;&#23545;&#30340; unlock &#20043;&#21069;&#65292;&#20013;&#26029;&#22987;&#32456;&#22788;&#20110;&#20851;&#38381;&#29366;&#24577;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#22312;&#20320;&#25226;&#36825;&#19968;&#20999;&#37117;&#24819;&#28165;&#26970;&#20197;&#21518;&#65292;&#27427;&#36175;&#24182;&#35843;&#35797;&#19968;&#19979; xv6 &#30340; <a href="../../../pages/OS/2021/demos/spinlock-xv6.c" class=" text-amber-900">spinlock.c</a> &#21543;&#65281;</p>
<h2 id="3" class=" text-xl mt-2 pb-2 font-sans">3. &#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#30340;&#30561;&#30496;&#31561;&#24453;</h2>
<p class=" font-serif my-1">&#26681;&#25454;&#21018;&#25165;&#30340;&#20998;&#26512;&#65292;&#33258;&#26059;&#38145;&#20250;<red>&#22312;&#22788;&#29702;&#22120;&#20013;&#26029;&#22788;&#20110;&#20851;&#38381;&#30340;&#29366;&#24577;&#19979;&#33258;&#26059;</red> (&#20320;&#24403;&#28982;&#21487;&#20197;&#22312;&#33258;&#26059;&#22833;&#36133;&#30340;&#26102;&#20505;&#25171;&#24320;&#20013;&#26029;&#65292;&#24403;&#28982;&#20320;&#38656;&#35201;&#22312;&#19979;&#27425;&#25191;&#34892; xchg &#21069;&#20877;&#27425;&#20851;&#38381;&#20013;&#26029;)&#65292;&#20294;&#26080;&#35770;&#22914;&#20309;&#65292;&#33258;&#26059;&#37117;&#26159;&#19968;&#39033;&#38750;&#24120;&#32791;&#26102;&#30340;&#25805;&#20316;&#12290;&#22240;&#27492;&#65292;&#33258;&#26059;&#38145;&#36890;&#24120;&#20165;&#29992;&#26469;&#20445;&#25252;&#21313;&#20998;&#37325;&#35201;&#30340;&#20869;&#26680;&#25968;&#25454;&#32467;&#26500;&#65292;&#20363;&#22914;&#36827;&#31243;&#21015;&#34920;&#31561;&#65292;&#20320;&#36890;&#24120;&#24076;&#26395;&#33258;&#26059;&#38145;&#20445;&#25252;&#30340;&#20195;&#30721;&#33021;&#23613;&#24555;&#24471;&#21040;&#25191;&#34892;&#24182;&#19988;&#19981;&#34987;&#25171;&#26029;&#12290;</p>
<p class=" font-serif my-1">&#19982;&#27492;&#21516;&#26102;&#65292;&#33258;&#26059;&#38145;&#24102;&#26469;&#30340;&#21478;&#19968;&#20010;&#38382;&#39064;&#26159;<red>&#25317;&#22581;</red> (contention)&#65292;&#20063;&#21487;&#20197;&#35828;&#25104;&#26159; &#8220;&#20280;&#32553;&#24615;&#8221; (scalability) &#30340;&#38382;&#39064;&#8212;&#8212;&#22914;&#26524;&#27599;&#20010; CPU &#19978;&#30340;&#36827;&#31243;&#37117;&#39057;&#32321;&#22320;&#36827;&#34892;&#31995;&#32479;&#35843;&#29992; (&#20174;&#32780;&#23548;&#33268;&#36827;&#31243;&#20999;&#25442;)&#65292;&#36827;&#31243;&#20999;&#25442;&#21448;&#38656;&#35201;&#33719;&#24471;&#20445;&#25252;&#36827;&#31243;&#21015;&#34920;&#30340;&#33258;&#26059;&#38145;&#65292;&#23601;&#20250;&#36896;&#25104; &#8220;&#22823;&#37096;&#20998; CPU &#26102;&#38388;&#37117;&#28010;&#36153;&#22312;&#31561;&#24453;&#38145;&#8221; &#19978;&#12290;&#19968;&#26041;&#38754;&#65292;&#25105;&#20204;&#21487;&#20197;&#20351;&#29992; malloc/free &#23454;&#39564;&#20013;&#30340;&#26041;&#24335;&#25913;&#36827;&#38145;&#30340;&#23454;&#29616;&#65292;&#20351;&#22823;&#37096;&#20998;&#35775;&#38382;&#26080;&#38656;&#19978;&#38145;&#65307;&#21478;&#19968;&#26041;&#38754;&#65292;&#25105;&#20204;&#20063;&#21487;&#20197;&#22312;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#23454;&#29616;&#21487;&#20197;&#30561;&#30496;&#30340;&#20114;&#26021;&#38145; (&#22312;&#19978;&#38145;&#22833;&#36133;&#26102;&#65292;&#31435;&#21363;&#20999;&#25442;&#21040;&#20854;&#20182;&#32447;&#31243;/&#36827;&#31243;&#25191;&#34892;&#65292;&#30452;&#21040;&#26377;&#20854;&#20182;&#36827;&#31243;/&#32447;&#31243;&#37322;&#25918;&#38145;&#21518;&#21796;&#37266;)&#65292;&#36825;&#23601;&#26159; <a href="../labs/L2.html" class=" text-amber-900">L2 - kmt</a> &#20013;&#22823;&#23478;&#38656;&#35201;&#33258;&#24049;&#21160;&#25163;&#23454;&#29616;&#30340;&#20869;&#23481;&#12290;</p></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../../../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../../../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>