<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // â€¢ auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // â€¢ rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>[C6] ä¸å¹¶å‘ Bugs ç›¸å¤„</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="c6-bugs" class=" text-2xl mt-2 font-sans">[C6] ä¸å¹¶å‘ Bugs ç›¸å¤„</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">è’‹ç‚å²©</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">ã€€ã€€å—äº¬å¤§å­¦ã€€ã€€</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">èƒŒæ™¯</h2>
<p class=" font-serif my-1">åŒæ­¥ã€äº’æ–¥çš„æ—¶å€™æˆ‘ä»¬å·²ç»è®²äº†å¾ˆå¤š â€œä¸å¯¹â€ çš„æ¡ˆä¾‹</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</li>
<li class=" ml-8">å“² â™‚ å­¦å®¶æ­»é”</li>
<li class=" ml-8">å„ç§é”™è¯¯çš„è‡ªæ—‹é”</li>
<li class=" ml-8">æ•™ç§‘ä¹¦ä¸Šçš„æ¡ä»¶å˜é‡ signal é”™çº¿ç¨‹</li>
<li class=" ml-8">â€¦â€¦</li>
</ul>
<hr>
<p class=" font-serif my-1">ä¸è¦ç¬‘ï¼ğŸ¤¡ ç«Ÿæ˜¯æˆ‘è‡ªå·±</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¹¶å‘ bugs æ€ä¹ˆåŠï¼Ÿ</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æœ¬æ¬¡è¯¾å†…å®¹ä¸ç›®æ ‡</h2>
<p class=" font-serif my-1">å¤ä¹ è°ƒè¯•ç†è®º</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä½ åœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ä¸Šæ´»ä¸‹æ¥æ‰€éœ€çš„æœ€é‡è¦çš„ç†è®º</li>
</ul>
<hr>
<p class=" font-serif my-1">ç†è§£å¹¶å‘ bugs çš„ç±»å‹ã€äº§ç”ŸåŸå› å’Œé¢„é˜²æ–¹æ³•</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ­»é” (lockdep)</li>
<li class=" ml-8">åŸå­æ€§/é¡ºåºè¿å (æµ‹è¯• + æ£€æŸ¥)</li>
</ul>
<hr>
<p class=" font-serif my-1">åº”ç”¨è°ƒè¯•ç†è®º</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¦‚ä½•åœ¨ç¼–å†™æ“ä½œç³»ç»Ÿå†…æ ¸æ—¶ä¿æŠ¤è‡ªå·±å°‘å—ä¼¤å®³ï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">(ä¸å—ä¼¤æ˜¯ä¸å¯èƒ½çš„å•¦â€¦â€¦)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">è°ƒè¯•ç†è®ºï¼šå¤ä¹ </h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">åŸºæœ¬åŸåˆ™</h2>
<p class=" font-serif my-1">åœ¨ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹å®éªŒä¸­æå‡º (<a href="https://www.bilibili.com/video/BV1qa4y1j7xk?p=10" class=" text-amber-900">è§†é¢‘å›çœ‹</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">åªè¦å†™ä»£ç ï¼Œå°±ä¼šä¸€ç›´ä¼´éšå¤§å®¶</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(ICS) ä¸ç®¡æ˜¯ crash äº†ï¼Œå›¾å½¢æ˜¾ç¤ºä¸æ­£å¸¸äº†ï¼Œè¿˜æ˜¯ <code>HIT BAD TRAP</code> äº†ï¼Œæœ€åéƒ½æ˜¯ä½ è‡ªå·±èƒŒé”…</li>
<li class=" ml-8">(OS) ä¸ç®¡æ˜¯å¡æ­»ã€å¼‚å¸¸è¿˜æ˜¯è™šæ‹Ÿæœºé‡å¯ï¼Œéƒ½æ˜¯ä½ è‡ªå·±çš„ bug</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>æœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(ICS/OS) ä½ ä»¥ä¸ºæœ€ä¸å¯èƒ½å‡º bug çš„åœ°æ–¹ï¼Œå¾€å¾€ bug å°±åœ¨é‚£èººç€</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="debug" class=" text-xl mt-2 pb-2 font-sans">è°ƒè¯•ç†è®ºï¼šä¸ºä»€ä¹ˆ Debug é‚£ä¹ˆå›°éš¾ï¼Ÿ</h2>
<p class=" font-serif my-1">ç¨‹åºï¼š<red>äººç±»ä¸–ç•Œéœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ç¨‹åºä¸­çš„ bug æ˜¯ç¨‹åºä¸è®¾è®¡/æ„å›¾è¿åä¹‹å¤„<ul class=" list-disc font-serif">
<li class=" ml-8">debug å°±æ˜¯å®šä½åˆ°ç¨‹åºä¸­ bug çš„è¿‡ç¨‹</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ç¨‹åºå‘˜ï¼šçŠ¯çš„æ˜¯ Faultï¼Œçœ‹åˆ°çš„æ˜¯ Failure</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Fault (bug) â†’ Error (ç¨‹åºçŠ¶æ€é”™) â†’ Failure (å¯è§‚æµ‹çš„ç»“æœé”™)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/ICS/2020/slides/img/fault-error-failure.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bug" class=" text-xl mt-2 pb-2 font-sans">è°ƒè¯•ç†è®ºï¼šå¦‚ä½•æ‰¾åˆ° Bug?</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª Failureï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°ç¬¬ä¸€ä¸ª Error çš„çŠ¶æ€ï¼Œå¯¼è‡´æ­¤çŠ¶æ€çš„ä»£ç å°±æ˜¯ Fault (bug)ã€‚</p>
<p class=" font-serif my-1">åœ¨å®é™…ä¸­çš„åº”ç”¨ï¼šçŠ¶æ€æœºçš„æ‰§è¡Œå¯èƒ½å¾ˆé•¿ï¼Œä½†æˆ‘ä»¬åªè¦æ ‡è®°å‡ºä¸€äº›<red>å…³é”®çš„çŠ¶æ€</red>ï¼Œå°±èƒ½å¸®æˆ‘ä»¬ç¼©å°æ’æŸ¥é—®é¢˜çš„èŒƒå›´</p>
</blockquote>
<hr>
<p class=" font-serif my-1">å®é™…ä¸­çš„è°ƒè¯•ï¼šæ›´ â€œäººç±»å‹å¥½â€ çš„åˆ†æ®µæ£€æŸ¥</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">printf â†’ è‡ªå®šä¹‰ log çš„ trace</li>
<li class=" ml-8">gdb â†’ æŒ‡ä»¤/è¯­å¥çº§ trace</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">å å…¥å¹¶å‘çš„æ·±æ¸Šâ€¦â€¦</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">å¹¶å‘ï¼šè°ƒè¯•ç†è®ºçš„ç¾éš¾</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">åœ¨æ— æ³• â€œå‡†ç¡®å¤ç°ä¸€æ¬¡æ‰§è¡Œâ€ çš„åŸºç¡€ä¸Šï¼Œâ€œæ‰¾åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€â€ å˜éš¾äº†â€¦â€¦</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Fault â†’ Error</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ¯æ¬¡çš„ Error éƒ½ä¸ä¸€æ ·</li>
<li class=" ml-8">æ— æ³• â€œäºŒåˆ†â€</li>
</ul>
<hr>
<p class=" font-serif my-1">Error â†’ Failure</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ—¥å¿—ä»ç„¶èƒ½å¸®åŠ©æˆ‘ä»¬ç¼©å° Error å‘ç”Ÿçš„èŒƒå›´</li>
<li class=" ml-8">ä½† Failure æ›´éš¾ç†è§£ (é”™è¯¯çš„è¾“å‡º/ç¥ç§˜å¼‚å¸¸/ç¥ç§˜é‡å¯/...)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æŒ£æ‰ï¼šä½¿ç”¨è°ƒè¯•ç†è®º</h2>
<p class=" font-serif my-1">è°ƒè¯•ç†è®ºå‘Šè¯‰æˆ‘ä»¬ï¼šfailure point å¾ˆé‡è¦</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¯ä»¥è¿½æº¯å‡ºä¸€äº› error states</li>
<li class=" ml-8">QEMU è®¾è®¡è€…å½“ç„¶çŸ¥é“è¿™ä¸€ç‚¹<ul class=" list-disc font-serif">
<li class=" ml-8"><red>å¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰ä»€ä¹ˆï¼Œé‚£ä¸€å®šä¼šæœ‰çš„ï¼</red></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">RTFM: QEMU Monitor (ä¾‹å­ï¼š<a href="../../../pages/OS/2021/demos/cpu-reset.c" class=" text-amber-900">cpu-reset.c</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¾—åˆ°è¯¦å°½çš„æ—¥å¿—: <code>log int,cpu_reset,exec</code><ul class=" list-disc font-serif">
<li class=" ml-8">fault â†’ error â†’ failure<ul class=" list-disc font-serif">
<li class=" ml-8"><code>int,cpu_reset</code> - å¸®åŠ©æˆ‘ä»¬å®šä½ failure</li>
<li class=" ml-8"><code>exec</code> - å¸®åŠ©æˆ‘ä»¬å®šä½ error (æ‰§è¡Œæµ)<ul class=" list-disc font-serif">
<li class=" ml-8">ç”šè‡³å¯ä»¥å¼€å‘ä¸€ä¸ªå°å·¥å…·ï¼Œâ€œç»˜åˆ¶â€ å‡ºç¨‹åºæ‰§è¡Œçš„è·¯å¾„</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bugs" class=" text-xl mt-2 pb-2 font-sans">å¹¶å‘ Bugs åˆ°åº•é•¿ä»€ä¹ˆæ ·ï¼Ÿ</h2>
<p class=" font-serif my-1">ä¸€ç§ç ”ç©¶æµæ´¾ï¼šå®è¯ç ”ç©¶ (empirical study)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸ºäº†æ›´å¥½åœ°è§£å†³å¹¶å‘ bugs çš„é—®é¢˜<ul class=" list-disc font-serif">
<li class=" ml-8">ä»ç°å®æ•°æ®é›†ä¸­ (éšæœº) é€‰å–ä¸€å®šæ¯”ä¾‹çš„ä¾‹å­</li>
<li class=" ml-8">å¯¹ç»“è®ºè¿›è¡Œå½’çº³æ€»ç»“</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ä¸€äº›å®è¯ç ”ç©¶</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">S. Lu, et al. <a href="https://dl.acm.org/doi/10.1145/1353535.1346323" class=" text-amber-900">Learning from mistakes â€” A comprehensive study on real world concurrency bug characteristics</a>. In <em>Proc. of ASPLOS</em>, 2008.</li>
<li class=" ml-8">Z. Yin, et al. <a href="https://dl.acm.org/doi/10.1145/2025113.2025121" class=" text-amber-900">How do fixes become bugs? A comprehensive characteristic study on incorrect fixes in commercial and
open source operating systems</a>. In <em>Proc. of ESEC/FSE</em>, 2011.</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="deadlock" class=" text-2xl mt-2 font-sans">æ­»é” (Deadlock)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="deadlock" class=" text-xl mt-2 pb-2 font-sans">æ­»é” (Deadlock)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
<p class=" font-serif my-1">Empirical study: MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</p>
</blockquote>
<p class=" font-serif my-1">å‡ºç°çº¿ç¨‹ â€œäº’ç›¸ç­‰å¾…â€ çš„æƒ…å†µ (è·¯å£ç©ºé—´ = èµ„æº)</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/deadlock-car.jpg" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="aa-deadlock" class=" text-xl mt-2 pb-2 font-sans">AA-Deadlock</h2>
<p class=" font-serif my-1">å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">é”™è¯¯å®ç°çš„ popcli</li>
<li class=" ml-8">ä¸åº”è¯¥å‘ç”Ÿçš„ <code>yield()</code></li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">os_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span><span class="w"> </span><span class="c1">// ---------+</span>
<span class="p">}</span><span class="w">                          </span><span class="c1">//    |</span>
<span class="w">                           </span><span class="c1">//    |</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">on_interrupt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">//    |</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span><span class="w">   </span><span class="c1">// <--+</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="abba-deadlock" class=" text-xl mt-2 pb-2 font-sans">ABBA-Deadlock</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">obj_move</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>obj_move</code> æœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜<ul class=" list-disc font-serif">
<li class=" ml-8"><code>obj_move(1, 2)</code>; <code>obj_move(2, 1)</code> â†’ æ­»é”</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">é¿å…æ­»é”</h2>
<p class=" font-serif my-1">æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr." class=" text-amber-900">Edward G. Coffman</a>, 1971):</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</li>
<li class=" ml-8">è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æº</li>
<li class=" ml-8">ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤º</li>
<li class=" ml-8">å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æºã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€
â€”â€”<red>Bullshit</red>.</p>
<p class=" font-serif my-1">ç ´åæ¯ä¸€ä¸ªæ¡ä»¶éƒ½æ˜¯éå¸¸å›°éš¾çš„ (è¯·é˜…è¯»æ•™ç§‘ä¹¦)</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">é¿å…æ­»é” (cont'd)</h2>
<p class=" font-serif my-1">AA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</li>
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/spinlock-xv6.c" class=" text-amber-900">spinlock.c</a><ul class=" list-disc font-serif">
<li class=" ml-8"><code>if (holding(lk)) panic();</code></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ABBA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</li>
<li class=" ml-8">ä¸¥æ ¼æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é” (lock ordering; æ¶ˆé™¤ â€œå¾ªç¯ç­‰å¾…â€)<ul class=" list-disc font-serif">
<li class=" ml-8">è¯•ä¸€è¯•ï¼šç”¨çŠ¶æ€æœºè¯æ˜ $T_1: A\to B\to C; T_2: B \to C$ æ˜¯å®‰å…¨çš„<ul class=" list-disc font-serif">
<li class=" ml-8">â€œåœ¨ä»»æ„æ—¶åˆ»æ€»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹ (è·å¾— â€œæœ€é åâ€ é”çš„) å¯ä»¥ç»§ç»­æ‰§è¡Œâ€</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lock-ordering-linux-kernel-rmapc" class=" text-xl mt-2 pb-2 font-sans">Lock Ordering: åº”ç”¨ (Linux Kernel: rmap.c)</h2>
<p class=" font-serif my-1"><img alt="" src="../../../pages/OS/img/kernel-rmap.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">ä½ å¤§çº¦å¯Ÿè§‰äº†â€¦â€¦</h2>
<p class=" font-serif my-1">Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. Practice will tell you that this approach doesn't scale: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p class=" font-serif my-1">The best locks are encapsulated: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.</p>
<p class=" font-serif my-1">â€”â€” <em>Unreliable Guide To Locking</em> by Rusty Russell</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">è®©ç¨‹åºå‘˜å½»åº•é¿å…æ­»é”ï¼Ÿä½ æƒ³å¤šäº†â€¦â€¦</h2>
<p class=" font-serif my-1">è°ƒè¯•å…¬ç†ï¼šæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Šâ€¦â€¦</li>
</ul>
<hr>
<p class=" font-serif my-1"><a href="../../OS_Lockdep.html" class=" text-amber-900">lockdep</a>, since Linux Kernel 2.6.17; also in <a href="https://gitee.com/openharmony" class=" text-amber-900">OpenHarmony</a>!</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸ºæ¯ä¸€ä¸ª â€œlock classâ€ æ£€æŸ¥ (åˆ†é…ä¸€ä¸ª key)<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/lock-site.c" class=" text-amber-900">lock-site.c</a>; æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ xv6 é‡Œå®ç°ä¸€ä¸ªï¼</li>
</ul>
</li>
<li class=" ml-8">åœ¨è¿è¡Œæ—¶è§‚å¯Ÿæ‰€æœ‰çš„ lock/unlock<ul class=" list-disc font-serif">
<li class=" ml-8">lock/unlock æ—¶è®°å½•æ‰€æœ‰å¯èƒ½çš„ä¸Šé”é¡ºåº<ul class=" list-disc font-serif">
<li class=" ml-8">çº¿ç¨‹è·å¾— $X, Y, Z$ ä¼šè®°å½• $X \to Y, X \to Z, Y \to Z$</li>
</ul>
</li>
<li class=" ml-8">æ£€æŸ¥æ˜¯å¦å­˜åœ¨ $A \to B$ å’Œ $B \to A$ (deadlock)<ul class=" list-disc font-serif">
<li class=" ml-8">å³ä¾¿æ­»é”æ²¡æœ‰çœŸæ­£å‘ç”Ÿï¼Œä½†åªè¦æœ‰ ABBA çš„é£é™©å°±ä¼šæŠ¥å‘Š</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æ­»é”ï¼šé”å¹¶ä¸æ˜¯å”¯ä¸€çš„åŸå› </h2>
<p class=" font-serif my-1">åœ¨æ¶‰åŠåŒæ­¥çš„æ—¶å€™ï¼Œæƒ…å†µå°±å¤æ‚å¾—å¤šäº†â€¦â€¦</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">è€æ€»æ‰“ç”µè¯ç»™ç§˜ä¹¦ï¼šâ€œè¿™å‡ å¤©æˆ‘é™ªä½ å»åŒ—äº¬ç©ç©ï¼Œä½ å‡†å¤‡ä¸€ä¸‹â€</li>
<li class=" ml-8">ç§˜ä¹¦æ‰“ç”µè¯ç»™è€å…¬ï¼šâ€œè¿™å‡ å¤©æˆ‘è¦å’Œè€æ€»å»åŒ—äº¬å¼€ä¼šâ€</li>
<li class=" ml-8">è€å…¬æ‰“ç”µè¯ç»™æƒ…äººï¼šâ€œè¿™å‡ å¤©æˆ‘è€å©†ä¸åœ¨å®¶ï¼Œé™ªæˆ‘â€</li>
<li class=" ml-8">æƒ…äººæ‰“ç”µè¯ç»™è¾…å¯¼å­¦ç”Ÿï¼šâ€œè¿™å‡ å¤©è€å¸ˆæœ‰äº‹ï¼Œåœè¯¾â€</li>
<li class=" ml-8">å­¦ç”Ÿæ‰“ç”µè¯ç»™çˆ·çˆ·ï¼šâ€œè¿™å‡ å¤©ä¸ä¸Šè¯¾ï¼Œçˆ·çˆ·ä½ é™ªæˆ‘ç©â€</li>
<li class=" ml-8">çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šâ€œåŒ—äº¬å»ä¸äº†äº†ï¼Œå­™å­è¦æˆ‘é™ªâ€</li>
<li class=" ml-8">ç§˜ä¹¦ç»™è€å…¬æ‰“ç”µè¯ï¼šâ€œè€æ€»çªç„¶æœ‰äº‹ä¸å»åŒ—äº¬å¼€ä¼šäº†â€</li>
<li class=" ml-8">è€å…¬ç»™æƒ…äººæ‰“ç”µè¯ï¼šâ€œè€å©†ä¸èµ°äº†ï¼Œä¸‹æ¬¡å†è¯´â€</li>
<li class=" ml-8">æƒ…äººç»™è¾…å¯¼å­¦ç”Ÿæ‰“ç”µè¯ï¼šâ€œè¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€</li>
<li class=" ml-8">å­¦ç”Ÿç»™çˆ·çˆ·æ‰“ç”µè¯ï¼šâ€œ555 è€å¸ˆè¯´è¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€</li>
<li class=" ml-8">çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šè¿˜æ˜¯å»åŒ—äº¬å§ï¼Œä½ å‡†å¤‡å‡†å¤‡</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">å¹¶å‘ Bugï¼šä¸ä»…æ˜¯æ­»é”</h1>
<p class=" font-serif my-1"><br></p>
<p class=" font-serif my-1">ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿ</p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™</h2>
<p class=" font-serif my-1">å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">äº’æ–¥é” (lock/unlock) - åŸå­æ€§</li>
<li class=" ml-8">æ¡ä»¶å˜é‡ (wait/signal) - åŒæ­¥</li>
</ul>
<hr>
<p class=" font-serif my-1">å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</p>
<p class=" font-serif my-1">å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</p>
<hr>
<p class=" font-serif my-1">Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
<li class=" ml-8"><red>97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯ AV æˆ– OV</red>ã€‚</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="av" class=" text-xl mt-2 pb-2 font-sans">åŸå­æ€§è¿å (AV)</h2>
<p class=" font-serif my-1">â€œABAâ€</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/av-bug.png" width="900px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">åŸå­æ€§è¿å (cont'd)</h2>
<p class=" font-serif my-1">æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">â€œTOCTTOUâ€ - time of check to time of use</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/tocttou.png" width="640px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">J. Wei and C. Pu. <a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf" class=" text-amber-900">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a>. In <em>Proc. of FAST</em>, 2005.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ov" class=" text-xl mt-2 pb-2 font-sans">é¡ºåºè¿å (OV)</h2>
<p class=" font-serif my-1">â€œBAâ€</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">ä¾‹å­ï¼šconcurrent use after free  </li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ov-bug.png" width="900px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="empirical-study" class=" text-xl mt-2 pb-2 font-sans">Empirical Study çš„æ„ä¹‰</h2>
<p class=" font-serif my-1">ç¨‹åºå‘˜ï¼šæˆ‘æœ¬åœ°éƒ½è·‘äº†å‡ ä¸‡æ¬¡äº†ï¼Œæ²¡é—®é¢˜å•Š</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸€éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒé‡Œå°± ğŸ’¥ çˆ†ç‚¸äº†</li>
</ul>
<p class=" font-serif my-1">æˆ‘ï¼šåœ¨æœ¬åœ°æµ‹çš„å¥½å¥½çš„å•Š</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æäº¤åˆ° Online Judge ä¸Šè¿ easy tests éƒ½è¿‡ä¸äº† (çœŸå®)</li>
</ul>
<hr>
<p class=" font-serif my-1">Empirical study ç»™äº†æˆ‘ä»¬æ›´å¤šæœ‰è¶£çš„å‘ç°ï¼ŒæŒ‡å¯¼ bug çš„å‘ç°/ä¿®å¤ï¼š</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Almost all (96%) of the examined bugs are guaranteed to manifest if certain partial order between <em>2 threads</em> is enforced. </li>
<li class=" ml-8">Many (66%) of the examined non-deadlock bugsâ€™ manifestation involves concurrent accesses to <em>only one variable</em>. </li>
<li class=" ml-8">Almost all (97%) of the examined deadlock bugs involve <em>two threads</em> circularly waiting for at most two resources. </li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="lab-1-pmm" class=" text-2xl mt-2 font-sans">è°ƒè¯•ç†è®ºåº”ç”¨ï¼šLab 1 (PMM)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="online-judge" class=" text-xl mt-2 pb-2 font-sans">Online Judge ä½“éªŒæå·®</h2>
<p class=" font-serif my-1">Lab 1 æœ‰ä¸€å®šéš¾åº¦</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æœ‰ä¸€ç‚¹è½»å¾®çš„å¹¶å‘ bug â†’ Wrong Answer</li>
<li class=" ml-8">ç”¨ä¸€æŠŠå¤§é” â†’ Wrong Answer (< 1Mop/s)<ul class=" list-disc font-serif">
<li class=" ml-8">å¤§éƒ¨åˆ†åˆ†æ•°åˆ°æ‰‹ï¼Œå»ºè®®ä»è¿™é‡Œå¼€å§‹</li>
</ul>
</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">å¦‚æœä½ è°ƒè¯•äº†å¾ˆä¹…éƒ½æ²¡æœ‰æƒ³æ³•ï¼Œä¸å¦‚ç”¨ä¸€ç‚¹ç³»ç»ŸåŒ–çš„æ‰‹æ®µã€‚</p>
<p class=" font-serif my-1">â€œè·³å‡ºé—®é¢˜çœ‹é—®é¢˜â€ æ˜¯ä¸“ä¸šäººå£«åº”å½“å…·å¤‡çš„ç´ è´¨ã€‚</p>
</blockquote>
<hr>
<p class=" font-serif my-1">åšå¥½ Lab1 çš„æµ‹è¯•æ¡†æ¶</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">è™½ç„¶å¤§å®¶å¯ä»¥ç¡¬æ¥ (xjb æ”¹ç¨‹åºç›´åˆ° Online Judge é€šè¿‡)</li>
<li class=" ml-8">ä½†æ€»æœ‰ä¸€å¤©å¤§å®¶ä¼šé¢å¯¹äº¤ä»˜ä»£ç ç»™å®¢æˆ·çš„åœºæ™¯</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fault-error" class=" text-xl mt-2 pb-2 font-sans">Fault â†’ Error: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">æƒ³ç³Šå¼„ï¼Ÿç³Šå¼„ä¸è¿‡å»çš„ã€‚</p>
</blockquote>
<p class=" font-serif my-1">æ¥æ„é€  kalloc çš„ workload å§ï¼</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">os_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pmm</span><span class="o">-></span><span class="n">alloc</span><span class="p">(</span><span class="n">random_size</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Insufficient: pmm->alloc(32);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload-kalloc" class=" text-xl mt-2 pb-2 font-sans">åˆ›å»ºåˆç†çš„ Workload: <code>kalloc</code></h2>
<p class=" font-serif my-1">Online Judge ä¸Šçš„ workload:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸ºæ¯ä¸€ç§åˆ†é…å¤§å° $(2^{i-1} + 1) \ldots 2^{i}$ è®¾ç½®æ¦‚ç‡</li>
<li class=" ml-8">é¢‘ç¹çš„å°å†…å­˜åˆ†é…ã€é¢‘ç¹çš„å¤§å†…å­˜åˆ†é… (4 KiB)ã€æ··åˆçš„å†…å­˜åˆ†é…â€¦â€¦</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pr</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span><span class="w"> </span><span class="c1">// sum = pr[0] + pr[1] + ... pr[N-1]</span>
<span class="w">                    </span><span class="c1">// roll(0, sum-1) => allocation size</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span>
<span class="w">  </span><span class="n">wl_typical</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="n">wl_stress</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="n">wl_page</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span><span class="w"> </span><span class="o">*</span><span class="n">workload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&</span><span class="n">wl_typical</span><span class="p">;</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload-kfree" class=" text-xl mt-2 pb-2 font-sans">åˆ›å»ºåˆç†çš„ Workload: <code>kfree</code></h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">å¹¶å‘çš„ alloc-free æ˜¯å¾ˆå¤šé—®é¢˜çš„æ¥æºã€‚</p>
<p class=" font-serif my-1">ä½†åŒå­¦ä»¬ä¸€å®šæ˜¯æ‡’å¾—å»æµ‹è¯•çš„ã€‚  â€”â€” jyy</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Online Judge: ä¼šæŠŠåˆ†é…çš„ç»“æœä¿å­˜åˆ°ä¸€ä¸ªå¹¶å‘æ•°æ®ç»“æ„ä¸­</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ç”¨ C11 <a href="https://en.cppreference.com/w/c/atomic" class=" text-amber-900"><code>stdatomic.h</code></a> å®ç°<ul class=" list-disc font-serif">
<li class=" ml-8">ä¿è¯åˆæ³•çš„ kalloc/kfree åºåˆ—</li>
<li class=" ml-8">ä½†ä¸€ä¸ª CPU çš„ç”³è¯·çš„å†…å­˜å¯ä»¥åœ¨å¦ä¸€ä¸ª CPU free</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">æƒ³è‡ªå·±å®ç°ä¸ªç®€å•çš„ï¼Ÿ</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">åœ¨ CPU æœ¬åœ°ç¼“å­˜æœ¬ CPU çš„ allocation log<ul class=" list-disc font-serif">
<li class=" ml-8">è¾¾åˆ°ä¸€å®šå¤§å°åæ”¾å…¥å…±äº«é˜Ÿåˆ—ä¸­ (é˜Ÿåˆ—æ»¡å³ä¸¢å¼ƒ)</li>
</ul>
</li>
<li class=" ml-8">æ¯éš”ä¸€æ®µæ—¶é—´ä»é˜Ÿåˆ—ä¸­å–ä¸€ä¸ª log æ‰§è¡Œ free</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload" class=" text-xl mt-2 pb-2 font-sans">æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼šä¸ä»…æ˜¯ Workload</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">åŸºæœ¬æƒ³æ³•: workload + åœ¨é€‚å½“çš„æ—¶å€™æ’å…¥ <code>delay()</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">è¿™æ‰æ˜¯ Online Judge æµ‹è¯•çš„ç²¾é«“<ul class=" list-disc font-serif">
<li class=" ml-8">allocation-biased/free-biased/mixed</li>
</ul>
</li>
</ul>
</blockquote>
<p class=" font-serif my-1">ABBA (deadlock), ABA (AV), BA (OV) éƒ½å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è§¦å‘</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æ’å…¥ delay æ˜¯ä¸ªæŠ€æœ¯æ´»<ul class=" list-disc font-serif">
<li class=" ml-8">K. Sen. <a href="https://dl.acm.org/doi/10.1145/1375581.1375584" class=" text-amber-900">Race directed random testing of concurrent programs</a>. In <em>Proc. of PLDI</em>, 2008.</li>
<li class=" ml-8">D. Chen, et al. <a href="https://dl.acm.org/doi/10.1145/3236024.3236077" class=" text-amber-900">Testing multithreaded programs via thread speed control</a>. In <em>Proc. of ESEC/FSE, 2018</em>.</li>
<li class=" ml-8">G. Li, et al. <a href="https://dl.acm.org/doi/10.1145/3341301.3359638" class=" text-amber-900">Efficient scalable thread-safety-violation detection: Finding thousands of concurrency bugs during testing</a>. In <em>Proc. SOSP</em>, 2019.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="error-failure" class=" text-xl mt-2 pb-2 font-sans">Error â†’ Failure: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ£€æŸ¥ï¼</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">å¾ˆå¤šç¨‹åºåº”è¯¥æ»¡è¶³çš„ specification å¹¶æ²¡æœ‰è¢«æ£€æŸ¥</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">C/C++ ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œå°±è®© undefined behavior å‘ç”Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">å¹¶ä¸æ€»æ˜¯æ˜¾ç° â€œæ˜¾è‘—â€ çš„åæœ</li>
<li class=" ml-8">ç»™ä½ ä¸€ç§ç¨‹åºå¥½åƒæ²¡é—®é¢˜çš„é”™è§‰</li>
</ul>
</li>
</ul>
</blockquote>
<p class=" font-serif my-1">åœ¨ç¨‹åºä¸­è®¾è®¡å„ç§æ£€æŸ¥ (å°±åƒ <a href="../../../pages/OS/2021/demos/spinlock-xv6.c" class=" text-amber-900">spinlock.c</a> é‚£æ ·)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">double acquire, dangling release, æŒæœ‰é”æ—¶å¼€ä¸­æ–­, ä¸é…å¯¹çš„ unlock</li>
</ul>
<hr>
<p class=" font-serif my-1">æ£€æŸ¥ï¼šä¸å¿…å¤§è´¹å‘¨ç« </p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ç»Ÿè®¡å½“å‰çš„ spin count<ul class=" list-disc font-serif">
<li class=" ml-8">å¦‚æœè¶…è¿‡æŸä¸ªæ˜æ˜¾ä¸æ­£å¸¸çš„æ•°å€¼å°±æŠ¥å‘Š<ul class=" list-disc font-serif">
<li class=" ml-8">é…åˆè°ƒè¯•å™¨ backtrace ä¸€ç§’è¯Šæ–­æ­»é”</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="double-allocation" class=" text-xl mt-2 pb-2 font-sans">æ›´å¤šçš„æ£€æŸ¥: Double-Allocation</h2>
<p class=" font-serif my-1">å†…å­˜åˆ†é…è¦æ±‚ï¼šå·²åˆ†é…å†…å­˜ $S = [\ell_0, r_0) \cup [\ell_1, r_1) \cup \ldots$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">kalloc($s$) è¿”å›çš„ $[\ell, r)$ å¿…é¡»æ»¡è¶³ $[\ell, r) \cap S = \varnothing$<ul class=" list-disc font-serif">
<li class=" ml-8">thread-local allocation + å¹¶å‘çš„ free è¿˜è›®å®¹æ˜“å¼„é”™çš„</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// allocation</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"double-allocation"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// free</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"double-free"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="buffer-overrun" class=" text-xl mt-2 pb-2 font-sans">æ›´å¤šçš„æ£€æŸ¥: Buffer Overrun</h2>
<p class=" font-serif my-1">Canary (é‡‘ä¸é›€) å¯¹ä¸€æ°§åŒ–ç¢³éå¸¸æ•æ„Ÿ</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ç”¨ç”Ÿå‘½é¢„è­¦çŸ¿äº•ä¸‹çš„ç“¦æ–¯æ³„éœ² (since 1911)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/canary_with_miner.jpg" width="400px"></p>
<p class=" font-serif my-1">Canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">â€œç‰ºç‰²â€ ä¸€äº›å†…å­˜å•å…ƒï¼Œæ¥é¢„è­¦ memory bug çš„å‘ç”Ÿ<ul class=" list-disc font-serif">
<li class=" ml-8">(ç¨‹åºè¿è¡Œæ—¶æ²¡æœ‰åŠ¨ç‰©å—åˆ°å®è´¨çš„ä¼¤å®³)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="canary" class=" text-xl mt-2 pb-2 font-sans">Canary çš„ä¾‹å­ï¼šä¿æŠ¤å†…æ ¸æ ˆ</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define MAGIC 0x55555555</span>
<span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span><span class="w"> </span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"underflow"</span><span class="p">);</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"overflow"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">çƒ«çƒ«çƒ«å’Œå±¯å±¯å±¯</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/GET.jpg" width="250px"></p>
<p class=" font-serif my-1">msvc ä¸­ debug mode çš„ guard/fence/canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">æœªåˆå§‹åŒ–æ ˆ: <code>0xcccccccc</code></li>
<li class=" ml-8">æœªåˆå§‹åŒ–å †: <code>0xcdcdcdcd</code></li>
<li class=" ml-8">å¯¹è±¡å¤´å°¾: <code>0xfdfdfdfd</code></li>
<li class=" ml-8">å·²å›æ”¶å†…å­˜: <code>0xdddddddd</code></li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>>>> (b'\xcc' * 80).decode('gb2312')
'çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«'
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">æ‰‹æŒä¸¤æŠŠé”Ÿæ–¤æ‹·ï¼Œå£ä¸­ç–¾å‘¼çƒ«çƒ«çƒ«</p>
<p class=" font-serif my-1">è„šè¸åƒæœµå±¯å±¯å±¯ï¼Œç¬‘çœ‹ä¸‡ç‰©é”˜é”˜é”˜</p>
<p class=" font-serif my-1">(è¿™äº›æ›¾ç»å¯æ€•çš„å½¢è±¡åŸæ¥ä¸€ç›´åœ¨æ— å½¢ä¸­ä¿æŠ¤ä½ )</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizers" class=" text-xl mt-2 pb-2 font-sans">æ›´å¤šçš„æ£€æŸ¥: Sanitizers</h2>
<p class=" font-serif my-1">â€œåŠ¨æ€ç¨‹åºåˆ†æâ€</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">åœ¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œè§‚æµ‹å’Œæ£€æŸ¥ï¼›é€‚å½“çš„æ—¶å€™å¯¹ç¨‹åºè¡Œä¸ºè¿›è¡Œè°ƒæ§</li>
</ul>
<hr>
<p class=" font-serif my-1">å¸¸è§çš„åŠ¨æ€åˆ†æï¼šæ£€æŸ¥æŸäº› specification æ˜¯å¦è¢«è¿å</p>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/observe.jpg" width="200px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¯ä»¥æŠŠåŠ¨æ€åˆ†æç†è§£æˆä¸¤ä¸ªéƒ¨åˆ†<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸€ä¸ªéƒ¨åˆ†ä¸æ–­åœ°åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰“å°æ—¥å¿— <ul class=" list-disc font-serif">
<li class=" ml-8">lock, unlock, memory access, ...</li>
</ul>
</li>
<li class=" ml-8">å¦ä¸€ä¸ªéƒ¨åˆ†è§£ææ—¥å¿—ï¼ŒæŸ¥çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜<ul class=" list-disc font-serif">
<li class=" ml-8">lockdep: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ABBA</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">ä»˜å‡ºç¨‹åºå˜æ…¢çš„ä»£ä»·<ul class=" list-disc font-serif">
<li class=" ml-8">ä½†æ˜¯éå¸¸å€¼å¾—</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizers" class=" text-xl mt-2 pb-2 font-sans">Sanitizers: å‰æ‰€æœªæœ‰çš„å®è—</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">å¦‚æœä½ æ²¡ç”¨è¿‡ lint/sanitizersï¼Œæ ¹æœ¬ä¸èƒ½ç®—ä¼šç¼–ç¨‹ã€‚</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://clang.llvm.org/docs/AddressSanitizer.html" class=" text-amber-900">AddressSanitizer</a> (asan); <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany" class=" text-amber-900">(paper)</a><ul class=" list-disc font-serif">
<li class=" ml-8">æ£€æŸ¥å„ç§éæ³•åœ°å€è®¿é—®: buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, ...</li>
<li class=" ml-8">demo: <a href="../../../pages/OS/2021/demos/uaf.c" class=" text-amber-900">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html" class=" text-amber-900">kasan ç°å·²åŠ å…¥ Linux å†…æ ¸</a></li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/MemorySanitizer.html" class=" text-amber-900">MemorySanitizer</a> (msan)<ul class=" list-disc font-serif">
<li class=" ml-8">æ£€æŸ¥æœªåˆå§‹åŒ–çš„è¯»å–</li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">ThreadSanitizer</a> (tsan)<ul class=" list-disc font-serif">
<li class=" ml-8">æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•°æ®ç«äº‰ (data race)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">UBSanitizer</a> (ubsan)<ul class=" list-disc font-serif">
<li class=" ml-8">æ£€æŸ¥æ˜¯å¦å­˜åœ¨å„ç§çœ‹èµ·æ¥æ²¡é—®é¢˜çš„ undefined behavior: misaligned pointer, signed integer overflow, ...</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizer" class=" text-xl mt-2 pb-2 font-sans">æˆ‘çš„æ“ä½œç³»ç»Ÿå†…æ ¸å¦‚ä½•å®ç° Sanitizer?</h2>
<p class=" font-serif my-1">ä½ çŸ¥é“å¾ˆå¤šå˜é‡çš„<red>å«ä¹‰</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>CHECK_INT(waitlist->count, >= 0)</code></li>
<li class=" ml-8"><code>CHECK_INT(pid, < MAX_PROCS)</code></li>
<li class=" ml-8"><code>CHECK_HEAP(ctx->rip)</code></li>
<li class=" ml-8">å«ä¹‰å‘ç”Ÿæ”¹å˜ â†’ memory error<ul class=" list-disc font-serif">
<li class=" ml-8">ä¸è¦å°çœ‹è¿™äº›æ£€æŸ¥</li>
<li class=" ml-8">å®ƒä»¬å¾ˆå¯èƒ½åœ¨è™šæ‹Ÿæœºç¥ç§˜é‡å¯/å¡ä½/...å‰å‘å‡ºè­¦æŠ¥</li>
</ul>
</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define CHECK_INT(x, cond) \</span>
<span class="cp">  ({ panic_on(!((x) cond), "int check fail: " #x " " #cond); })</span>
<span class="cp">#define CHECK_HEAP(ptr) \</span>
<span class="cp">  ({ panic_on(!IN_RANGE((ptr), heap)); })</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">æ€»ç»“</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">æ€»ç»“</h2>
<p class=" font-serif my-1">æœ¬æ¬¡è¯¾å†…å®¹ä¸ç›®æ ‡</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">å¤ä¹ è°ƒè¯•ç†è®º (Fault, Error, Failure)</li>
<li class=" ml-8">ç†è§£å¹¶å‘ bugs</li>
<li class=" ml-8">å°†è°ƒè¯•ç†è®ºåº”ç”¨åˆ°å¹¶å‘</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">â€œå¥½çš„ä¸œè¥¿â€ ç¦»æˆ‘ä»¬ä¸€ç‚¹ä¹Ÿä¸è¿œ</li>
<li class=" ml-8">Fault â†’ Error: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼<ul class=" list-disc font-serif">
<li class=" ml-8">æ„é€ æ›´å¼ºçš„ workloads</li>
</ul>
</li>
<li class=" ml-8">Error â†’ Failure: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ£€æŸ¥ï¼<ul class=" list-disc font-serif">
<li class=" ml-8">assertions, sanitizers, ...</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>