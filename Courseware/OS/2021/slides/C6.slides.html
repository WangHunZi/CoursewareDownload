<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>[C6] 与并发 Bugs 相处</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="c6-bugs" class=" text-2xl mt-2 font-sans">[C6] 与并发 Bugs 相处</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">同步、互斥的时候我们已经讲了很多 “不对” 的案例</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并发编程：从入门到放弃</li>
<li class=" ml-8">哲 ♂ 学家死锁</li>
<li class=" ml-8">各种错误的自旋锁</li>
<li class=" ml-8">教科书上的条件变量 signal 错线程</li>
<li class=" ml-8">……</li>
</ul>
<hr>
<p class=" font-serif my-1">不要笑！🤡 竟是我自己</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并发 bugs 怎么办？</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">复习调试理论</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">你在《操作系统》课上活下来所需的最重要的理论</li>
</ul>
<hr>
<p class=" font-serif my-1">理解并发 bugs 的类型、产生原因和预防方法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">死锁 (lockdep)</li>
<li class=" ml-8">原子性/顺序违反 (测试 + 检查)</li>
</ul>
<hr>
<p class=" font-serif my-1">应用调试理论</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如何在编写操作系统内核时保护自己少受伤害？<ul class=" list-disc font-serif">
<li class=" ml-8">(不受伤是不可能的啦……)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">调试理论：复习</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">基本原则</h2>
<p class=" font-serif my-1">在《计算机系统基础》实验中提出 (<a href="https://www.bilibili.com/video/BV1qa4y1j7xk?p=10" class=" text-amber-900">视频回看</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">只要写代码，就会一直伴随大家</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>机器永远是对的</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(ICS) 不管是 crash 了，图形显示不正常了，还是 <code>HIT BAD TRAP</code> 了，最后都是你自己背锅</li>
<li class=" ml-8">(OS) 不管是卡死、异常还是虚拟机重启，都是你自己的 bug</li>
</ul>
<hr>
<p class=" font-serif my-1"><red>未测代码永远是错的</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(ICS/OS) 你以为最不可能出 bug 的地方，往往 bug 就在那躺着</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="debug" class=" text-xl mt-2 pb-2 font-sans">调试理论：为什么 Debug 那么困难？</h2>
<p class=" font-serif my-1">程序：<red>人类世界需求在信息世界的投影</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">程序中的 bug 是程序与设计/意图违反之处<ul class=" list-disc font-serif">
<li class=" ml-8">debug 就是定位到程序中 bug 的过程</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">程序员：犯的是 Fault，看到的是 Failure</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Fault (bug) → Error (程序状态错) → Failure (可观测的结果错)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/ICS/2020/slides/img/fault-error-failure.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bug" class=" text-xl mt-2 pb-2 font-sans">调试理论：如何找到 Bug?</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">调试理论：如果我们能判定任意程序状态的正确性，那么给定一个 Failure，通过二分查找定位到第一个 Error 的状态，导致此状态的代码就是 Fault (bug)。</p>
<p class=" font-serif my-1">在实际中的应用：状态机的执行可能很长，但我们只要标记出一些<red>关键的状态</red>，就能帮我们缩小排查问题的范围</p>
</blockquote>
<hr>
<p class=" font-serif my-1">实际中的调试：更 “人类友好” 的分段检查</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">printf → 自定义 log 的 trace</li>
<li class=" ml-8">gdb → 指令/语句级 trace</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">坠入并发的深渊……</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">并发：调试理论的灾难</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">在无法 “准确复现一次执行” 的基础上，“找到第一个 error 的状态” 变难了……</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Fault → Error</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">每次的 Error 都不一样</li>
<li class=" ml-8">无法 “二分”</li>
</ul>
<hr>
<p class=" font-serif my-1">Error → Failure</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">日志仍然能帮助我们缩小 Error 发生的范围</li>
<li class=" ml-8">但 Failure 更难理解 (错误的输出/神秘异常/神秘重启/...)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">挣扎：使用调试理论</h2>
<p class=" font-serif my-1">调试理论告诉我们：failure point 很重要</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可以追溯出一些 error states</li>
<li class=" ml-8">QEMU 设计者当然知道这一点<ul class=" list-disc font-serif">
<li class=" ml-8"><red>如果我们希望有什么，那一定会有的！</red></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">RTFM: QEMU Monitor (例子：<a href="../../../pages/OS/2021/demos/cpu-reset.c" class=" text-amber-900">cpu-reset.c</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">得到详尽的日志: <code>log int,cpu_reset,exec</code><ul class=" list-disc font-serif">
<li class=" ml-8">fault → error → failure<ul class=" list-disc font-serif">
<li class=" ml-8"><code>int,cpu_reset</code> - 帮助我们定位 failure</li>
<li class=" ml-8"><code>exec</code> - 帮助我们定位 error (执行流)<ul class=" list-disc font-serif">
<li class=" ml-8">甚至可以开发一个小工具，“绘制” 出程序执行的路径</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="bugs" class=" text-xl mt-2 pb-2 font-sans">并发 Bugs 到底长什么样？</h2>
<p class=" font-serif my-1">一种研究流派：实证研究 (empirical study)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为了更好地解决并发 bugs 的问题<ul class=" list-disc font-serif">
<li class=" ml-8">从现实数据集中 (随机) 选取一定比例的例子</li>
<li class=" ml-8">对结论进行归纳总结</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">一些实证研究</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">S. Lu, et al. <a href="https://dl.acm.org/doi/10.1145/1353535.1346323" class=" text-amber-900">Learning from mistakes — A comprehensive study on real world concurrency bug characteristics</a>. In <em>Proc. of ASPLOS</em>, 2008.</li>
<li class=" ml-8">Z. Yin, et al. <a href="https://dl.acm.org/doi/10.1145/2025113.2025121" class=" text-amber-900">How do fixes become bugs? A comprehensive characteristic study on incorrect fixes in commercial and
open source operating systems</a>. In <em>Proc. of ESEC/FSE</em>, 2011.</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="deadlock" class=" text-2xl mt-2 font-sans">死锁 (Deadlock)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="deadlock" class=" text-xl mt-2 pb-2 font-sans">死锁 (Deadlock)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
<p class=" font-serif my-1">Empirical study: MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</p>
</blockquote>
<p class=" font-serif my-1">出现线程 “互相等待” 的情况 (路口空间 = 资源)</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/deadlock-car.jpg" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="aa-deadlock" class=" text-xl mt-2 pb-2 font-sans">AA-Deadlock</h2>
<p class=" font-serif my-1">假设你的 spinlock 不小心发生了中断</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">错误实现的 popcli</li>
<li class=" ml-8">不应该发生的 <code>yield()</code></li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">os_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span><span class="w"> </span><span class="c1">// ---------+</span>
<span class="p">}</span><span class="w">                          </span><span class="c1">//    |</span>
<span class="w">                           </span><span class="c1">//    |</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">on_interrupt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">//    |</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span><span class="w">   </span><span class="c1">// <--+</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="abba-deadlock" class=" text-xl mt-2 pb-2 font-sans">ABBA-Deadlock</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">obj_move</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="w">  </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">上锁的顺序很重要……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>obj_move</code> 本身看起来没有问题<ul class=" list-disc font-serif">
<li class=" ml-8"><code>obj_move(1, 2)</code>; <code>obj_move(2, 1)</code> → 死锁</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">避免死锁</h2>
<p class=" font-serif my-1">死锁产生的四个必要条件 (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr." class=" text-amber-900">Edward G. Coffman</a>, 1971):</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">互斥：一个资源每次只能被一个进程使用</li>
<li class=" ml-8">请求与保持：一个进程请求资阻塞时，不释放已获得的资源</li>
<li class=" ml-8">不剥夺：进程已获得的资源不能强行剥夺</li>
<li class=" ml-8">循环等待：若干进程之间形成头尾相接的循环等待资源关系</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">“理解了死锁的原因，尤其是产生死锁的四个必要条件，就可以最大可能地避免、预防和解除死锁。所以，在系统设计、进程调度等方面注意如何不让这四个必要条件成立，如何确定资源的合理分配算法，避免进程永久占据系统资源。此外，也要防止进程在处于等待状态的情况下占用资源。因此，对资源的分配要给予合理的规划。”
——<red>Bullshit</red>.</p>
<p class=" font-serif my-1">破坏每一个条件都是非常困难的 (请阅读教科书)</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">避免死锁 (cont'd)</h2>
<p class=" font-serif my-1">AA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">AA 型的死锁容易检测，及早报告，及早修复</li>
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/spinlock-xv6.c" class=" text-amber-900">spinlock.c</a><ul class=" list-disc font-serif">
<li class=" ml-8"><code>if (holding(lk)) panic();</code></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">ABBA-Deadlock</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">任意时刻系统中的锁都是有限的</li>
<li class=" ml-8">严格按照固定的顺序获得所有锁 (lock ordering; 消除 “循环等待”)<ul class=" list-disc font-serif">
<li class=" ml-8">试一试：用状态机证明 $T_1: A\to B\to C; T_2: B \to C$ 是安全的<ul class=" list-disc font-serif">
<li class=" ml-8">“在任意时刻总是有一个线程 (获得 “最靠后” 锁的) 可以继续执行”</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lock-ordering-linux-kernel-rmapc" class=" text-xl mt-2 pb-2 font-sans">Lock Ordering: 应用 (Linux Kernel: rmap.c)</h2>
<p class=" font-serif my-1"><img alt="" src="../../../pages/OS/img/kernel-rmap.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">你大约察觉了……</h2>
<p class=" font-serif my-1">Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. Practice will tell you that this approach doesn't scale: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p class=" font-serif my-1">The best locks are encapsulated: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.</p>
<p class=" font-serif my-1">—— <em>Unreliable Guide To Locking</em> by Rusty Russell</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">让程序员彻底避免死锁？你想多了……</h2>
<p class=" font-serif my-1">调试公理：未测代码永远是错的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">并发那么复杂，程序员哪能充分测试啊……</li>
</ul>
<hr>
<p class=" font-serif my-1"><a href="../../OS_Lockdep.html" class=" text-amber-900">lockdep</a>, since Linux Kernel 2.6.17; also in <a href="https://gitee.com/openharmony" class=" text-amber-900">OpenHarmony</a>!</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为每一个 “lock class” 检查 (分配一个 key)<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/lock-site.c" class=" text-amber-900">lock-site.c</a>; 我们也可以在 xv6 里实现一个！</li>
</ul>
</li>
<li class=" ml-8">在运行时观察所有的 lock/unlock<ul class=" list-disc font-serif">
<li class=" ml-8">lock/unlock 时记录所有可能的上锁顺序<ul class=" list-disc font-serif">
<li class=" ml-8">线程获得 $X, Y, Z$ 会记录 $X \to Y, X \to Z, Y \to Z$</li>
</ul>
</li>
<li class=" ml-8">检查是否存在 $A \to B$ 和 $B \to A$ (deadlock)<ul class=" list-disc font-serif">
<li class=" ml-8">即便死锁没有真正发生，但只要有 ABBA 的风险就会报告</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">死锁：锁并不是唯一的原因</h2>
<p class=" font-serif my-1">在涉及同步的时候，情况就复杂得多了……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">老总打电话给秘书：“这几天我陪你去北京玩玩，你准备一下”</li>
<li class=" ml-8">秘书打电话给老公：“这几天我要和老总去北京开会”</li>
<li class=" ml-8">老公打电话给情人：“这几天我老婆不在家，陪我”</li>
<li class=" ml-8">情人打电话给辅导学生：“这几天老师有事，停课”</li>
<li class=" ml-8">学生打电话给爷爷：“这几天不上课，爷爷你陪我玩”</li>
<li class=" ml-8">爷爷给秘书打电话：“北京去不了了，孙子要我陪”</li>
<li class=" ml-8">秘书给老公打电话：“老总突然有事不去北京开会了”</li>
<li class=" ml-8">老公给情人打电话：“老婆不走了，下次再说”</li>
<li class=" ml-8">情人给辅导学生打电话：“这几天照常上课”</li>
<li class=" ml-8">学生给爷爷打电话：“555 老师说这几天照常上课”</li>
<li class=" ml-8">爷爷给秘书打电话：还是去北京吧，你准备准备</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="bug" class=" text-2xl mt-2 font-sans">并发 Bug：不仅是死锁</h1>
<p class=" font-serif my-1"><br></p>
<p class=" font-serif my-1">不上锁不就没有死锁了吗？</p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">程序员：花式犯错</h2>
<p class=" font-serif my-1">回顾我们实现并发控制的工具</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">互斥锁 (lock/unlock) - 原子性</li>
<li class=" ml-8">条件变量 (wait/signal) - 同步</li>
</ul>
<hr>
<p class=" font-serif my-1">忘记上锁——原子性违反 (Atomicity Violation, AV)</p>
<p class=" font-serif my-1">忘记同步——顺序违反 (Order Violation, OV)</p>
<hr>
<p class=" font-serif my-1">Empirical study: 在 105 个并发 bug 中 (non-deadlock/deadlock)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
<li class=" ml-8"><red>97% 的非死锁并发 bug 都是 AV 或 OV</red>。</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="av" class=" text-xl mt-2 pb-2 font-sans">原子性违反 (AV)</h2>
<p class=" font-serif my-1">“ABA”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我以为一段代码没啥事呢，但被人强势插入了</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/av-bug.png" width="900px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">原子性违反 (cont'd)</h2>
<p class=" font-serif my-1">有时候上锁也不解决问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“TOCTTOU” - time of check to time of use</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/tocttou.png" width="640px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">J. Wei and C. Pu. <a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf" class=" text-amber-900">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a>. In <em>Proc. of FAST</em>, 2005.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ov" class=" text-xl mt-2 pb-2 font-sans">顺序违反 (OV)</h2>
<p class=" font-serif my-1">“BA”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">怎么就没按我预想的顺序来呢？<ul class=" list-disc font-serif">
<li class=" ml-8">例子：concurrent use after free  </li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ov-bug.png" width="900px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="empirical-study" class=" text-xl mt-2 pb-2 font-sans">Empirical Study 的意义</h2>
<p class=" font-serif my-1">程序员：我本地都跑了几万次了，没问题啊</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一部署到生产环境里就 💥 爆炸了</li>
</ul>
<p class=" font-serif my-1">我：在本地测的好好的啊</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">提交到 Online Judge 上连 easy tests 都过不了 (真实)</li>
</ul>
<hr>
<p class=" font-serif my-1">Empirical study 给了我们更多有趣的发现，指导 bug 的发现/修复：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Almost all (96%) of the examined bugs are guaranteed to manifest if certain partial order between <em>2 threads</em> is enforced. </li>
<li class=" ml-8">Many (66%) of the examined non-deadlock bugs’ manifestation involves concurrent accesses to <em>only one variable</em>. </li>
<li class=" ml-8">Almost all (97%) of the examined deadlock bugs involve <em>two threads</em> circularly waiting for at most two resources. </li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="lab-1-pmm" class=" text-2xl mt-2 font-sans">调试理论应用：Lab 1 (PMM)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="online-judge" class=" text-xl mt-2 pb-2 font-sans">Online Judge 体验极差</h2>
<p class=" font-serif my-1">Lab 1 有一定难度</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">有一点轻微的并发 bug → Wrong Answer</li>
<li class=" ml-8">用一把大锁 → Wrong Answer (< 1Mop/s)<ul class=" list-disc font-serif">
<li class=" ml-8">大部分分数到手，建议从这里开始</li>
</ul>
</li>
</ul>
<hr>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">如果你调试了很久都没有想法，不如用一点系统化的手段。</p>
<p class=" font-serif my-1">“跳出问题看问题” 是专业人士应当具备的素质。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">做好 Lab1 的测试框架</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">虽然大家可以硬来 (xjb 改程序直到 Online Judge 通过)</li>
<li class=" ml-8">但总有一天大家会面对交付代码给客户的场景</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fault-error" class=" text-xl mt-2 pb-2 font-sans">Fault → Error: 我们需要更多的测试用例！</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">想糊弄？糊弄不过去的。</p>
</blockquote>
<p class=" font-serif my-1">来构造 kalloc 的 workload 吧！</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">os_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pmm</span><span class="o">-></span><span class="n">alloc</span><span class="p">(</span><span class="n">random_size</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Insufficient: pmm->alloc(32);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload-kalloc" class=" text-xl mt-2 pb-2 font-sans">创建合理的 Workload: <code>kalloc</code></h2>
<p class=" font-serif my-1">Online Judge 上的 workload:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">为每一种分配大小 $(2^{i-1} + 1) \ldots 2^{i}$ 设置概率</li>
<li class=" ml-8">频繁的小内存分配、频繁的大内存分配 (4 KiB)、混合的内存分配……</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pr</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span><span class="w"> </span><span class="c1">// sum = pr[0] + pr[1] + ... pr[N-1]</span>
<span class="w">                    </span><span class="c1">// roll(0, sum-1) => allocation size</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span>
<span class="w">  </span><span class="n">wl_typical</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="n">wl_stress</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="n">wl_page</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">workload</span><span class="w"> </span><span class="o">*</span><span class="n">workload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&</span><span class="n">wl_typical</span><span class="p">;</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload-kfree" class=" text-xl mt-2 pb-2 font-sans">创建合理的 Workload: <code>kfree</code></h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">并发的 alloc-free 是很多问题的来源。</p>
<p class=" font-serif my-1">但同学们一定是懒得去测试的。  —— jyy</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Online Judge: 会把分配的结果保存到一个并发数据结构中</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">用 C11 <a href="https://en.cppreference.com/w/c/atomic" class=" text-amber-900"><code>stdatomic.h</code></a> 实现<ul class=" list-disc font-serif">
<li class=" ml-8">保证合法的 kalloc/kfree 序列</li>
<li class=" ml-8">但一个 CPU 的申请的内存可以在另一个 CPU free</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">想自己实现个简单的？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在 CPU 本地缓存本 CPU 的 allocation log<ul class=" list-disc font-serif">
<li class=" ml-8">达到一定大小后放入共享队列中 (队列满即丢弃)</li>
</ul>
</li>
<li class=" ml-8">每隔一段时间从队列中取一个 log 执行 free</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="workload" class=" text-xl mt-2 pb-2 font-sans">更多的测试用例：不仅是 Workload</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">基本想法: workload + 在适当的时候插入 <code>delay()</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">这才是 Online Judge 测试的精髓<ul class=" list-disc font-serif">
<li class=" ml-8">allocation-biased/free-biased/mixed</li>
</ul>
</li>
</ul>
</blockquote>
<p class=" font-serif my-1">ABBA (deadlock), ABA (AV), BA (OV) 都可以通过这种方式触发</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">插入 delay 是个技术活<ul class=" list-disc font-serif">
<li class=" ml-8">K. Sen. <a href="https://dl.acm.org/doi/10.1145/1375581.1375584" class=" text-amber-900">Race directed random testing of concurrent programs</a>. In <em>Proc. of PLDI</em>, 2008.</li>
<li class=" ml-8">D. Chen, et al. <a href="https://dl.acm.org/doi/10.1145/3236024.3236077" class=" text-amber-900">Testing multithreaded programs via thread speed control</a>. In <em>Proc. of ESEC/FSE, 2018</em>.</li>
<li class=" ml-8">G. Li, et al. <a href="https://dl.acm.org/doi/10.1145/3341301.3359638" class=" text-amber-900">Efficient scalable thread-safety-violation detection: Finding thousands of concurrency bugs during testing</a>. In <em>Proc. SOSP</em>, 2019.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="error-failure" class=" text-xl mt-2 pb-2 font-sans">Error → Failure: 我们需要更多的检查！</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">很多程序应该满足的 specification 并没有被检查</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">C/C++ 为了性能考虑，就让 undefined behavior 发生<ul class=" list-disc font-serif">
<li class=" ml-8">并不总是显现 “显著” 的后果</li>
<li class=" ml-8">给你一种程序好像没问题的错觉</li>
</ul>
</li>
</ul>
</blockquote>
<p class=" font-serif my-1">在程序中设计各种检查 (就像 <a href="../../../pages/OS/2021/demos/spinlock-xv6.c" class=" text-amber-900">spinlock.c</a> 那样)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">double acquire, dangling release, 持有锁时开中断, 不配对的 unlock</li>
</ul>
<hr>
<p class=" font-serif my-1">检查：不必大费周章</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">统计当前的 spin count<ul class=" list-disc font-serif">
<li class=" ml-8">如果超过某个明显不正常的数值就报告<ul class=" list-disc font-serif">
<li class=" ml-8">配合调试器 backtrace 一秒诊断死锁</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="double-allocation" class=" text-xl mt-2 pb-2 font-sans">更多的检查: Double-Allocation</h2>
<p class=" font-serif my-1">内存分配要求：已分配内存 $S = [\ell_0, r_0) \cup [\ell_1, r_1) \cup \ldots$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">kalloc($s$) 返回的 $[\ell, r)$ 必须满足 $[\ell, r) \cap S = \varnothing$<ul class=" list-disc font-serif">
<li class=" ml-8">thread-local allocation + 并发的 free 还蛮容易弄错的</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="c1">// allocation</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"double-allocation"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// free</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o"><=</span><span class="w"> </span><span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"double-free"</span><span class="p">);</span>
<span class="w">  </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="buffer-overrun" class=" text-xl mt-2 pb-2 font-sans">更多的检查: Buffer Overrun</h2>
<p class=" font-serif my-1">Canary (金丝雀) 对一氧化碳非常敏感</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">用生命预警矿井下的瓦斯泄露 (since 1911)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/canary_with_miner.jpg" width="400px"></p>
<p class=" font-serif my-1">Canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“牺牲” 一些内存单元，来预警 memory bug 的发生<ul class=" list-disc font-serif">
<li class=" ml-8">(程序运行时没有动物受到实质的伤害)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="canary" class=" text-xl mt-2 pb-2 font-sans">Canary 的例子：保护内核栈</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define MAGIC 0x55555555</span>
<span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span><span class="w"> </span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o"><</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"underflow"</span><span class="p">);</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">"overflow"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">烫烫烫和屯屯屯</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/GET.jpg" width="250px"></p>
<p class=" font-serif my-1">msvc 中 debug mode 的 guard/fence/canary</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">未初始化栈: <code>0xcccccccc</code></li>
<li class=" ml-8">未初始化堆: <code>0xcdcdcdcd</code></li>
<li class=" ml-8">对象头尾: <code>0xfdfdfdfd</code></li>
<li class=" ml-8">已回收内存: <code>0xdddddddd</code></li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>>>> (b'\xcc' * 80).decode('gb2312')
'烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫'
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">手持两把锟斤拷，口中疾呼烫烫烫</p>
<p class=" font-serif my-1">脚踏千朵屯屯屯，笑看万物锘锘锘</p>
<p class=" font-serif my-1">(这些曾经可怕的形象原来一直在无形中保护你)</p>
</blockquote></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizers" class=" text-xl mt-2 pb-2 font-sans">更多的检查: Sanitizers</h2>
<p class=" font-serif my-1">“动态程序分析”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在程序运行时进行观测和检查；适当的时候对程序行为进行调控</li>
</ul>
<hr>
<p class=" font-serif my-1">常见的动态分析：检查某些 specification 是否被违反</p>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/observe.jpg" width="200px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可以把动态分析理解成两个部分<ul class=" list-disc font-serif">
<li class=" ml-8">一个部分不断地在程序运行时打印日志 <ul class=" list-disc font-serif">
<li class=" ml-8">lock, unlock, memory access, ...</li>
</ul>
</li>
<li class=" ml-8">另一个部分解析日志，查看有没有什么问题<ul class=" list-disc font-serif">
<li class=" ml-8">lockdep: 检查是否存在 ABBA</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">付出程序变慢的代价<ul class=" list-disc font-serif">
<li class=" ml-8">但是非常值得</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizers" class=" text-xl mt-2 pb-2 font-sans">Sanitizers: 前所未有的宝藏</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">如果你没用过 lint/sanitizers，根本不能算会编程。</p>
</blockquote>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://clang.llvm.org/docs/AddressSanitizer.html" class=" text-amber-900">AddressSanitizer</a> (asan); <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany" class=" text-amber-900">(paper)</a><ul class=" list-disc font-serif">
<li class=" ml-8">检查各种非法地址访问: buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, ...</li>
<li class=" ml-8">demo: <a href="../../../pages/OS/2021/demos/uaf.c" class=" text-amber-900">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html" class=" text-amber-900">kasan 现已加入 Linux 内核</a></li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/MemorySanitizer.html" class=" text-amber-900">MemorySanitizer</a> (msan)<ul class=" list-disc font-serif">
<li class=" ml-8">检查未初始化的读取</li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">ThreadSanitizer</a> (tsan)<ul class=" list-disc font-serif">
<li class=" ml-8">检查是否存在数据竞争 (data race)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html" class=" text-amber-900">UBSanitizer</a> (ubsan)<ul class=" list-disc font-serif">
<li class=" ml-8">检查是否存在各种看起来没问题的 undefined behavior: misaligned pointer, signed integer overflow, ...</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="sanitizer" class=" text-xl mt-2 pb-2 font-sans">我的操作系统内核如何实现 Sanitizer?</h2>
<p class=" font-serif my-1">你知道很多变量的<red>含义</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>CHECK_INT(waitlist->count, >= 0)</code></li>
<li class=" ml-8"><code>CHECK_INT(pid, < MAX_PROCS)</code></li>
<li class=" ml-8"><code>CHECK_HEAP(ctx->rip)</code></li>
<li class=" ml-8">含义发生改变 → memory error<ul class=" list-disc font-serif">
<li class=" ml-8">不要小看这些检查</li>
<li class=" ml-8">它们很可能在虚拟机神秘重启/卡住/...前发出警报</li>
</ul>
</li>
</ul>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define CHECK_INT(x, cond) \</span>
<span class="cp">  ({ panic_on(!((x) cond), "int check fail: " #x " " #cond); })</span>
<span class="cp">#define CHECK_HEAP(ptr) \</span>
<span class="cp">  ({ panic_on(!IN_RANGE((ptr), heap)); })</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">复习调试理论 (Fault, Error, Failure)</li>
<li class=" ml-8">理解并发 bugs</li>
<li class=" ml-8">将调试理论应用到并发</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“好的东西” 离我们一点也不远</li>
<li class=" ml-8">Fault → Error: 我们需要更多的测试用例！<ul class=" list-disc font-serif">
<li class=" ml-8">构造更强的 workloads</li>
</ul>
</li>
<li class=" ml-8">Error → Failure: 我们需要更多的检查！<ul class=" list-disc font-serif">
<li class=" ml-8">assertions, sanitizers, ...</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>