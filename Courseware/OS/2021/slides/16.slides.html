<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>持久数据的可靠性</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">持久数据的可靠性</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">文件系统 = 把设备抽象成目录树</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">mount - 文件系统管理</li>
<li class=" ml-8">mkdir, rmkdir, link, symlink, unlink... - 目录管理</li>
<li class=" ml-8">open, mmap, read, write, lseek... - 文件管理<ul class=" list-disc font-serif">
<li class=" ml-8">使用链表、索引、……实现</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">如何实现<red>高可靠、高性能</red>？</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">RAID: Redundant Array of Inexpensive Disks</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">把多块磁盘虚拟化成一块性能更好、更可靠的磁盘</li>
</ul>
<hr>
<p class=" font-serif my-1">崩溃一致性</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如何在硬件可能崩溃的情况下保证文件系统 (数据结构) 的一致性</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="redundant-array-of-inexpensive-disks-raid" class=" text-2xl mt-2 font-sans">Redundant Array of Inexpensive Disks (RAID)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">持久数据的可靠性</h2>
<p class=" font-serif my-1">任何物理存储介质都有失效的可能</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">你依然希望在存储设备失效的时候能保持数据的完整<ul class=" list-disc font-serif">
<li class=" ml-8">极小概率事件：战争爆发/三体人进攻地球/世界毁灭 😂</li>
<li class=" ml-8">小概率事件：硬盘损坏<ul class=" list-disc font-serif">
<li class=" ml-8">大量重复 = 必然发生<ul class=" list-disc font-serif">
<li class=" ml-8">但我们还是希望系统能照常运转</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">增加持久数据可靠性的方法</h2>
<p class=" font-serif my-1"><red>备胎</red>：鸡蛋不能放在一个篮子里</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">教务处：物理备份<ul class=" list-disc font-serif">
<li class=" ml-8">期末考试后会提交所有批阅的试卷、成绩表、成绩分布</li>
<li class=" ml-8">假设教务系统崩溃 v.s. 教务处崩溃是独立事件<ul class=" list-disc font-serif">
<li class=" ml-8">两个极小概率事件同时发生，那就认倒霉吧</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">服务器：数据备份<ul class=" list-disc font-serif">
<li class=" ml-8">所有数据同时写入两块磁盘</li>
<li class=" ml-8">每日或每周备份<ul class=" list-disc font-serif">
<li class=" ml-8">crontab (time-based job scheduler)</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid" class=" text-xl mt-2 pb-2 font-sans">RAID: 存储设备的虚拟化</h2>
<p class=" font-serif my-1">Redundant Array of Inexpensive (<em>Independent</em>) Disks (RAID)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">把多个 (不可靠的) 磁盘虚拟成一块非常可靠的虚拟磁盘</li>
</ul>
<hr>
<p class=" font-serif my-1">类比我们见过的虚拟化</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">进程：把一个 CPU 分时虚拟成多个虚拟 CPU</li>
<li class=" ml-8">虚存：把一份内存通过 MMU 虚拟成多个地址空间</li>
<li class=" ml-8">文件：把一个存储设备虚拟成多个虚拟磁盘</li>
</ul>
<hr>
<p class=" font-serif my-1">RAID 的虚拟化是 “反向” 的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(一个 → 多个) vs. (多个 → 一个)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-fault-model-fail-stop" class=" text-xl mt-2 pb-2 font-sans">RAID 的 Fault Model: Fail-Stop</h2>
<p class=" font-serif my-1">磁盘可能在某个时刻忽然彻底无法访问 (数据好像完全消失)。</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">机械故障、芯片故障……<ul class=" list-disc font-serif">
<li class=" ml-8">磁盘好像就 “忽然消失” 了</li>
<li class=" ml-8">假设磁盘能报告这个问题 (如何报告？)</li>
</ul>
</li>
<li class=" ml-8">L. Bairavasundaram, et al. An analysis of data corruption in the storage stack. In <em>Proc. of FAST</em>, 2008.</li>
</ul>
<hr>
<p class=" font-serif my-1">你还敢用这个硬盘做 {教务系统, 支付宝, 银行, …} 吗？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">总有一天，一定有磁盘会坏掉的<ul class=" list-disc font-serif">
<li class=" ml-8">坏事件一旦发生，就有数据会丢失</li>
<li class=" ml-8">永远不丢失数据似乎是不可能的</li>
</ul>
</li>
<li class=" ml-8">我们还能构造可靠的 (单机) 存储系统吗？</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">当然可以！</h2>
<p class=" font-serif my-1">假设我愿意在系统里多接入一块硬盘用于容灾</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">通过设备驱动程序抽象成 “一个磁盘” $V$ (例如 1TB)<ul class=" list-disc font-serif">
<li class=" ml-8">实际由 $A$, $B$ 两块 1TB 的物理磁盘组成<red>镜像</red></li>
</ul>
</li>
<li class=" ml-8">readb($V$, blk)<ul class=" list-disc font-serif">
<li class=" ml-8">可以从 $A$ 或 $B$ 中的任意一个读取</li>
</ul>
</li>
<li class=" ml-8">writeb($V$, blk)<ul class=" list-disc font-serif">
<li class=" ml-8">将同样的数据写入 $A$, $B$ 的同一位置  </li>
</ul>
</li>
</ul></div>
        
      
         <div class="fragment"> 
        <div><hr>
<p class=" font-serif my-1">假设内存带宽远高于磁盘带宽</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">1X write (浪费了 1/2 的总带宽)</li>
<li class=" ml-8">2X sequential read (tricky)</li>
<li class=" ml-8">2X random read (使用了 100% 的总带宽)</li>
<li class=" ml-8">抵抗任意一块盘的损坏</li>
</ul></div>
         </div> 
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">RAID (虚拟化) = 虚拟磁盘块到物理磁盘块的 “映射”。</p>
</blockquote>
<p class=" font-serif my-1">RAID-0: 把多块盘 “交替拼接”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$V_0 \to A_0$, $V_1 \to B_0$, $V_{2i} \to A_i$, $V_{2i+1} \to B_i$</li>
<li class=" ml-8">完美扩展的高性能虚拟磁盘<ul class=" list-disc font-serif">
<li class=" ml-8">100% 顺序/随机读写总带宽</li>
</ul>
</li>
<li class=" ml-8">但完全不能容错</li>
</ul>
<hr>
<p class=" font-serif my-1">RAID-1 (镜像)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$V_0 \to (A_0, B_0)$</li>
<li class=" ml-8">容忍一块盘 fail</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space-contd" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space (cont'd)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">RAID: 允许 “多对多” 的映射 (一组映射称为 “条带”, stripe)</p>
</blockquote>
<p class=" font-serif my-1">RAID-10</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$(V_0, V_1) \to (A_0, B_0, C_0, D_0)$<ul class=" list-disc font-serif">
<li class=" ml-8">$A_0 = B_0 = V_0$, $C_0 = D_0 = V_1$</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">另一种可能的方式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$(V_0, V_1, V_2) \to (A_0, B_0, C_0, D_0)$<ul class=" list-disc font-serif">
<li class=" ml-8">“三块映射到四块”</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-design-space-contd" class=" text-xl mt-2 pb-2 font-sans">RAID: Design Space (cont'd)</h2>
<p class=" font-serif my-1">$(V_0, V_1, V_2) \to (A_0, B_0, C_0, D_0)$</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不妨假设所有的条带 $V_i, A_i, B_i, C_i, D_i$ 都只有 1-bit</li>
<li class=" ml-8">问题：<red>如何用 4 个 bit 存储 3-bit 信息，使得 4 个 bit 中的任何一个丢失，都能恢复出存储的 3-bit 的信息？</red><ul class=" list-disc font-serif">
<li class=" ml-8">奇偶校验！</li>
<li class=" ml-8">对于 bits $a_1, a_2, \ldots, a_n$<ul class=" list-disc font-serif">
<li class=" ml-8">存储 $a_{n+1} = a_1 \oplus a_2 \oplus \ldots \oplus a_n$<ul class=" list-disc font-serif">
<li class=" ml-8">移项得 $a_1 \oplus a_2 \oplus \ldots \oplus a_n \oplus a_{n+1} = 0$</li>
</ul>
</li>
<li class=" ml-8">任何一个 bit 丢失 (对应 $A,B,C,D$ 中某块硬盘不能启动)<ul class=" list-disc font-serif">
<li class=" ml-8">$a_i = a_1 \oplus \ldots \oplus a_{i-1} \oplus a_{i+1} \oplus \ldots \oplus a_n \oplus a_{n+1}$</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-4-parity-disk" class=" text-xl mt-2 pb-2 font-sans">RAID-4: Parity Disk</h2>
<p class=" font-serif my-1">专门留一块磁盘作为奇偶校验盘。</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$(V_0, V_1, V_2) \to (A_0, B_0, C_0, D_0)$<ul class=" list-disc font-serif">
<li class=" ml-8">$A_0 = V_0$, $B_0 = V_1$, $C_0 = V_2$</li>
<li class=" ml-8">$D_0 = V_0 \oplus V_1 \oplus V_2$ (奇偶校验)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">性能分析</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">sequential/random read: 3x (75% 总带宽)</li>
<li class=" ml-8">sequential write: 3x (75% 总带宽)</li>
<li class=" ml-8">random write (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">$D_0 = V_0 \oplus V_1 \oplus V_2$</li>
<li class=" ml-8">写入任意 $V_0, V_1, V_2$ 都需要更新 $D_0$<ul class=" list-disc font-serif">
<li class=" ml-8">更新 $V_0$ 需要 readb($\{A_0,D_0\})$, writeb($\{A_0,D_0\}$)</li>
</ul>
</li>
<li class=" ml-8">奇偶校验盘成为了瓶颈: 0.5x</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-5-rotating-parity" class=" text-xl mt-2 pb-2 font-sans">RAID-5: Rotating Parity</h2>
<p class=" font-serif my-1">“交错排列” parity block!</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/raid5.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid-5" class=" text-xl mt-2 pb-2 font-sans">RAID-5: 性能分析</h2>
<p class=" font-serif my-1">让每一块盘都有均等的机会存储 parity</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">sequential read/write: 3x (75% 总带宽)</li>
<li class=" ml-8">random read (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">(read 足够大，所有磁盘都可以提供数据) 4x (100% 总带宽)</li>
</ul>
</li>
<li class=" ml-8">random write (tricky)<ul class=" list-disc font-serif">
<li class=" ml-8">$D_0 = V_0 \oplus V_1 \oplus V_2$; 写入任意 $V_0, V_1, V_2$ 都需要更新 $D_0$</li>
<li class=" ml-8">奇偶校验依然严重拖慢了随机写入<ul class=" list-disc font-serif">
<li class=" ml-8">但至少 $n$ 块盘可以获得 $n/4$ 的随机写性能 (能够 scale)</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="raid" class=" text-xl mt-2 pb-2 font-sans">RAID: 讨论</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/emc-vnx5300.jpg" width="400px"></p>
<p class=" font-serif my-1">更快、更可靠、近乎免费的大容量磁盘</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">今天服务器的标准配置</li>
</ul>
<hr>
<p class=" font-serif my-1">RAID 的可靠性</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RAID 系统发生断电？<ul class=" list-disc font-serif">
<li class=" ml-8">例子：RAID-1 镜像盘出现不一致的数据</li>
</ul>
</li>
<li class=" ml-8">检测到磁盘坏？<ul class=" list-disc font-serif">
<li class=" ml-8">自动重组</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">崩溃一致性与崩溃恢复</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fault-model" class=" text-xl mt-2 pb-2 font-sans">另一种 Fault Model</h2>
<p class=" font-serif my-1">磁盘并没有故障</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但操作系统内核可能 crash，系统可能断电</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/cat-crash-consistency.jpg" width="400px"></p>
<p class=" font-serif my-1">文件系统：设备上的树结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">即便只是 append 一个字节，也涉及多处磁盘的修改<ul class=" list-disc font-serif">
<li class=" ml-8">inode, inode-bitmap, block-bitmap</li>
<li class=" ml-8">不同的 block，因此无法同时完成</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="crash-consistency" class=" text-xl mt-2 pb-2 font-sans">崩溃一致性 (Crash Consistency)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><strong>Crash Consistency</strong>: Move the file system from one consistent state (e.g., before the file got appended to) to another atomically (e.g., after the inode, bitmap, and new data block have been written to disk).</p>
</blockquote>
<p class=" font-serif my-1"></p><center>(你们平时编程时假设不会发生的事，操作系统都要给你兜底)</center>
<hr>
<p class=" font-serif my-1">导致崩溃一致性的原因</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RAID: write($V_0$) $\to$ write($A_0$) write($B_0$)</li>
<li class=" ml-8">ext2 (文件追加写入一块): write(inode); write(bitmap); write(data);<ul class=" list-disc font-serif">
<li class=" ml-8">但是存储设备的多次写入没有原子性保证 😂</li>
<li class=" ml-8">甚至为了性能，没有顺序保证 (并发编程：从入门到放弃)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">原子性的丧失：后果</h2>
<p class=" font-serif my-1">考虑追加写入一个数据块，磁盘上数据结构的更新</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fs-layout.png" width="900px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">b: bitmap; i: inode; d: data<ul class=" list-disc font-serif">
<li class=" ml-8">$\{b\}$ - dead block</li>
<li class=" ml-8">$\{i\}$ - dangling pointer</li>
<li class=" ml-8">$\{d\}$ - random writes (没有一致性问题)</li>
<li class=" ml-8">$\{b,i\}$ - incorrect data</li>
<li class=" ml-8">$\{i,d\}$ - dangling pointer</li>
<li class=" ml-8">$\{b,d\}$ - dead block</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="fsck" class=" text-2xl mt-2 font-sans">崩溃恢复: FSCK</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="file-system-checking-fsck" class=" text-xl mt-2 pb-2 font-sans">File System Checking (FSCK)</h2>
<p class=" font-serif my-1">根据磁盘上已有的信息，恢复出 “最可能” 的数据结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">检查 inode 标记的数据块是否 bitmap 都标记为 “1”</li>
<li class=" ml-8">检查 inode 数据是否 “看起来合法”，否则删除</li>
<li class=" ml-8">检查是否存在 dangling link<ul class=" list-disc font-serif">
<li class=" ml-8">没有链接的 inode 被移到 lost+found 目录中</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">刚才的哪些情况可以由 fsck 修复？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">$\{b,i\}$ - incorrect data</li>
<li class=" ml-8">$\{i,d\}$ - dangling pointer</li>
<li class=" ml-8">$\{b,d\}$ - dead block</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fsck" class=" text-xl mt-2 pb-2 font-sans">FSCK 的难题</h2>
<p class=" font-serif my-1">在发生不一致时，“到底什么是对的”？</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fsck-recovery.png" width="750px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">H. S. Gunawi, et al. SQCK: A declarative file system checker. In <em>Proc. of OSDI</em>, 2008.</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fsck" class=" text-xl mt-2 pb-2 font-sans">如果 fsck 的时候发生崩溃 😂</h2>
<p class=" font-serif my-1">fsck 也是程序，fsck 也要访问文件系统</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果 fsck 时发生崩溃，文件系统可能进入彻底无法恢复的状态！<ul class=" list-disc font-serif">
<li class=" ml-8">O. R. Gatla, et al. Towards robust file system checkers. In <em>Proc. of FAST</em>, 2018.</li>
</ul>
</li>
<li class=" ml-8">fsck 更多用于磁盘发生部分损坏时的数据抢救</li>
</ul>
<hr>
<p class=" font-serif my-1">针对 crash，我们需要更可靠的方法我们需要一个更可靠的方法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统不一致的根本原因是<red>存储设备无法提供多次写入的原子性</red></li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="journaling" class=" text-2xl mt-2 font-sans">崩溃恢复: Journaling</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="journaling" class=" text-xl mt-2 pb-2 font-sans">日志 (Journaling)</h2>
<p class=" font-serif my-1">能否在磁盘 API 上实现可靠的 multi-write 原子性？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">readb (读一块), writeb (写一块), sync (等待所有过去的写入落盘)</li>
</ul>
<hr>
<p class=" font-serif my-1">数据结构有两种实现方法</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">存储实际<red>数据结构</red><ul class=" list-disc font-serif">
<li class=" ml-8">文件系统的 “直观” 表示</li>
<li class=" ml-8">crash unsafe</li>
</ul>
</li>
<li class=" ml-8">append-only 记录所有<red>历史操作</red><ul class=" list-disc font-serif">
<li class=" ml-8">“重做” 所有操作得到数据结构的当前状态</li>
<li class=" ml-8">容易实现崩溃一致性</li>
</ul>
</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="atomic-append" class=" text-xl mt-2 pb-2 font-sans">实现 Atomic Append</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fs-journaling.png" width="800px"></p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">定位到 journal 的末尾 (使用 readb)</li>
<li class=" ml-8">在 journal 末尾 append TXBegin，并记录所有操作<ul class=" list-disc font-serif">
<li class=" ml-8">记录文件系统操作 v.s. 记录磁盘块操作</li>
</ul>
</li>
<li class=" ml-8">sync，等待数据落盘</li>
<li class=" ml-8">append TXEnd</li>
<li class=" ml-8">sync，等待 TXEnd 落盘<ul class=" list-disc font-serif">
<li class=" ml-8">sync 返回后持久化完成 (“committed”)</li>
</ul>
</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="crash-consistency" class=" text-xl mt-2 pb-2 font-sans">实现 Crash Consistency</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">小孩子才做选择，我文件系统全都要！</p>
</blockquote>
<p class=" font-serif my-1">主要维护文件系统的结构，但预留一定的 journal 区域</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">journal commit 后，可以将 journal 中的操作直接应用到文件系统上 (checkpoint)<ul class=" list-disc font-serif">
<li class=" ml-8">redo logging (write-ahead logging): journal 记录 “做什么”<ul class=" list-disc font-serif">
<li class=" ml-8">先写 journal，再写文件系统</li>
<li class=" ml-8">崩溃恢复时，重做 journal 中的操作</li>
</ul>
</li>
<li class=" ml-8">undo logging: 记录如何 “撤销” 操作 (即块中的数值)<ul class=" list-disc font-serif">
<li class=" ml-8">先写文件系统，再写 journal</li>
<li class=" ml-8">崩溃恢复时，撤销文件系统中的</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="journaling" class=" text-xl mt-2 pb-2 font-sans">Journaling: 优化</h2>
<p class=" font-serif my-1">现在磁盘需要写入双份的数据</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">批处理 (xv6; jbd)<ul class=" list-disc font-serif">
<li class=" ml-8">多次系统调用的 Tx 合并成一个，减少 log 的大小</li>
<li class=" ml-8">jbd: 定期 write back</li>
</ul>
</li>
<li class=" ml-8">Checksum (ext4)<ul class=" list-disc font-serif">
<li class=" ml-8">不再标记 TxBegin/TxEnd</li>
<li class=" ml-8">直接标记 Tx 的长度和 checksum</li>
</ul>
</li>
<li class=" ml-8">Metadata journaling (ext4 default)<ul class=" list-disc font-serif">
<li class=" ml-8">数据占磁盘写入的绝大部分<ul class=" list-disc font-serif">
<li class=" ml-8">只对 inode 和 bitmap 做 journaling 可以提高性能</li>
</ul>
</li>
<li class=" ml-8">保证文件系统的目录结构是一致的；但数据可能丢失</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="metadata-journaling" class=" text-xl mt-2 pb-2 font-sans">Metadata Journaling</h2>
<p class=" font-serif my-1">从应用视角来看，文件系统的行为可能很怪异</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">各类系统软件 (git, sqlite, gdbm, ...) 不幸中招<ul class=" list-disc font-serif">
<li class=" ml-8">T. S. Pillai. All file systems are not created equal: On the complexity of crafting crash-consistent applications. In <em>Proc. of OSDI</em>, 2014.</li>
<li class=" ml-8">(os-workbench 里的小秘密)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><a href="https://zhuanlan.zhihu.com/p/25188921" class=" text-amber-900">更多的应用程序可能发生 data loss</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">我们的工作: GNU coreutils, gmake, gzip, ... 也有问题<ul class=" list-disc font-serif">
<li class=" ml-8">Y. Jiang, et al. Crash consistency validation made easy. In <em>Proc. of FSE</em>, 2016.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="multi-write" class=" text-xl mt-2 pb-2 font-sans">为应用程序提供 Multi-Write 的一致性？</h2>
<p class=" font-serif my-1">TxOS: 提供三个新的系统调用</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">xbegin, xend, xabort</li>
<li class=" ml-8">实现多个系统调用的原子性<ul class=" list-disc font-serif">
<li class=" ml-8">应用场景：数据更新、软件更新、check-use……</li>
</ul>
</li>
<li class=" ml-8">D. E. Porter, et al. Operating systems transactions. In <em>Proc. of SOSP</em>, 2009.</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">持久数据的可靠性<ul class=" list-disc font-serif">
<li class=" ml-8">fail-stop: RAID</li>
<li class=" ml-8">随机损坏：fsck</li>
<li class=" ml-8">崩溃：journaling</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">Takeaway messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">把磁盘理解成 “数据结构”</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>