<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>[C9] 动态连接与加载</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="c9" class=" text-2xl mt-2 font-sans">[C9] 动态连接与加载</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">ELF 可执行文件</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/doge-double-click.jpg" width="1000px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">自己动手实现动态加载</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">理解动态加载的动机</li>
<li class=" ml-8">“lazy” 的延迟符号绑定</li>
</ul>
<hr>
<p class=" font-serif my-1">动态链接一直都没能讲得很简单</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">今天再试一次！</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">动态链接与加载</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">为什么需要动态链接/加载？</h2>
<p class=" font-serif my-1">例子：libc.so</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">300K 条指令，2 MiB 大小<ul class=" list-disc font-serif">
<li class=" ml-8">每个程序如果都静态链接，浪费的空间很大</li>
<li class=" ml-8">最好是整个系统里只有一个 libc 的副本<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统里只有一个副本 (libc.so)</li>
<li class=" ml-8">内存里只有一个副本</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">问题：真的整个操作系统里只有一个 libc 的副本吗？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">方法 1: 看 Linux Kernel 的 trace</li>
<li class=" ml-8">方法 2: 调试 Linux Kernel, 查看内存映射 (QEMU monitor)</li>
<li class=" ml-8">方法 3: 简单做个实验</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">让我们加载很多个很大的程序吧！</h2>
<p class=" font-serif my-1"><a href="../../../pages/OS/2021/demos/huge.c" class=" text-amber-900">huge.c</a></p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1000</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="p">;</span><span class="w"> </span>./a.out<span class="w"> </span><span class="p">&;</span><span class="w"> </span><span class="k">done</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">通过 inline assembly 创建一个 “巨大” 的可执行文件<ul class=" list-disc font-serif">
<li class=" ml-8">128M 个 nop</li>
</ul>
</li>
<li class=" ml-8">然后再创建 1000 份<ul class=" list-disc font-serif">
<li class=" ml-8">如果每个进程都有独立的代码副本，总共需要 128G 内存</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">操作系统内核：不难实现</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">所有以只读方式映射同一个文件的部分时，都指向同一个副本</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">实现动态链接与加载</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">需求分析</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">printf</span><span class="p">(</span><span class="s">"Hello, World</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">链接时</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">不知道 <code>printf</code> 符号的地址<ul class=" list-disc font-serif">
<li class=" ml-8">无法用 rip 相对寻址直接调用</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">加载时</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可以正确跳转到 <code>printf</code> 代码执行</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">第一步：库函数和位置无关代码</h2>
<p class=" font-serif my-1">库内的代码和数据：只需生成位置无关代码即可</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nl">liba_foo:</span>
<span class="w">  </span><span class="nf">movl</span><span class="w"> </span><span class="no">$1</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">  </span><span class="nf">ret</span>

<span class="nl">liba_bar:</span>
<span class="w">  </span><span class="nf">incl</span><span class="w"> </span><span class="no">x</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>
<span class="w">  </span><span class="nf">movl</span><span class="w"> </span><span class="no">x</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">  </span><span class="nf">ret</span>

<span class="nl">x:</span>
<span class="w">  </span><span class="na">.int</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">访问库函数：动态链接时定位</h2>
<p class=" font-serif my-1">如果另一个库需要调用 foo/bar？</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nl">libb_baz:</span>
<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="no">liba_bar</span><span class="w"> </span><span class="c1">// 编译时: 00 00 00 00</span>
<span class="w">  </span><span class="nf">ret</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">两个问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">浪费了内存<ul class=" list-disc font-serif">
<li class=" ml-8">代码不再能共享 (操作系统的精妙设计)<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/huge.c" class=" text-amber-900">huge.c</a></li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">浪费了时间<ul class=" list-disc font-serif">
<li class=" ml-8">没有调用的代码也会被重定位</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">为每一个程序创建一张 “表”</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">把需要地址解析的部分集中在表里。</p>
</blockquote>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="no">liba_bar</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="na">.section</span><span class="w"> </span><span class="no">.data</span>
<span class="nl">liba_bar_dyn:</span>
<span class="w">  </span><span class="na">.quad</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">// 加载时重填</span>

<span class="na">.section</span><span class="w"> </span><span class="no">.text</span>
<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="p">*</span><span class="no">liba_bar_dyn</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">如果要给这张表一个名字，就叫它 GOT (Global Offset Table) 吧</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="loader" class=" text-xl mt-2 pb-2 font-sans">自己动手实现动态库和 Loader</h2>
<p class=" font-serif my-1"><a href="../../../pages/OS/2021/demos/mini-loader.tar.gzip" class=" text-amber-900">mini-loader.tar.gz</a></p>
<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">symbol</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">REC_SZ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)];</span>
<span class="p">};</span>
</code></pre></div>

<p class=" font-serif my-1">动态库是由 “symbol” 列表、代码 + 数据组成</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">symbols 位于动态库的头部，以空名字结束</li>
<li class=" ml-8">分为两种符号<ul class=" list-disc font-serif">
<li class=" ml-8">IMPORT (需要从其他库导入)</li>
<li class=" ml-8">EXPORT (导出其他库可见)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="plt" class=" text-xl mt-2 pb-2 font-sans">PLT: 无论何种符号，都仅使用普通的跳转</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">hello</span><span class="p">();</span>
</code></pre></div>

<p class=" font-serif my-1">编译时无法决定是以下哪种情况</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nf">call</span><span class="w"> </span><span class="no">hello</span>
<span class="nf">call</span><span class="w"> </span><span class="p">*</span><span class="no">hello_dyn</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">解决办法</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nl">liba_bar@plt:</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="p">*</span><span class="no">liba_bar_dyn</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span><span class="w"> </span><span class="c1">// 这里可以实现 “延迟绑定”</span>
<span class="nl">puts_bar@plt:</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="p">*</span><span class="no">puts_dyn</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>

<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="no">liba_bar@plt</span>
<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="no">puts@plt</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="elf" class=" text-xl mt-2 pb-2 font-sans">再来看看动态链接的 ELF</h2>
<p class=" font-serif my-1">Program header 中有 <code>PT_INTERP</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">elf(5) <code>PT_INTERP</code>: The array element specifies the location and size of a null-terminated pathname to invoke as an interpreter.  This segment type is meaningful only for executable files (though it may occur for shared objects).  However it may not occur more than once in a file.  If it is present, it must precede any loadable segment entry.<ul class=" list-disc font-serif">
<li class=" ml-8">system (UNIX) 的世界各种不完美</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="elf" class=" text-xl mt-2 pb-2 font-sans">ELF 的加载</h2>
<p class=" font-serif my-1">ldd</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">ldd 比 readelf 做的事情稍稍多一些<ul class=" list-disc font-serif">
<li class=" ml-8">它会试着 “加载”</li>
<li class=" ml-8">RTFM</li>
</ul>
</li>
<li class=" ml-8">ld.so 会比我们的 “简易” 加载器完成更多的操作<ul class=" list-disc font-serif">
<li class=" ml-8"><code>LD_PRELOAD</code> (允许我们预先加载 “覆盖” 一些符号)</li>
<li class=" ml-8">递归解析依赖关系</li>
<li class=" ml-8">……</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">自己实现动态加载</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RTFM; RTFSC</li>
<li class=" ml-8">正确理解需求，你也能给出和工业界/开源社区一样的方案</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>