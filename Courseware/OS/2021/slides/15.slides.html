<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>文件系统实现</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">文件系统实现</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">应用眼中的文件系统</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一组 API<ul class=" list-disc font-serif">
<li class=" ml-8">mount - 文件系统管理gg</li>
<li class=" ml-8">mkdir, rmkdir, link, symlink, unlink... - 目录管理</li>
<li class=" ml-8">open, mmap, read, write, lseek... - 文件管理</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">理解两个文件系统的设计与实现</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">FAT</li>
<li class=" ml-8">UNIX 文件系统/ext2</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">文件系统实现：需求分析</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="linux" class=" text-xl mt-2 pb-2 font-sans">例子：Linux 文件系统初始化</h2>
<p class=" font-serif my-1">最小的 <a href="https://box.nju.edu.cn/f/3f67e092e1ba441187d9/?dl=1" class=" text-amber-900">Linux 系统镜像</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">构造 Linux 启动时的 “根文件系统”<ul class=" list-disc font-serif">
<li class=" ml-8">随操作系统启动加载</li>
<li class=" ml-8"><red>你可以像调试你的 oslab 一样调试 Linux!</red></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>initramfs
├── busybox
└── init
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8"><code>/busybox</code> 是个二进制文件<ul class=" list-disc font-serif">
<li class=" ml-8">ELF 64-bit LSB executable, statically linked</li>
</ul>
</li>
<li class=" ml-8"><code>/init</code> 只有 3 行<ul class=" list-disc font-serif">
<li class=" ml-8">实际只做一件事: 执行 busybox<ul class=" list-disc font-serif">
<li class=" ml-8"><code>exec /busybox sh</code></li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="linux" class=" text-xl mt-2 pb-2 font-sans">Linux 启动第一个应用程序时的状态</h2>
<p class=" font-serif my-1">“几乎什么也没有”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">但所有的一切都可以被<red>系统调用</red> “创建” 出来<ul class=" list-disc font-serif">
<li class=" ml-8">mount - 文件系统管理</li>
<li class=" ml-8">mkdir, rmkdir, link, symlink, unlink... - 目录管理</li>
<li class=" ml-8">open, mmap, read, write, lseek... - 文件管理</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>/busybox mkdir -p /bin && /busybox mv /busybox /bin/
c1="arch ash base64 cat chattr chgrp chmod chown conspy cp cpio cttyhack date dd df dmesg dnsdomainname dumpkmap echo ed egrep false fatattr fdflush fgrep fsync getopt grep gunzip gzip hostname hush ionice iostat ipcalc kbd_mode kill link linux32 linux64 ln login ls lsattr lzop makemime mkdir mknod mktemp more mount mountpoint mpstat mt mv netstat nice nuke pidof ping ping6 pipe_progress printenv ps pwd reformime resume rev rm rmdir rpm run-parts scriptreplay sed setarch setpriv setserial sh sleep stat stty su sync tar touch true umount uname usleep vi watch zcat"
c2="[ [[ awk basename bc beep blkdiscard bunzip2 bzcat bzip2 cal chpst chrt chvt cksum clear cmp comm crontab cryptpw cut dc deallocvt diff dirname dos2unix dpkg dpkg-deb du dumpleases eject env envdir envuidgid expand expr factor fallocate fgconsole find flock fold free ftpget ftpput fuser groups hd head hexdump hexedit hostid id install ipcrm ipcs killall last less logger logname lpq lpr lsof lspci lsscsi lsusb lzcat lzma man md5sum mesg microcom mkfifo mkpasswd nc nl nmeter nohup nproc nsenter nslookup od openvt passwd paste patch pgrep pkill pmap printf pscan"
c3="pstree pwdx readlink realpath renice reset resize rpm2cpio runsv runsvdir rx script seq setfattr setkeycodes setsid setuidgid sha1sum sha256sum sha3sum sha512sum showkey shred shuf smemcap softlimit sort split ssl_client strings sum sv svc svok tac tail taskset tcpsvd tee telnet test tftp time timeout top tr traceroute traceroute6 truncate ts tty ttysize udhcpc6 udpsvd unexpand uniq unix2dos unlink unlzma unshare unxz unzip uptime users uudecode uuencode vlock volname w wall wc wget which who whoami whois xargs xxd xz xzcat yes"
for cmd in $c1 $c2 $c3; do
  /bin/busybox ln -s /bin/busybox /bin/$cmd
done
mkdir -p /proc && mount -t proc  none /proc
mkdir -p /sys  && mount -t sysfs none /sys
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">文件系统实现</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">在一个 I/O 设备 (驱动) 上实现 “目录树” 的数据结构。</p>
</blockquote>
<p class=" font-serif my-1"><a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html" class=" text-amber-900">VFS</a>: 管理所有文件系统共享的部分</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">对象 (inode) 分配/回收、路径/符号链接解析、挂载</li>
<li class=" ml-8">定义了每个具体文件系统需要实现的接口</li>
</ul>
<hr>
<p class=" font-serif my-1">块设备驱动</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>read_block</code>, <code>write_block</code></li>
</ul>
<hr>
<p class=" font-serif my-1">目录/文件 API</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>mkdir</code>, <code>rmdir</code>, <code>link</code>, <code>unlink</code></li>
<li class=" ml-8"><code>open</code>, <code>read</code>, <code>write</code>, <code>stat</code></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">回到数据结构课……</h2>
<p class=" font-serif my-1">文件系统实现</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在 <code>read_block</code>, <code>write_block</code> 上实现一个 “目录树” 的抽象数据类型</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/dir-tree.png" width="500px"></p></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="file-allocation-table-fat" class=" text-2xl mt-2 font-sans">File Allocation Table (FAT)</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1980" class=" text-xl mt-2 pb-2 font-sans">让时间回到 1980 年</h2>
<p class=" font-serif my-1">5.25" 软盘：单面 180 KiB</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">360 个 512B 扇区 (sectors)</li>
<li class=" ml-8">在这样的设备上持久化数据，应该选用怎样的数据结构？</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/floppy-drives.jpg" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fat" class=" text-xl mt-2 pb-2 font-sans">FAT 文件系统：分析</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">抛开 workload 谈优化，就是耍流氓。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">需求</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">树状的目录结构</li>
<li class=" ml-8">系统中以小文件为主 (几个 block 以内)</li>
<li class=" ml-8">无需支持链接</li>
</ul>
<hr>
<p class=" font-serif my-1">实现方式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">链表<ul class=" list-disc font-serif">
<li class=" ml-8">任何复杂的高级数据结构都显得浪费</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">用链表存储数据：两种设计</h2>
<ol class=" list-decimal font-serif">
<li class=" ml-8">在每个数据块后放置指针<ul class=" list-disc font-serif">
<li class=" ml-8"><green>优点</green>：实现简单、无须单独开辟存储空间</li>
<li class=" ml-8"><red>缺点</red>：数据的大小不是 $2^k$; 单纯的 lseek 需要读整块数据</li>
</ul>
</li>
<li class=" ml-8">将指针集中存放在文件系统的某个区域<ul class=" list-disc font-serif">
<li class=" ml-8"><green>优点</green>：局部性好；lseek 更快</li>
<li class=" ml-8"><red>缺点</red>：集中存放的数据损坏将导致数据丢失 (怎么办？)</li>
</ul>
</li>
</ol>
<hr>
<p class=" font-serif my-1">哪种方式的缺陷是致命、难以解决的？</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">集中保存所有指针</h2>
<p class=" font-serif my-1">集中存储的指针容易损坏？存 $n$ 份就行！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">FAT-12/16/32 (FAT entry，即 “next 指针” 的大小)</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fat32_layout.gif" width="700px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="file-allocation-table" class=" text-xl mt-2 pb-2 font-sans">“File Allocation Table” 文件系统</h2>
<p class=" font-serif my-1"><a href="http://localhost:5001/static/wiki/OS/MSFAT-spec.pdf" class=" text-amber-900">RTFM</a> 得到必要的细节</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">逻辑上，文件/目录都是字节序列 (虚拟化的磁盘)<ul class=" list-disc font-serif">
<li class=" ml-8">以 cluster (簇) 为单位链接 (FAT 集中存储链表的 next)</li>
</ul>
</li>
<li class=" ml-8">目录也是文件<ul class=" list-disc font-serif">
<li class=" ml-8">一个 (filename, size, firstblock) 的列表，顺序存储</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><code>mmap</code> 到内存，就可以直接访问</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">fat_volume</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">fat_header</span><span class="w"> </span><span class="n">header</span><span class="p">;</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">fat</span><span class="p">[</span><span class="n">FAT_NUM</span><span class="p">];</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">clusters</span><span class="p">[</span><span class="n">CLUSTER_SZ</span><span class="p">][];</span>
<span class="p">};</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fat" class=" text-xl mt-2 pb-2 font-sans">FAT: 链接存储的文件</h2>
<p class=" font-serif my-1">“FAT” 的 “next” 数组</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>0</code>: free; <code>2...MAX</code>: allocated; </li>
<li class=" ml-8"><code>ffffff7</code>: bad cluster; <code>ffffff8-ffffffe</code>, <code>-1</code>: end-of-file</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/FAT-number.png" width="1000px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">目录树实现：目录文件</h2>
<p class=" font-serif my-1">以普通文件的方式存储 “目录” 这个数据结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">FAT: 目录 = 32-byte 定长目录项的集合</li>
<li class=" ml-8">操作系统在解析时把标记为目录的目录项 “当做” 目录即可<ul class=" list-disc font-serif">
<li class=" ml-8">可以用连续的若干个目录项存储 “长文件名”</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/FAT-dent.png" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="fat" class=" text-xl mt-2 pb-2 font-sans">FAT: 性能与可靠性</h2>
<p class=" font-serif my-1">性能</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><green>＋</green> 小文件简直太合适了</li>
<li class=" ml-8"><red>－</red> 但大文件的随机访问就不行了<ul class=" list-disc font-serif">
<li class=" ml-8">4 GB 的文件跳到末尾 (4 KB cluster) 有 $2^{20}$ 次链表 next 操作</li>
<li class=" ml-8">缓存能部分解决这个问题</li>
</ul>
</li>
<li class=" ml-8">在 FAT 时代，磁盘连续访问性能更佳<ul class=" list-disc font-serif">
<li class=" ml-8">使用时间久的磁盘会产生碎片 (fragmentation)<ul class=" list-disc font-serif">
<li class=" ml-8">malloc 也会产生碎片，不过对性能影响不太大</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">可靠性</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">维护若干个 FAT 的副本防止元数据损坏<ul class=" list-disc font-serif">
<li class=" ml-8">额外的同步开销</li>
</ul>
</li>
<li class=" ml-8">损坏的 cluster 在 FAT 中标记</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="ext2unix" class=" text-2xl mt-2 font-sans">ext2/UNIX 文件系统</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">更好的文件系统：需要做到什么？</h2>
<p class=" font-serif my-1">不能 “尽善尽美”，但可以在 “实际 workload” 下尽可能好</p>
<table>
<thead>
<tr>
<th><strong>Summary</strong></th>
<th><strong>Findings</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Most files are small</td>
<td>Roughly 2K is the most common size</td>
</tr>
<tr>
<td>Average file size is growing</td>
<td>Almost 200K is the average</td>
</tr>
<tr>
<td>Most bytes are stored in large files</td>
<td>A few big files use most of the space</td>
</tr>
<tr>
<td>File systems contains lots of files</td>
<td>Almost 100K on average</td>
</tr>
<tr>
<td>File systems are roughly half full</td>
<td>Even as disks grow, file systems remain ~50% full</td>
</tr>
<tr>
<td>Directories are typically small</td>
<td>Many have few entries; most have 20 or fewer</td>
</tr>
</tbody>
</table></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ext2unix" class=" text-xl mt-2 pb-2 font-sans">ext2/UNIX 文件系统</h2>
<p class=" font-serif my-1">按对象方式集中存储文件/目录元数据</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">增强局部性 (更易于缓存)</li>
<li class=" ml-8">支持链接</li>
</ul>
<hr>
<p class=" font-serif my-1">为大小文件区分 fast/slow path</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">小的时候应该用数组<ul class=" list-disc font-serif">
<li class=" ml-8">连链表遍历都省了</li>
</ul>
</li>
<li class=" ml-8">大的时候应该用树 (B-Tree; Radix-Tree; ...)<ul class=" list-disc font-serif">
<li class=" ml-8">快速的随机访问</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ext2" class=" text-xl mt-2 pb-2 font-sans">ext2: 磁盘镜像格式</h2>
<p class=" font-serif my-1">对磁盘进行分组</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fs-ext2.png" width="600px"></p>
<p class=" font-serif my-1">“superblock”：文件系统元数据</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件 (inode) 数量</li>
<li class=" ml-8">block group 信息<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/ext2.h" class=" text-amber-900">ext2.h</a> 里有你需要知道的一切</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ext2-inode" class=" text-xl mt-2 pb-2 font-sans">ext2 inode</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ext2-inode.gif" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ext2" class=" text-xl mt-2 pb-2 font-sans">ext2 目录文件</h2>
<p class=" font-serif my-1">与 FAT 本质相同：在文件上建立目录的数据结构</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">注意到 inode 统一存储<ul class=" list-disc font-serif">
<li class=" ml-8">目录文件中存储文件名到 inode 编号的 key-value mapping</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/ext2-dirent.jpg" width="800px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ext2" class=" text-xl mt-2 pb-2 font-sans">ext2: 性能与可靠性</h2>
<p class=" font-serif my-1">大文件的随机读写性能提升明显 ($O(1)$)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">支持链接 (一定程度减少空间浪费)</li>
<li class=" ml-8">inode 在磁盘上连续存储，便于缓存/预取</li>
<li class=" ml-8">依然有碎片的问题</li>
</ul>
<hr>
<p class=" font-serif my-1">但可靠性依然是个很大的问题</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">存储 inode 的数据块损坏是很严重的</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">寻找更高效的数据结构？</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/btrfs-cow.png" width="500px"></p>
<p class=" font-serif my-1">btrfs: <em>Everything is a B-tree</em></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">The BTRFS B-tree... knows only about “keys, items, and block headers.”</li>
<li class=" ml-8">数据结构由多个 copy-on-write 的 tree 组成<ul class=" list-disc font-serif">
<li class=" ml-8">subvolume, extent allocation tree, checksum tree, chunk and device tree, reloc tree, ...</li>
<li class=" ml-8">O. Rodeth, et al. BTRFS: The Linux B-tree filesystem. <em>ACM Transactions on Storage</em> (ToS), 9(3), 2013.</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">理解两个文件系统的设计与实现<ul class=" list-disc font-serif">
<li class=" ml-8">FAT: 链表 + 元数据存储在目录项</li>
<li class=" ml-8">UNIX 文件系统/ext2: bitmap + inode + 索引</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">Takeaway messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统是磁盘 (驱动) 上的数据结构</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>