<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>[C8] 可执行文件</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="c8" class=" text-2xl mt-2 font-sans">[C8] 可执行文件</h1>
<p class=" font-serif my-1"><include src="Slides_Author"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">程序 = 状态机</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">程序执行 (进程) = 状态机上的路径</li>
<li class=" ml-8">状态机管理<ul class=" list-disc font-serif">
<li class=" ml-8">fork - 复制</li>
<li class=" ml-8">execve - 重置</li>
<li class=" ml-8">exit - 终止</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">状态机 = 可执行文件</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一直以来 “最神秘” 的一种文件<ul class=" list-disc font-serif">
<li class=" ml-8">双击即可打开</li>
<li class=" ml-8">为什么？？</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">理解静态链接的可执行文件</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可执行文件的加载</li>
<li class=" ml-8">xv6 加载器</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">可执行文件的加载</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="ne-elf" class=" text-xl mt-2 pb-2 font-sans">小知识：可执行文件 $\ne$ ELF</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="ch">#!/bin/bash -x</span>
<span class="nb">echo</span><span class="w"> </span>Hello
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="ch">#!/usr/bin/env python3</span>
print<span class="o">(</span><span class="s1">'Hello'</span><span class="o">)</span>
</code></pre></div>

<hr>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="ch">#!./a.out</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">为什么是 <code>/usr/bin/env</code>？<ul class=" list-disc font-serif">
<li class=" ml-8">因为 <code>#!</code> 需要绝对路径 (背后是 execve)</li>
</ul>
</li>
<li class=" ml-8">Shebang 究竟发生了什么？<ul class=" list-disc font-serif">
<li class=" ml-8">不妨 strace 一下！</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="elf" class=" text-xl mt-2 pb-2 font-sans">虚假的进程 (ELF) 初始化</h2>
<p class=" font-serif my-1"><code>execve(path, argv, envp)</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">“重置一个状态机”，为它传入参数 argv 和 envp<ul class=" list-disc font-serif">
<li class=" ml-8">概念上好理解……但什么叫<red>传入</red>？</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/doge-double-click.jpg" width="1000px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="elf" class=" text-xl mt-2 pb-2 font-sans">真正的进程 (ELF) 初始化</h2>
<p class=" font-serif my-1">RTFM</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/manuals/sysv-abi.pdf" class=" text-amber-900">System V ABI (x86-64)</a><ul class=" list-disc font-serif">
<li class=" ml-8">Section 3.4: Process Initialization<ul class=" list-disc font-serif">
<li class=" ml-8">之前用 gdb 调试过 “初始状态”<ul class=" list-disc font-serif">
<li class=" ml-8">看到了寄存器的初始值</li>
</ul>
</li>
<li class=" ml-8">手册完整规定了 execve 后的进程状态<ul class=" list-disc font-serif">
<li class=" ml-8">libc 会使用它</li>
<li class=" ml-8">根据 ABI，你可以开发自己的 libc!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">Gitlab <a href="https://gitlab.com/x86-psABIs/x86-64-ABI" class=" text-amber-900">repo</a></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="execve-elf" class=" text-xl mt-2 pb-2 font-sans">挑战：不使用 execve 加载 ELF</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">理论上把可执行文件 (ELF) 指定的数据搬运到内存，就可以实现二进制文件的加载。</p>
</blockquote>
<p class=" font-serif my-1">试一试？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/loader.zip" class=" text-amber-900">loader.zip</a>: 加载静态链接的 ELF (glibc)</li>
</ul>
<hr>
<p class=" font-serif my-1">execve 本质上是 “多余” 的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">可以用 mmap/munmap + 一小段 trampoline code 实现</li>
<li class=" ml-8">这个系统调用可以被库函数 (和其他系统调用) “模拟”</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1" class=" text-xl mt-2 pb-2 font-sans">模拟系统调用 (1): 互相模拟、互相伤害</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">既然完全可以 “自己加载” 可执行文件。我们也可以在一个操作系统里实现另一个操作系统的 API 啊</p>
<p class=" font-serif my-1"><red>指令面前系统平等 (Linux, Windows, ...)</red></p>
</blockquote>
<hr>
<p class=" font-serif my-1">WSL (Windows Subsystem for Linux)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Windows 执行 ELF64; 在 Windows 中实现 Linux 系统调用<ul class=" list-disc font-serif">
<li class=" ml-8">南大系统实验全家桶完全没问题</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><a href="https://www.winehq.org" class=" text-amber-900">Wine</a> (POSIX Subsystem for Windows 😂)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">支持 Windows PE (Portable Executable) 格式</li>
<li class=" ml-8">实现 Windows API (<a href="https://wiki.winehq.org/Wine_Developer%27s_Guide/Architecture_Overview" class=" text-amber-900">Overview</a>)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2" class=" text-xl mt-2 pb-2 font-sans">模拟系统调用 (2): 把系统调用挪到用户空间</h2>
<p class=" font-serif my-1">“微内核” (Microkernel)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">操作系统只提供非常有限的 API 和权限管理<ul class=" list-disc font-serif">
<li class=" ml-8">进程/线程创建和通信</li>
<li class=" ml-8">内存映射</li>
<li class=" ml-8">设备寄存器</li>
</ul>
</li>
<li class=" ml-8">其他都实现在用户程序<ul class=" list-disc font-serif">
<li class=" ml-8">例如内核里没有文件系统</li>
<li class=" ml-8">想打开文件？发消息给服务器吧</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">“外核” (<a href="https://pdos.csail.mit.edu/6.828/2008/readings/engler95exokernel.pdf" class=" text-amber-900">Exokernel</a>)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">操作系统 = 库函数</li>
<li class=" ml-8">一个硬件上可以跑多个 libOS</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">灌鸡汤：《操作系统》这门课究竟学什么？</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">相比知识点本身，<red>获得知识的方法</red>和<red>对系统的掌控力</red>更重要。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">状态机视角</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">程序 = 状态机</li>
<li class=" ml-8">操作系统 = 状态机的虚拟化</li>
</ul>
<hr>
<p class=" font-serif my-1">机器永远是对的</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">只要按照 spec 实现，就绝对能 work<ul class=" list-disc font-serif">
<li class=" ml-8">地址空间里的每一个地址都有解释 (vdso, vvar, ...)</li>
<li class=" ml-8">CPU: 指令实现对了，仙剑就能跑、操作系统就能跑</li>
<li class=" ml-8">System-V ABI: 实现对了，不用 execve 也可以加载可执行文件</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="xv6" class=" text-2xl mt-2 font-sans">xv6 进程的加载和执行</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">再次强调</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">听课以为自己懂了，不自己调试是不行的。</p>
</blockquote>
<hr>
<p class=" font-serif my-1">肉眼 “看懂” 代码和自己写出代码之间有巨大的鸿沟</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">做实验是不会骗人的……</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="initcode" class=" text-xl mt-2 pb-2 font-sans">initcode 的加载和执行</h2>
<p class=" font-serif my-1">回顾上次代码课的调试 (和阅读的源代码)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">用户进程映射在 0 开始的内存位置<ul class=" list-disc font-serif">
<li class=" ml-8"><code>memlayout.h</code></li>
<li class=" ml-8">但断点只能打在 <code>0x4</code>，否则 gdb 会 crash</li>
</ul>
</li>
</ul>
<hr>
<ul class=" list-disc font-serif">
<li class=" ml-8">系统调用的入口在 <code>TRAMPOLINE</code><ul class=" list-disc font-serif">
<li class=" ml-8"><code>#define TRAMPOLINE (MAXVA - PGSIZE)</code></li>
<li class=" ml-8"><code>0x3ffffff000</code><ul class=" list-disc font-serif">
<li class=" ml-8">马甲符号: uservec, trampline</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="exec" class=" text-xl mt-2 pb-2 font-sans">exec: 开始执行</h2>
<p class=" font-serif my-1">神奇的 “trampoline” (跳板)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">从一处跳到另一处的代码</li>
<li class=" ml-8">很多有趣的用途 (C 的 nested function; 插桩; ...)</li>
</ul>
<hr>
<p class=" font-serif my-1">xv6 trap trampoline</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">保存寄存器<ul class=" list-disc font-serif">
<li class=" ml-8"><code>swap(a0, sscratch)</code></li>
<li class=" ml-8">然后执行保存 (类似上学期实现的 setjmp)</li>
</ul>
</li>
<li class=" ml-8">恢复寄存器<ul class=" list-disc font-serif">
<li class=" ml-8">完整的逆过程</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="exec" class=" text-xl mt-2 pb-2 font-sans">exec: 系统调用的执行</h2>
<p class=" font-serif my-1">来到 <code>sys_exec</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">复制系统调用参数<ul class=" list-disc font-serif">
<li class=" ml-8">涉及到用户/内核之间的数据复制</li>
</ul>
</li>
<li class=" ml-8">创建新的地址空间并加载<ul class=" list-disc font-serif">
<li class=" ml-8">同 mmap</li>
</ul>
</li>
<li class=" ml-8">创建堆栈上的参数<ul class=" list-disc font-serif">
<li class=" ml-8">回顾 ABI 中的要求</li>
</ul>
</li>
<li class=" ml-8">重置 <code>p->trapframe</code> 中的寄存器</li>
<li class=" ml-8">释放内存</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">理解静态链接的可执行文件<ul class=" list-disc font-serif">
<li class=" ml-8">可执行文件的加载</li>
<li class=" ml-8">xv6 加载器</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">RTFM; RTFSC</li>
<li class=" ml-8"><red>纸面上的理解都是片面的</red></li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>

</html>