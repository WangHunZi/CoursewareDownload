<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>并发控制：互斥 (1)</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="1" class=" text-2xl mt-2 font-sans">并发控制：互斥 (1)</h1>
<p class=" font-serif my-1"><include src="Slides_Author/index.html"><div><div class="py-16">
<p class=" font-serif my-1"><a href="http://ics.nju.edu.cn/~jyy" class=" text-amber-900">蒋炎岩</a></p>
</div>
<div class="row">
<div class="author-affiliation">
    <a href="http://www.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">　　南京大学　　</p>
    <img class="inline-img h-24" src="../../../static/img/nju-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/" class=" text-amber-900"><p class=" font-serif my-1">计算机科学与技术系</p>
    <img class="inline-img h-24" src="../../../static/img/njucs-logo.jpg" style="display: inline-block;"></a>
  </div>
<div class="author-affiliation">
    <a href="https://cs.nju.edu.cn/ics/" class=" text-amber-900"><p class=" font-serif my-1">计算机软件研究所</p>
    <img class="inline-img h-24" src="../../../static/img/ics-logo.png" style="display: inline-block;"></a>
  </div>
</div></div></include></p></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">背景</h2>
<p class=" font-serif my-1">并发编程：从入门到放弃</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">入门：<code>threads.h</code></li>
<li class=" ml-8">放弃：原子性、顺序、可见性的丧失</li>
</ul>
<hr>
<p class=" font-serif my-1">阅读理解并发程序</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Prove by brute-force</li>
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/model-checker.py" class=" text-amber-900">年轻人的第一个 model checker</a></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">本次课内容与目标</h2>
<p class=" font-serif my-1">理解和使用互斥锁 API</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">lock(), unlock()</li>
</ul>
<hr>
<p class=" font-serif my-1">在多处理器系统上实现互斥</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">硬件提供的同步机制</li>
<li class=" ml-8">自旋锁 (spin lock)</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">共享内存上的互斥</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">互斥：直观理解</h2>
<p class=" font-serif my-1">理解并发的另一个工具：把线程想象成人、把共享内存想象成物理世界</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">物理世界是天生并发的，在小范围宏观意义上，所有部分的空间 “同时” 沿着时间方向前进)<ul class=" list-disc font-serif">
<li class=" ml-8">物理世界 = 共享内存</li>
<li class=" ml-8">我们 (根据想法执行物理世界动作) = 线程 (根据程序局部状态访问共享状态)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">互斥：直观理解</h2>
<p class=" font-serif my-1">线程 (我) 想不被别人打断地做一件事</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">一旦某个人已经开始，其他人就必须等待</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/wc.jpg" width="700px"></p>
<p class=" font-serif my-1"></p><center>“躲进厕所锁上门，我就把全世界人锁在了厕所外面”</center></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">共享内存上的互斥：问题定义</h2>
<p class=" font-serif my-1">互斥 (mutual exclusion)，“互相排斥”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">实现 <code>lock_t</code> 数据结构和 <code>lock/unlock</code> API:</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span><span class="w"> </span><span class="n">lock_t</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">);</span><span class="w">   </span><span class="c1">// 试图获得锁的独占访问，成功获得后返回</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">(</span><span class="n">lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lk</span><span class="p">);</span><span class="w"> </span><span class="c1">// 释放锁的独占访问</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">一把 “排他性” 的锁——对于锁对象 <code>lk</code></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">如果某个线程处于 <code>lock</code> 和 <code>unlock</code> 之间，则其他线程的 <code>lock</code> 不能返回</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">实现互斥为什么困难？</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">共享内存上的互斥</h2>
<p class=" font-serif my-1">失败的尝试</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/mutex-buggy.yaml" class=" text-amber-900">mutex-buggy.yaml</a></li>
</ul>
<hr>
<p class=" font-serif my-1">成功的尝试</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/mutex-peterson.yaml" class=" text-amber-900">mutex-peterson.yaml</a></li>
</ul>
<hr>
<p class=" font-serif my-1">困难之处在于：<red>不能同时读/写共享内存</red></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">load (环顾四周) 的时候不能写，只能 “干看”</li>
<li class=" ml-8">store (改变物理世界状态) 的时候不能读，只能 “闭着眼睛动手”</li>
<li class=" ml-8">所以才有 Peterson 等非常 “巧妙” 的算法<ul class=" list-disc font-serif">
<li class=" ml-8">这是《操作系统》课</li>
<li class=" ml-8">风格：<del>简单、粗暴 (稳定)、有效</del></li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="peterson" class=" text-xl mt-2 pb-2 font-sans">Peterson 算法的另一个问题</h2>
<p class=" font-serif my-1">并发编程：从入门到放弃</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">顺序、原子性、可见性的丢失</li>
</ul>
<hr>
<p class=" font-serif my-1">即便是一条指令，也不能保证原子性 <a href="../../../pages/OS/2021/demos/sum.c" class=" text-amber-900">sum.c</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">运行结果<ul class=" list-disc font-serif">
<li class=" ml-8"><code>sum = 12615418</code><ul class=" list-disc font-serif">
<li class=" ml-8">假设指令执行是原子不可分割的，那么 <code>sum</code> 应该完全正确才对</li>
</ul>
</li>
<li class=" ml-8"><code>sum = 9894505</code><ul class=" list-disc font-serif">
<li class=" ml-8">一条 <code>add</code> 可以看成 <code>t = load(x); t++; store(x, t)</code></li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">实现互斥：软件不够，硬件来凑</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">如果可以在一条指令内同时完成读写？</h2>
<p class=" font-serif my-1">假设硬件能为我们提供一条 “瞬间完成” 的 load-exec-store 的指令</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">行为如 xchg</li>
<li class=" ml-8">但 “立即完成”，不会被打断</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">xchg</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">  </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newval</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="x86-lock" class=" text-xl mt-2 pb-2 font-sans">x86 原子操作：<code>LOCK</code> 指令前缀</h2>
<p class=" font-serif my-1">例子：<a href="../../../pages/OS/2021/demos/sum-atomic.c" class=" text-amber-900"><code>sum-atomic.c</code></a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>sum = 40000000</code></li>
</ul>
<hr>
<p class=" font-serif my-1">x86 的原子操作保证：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><red>原子性</red>: load/store 不会被打断</li>
<li class=" ml-8"><red>顺序</red>：线程 (处理器) 执行的乱序只能不能越过原子操作</li>
<li class=" ml-8"><red>多处理器之间的可见性</red>：若原子操作 $A$ 发生在 $B$ 之前，则 $A$ 之前的 store 对 $B$ 之后的 load 可见</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="x86-xchg" class=" text-xl mt-2 pb-2 font-sans">x86 原子操作：<code>xchg</code></h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">xchg</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">  </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span><span class="s">"lock xchg %0, %1"</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="s">"+m"</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="s">"=a"</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">"1"</span><span class="p">(</span><span class="n">newval</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">"cc"</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="xchg" class=" text-2xl mt-2 font-sans">用 xchg 实现互斥</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="xchg" class=" text-xl mt-2 pb-2 font-sans">用 <code>xchg</code> 实现互斥</h2>
<p class=" font-serif my-1">如何协调宿舍若干位同学上厕所问题？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在厕所门口放一个桌子 (共享变量)<ul class=" list-disc font-serif">
<li class=" ml-8">初始时，桌上是 🔑</li>
</ul>
</li>
<li class=" ml-8">每个同学可以完成原子操作<ul class=" list-disc font-serif">
<li class=" ml-8">拿任何和东西和桌上的物品交换 (xchg)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/no-key.jpg" width="200px">
实现互斥的协议</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">想上厕所的同学，拿一张 🔖 字条和桌上的东西交换<ul class=" list-disc font-serif">
<li class=" ml-8">得到 🔑: 进入厕所</li>
<li class=" ml-8">得到字条 🔖: 重试</li>
</ul>
</li>
<li class=" ml-8">出厕所的同学<ul class=" list-disc font-serif">
<li class=" ml-8">将手上的 🔑 和桌上的物品 (🔖) 交换 (还钥匙)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">实现互斥：自旋锁</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEY</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xchg</span><span class="p">(</span><span class="o">&</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">NOTE</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">KEY</span><span class="p">)</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">KEY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">xchg</span><span class="p">(</span><span class="o">&</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">KEY</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="contd" class=" text-xl mt-2 pb-2 font-sans">实现互斥：自旋锁 (cont'd)</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">xchg</span><span class="p">(</span><span class="o">&</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<p class=" font-serif my-1">并发编程：千万小心</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">理论证明 (用 <a href="../../../pages/OS/2021/demos/model-checker.py" class=" text-amber-900">model checker</a> 检查 <a href="../../../pages/OS/2021/demos/mutex-xchg.yaml" class=" text-amber-900">mutex-xchg.yaml</a>)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">互斥：阻止并发的发生</h2>
<p class=" font-serif my-1">在共享内存上，共享资源的访问太危险 (原子性、顺序、可见性的丧失)，互斥用来阻止代码块之间的并发，实现 “串行化”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">lock/unlock 保护的区域成为一个<red>原子</red>的黑盒子</li>
<li class=" ml-8">黑盒子的代码不能随意并发，<red>顺序</red>满足要么 $T_1 \to T_2$，要么 $T_2 \to T_1$</li>
<li class=" ml-8">且先完成的黑盒子的内存访问在之后的黑盒子中<red>可见</red></li>
</ul>
<hr>
<p class=" font-serif my-1">测试一下实现是否正确</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="../../../pages/OS/2021/demos/spinlock.c" class=" text-amber-900">spinlock.c</a></li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">原子指令的硬件实现</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lock-bus-lock-80486" class=" text-xl mt-2 pb-2 font-sans">Lock 前缀的诞生：Bus Lock (80486)</h2>
<p class=" font-serif my-1">简单粗暴：锁住总线，内存就是我的了</p>
<p class=" font-serif my-1"><img alt="" class="center" height="600px" src="../../../pages/OS/img/80486-arch.jpg"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lock" class=" text-xl mt-2 pb-2 font-sans">Lock 指令前缀的现代实现</h2>
<p class=" font-serif my-1">在 L1 cache 层保持一致性 (ring/mesh bus)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">相当于每个 cache line 有分别的锁</li>
<li class=" ml-8">store(x) 进入 L1 缓存即保证对其他处理器可见<ul class=" list-disc font-serif">
<li class=" ml-8">但要小心 store buffer 和乱序执行</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">L1 cache line 根据状态进行协调</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">M (Modified), 脏值</li>
<li class=" ml-8">E (Exclusive), 独占访问</li>
<li class=" ml-8">S (Shared), 只读共享</li>
<li class=" ml-8">I (Invalid), 不拥有 cache line</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="x86" class=" text-xl mt-2 pb-2 font-sans">理解 x86 内存模型 (指令运行的行为)</h2>
<p class=" font-serif my-1">Further reading: <a href="https://cacm.acm.org/magazines/2010/7/95048-x86-tso-a-rigorous-and-usable-programmers-model-for-x86-multiprocessors/fulltext" class=" text-amber-900">x86-TSO: A rigorous and ­usable programmer's model for x86 multiprocessors</a></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">乱序执行使单线程执行更快；同时也让并行程序的行为更难理解</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/2021/slides/img/x86-tso.png" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="risc-v" class=" text-xl mt-2 pb-2 font-sans">RISC-V: 另一种原子操作的设计</h2>
<p class=" font-serif my-1">考虑常见的原子操作：</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">atomic test-and-set<ul class=" list-disc font-serif">
<li class=" ml-8"><code>reg = load(x); if (reg == XX) { store(x, YY); }</code></li>
</ul>
</li>
<li class=" ml-8">lock xchg<ul class=" list-disc font-serif">
<li class=" ml-8"><code>reg = load(x); store(x, XX);</code></li>
</ul>
</li>
<li class=" ml-8">lock add<ul class=" list-disc font-serif">
<li class=" ml-8"><code>t = load(x); t++; store(x, t);</code></li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">它们的本质都是：</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">load</li>
<li class=" ml-8">exec (处理器本地寄存器的运算)</li>
<li class=" ml-8">store</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="load-reservedstore-conditional-lrsc" class=" text-xl mt-2 pb-2 font-sans">Load-Reserved/Store-Conditional (LR/SC)</h2>
<p class=" font-serif my-1">LR: 在内存上标记 reserved (盯上你了)，中断、其他处理器写入都会导致标记消除</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>lr.w rd, (rs1)
  rd = M[rs1]
  reserve M[rs1]
</code></pre></div>

<hr>
<p class=" font-serif my-1">SC: 如果 “盯上” 未被解除，则写入</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>sc.w rd, rs2, (rs1)
  if still reserved:
    M[rs1] = rs2
    rd = 0
  else:
    rd = nonzero
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lrsc" class=" text-xl mt-2 pb-2 font-sans">使用 LR/SC 实现原子指令</h2>
<p class=" font-serif my-1">只要 lr/sc 满足顺序/可见性/原子性，lr 到 sc 之间的区域就是原子的！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">用原子的 load/store 实现了一段代码的原子性 (精妙)<ul class=" list-disc font-serif">
<li class=" ml-8">偶尔会失败，提供 abort 机制</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">do_lrsc</span><span class="p">(){</span>
<span class="w">     </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lr</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f1</span><span class="o">/</span><span class="n">f2</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w"> </span><span class="c1">// 不同线程可以执行不同操作</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">状态机建模</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="compare-and-swap-lrsc" class=" text-xl mt-2 pb-2 font-sans">Compare-and-Swap 的 LR/SC 实现</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">cas</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmp_val</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">new_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">old_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cmp_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_val</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>cas:
  lr.w  t0, (a0)       # Load original value.
  bne   t0, a1, fail   # Doesn’t match, so fail.
  sc.w  t0, a2, (a0)   # Try to update.
  bnez  t0, cas        # Retry if store-conditional failed.
  li a0, 0             # Set return to success.
  jr ra                # Return.
fail:
  li a0, 1             # Set return to failure.
  jr ra                # Return
</code></pre></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="lrsc" class=" text-xl mt-2 pb-2 font-sans">LR/SC 的硬件实现</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/boom-pipeline-detailed.png" width="400px"></p>
<p class=" font-serif my-1">BOOM (Berkeley Out-of-Order Processor)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://github.com/riscv-boom/riscv-boom" class=" text-amber-900">riscv-boom</a><ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://github.com/riscv-boom/riscv-boom/blob/master/src/main/scala/lsu/dcache.scala#L655" class=" text-amber-900"><code>lsu/dcache.scala</code></a></li>
<li class=" ml-8">留意 <code>s2_sc_fail</code> 的条件 (s2 是流水线 Stage 2)</li>
<li class=" ml-8">(yzh 扒出的代码)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">什么是 “CPU 的实现”？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">CPU = 数字逻辑电路<ul class=" list-disc font-serif">
<li class=" ml-8">寄存器 + 组合逻辑</li>
</ul>
</li>
<li class=" ml-8">硬件描述语言 (HDL)<ul class=" list-disc font-serif">
<li class=" ml-8">Verilog, <a href="https://www.chisel-lang.org/" class=" text-amber-900">Chisel</a> (on Scala)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans">总结</h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">总结</h2>
<p class=" font-serif my-1">本次课内容与目标</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">理解和使用互斥锁 API (lock, unlock)</li>
<li class=" ml-8">在多处理器系统上实现互斥 (xchg, LR/SC 和自旋锁)</li>
</ul>
<hr>
<p class=" font-serif my-1">Take-away messages</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">动手很重要<ul class=" list-disc font-serif">
<li class=" ml-8">写测试代码</li>
<li class=" ml-8">用 model checker 证明</li>
</ul>
</li>
<li class=" ml-8">软件不够，硬件来凑<ul class=" list-disc font-serif">
<li class=" ml-8">这是 system 里的常用手段</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>