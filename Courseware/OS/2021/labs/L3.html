<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>L3: &#34394;&#25311;&#25991;&#20214;&#31995;&#32479; (vfs)</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="../../../index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="../../2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="l3-vfs" class=" text-2xl mt-2 font-sans">L3: &#34394;&#25311;&#25991;&#20214;&#31995;&#32479; (vfs)</h1>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">&#20851;&#20110;&#23454;&#39564;&#29615;&#22659;&#35774;&#32622;&#12289;&#25552;&#20132;&#26041;&#27861;&#12289;&#35780;&#20998;&#35268;&#21017;&#31561;&#65292;&#35831;&#38405;&#35835;<a href="Labs.html" class=" text-amber-900">&#23454;&#39564;&#39035;&#30693;</a>&#12290;&#33719;&#21462;&#20195;&#30721;&#21518;&#65292;&#22312; <code>os-workbench</code> &#20013;&#25191;&#34892; <code>git pull origin L3</code> &#19979;&#36733;&#20195;&#30721;&#12290;&#30001;&#20110; kernel &#30446;&#24405;&#23558;&#22312;&#21518;&#32493;&#30340;&#25805;&#20316;&#31995;&#32479;&#23454;&#39564;&#20013;&#20351;&#29992;&#65292;<strong>&#26412;&#27425;&#23454;&#39564;&#25552;&#20132;&#26102;&#65292;&#38656;&#35201;&#35774;&#32622;&#29615;&#22659;&#21464;&#37327; <code>MODULE</code> &#20026; <code>L3</code></strong> (&#22914;&#26524;&#20320;&#23558; export &#20889;&#22312;&#20102; Makefile &#37324;&#65292;&#38656;&#35201;&#30456;&#24212;&#20316;&#20986;&#20462;&#25913;&#65292;&#21542;&#21017;&#23558;&#25552;&#20132;&#21040;&#36807;&#24448;&#30340;&#23454;&#39564;)&#12290;</p>
<p class=" font-serif my-1">Soft Deadline: 2021 &#24180; 7 &#26376; 25 &#26085;</p>
</blockquote>
<p class=" font-serif my-1"><oj-status course="OS2021" module="L3"><div class="divide-y divide-dashed">
    <div class="flex font-semibold">
      OS2021-L3 &#25552;&#20132;&#32467;&#26524;
    </div>
    
  </div>
</oj-status></p>
<p class=" font-serif my-1"><strong>&#26412;&#23454;&#39564;&#22312; L2 &#20195;&#30721;&#30340;&#22522;&#30784;&#19978;&#23436;&#25104;</strong>&#12290;&#38656;&#35201;&#25552;&#20132;&#20197;&#23398;&#21495;&#21629;&#21517;&#30340; .pdf &#26684;&#24335;&#23454;&#39564;&#25253;&#21578; (&#20445;&#23384;&#22312; <code>kernel/</code> &#30446;&#24405;&#19979;&#65292;&#22312; L1/L2 &#30340;&#23454;&#39564;&#25253;&#21578;&#20043;&#21518;&#28155;&#21152;)&#12290;&#38500;&#38750;&#29305;&#27530;&#24773;&#20917;&#65292;&#26412;&#27425;&#23454;&#39564;&#25253;&#21578;&#26032;&#22686;&#20869;&#23481;<strong>&#19981;&#24314;&#35758;&#36229;&#36807; 2 &#39029; A4 &#32440;</strong>&#12290;&#35831;&#22312;&#23454;&#39564;&#25253;&#21578;&#20013;&#25551;&#36848;&#20320;&#22312;&#23454;&#39564;&#20013;&#36935;&#21040;&#30340;&#29305;&#21035;&#20540;&#24471;&#19968;&#25552;&#30340;&#20107;&#20214;&#65292;&#20363;&#22914;&#20320;&#20195;&#30721;&#30340;&#26550;&#26500;&#35774;&#35745;&#12289;&#29305;&#21035;&#31934;&#24039;&#30340;&#23454;&#29616;&#12289;&#36935;&#21040;&#21360;&#35937;&#28145;&#21051;&#30340; bug &#31561;&#12290;</p>
<h2 id="1" class=" text-xl mt-2 pb-2 font-sans">1. &#32972;&#26223;</h2>
<p class=" font-serif my-1">&#22312;&#36825;&#20010;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#22312;&#22810;&#22788;&#29702;&#22120;&#20998;&#26102;&#22810;&#32447;&#31243;&#30340;&#22522;&#30784;&#19978;&#23454;&#29616;<strong>&#32447;&#31243;&#23433;&#20840;</strong>&#30340;&#34394;&#25311;&#25991;&#20214;&#31995;&#32479; (virtual file system, VFS) API&#65292;&#24182;&#19988;&#22312; VFS &#36825;&#19968;&#25277;&#35937;&#23618;&#19978;&#23454;&#29616;&#33509;&#24178;&#19981;&#21516;&#30340;&#25991;&#20214;&#31995;&#32479;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#22312;&#23384;&#20648;&#35774;&#22791; (<code>sda</code>) &#19978;&#25903;&#25345;&#23436;&#25972;&#25991;&#20214;&#21644;&#30446;&#24405;&#25805;&#20316;&#30340;&#25991;&#20214;&#31995;&#32479; &#8220;ultra-simple file system&#8221; (ufs);</li>
<li class=" ml-8">&#34394;&#25311;&#30340; procfs&#65292;&#25552;&#20379;&#19968;&#31995;&#21015;&#21482;&#35835;&#30340;&#12289;&#21453;&#26144;&#25805;&#20316;&#31995;&#32479;&#20869;&#37096;&#29366;&#24577;&#30340;&#25991;&#20214;&#65307;</li>
<li class=" ml-8">&#34394;&#25311;&#30340; devfs&#65292;&#23558;&#25805;&#20316;&#31995;&#32479;&#20013;&#30340;&#35774;&#22791;&#25277;&#35937;&#20026;&#21487;&#20197;&#35775;&#38382;&#30340;&#25991;&#20214;&#65292;&#24182;&#20026;&#36825;&#20123;&#25991;&#20214;&#25552;&#20379;&#35835;&#20889;&#25805;&#20316;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#23454;&#29616;&#23436;&#25104;&#21518;&#65292;&#31995;&#32479;&#20013;&#30340;&#22810;&#20010;&#32447;&#31243;&#23601;&#33021;&#36890;&#36807;&#25991;&#20214;&#31995;&#32479; API &#35835;&#20889;&#25991;&#20214;&#8212;&#8212;&#33267;&#27492;&#25105;&#20204;&#31163;&#29616;&#20195;&#25805;&#20316;&#31995;&#32479;&#23601;&#21482;&#26377;&#19968;&#27493;&#20043;&#36965;&#65306;&#21482;&#38656;&#20026;&#27599;&#20010;&#32447;&#31243;&#38468;&#23646;&#19968;&#20010;&#29420;&#31435;&#30340;&#22320;&#22336;&#31354;&#38388; (&#36890;&#36807;&#34394;&#25311;&#23384;&#20648;&#23454;&#29616;&#65292;&#21442;&#32771; xv6 &#20195;&#30721;)&#65292;&#32447;&#31243;&#23601;&#21464;&#25104;&#20102;&#25105;&#20204;&#29087;&#30693;&#30340;&#36827;&#31243;&#65292;&#25805;&#20316;&#31995;&#32479;&#23601;&#23436;&#25972;&#20102;&#12290;</p>
<h2 id="2" class=" text-xl mt-2 pb-2 font-sans">2. &#23454;&#39564;&#25551;&#36848;</h2>
<h3 id="21" class=" text-lg mt-2 pb-2 font-sans">2.1 &#23454;&#39564;&#24635;&#35272;</h3>
<p class=" font-serif my-1">&#36825;&#20010;&#23454;&#39564;&#22312; pmm &#21644; kmt (&#21253;&#25324; dev) &#30340;&#22522;&#30784;&#19978;&#65292;&#22312;&#30913;&#30424;&#35774;&#22791; (&#39537;&#21160;&#31243;&#24207;) &#30340;&#22522;&#30784;&#19978;&#23454;&#29616;&#25345;&#20037;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#24182;&#19988;&#22312;&#32447;&#31243;&#32423;&#21035;&#25903;&#25345;&#25991;&#20214;&#25551;&#36848;&#31526;&#21644;&#25991;&#20214;/&#30446;&#24405;&#25805;&#20316; API&#8212;&#8212;vfs &#30340; API &#21644;&#22823;&#23478;&#22312; MiniLabs &#20013;&#20351;&#29992;&#30340;&#31995;&#32479;&#35843;&#29992;&#20960;&#20046;&#23436;&#20840;&#19968;&#26679;&#8212;&#8212;&#22312; Linux &#20013;&#65292;&#25105;&#20204;&#30340;&#36827;&#31243;&#36890;&#36807; syscall &#25351;&#20196;&#36827;&#20837;&#36827;&#20837;&#25805;&#20316;&#31995;&#32479;&#21518;&#23601;&#20250;&#30452;&#25509;&#35843;&#29992;&#36825;&#20123;&#20989;&#25968;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#27880;&#24847;&#65306;&#26412;&#23454;&#39564;&#38656;&#35201;&#35774;&#22791;&#39537;&#21160;&#31243;&#24207;&#37096;&#20998;&#27491;&#24120;&#24037;&#20316;</h4>
<p class=" font-serif my-1">&#22312; Lab 3 &#20013;&#65292;&#20320;&#38656;&#35201;&#21512;&#24182; Lab 2 &#30340;&#23448;&#26041;&#27979;&#35797;&#29992;&#20363; (dev &#20197;&#21450;&#33509;&#24178;&#35774;&#22791;&#39537;&#21160;&#30340;&#23454;&#29616;)&#12290;&#20294;&#21363;&#20415;&#20320;&#30340; kmt &#23454;&#29616;&#26377;&#38382;&#39064; (&#20363;&#22914;&#32456;&#31471;&#35774;&#22791;&#22312;&#26102;&#38047;&#20316;&#29992;&#19979;&#26377;&#19968;&#23450;&#30340;&#24322;&#24120;)&#65292;&#20320;&#20063;&#21487;&#20197;&#23581;&#35797;&#27880;&#37322;&#25481;&#32447;&#31243;&#21019;&#24314;&#30340;&#20195;&#30721;&#21644;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#30340;&#27880;&#20876;&#65292;Lab 3 &#30340; Online Judge &#21482;&#35843;&#29992;&#30913;&#30424;&#35774;&#22791; (sda)&#65292;&#20854;&#20195;&#30721;&#30456;&#23545;&#31616;&#21333;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#25105;&#20204;&#30340;&#25991;&#20214;&#31995;&#32479; API &#20570;&#20102;&#30456;&#24403;&#30340;&#31616;&#21270;&#65292;&#20363;&#22914;&#24182;&#19981;&#25903;&#25345;&#21160;&#24577;&#30340; mount (&#25991;&#20214;&#31995;&#32479;&#22312;&#31995;&#32479;&#21551;&#21160;&#26102;&#34987; mount)&#12290;&#20855;&#20307;&#26469;&#35828;&#65292;&#20320;&#38656;&#35201;&#23454;&#29616;&#20197;&#19979; API:</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_stat</span><span class="p">;</span>
<span class="n">MODULE</span><span class="p">(</span><span class="n">vfs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)();</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lseek</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">whence</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">oldpath</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">newpath</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlink</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fstat</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_stat</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mkdir</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">chdir</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dup</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p class=" font-serif my-1">&#27880;&#24847;&#21040;&#25105;&#20204;&#30340;&#26694;&#26550;&#20013;&#36824;&#25552;&#20379;&#20102; <code>framework/user.h</code>, &#36825;&#20010;&#25991;&#20214;&#26159;&#29992;&#25143;&#36827;&#31243; (&#20551;&#24819;&#26377;&#30340;&#35805;)/&#20869;&#26680;&#20043;&#38388;&#20849;&#20139;&#30340;&#65292;&#23427;&#23450;&#20041;&#20102;&#35832;&#22914; <code>struct ufs_stat</code>, &#20197;&#21450;&#33509;&#24178;&#20989;&#25968;&#21442;&#25968;&#30340;&#21547;&#20041;&#65292;&#21644;&#30446;&#24405;&#25991;&#20214;&#30340;&#26684;&#24335;&#12290;&#20363;&#22914; <code>whence</code> &#20013;&#30340; <code>SEEK_SET</code>, <code>SEEK_CUR</code> &#21644; <code>SEEK_END</code>&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define T_DIR     1</span>
<span class="cp">#define T_FILE    2</span>

<span class="cp">#define SEEK_CUR  0</span>
<span class="cp">#define SEEK_SET  1</span>
<span class="cp">#define SEEK_END  2</span>

<span class="cp">#define O_RDONLY  00000000</span>
<span class="cp">#define O_WRONLY  00000001</span>
<span class="cp">#define O_RDWR    00000002</span>
<span class="cp">#define O_CREAT   00000100</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">ufs_stat</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">ufs_dirent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">inode</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
</code></pre></div>

<p class=" font-serif my-1">&#35831;&#19981;&#35201;&#20462;&#25913;&#19978;&#36848;&#26694;&#26550;&#20013;&#30340;&#23450;&#20041;&#65292;&#20294;&#25991;&#20214;&#31995;&#32479;&#30340;&#25968;&#25454;&#32467;&#26500;&#35774;&#35745;&#12289;&#32447;&#31243;&#21516;&#27493;&#31561;&#20320;&#37117;&#21487;&#20197;&#33258;&#30001;&#21457;&#25381;&#65281;&#34429;&#28982;&#25991;&#20214;&#31995;&#32479;&#30340;&#23454;&#29616;&#21407;&#29702;&#31616;&#21333;&#65292;&#20294;&#23454;&#29616;&#25991;&#20214;&#31995;&#32479;&#30340;&#24037;&#20316;&#37327;&#22815;&#22823; (&#32780;&#19988;&#35201;&#23567;&#24515;&#22788;&#29702;&#24456;&#22810;&#23545;&#35937;&#30340;&#29983;&#21629;&#21608;&#26399;&#21644; error handling)&#65292;&#35831;&#20320;&#20570;&#22909;&#35843;&#35797;&#20195;&#30721;&#30340;&#24515;&#29702;&#20934;&#22791; &#128513;&#12290;</p>
<h2 id="22-vfs-virtual-file-system" class=" text-xl mt-2 pb-2 font-sans">2.2 VFS (Virtual File System) &#27169;&#22359;</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_2" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-red" style=" padding-bottom: 0;">&#9888;&#65039; &#32447;&#31243;&#23433;&#20840;&#24615;</h4>
<p class=" font-serif my-1">&#27880;&#24847;&#65292;&#38500;&#20102;&#27169;&#22359;&#30340;&#21021;&#22987;&#21270; (<code>init</code>) &#20043;&#22806;&#65292;&#31995;&#32479;&#20013;&#21019;&#24314;&#30340;&#32447;&#31243;&#37117;&#21487;&#20197;&#24182;&#21457;&#22320;&#35775;&#38382;&#25805;&#20316;&#31995;&#32479;&#20013;&#30340;&#23545;&#35937;&#8212;&#8212;&#20294;&#27880;&#24847;&#27599;&#20010;&#32447;&#31243;&#37117;&#26377;&#19968;&#20221;&#25991;&#20214;&#25551;&#36848;&#31526;&#30340;&#21103;&#26412;&#12290;</p>
</blockquote>
<h3 id="221" class=" text-lg mt-2 pb-2 font-sans">2.2.1 &#27169;&#22359;&#21021;&#22987;&#21270;</h3>
<p class=" font-serif my-1"><code>vfs-&gt;init()</code> &#36127;&#36131;&#21021;&#22987;&#21270;&#24517;&#35201;&#30340;&#25968;&#25454;&#65292;&#20363;&#22914;&#26681;&#25991;&#20214;&#31995;&#32479;&#30340;&#21019;&#24314;&#31561;&#12290;&#25105;&#20204;&#39044;&#26399;&#20320;&#20250;&#22312; <code>os-&gt;init()</code> &#26102;&#35843;&#29992; <code>vfs-&gt;init()</code>&#12290;&#25972;&#20010;&#31995;&#32479;&#21551;&#21160;&#21482;&#35843;&#29992;&#19968;&#27425; <code>vfs-&gt;init()</code>&#12290;</p>
<h3 id="222" class=" text-lg mt-2 pb-2 font-sans">2.2.2 &#30446;&#24405;&#32467;&#26500;</h3>
<p class=" font-serif my-1">&#22312; Lab 3 &#20013;&#65292;&#25105;&#20204;&#23454;&#29616;&#26641;&#29366;&#30340;&#30446;&#24405;&#32467;&#26500;&#65292;&#19977;&#20010;&#25991;&#20214;&#31995;&#32479;&#23454;&#29616;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#36890;&#36807; <code>/</code> &#35775;&#38382; ufs&#65292;ufs &#31649;&#29702;&#30913;&#30424;&#35774;&#22791; <code>sda</code>&#12290;ufs &#25903;&#25345;&#25991;&#20214;&#31995;&#32479;&#20869;&#30340;&#38142;&#25509; (linking)&#65307;</li>
<li class=" ml-8">&#36890;&#36807; <code>/proc</code> &#21487;&#20197;&#35775;&#38382; procfs&#12290;procfs &#20026;&#27599;&#19968;&#20010;&#32447;&#31243; (&#20043;&#21518;&#30340;&#36827;&#31243;) &#21019;&#24314;&#19968;&#20010;&#30446;&#24405;&#65292;&#30446;&#24405;&#20013;&#21487;&#20197;&#25552;&#20379;&#35813;&#32447;&#31243; (&#36827;&#31243;) &#30340;&#20449;&#24687;&#65292;&#20363;&#22914;&#20320;&#21487;&#20197;&#36890;&#36807; <code>/proc/1/name</code> &#26469;&#24471;&#21040;&#32447;&#31243;&#30340;&#21517;&#23383;&#65307;</li>
<li class=" ml-8">&#25105;&#20204;&#39044;&#26399;&#36890;&#36807; <code>/dev</code> &#35775;&#38382; devfs&#65292;&#20363;&#22914;&#36890;&#36807; <code>/dev/sda</code> &#29992;&#25991;&#20214;&#31995;&#32479; API &#30452;&#25509;&#35835;&#20889;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#20320;&#21487;&#20197;&#29702;&#35299;&#20026;&#20320;&#30340; <code>vfs-&gt;init()</code> &#38656;&#35201;&#23436;&#25104; <code>/proc</code> &#21644; <code>/dev</code> &#30340;&#25346;&#36733;&#8212;&#8212;&#20294;&#20320;&#19981;&#38656;&#35201;&#23454;&#29616; mount/unmount API&#65292;&#22240;&#27492;&#20320;&#21487;&#20197;&#22312;&#36866;&#24403;&#30340;&#26102;&#20505; &#8220;&#30828;&#32534;&#30721;&#8221; &#20197;&#20943;&#23569;&#20195;&#30721;&#30340;&#22797;&#26434;&#24230;&#12290;&#25991;&#20214;&#31995;&#32479;&#30340;&#30446;&#24405;&#26641;&#30475;&#36215;&#26469;&#21644; Linux &#26377;&#19968;&#23450;&#30340;&#30456;&#20284;&#24615; (&#32418;&#33394;&#30340;&#33410;&#28857;&#34920;&#31034;&#30446;&#24405;&#65292;&#40657;&#33394;&#30340;&#33410;&#28857;&#34920;&#31034;&#25991;&#20214;&#65292;&#19977;&#35282;&#24418;&#34920;&#31034;&#25991;&#20214;&#31995;&#32479;)&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/2021/labs/img/fs-tree.png" width="600px"></p>
<p class=" font-serif my-1"><code>vfs</code> &#27169;&#22359;&#20013;&#30340; API &#29992;&#20110;&#25913;&#21464;&#25991;&#20214;&#31995;&#32479;&#30340;&#32467;&#26500;&#21644;&#31649;&#29702;&#32447;&#31243;&#25171;&#24320;&#30340;&#25991;&#20214;&#12290;</p>
<h3 id="223" class=" text-lg mt-2 pb-2 font-sans">2.2.3 &#36335;&#24452;&#19982;&#25991;&#20214;&#25551;&#36848;&#31526;</h3>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">chdir</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#25105;&#20204;&#23454;&#29616;&#30340;&#25805;&#20316;&#31995;&#32479;&#20013;&#65292;&#27599;&#20010;&#32447;&#31243;&#37117;&#26377;&#19968;&#20010; &#8220;&#24403;&#21069;&#36335;&#24452;&#8221;&#65292;&#25351;&#21521;&#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#19968;&#20010;&#23384;&#22312;&#30340;&#30446;&#24405; (&#25105;&#20204;&#20551;&#35774;&#19981;&#20250;&#21024;&#38500;&#20219;&#20309;&#36827;&#31243;&#30340;&#24403;&#21069;&#30446;&#24405;&#65292;&#34429;&#28982;&#23454;&#38469;&#30340;&#31995;&#32479;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#26377; defined behavior&#65307;&#20320;&#21487;&#20197;&#32771;&#34385;&#22914;&#20309;&#23454;&#29616;&#36825;&#19968;&#28857;)&#12290;&#20043;&#21518;&#32447;&#31243;&#25191;&#34892;&#25152;&#26377;&#30340; API (chdir, open, read, link, unlink, mkdir) &#26102;&#65292;&#22914;&#36335;&#24452;&#19981;&#26159;&#20197; <code>/</code> &#24320;&#22836;&#65292;&#21017;&#30456;&#23545;&#20110;&#24403;&#21069;&#36335;&#24452;&#36827;&#34892;&#36335;&#24452;&#35299;&#26512;&#12290;&#20363;&#22914;&#65292;&#22914;&#26524;&#24403;&#21069;&#30446;&#24405;&#26159; <code>/proc</code> (procfs)&#65292;&#37027;&#20040; <code>1/name</code> &#23601;&#26159;&#19968;&#20010;&#21512;&#27861;&#30340;&#36335;&#24452; (&#25351;&#21521; <code>/proc/1/name</code>)&#12290;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">chdir &#25913;&#21464;&#24403;&#21069;&#32447;&#31243;&#30340;&#24403;&#21069;&#36335;&#24452;&#20026; <code>path</code>; &#25104;&#21151;&#36820;&#22238; 0&#12290;</li>
<li class=" ml-8">
<p class=" font-serif my-1">open &#25171;&#24320; <code>path</code>, &#20801;&#35768;&#30340;&#25171;&#24320;&#26041;&#24335; flags &#23450;&#20041;&#22312; <code>user.h</code>:</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>O_RDONLY</code>: &#21482;&#35835;&#65307;</li>
<li class=" ml-8"><code>O_WRONLY</code>: &#21482;&#20889;&#65307;</li>
<li class=" ml-8"><code>O_RDWR</code>: &#21487;&#35835;&#21487;&#20889;&#65307;</li>
<li class=" ml-8"><code>O_CREAT</code>: &#22914;&#26524;&#25991;&#20214;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#22914;&#25171;&#24320;&#25104;&#21151;&#65292;&#36820;&#22238;&#19968;&#20010;&#38750;&#36127;&#25972;&#25968;&#32534;&#21495;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526; (&#26368;&#23567;&#30340;&#26410;&#20351;&#29992;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#65292;&#23601;&#20687;&#25105;&#20204;&#22312; Linux &#20013;&#35265;&#21040;&#30340;&#37027;&#26679;&#65292;&#25171;&#24320;&#22833;&#36133;&#36820;&#22238;&#36127;&#25968;)&#12290;&#25991;&#20214;&#25551;&#36848;&#31526;&#26159;&#25351;&#21521;&#25805;&#20316;&#31995;&#32479;&#23545;&#35937; (&#20855;&#20307;&#26469;&#35828;&#65292;&#22312;&#25105;&#20204;&#30340;&#23454;&#29616;&#37324;&#23601;&#26159;&#25991;&#20214;) &#30340;&#25351;&#38024;&#65292;&#24182;&#19988;&#21487;&#20197;&#36890;&#36807;&#25991;&#20214;&#25551;&#36848;&#31526;&#25805;&#20316;&#35775;&#38382;&#36825;&#20010;&#23545;&#35937;&#12290;</p>
</li>
<li class=" ml-8">
<p class=" font-serif my-1">close &#20851;&#38381;&#19968;&#20010;&#25991;&#20214;&#25551;&#36848;&#31526;&#12290;</p>
</li>
</ul>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="unix" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#19982; UNIX &#25991;&#20214;&#31995;&#32479;&#30340;&#21306;&#21035;</h4>
<p class=" font-serif my-1"><red>&#27880;&#24847;&#20801;&#35768; open &#20197;&#21482;&#35835;&#30340;&#26041;&#24335;&#25171;&#24320;&#30446;&#24405;&#25991;&#20214;</red>&#12290;&#22312;&#25105;&#20204;&#30340; ufs &#20013;&#65292;&#30446;&#24405;&#25991;&#20214;&#20197;&#20108;&#36827;&#21046;&#24418;&#24335;&#23384;&#20648; <code>struct ufs_dirent</code> &#30340;&#25968;&#32452;&#65292;&#20174;&#32780;&#21487;&#20197;&#33719;&#24471;&#30446;&#24405;&#20013;&#25991;&#20214;&#30340;&#21015;&#34920;&#65292;&#20174;&#32780;&#26080;&#38656; <code>readdir</code> (<code>getdents</code>) &#31995;&#32479;&#35843;&#29992;&#12290;</p>
</blockquote>
<h3 id="224" class=" text-lg mt-2 pb-2 font-sans">2.2.4 &#30446;&#24405;&#21644;&#25991;&#20214;&#25805;&#20316;</h3>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mkdir</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">oldpath</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">newpath</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlink</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fstat</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_stat</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div>

<ul class=" list-disc font-serif">
<li class=" ml-8">&#30446;&#24405;&#31649;&#29702;&#30340; API &#26159; mkdir (&#21019;&#24314;&#30446;&#24405;)&#12289;link (&#21019;&#24314;&#25991;&#20214;&#30340;&#38142;&#25509;)&#12289;unlink (&#21024;&#38500;&#38142;&#25509;)&#65292;&#34892;&#20026;&#21644; Linux/&#25945;&#31185;&#20070;&#20445;&#25345;&#19968;&#33268;&#65292;&#27880;&#24847;&#36335;&#24452;&#21517;&#22914;&#26524;&#19981;&#26159;&#20197; <code>/</code> &#24320;&#22836;&#38656;&#35201;&#20197;&#24403;&#21069;&#32447;&#31243;&#30340;&#24037;&#20316;&#30446;&#24405;&#36827;&#34892;&#30456;&#23545;&#35299;&#26512;&#12290;&#27880;&#24847;&#21482;&#26377;&#30913;&#30424;&#19978;&#25345;&#20037;&#30340;&#25991;&#20214;&#31995;&#32479;&#25903;&#25345;&#38142;&#25509;&#8212;&#8212;&#20320;&#19981;&#38656;&#35201;&#20026; procfs &#21644; devfs &#25903;&#25345;&#38142;&#25509;&#12290;</li>
<li class=" ml-8">&#23545;&#19968;&#20010;&#25171;&#24320;&#30340;&#25991;&#20214;&#65292;&#21487;&#20197;&#20351;&#29992; fstat &#26597;&#30475;&#25991;&#20214;&#30340;&#23646;&#24615;&#65292;<code>struct ufs_stat</code> &#23450;&#20041;&#22312; <code>user.h</code>&#65306;<ul class=" list-disc font-serif">
<li class=" ml-8">id &#26159;&#32534;&#21495; (<code>&gt;= 1</code>)&#65307;</li>
<li class=" ml-8">type &#26159; <code>T_DIR</code> (&#30446;&#24405;) &#25110; <code>T_FILE</code> (&#25991;&#20214;)&#65292;&#20854;&#20182;&#25968;&#20540;&#20026;&#38750;&#27861;&#65307;</li>
<li class=" ml-8">size &#26159;&#25991;&#20214;&#22823;&#23567;&#30340;&#23383;&#33410;&#25968;&#12290;&#23545;&#20110;&#30446;&#24405;&#25991;&#20214; (&#30446;&#24405;&#39033;&#30340;&#25968;&#32452;)&#65292;&#22823;&#23567;&#24635;&#26159; <code>struct ufs_dirent</code> &#22823;&#23567;&#30340;&#25972;&#25968;&#20493;&#12290;</li>
</ul>
</li>
</ul>
<h3 id="225" class=" text-lg mt-2 pb-2 font-sans">2.2.5 &#25991;&#20214;&#25551;&#36848;&#31526;&#25805;&#20316;</h3>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lseek</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">whence</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dup</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</code></pre></div>

<p class=" font-serif my-1">&#25226;&#25991;&#20214;&#25551;&#36848;&#31526;&#30475;&#25104;&#26159;&#35775;&#38382;&#25805;&#20316;&#31995;&#32479;&#23545;&#35937;&#30340; &#8220;&#25351;&#38024;&#8221;&#65292;&#25991;&#20214;&#25551;&#36848;&#31526;&#19978;&#30340;&#25805;&#20316;&#23601;&#38750;&#24120;&#23481;&#26131;&#29702;&#35299;&#65306;read, write &#20250;&#20174;&#25991;&#20214;&#25551;&#36848;&#31526;&#20869;&#32622;&#30340;&#28216;&#26631; (offset) &#20013;&#35835;&#21462;&#25968;&#25454;&#24182;&#30456;&#24212;&#26356;&#26032; offset, lseek &#20250;&#25913;&#21464;&#28216;&#26631;&#30340;&#20301;&#32622;&#65292;&#20854;&#20013; whence (<code>user.h</code>):</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>SEEK_CUR</code>: &#20174;&#24403;&#21069;&#20301;&#32622;&#24320;&#22987;&#65307;</li>
<li class=" ml-8"><code>SEEK_SET</code>: &#20174;&#22836;&#37096;&#24320;&#22987;&#65307;</li>
<li class=" ml-8"><code>SEEK_END</code>: &#20174;&#23614;&#37096;&#24320;&#22987;&#12290;&#27492;&#26102; <code>offset</code> &#20026; 0 &#23558;&#20250;&#35835;&#21040; EOF (end-of-file)&#12290;</li>
</ul>
<p class=" font-serif my-1">dup &#22797;&#21046;&#19968;&#20221;&#20849;&#20139; offset &#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#65292;&#36820;&#22238;&#26368;&#23567;&#21487;&#29992;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#12290;&#36825;&#20123; API &#30340;&#34892;&#20026;&#37117;&#21644; Linux &#19968;&#33268;&#12290;</p>
<h3 id="226" class=" text-lg mt-2 pb-2 font-sans">2.2.6 &#25346;&#36733;&#30340;&#25991;&#20214;&#31995;&#32479;</h3>
<h4 id="1-ufs" class=" pt-2 pb-2 font-sans">(1) ufs</h4>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">ufs &#26159;&#24314;&#31435;&#22312;&#35774;&#22791; <code>sda</code> (&#30913;&#30424;) &#19978;&#30340;&#25345;&#20037;&#25968;&#25454;&#32467;&#26500;&#12290;&#35774;&#22791;&#39537;&#21160;&#25552;&#20379;&#20102;&#23545; sda &#30340;&#35835;&#20889;&#25805;&#20316;&#12290;&#20320;&#38656;&#35201;&#25903;&#25345;&#22312; ufs &#20013;&#21019;&#24314;&#30446;&#24405;&#12289;&#25991;&#20214;&#21644;&#38142;&#25509;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">ufs &#40664;&#35748;&#25346;&#36733;&#22312; <code>/</code>&#65292;&#21363;&#38500;&#20102; <code>/proc</code> &#21644; <code>/dev</code> &#20013;&#30340;&#25991;&#20214;&#21644;&#30446;&#24405;&#20043;&#22806;&#65292;&#20854;&#20182;&#30340;&#25991;&#20214;&#21644;&#30446;&#24405;&#37117;&#23646;&#20110; ufs&#65307;&#27880;&#24847;&#22914;&#26524;&#20351;&#29992; open &#25171;&#24320; <code>/</code> (ufs)&#65292;&#24182;&#19988;&#35835;&#21462;&#20854;&#20013;&#30340;&#30446;&#24405;&#39033;&#65292;&#20320;&#33021;&#22815;&#35835;&#21040; <code>dev</code> &#21644; <code>proc</code> (&#20004;&#20010;&#30446;&#24405;)&#65292;&#20294;&#23427;&#20204;&#30340; inode &#32534;&#21495;&#24182;&#19981;&#37325;&#35201;&#65292;&#20320;&#21487;&#20197;&#26681;&#25454;&#20320;&#30340;&#23454;&#29616;&#33258;&#34892;&#30830;&#23450;&#12290;</p>
<p class=" font-serif my-1">&#20351;&#29992;&#30446;&#24405;&#31649;&#29702;/&#25991;&#20214;&#31649;&#29702;&#30340; API &#21487;&#20197;&#20462;&#25913; ufs &#25991;&#20214;&#31995;&#32479;&#30340;&#32467;&#26500;&#65292;&#24182;&#19988;&#36825;&#20123;&#20462;&#25913;&#20250;&#26368;&#32456;&#34987;&#25345;&#20037;&#21270;&#21040;&#30913;&#30424;&#19978;&#8212;&#8212;ufs &#26159;&#30913;&#30424;&#19978; (<code>sda</code>) &#35774;&#22791;&#19978;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#20320;&#38656;&#35201;&#23558;&#25991;&#20214;&#31995;&#32479;&#36825;&#19968;&#25968;&#25454;&#32467;&#26500;&#65292;&#32763;&#35793;&#25104;&#23545; I/O &#35774;&#22791;&#30340;&#35835;/&#20889;&#25805;&#20316;&#12290;&#27880;&#24847;&#25105;&#20204;&#30340; dev &#27169;&#22359;&#24050;&#32463;&#23545;&#30913;&#30424;&#36827;&#34892;&#20102;&#23553;&#35013;&#65292;&#23558;&#30913;&#30424;&#23553;&#35013;&#25104;&#20102;&#19968;&#20010;&#23383;&#33410;&#24207;&#21015;&#65292;&#21487;&#20197;&#25903;&#25345;&#20219;&#24847;&#20301;&#32622;&#30340;&#35835;&#20889;&#8212;&#8212;&#36825;&#21487;&#33021;&#20250;&#31616;&#21270;&#20320;&#30340;&#32534;&#31243;&#65292;&#20294;&#35201;&#27880;&#24847;&#38750;&#23545;&#40784;&#30340;&#35835;/&#20889;&#20250;&#24341;&#36215;&#39069;&#22806;&#30340; I/O &#25805;&#20316;&#8212;&#8212;&#20363;&#22914;&#20320;&#24076;&#26395;&#20889;&#20837;&#30913;&#30424;&#30340;&#26576;&#20010;&#23383;&#33410;&#65292;&#23601;&#20250;&#23548;&#33268;&#21253;&#21547;&#36825;&#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#22359;&#34987;&#35835;&#21462;&#65292;&#28982;&#21518;&#20877;&#27425;&#34987;&#20889;&#20837;&#12290;&#40723;&#21169;&#20320;&#22312;&#20320;&#30340;&#31995;&#32479;&#20013;&#23454;&#29616;&#19968;&#23618;&#22522;&#20110;&#25968;&#25454;&#22359; (&#22359;&#22823;&#23567;&#21487;&#20197;&#30001;&#20320;&#33258;&#34892;&#23450;&#20041;&#65292;&#20363;&#22914; 4 KiB) &#30340;&#32531;&#23384;&#12290;</p>
<h4 id="2-procfs" class=" pt-2 pb-2 font-sans">(2) procfs</h4>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">procfs &#26159;&#34394;&#25311;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#19981;&#28041;&#21450;&#20219;&#20309;&#35774;&#22791;&#12290;<red>&#19981;&#25903;&#25345;&#22312; procfs &#20013;&#20351;&#29992; vfs API &#21019;&#24314;&#25991;&#20214;/&#30446;&#24405;/&#38142;&#25509;</red>&#12290;procfs &#20013;&#30340;&#30446;&#24405; (<code>/proc</code> &#26412;&#36523;&#65292;&#20197;&#21450;&#24418;&#22914; <code>/proc/[id]</code> &#30340;&#30446;&#24405;) &#38656;&#35201;&#25903;&#25345; fstat &#21644;read &#25805;&#20316;&#65292;&#33021;&#35835;&#20986;&#27491;&#30830;&#30340;&#22823;&#23567; (<code>struct ufs_stat</code> &#20013;&#30340; <code>size</code> &#23383;&#33410;&#25968;)&#65292;&#21644; <code>struct ufs_dirent</code> &#32467;&#26500;&#20307;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">procfs &#22909;&#20687;&#26159; &#8220;&#25346;&#36733;&#8221; &#22312; <code>/proc</code> &#19979;&#65292;procfs &#20013;&#30340;&#30446;&#24405;&#26159;&#25152;&#26377;&#30340;&#32447;&#31243;&#30340;&#32534;&#21495;&#12290;&#27599;&#20010;&#32447;&#31243;&#23545;&#24212;&#30340;&#30446;&#24405;&#37324;&#33267;&#23569;&#26377;&#19968;&#20010; &#8220;name&#8221; &#25991;&#20214;&#65292;&#35835;&#21462;&#35813;&#25991;&#20214;&#21487;&#20197;&#24471;&#21040;&#32447;&#31243;&#30340;&#21517;&#23383; (<code>kmt-&gt;create</code> &#26102;&#30340;&#21442;&#25968;)&#12290;&#22240;&#27492;&#20320;&#30340; procfs &#23454;&#29616;&#30475;&#36215;&#26469;&#23601;&#26159;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>/
&#9492;&#9472;&#9472; proc
    &#9500;&#9472;&#9472; 1
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; name
    &#9500;&#9472;&#9472; 2
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; name
    &#9500;&#9472;&#9472; 4
    &#9474;&#160;&#160; &#9492;&#9472;&#9472; name
    &#9500;&#9472;&#9472; cpuinfo
    &#9492;&#9472;&#9472; meminfo
</code></pre></div>

<p class=" font-serif my-1">procfs &#20013;&#30340;&#30446;&#24405;&#21644;&#25991;&#20214;&#20250;&#26681;&#25454;&#32447;&#31243;&#30340;&#21019;&#24314;/&#21024;&#38500;&#21160;&#24577;&#21464;&#21270;&#12290;&#22240;&#27492;&#20320;&#35201;&#23567;&#24515;&#20197;&#19979;&#24773;&#20917;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#20351;&#29992; open &#25171;&#24320; <code>/proc</code> &#21518;&#35835;&#21462;&#21040;&#20102;&#32534;&#21495;&#20026; 10 &#30340;&#32447;&#31243;&#65307;</li>
<li class=" ml-8">&#25171;&#24320; <code>/proc/10/name</code> &#25104;&#21151;&#65307;</li>
<li class=" ml-8">&#27492;&#26102;&#32447;&#31243;&#32467;&#26463;&#36864;&#20986;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#26080;&#35770;&#20320;&#30340; read &#26159;&#36820;&#22238; EOF &#36824;&#26159;&#20381;&#28982;&#25104;&#21151;&#37117;&#26159;&#21512;&#29702;&#30340;&#65307;&#20294;&#20320;&#30340;&#25805;&#20316;&#31995;&#32479;&#19981;&#33021;&#22240;&#27492; crash&#12290;</p>
<h4 id="3-devfs" class=" pt-2 pb-2 font-sans">(3) devfs</h4>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">devfs &#26159;&#34394;&#25311;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#19981;&#28041;&#21450;&#20219;&#20309;&#35774;&#22791;&#12290;<red>&#19981;&#25903;&#25345;&#22312; devfs &#20013;&#20351;&#29992; vfs API &#21019;&#24314;&#25991;&#20214;/&#30446;&#24405;/&#38142;&#25509;</red>&#12290;</p>
</blockquote>
<p class=" font-serif my-1">devfs &#22909;&#20687;&#26159; &#8220;&#25346;&#36733;&#8221; &#22312; <code>/dev</code> &#19979;&#65292;devfs &#20013;&#33267;&#23569;&#38656;&#35201;&#21253;&#21547;&#20197;&#19979;&#25991;&#20214;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">zero (<code>/dev/zero</code>): &#21482;&#35835;&#65292;&#27704;&#36828;&#36820;&#22238; 0 &#30340;&#24207;&#21015;&#65307;</li>
<li class=" ml-8">null (<code>/dev/zero</code>): &#35835;&#20889;&#65292;&#35835;&#27704;&#36828;&#36820;&#22238; EOF&#65292;&#20889;&#25968;&#25454;&#30452;&#25509;&#25104;&#21151; (&#20002;&#24323;)&#65307;</li>
<li class=" ml-8">random (<code>/dev/random</code>): &#21482;&#35835;&#65292;&#36820;&#22238;&#38543;&#26426;&#30340;&#23383;&#33410;&#24207;&#21015;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#21516; procfs, &#25105;&#20204;&#21487;&#20197;&#20351;&#29992; vfs &#30340; API &#25171;&#24320;&#12289;&#35835;&#21462;&#12289;&#20889;&#20837;&#36825;&#20123;&#25991;&#20214;&#12290;</p>
<h3 id="227-mkfs" class=" text-lg mt-2 pb-2 font-sans">2.2.7 mkfs &#24037;&#20855;</h3>
<p class=" font-serif my-1">&#20320;&#19968;&#23450;&#30041;&#24847;&#21040; <code>tools/mkfs.c</code> &#36825;&#20010;&#25991;&#20214;&#20102;&#12290;&#20320;&#38656;&#35201;&#23454;&#29616;&#36825;&#20010; mkfs &#24037;&#20855;&#65292;&#23427;&#25509;&#21463;&#19977;&#20010;&#21442;&#25968; size, img &#21644; dir&#65292;&#23558;&#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#30446;&#24405; dir &#20013;&#30340;&#25152;&#26377;&#30446;&#24405;&#21644;&#25991;&#20214; &#8220;&#25171;&#21253;&#8221; &#21040; img &#38236;&#20687;&#25991;&#20214;&#20013;&#65292;&#24182;&#23558;&#38236;&#20687;&#25991;&#20214;&#30340;&#22823;&#23567;&#35774;&#32622;&#20026; size MiB&#12290;&#20363;&#22914;&#65292;&#20551;&#35774;&#24403;&#21069;&#30446;&#24405;&#20013;&#26377; fs-img:</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>fs-img
&#9500;&#9472;&#9472; a.txt
&#9500;&#9472;&#9472; b.txt
&#9492;&#9472;&#9472; t
    &#9492;&#9472;&#9472; tmp.txt
</code></pre></div>

<p class=" font-serif my-1">&#21017;&#25191;&#34892;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>mkfs 64 build/kernel-x86_64-qemu fs-img/
</code></pre></div>

<p class=" font-serif my-1">&#23558;&#20250;&#25226; &#8220;fs-img&#8221; &#20316;&#20026;&#20320;&#30913;&#30424;&#19978;&#25991;&#20214;&#31995;&#32479; (&#25968;&#25454;&#32467;&#26500;) &#30340;&#26681; (<code>/</code>)&#65292;&#20889;&#20837;&#21040; <code>build/kernel-x86_64-qemu</code> &#20013;&#65292;&#24182;&#23558;&#35813;&#25991;&#20214;&#30340;&#22823;&#23567;&#35774;&#32622;&#20026; 64 MiB&#12290;&#31616;&#21333;&#36215;&#35265;&#65292;&#20320;&#21487;&#20197;&#20551;&#35774; dir &#20013;&#19981;&#23384;&#22312;&#20219;&#20309;&#24418;&#24335;&#30340;&#38142;&#25509; (&#31526;&#21495;&#38142;&#25509;&#25110;&#30828;&#38142;&#25509;)&#12290;Online Judge &#20250;&#22312; make &#32534;&#35793;&#23436;&#25104;&#21518;&#12289;&#25191;&#34892;&#24320;&#22987;&#21069;&#35843;&#29992;&#20320;&#30340; mkfs &#24037;&#20855;&#65292;&#21019;&#24314;&#21021;&#22987;&#30340;&#38236;&#20687;&#65292;&#28982;&#21518;&#24320;&#22987;&#25191;&#34892;&#25991;&#20214;&#31995;&#32479;&#30340; workloads&#12290;&#25105;&#20204;&#22312;&#27979;&#35797;&#26102;&#65292;mkfs &#21019;&#24314;&#30340;&#38236;&#20687;&#19981;&#20250;&#36229;&#36807; AbstractMachine &#20013;&#30913;&#30424;&#30340;&#22823;&#23567; (&#22312;&#24403;&#21069;&#30340;&#23454;&#29616;&#20013;&#26159; 256 MiB)&#12290;</p>
<p class=" font-serif my-1">&#27880;&#24847; AbstractMachine &#30913;&#30424;&#38236;&#20687;&#26377;&#23427;&#22266;&#23450;&#30340;&#26684;&#24335;&#65306;</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/am-disk-img.png" width="500px"></p>
<p class=" font-serif my-1">&#21482;&#26377;&#22312; kernel &#30340; ELF &#25991;&#20214;&#20043;&#21518;&#30340;&#31354;&#38388;&#25165;&#26159;&#21487;&#29992;&#30340;&#12290;&#20026;&#20102;&#22312;&#30913;&#30424;&#19978;&#24314;&#31435;&#25991;&#20214;&#31995;&#32479;&#65292;&#20320;&#26377;&#20004;&#31181;&#21487;&#34892;&#30340;&#26041;&#27861;&#65292;&#21487;&#20197;&#20219;&#24847;&#36873;&#25321;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#25991;&#20214;&#31995;&#32479;&#30340;&#31532;&#19968;&#20010; block &#20174;&#22266;&#23450;&#30340;&#20301;&#32622;&#24320;&#22987;&#65292;&#20363;&#22914; 1 MiB &#30340;&#20301;&#32622;&#12290;&#36825;&#26679;&#20320;&#21487;&#33021;&#38656;&#35201;&#26816;&#26597;&#20108;&#36827;&#21046;&#25991;&#20214;&#30340;&#22823;&#23567;&#65292;&#22312;&#20108;&#36827;&#21046;&#25991;&#20214;&#36807;&#22823;&#26102;&#26174;&#31034;&#38169;&#35823;&#20449;&#24687;&#12290;</li>
<li class=" ml-8">&#25991;&#20214;&#31995;&#32479;&#30340;&#31532;&#19968;&#20010; block &#30001; ELF &#25991;&#20214;&#20915;&#23450;&#65292;&#20363;&#22914;&#30452;&#25509;&#22312; ELF &#25991;&#20214;&#20043;&#21518;&#12290;&#20320;&#38656;&#35201;&#25226;&#36825;&#20010; block &#30340;&#32534;&#21495; (&#20363;&#22914;&#25159;&#21306;&#21495;) &#20889;&#20837;&#21040;&#30913;&#30424;&#30340;&#24341;&#23548;&#25159;&#21306; (&#31532;&#19968;&#20010; 512 &#23383;&#33410;) &#20013;&#12290;</li>
</ul>
<h3 id="2210" class=" text-lg mt-2 pb-2 font-sans">2.2.10 &#22353;</h3>
<p class=" font-serif my-1">&#20320;&#20250;&#22312;&#23454;&#29616;&#25991;&#20214;&#31995;&#32479;&#30340;&#36807;&#31243;&#20013;&#36935;&#21040;&#21508;&#31181;&#21508;&#26679;&#30340;&#23567;&#40635;&#28902;&#65292;&#20363;&#22914;&#20320;&#39318;&#20808;&#36935;&#21040;&#30340;&#22353;&#26159; mkfs &#38656;&#35201;&#23558;&#25991;&#20214; &#8220;pad&#8221; &#21040;&#25351;&#23450;&#30340;&#22823;&#23567;&#65292;&#30913;&#30424;&#25165;&#33021;&#27491;&#30830;&#20889;&#20837;&#12290;&#22914;&#26524;&#38236;&#20687;&#25991;&#20214;&#21482;&#26377; 1 MiB&#65292;&#37027;&#20040;&#35835;&#21462;&#20043;&#21518;&#30340;&#23383;&#33410;&#37117;&#23558;&#24471;&#21040; 0&#12290;&#20320;&#35835;&#21040;&#36825;&#21477;&#35805;&#30340;&#26102;&#20505;&#65292;&#21487;&#33021;&#36935;&#21040;&#36807;&#36825;&#20010;&#38382;&#39064;&#24182;&#19988; debug &#24456;&#20037;&#20102;&#8212;&#8212;jyy &#35273;&#24471;&#35843;&#35797;&#21644;&#36208;&#36807;&#30340;&#24367;&#36335;&#37117;&#26159;&#38750;&#24120;&#23453;&#36149;&#30340;&#32463;&#39564;&#12290;</p>
<p class=" font-serif my-1">&#27599;&#20010;&#36827;&#31243;&#26377; &#8220;&#24403;&#21069;&#36335;&#24452;&#8221;&#65292;&#36890;&#24120;&#26159;&#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#19968;&#20010;&#21512;&#27861;&#30446;&#24405; (&#33267;&#23569;&#22312; chdir &#36820;&#22238;&#30340;&#30636;&#38388;&#65292;&#21542;&#21017; chdir &#24212;&#35813;&#36820;&#22238;&#22833;&#36133;)&#12290;&#20294;&#26159;&#65292;&#31995;&#32479;&#20013;&#30340;&#20854;&#20182;&#32447;&#31243; (&#29978;&#33267;&#24403;&#21069;&#32447;&#31243;) &#21487;&#33021;&#23558;&#36825;&#20010;&#30446;&#24405;&#21024;&#38500;&#12290;&#27492;&#26102;&#65292;&#20320;&#30340;&#31995;&#32479;&#30340;&#34892;&#20026;&#26159;&#20160;&#20040;&#65311;&#22914;&#26524;&#20877;&#32771;&#34385;&#21040; inode &#30340;&#22238;&#25910;&#65292;&#20320;&#20250;&#21457;&#29616;&#36825;&#20214;&#20107;&#36828;&#27604;&#20320;&#24819;&#35937;&#24471;&#22256;&#38590;&#8212;&#8212;&#20320;&#38656;&#35201;&#38750;&#24120;&#20180;&#32454;&#22320;&#35774;&#35745;&#20854;&#20013;&#30340;&#23545;&#35937;&#32467;&#26500;&#12289;&#24341;&#29992;&#35745;&#25968;&#31561;&#65292;&#25991;&#20214;&#31995;&#32479;&#30340;&#23454;&#29616;&#24182;&#19981;&#21482;&#26159; &#8220;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#32467;&#8221;&#65292;&#25105;&#20204;&#36824;&#24517;&#39035;&#27491;&#30830;&#23454;&#29616;&#23427;&#22312;&#20869;&#23384;&#20013;&#30340;&#35270;&#22270;&#12290;</p>
<p class=" font-serif my-1">&#20320;&#19981;&#22952;&#22312; Linux &#31995;&#32479;&#37324;&#35797;&#19968;&#35797;&#65292;&#22914;&#26524;&#22788;&#20110;&#19968;&#20010;&#34987;&#21024;&#38500;&#30340;&#30446;&#24405;&#20250;&#21457;&#29983;&#20160;&#20040;&#8212;&#8212;&#26080;&#35770;&#22914;&#20309;&#21487;&#20197;&#32943;&#23450;&#30340;&#26159;&#65292;Linux &#31995;&#32479;&#19981;&#20250; crash&#65292;&#20294;&#20320;&#30340;&#25805;&#20316;&#31995;&#32479;&#21487;&#33021;&#23601;&#20250;&#20102;&#12290;&#24403;&#28982;&#65292;&#25105;&#20204;&#30340;&#27979;&#35797;&#29992;&#20363;&#20013;&#27809;&#26377;&#36825;&#31181;&#24773;&#20917;&#8212;&#8212;&#25105;&#20204;&#30340;&#27979;&#35797;&#29992;&#20363;&#20013;&#25152;&#26377;&#30340;&#35775;&#38382;&#37117;&#26159;&#21512;&#27861;&#30340;&#12290;&#20570;&#23545;&#25152;&#26377;&#30340; error handling &#26159;&#20010;&#26497;&#20855;&#25361;&#25112;&#30340;&#38382;&#39064;&#65292;&#29978;&#33267; Linux Kernel &#37117;&#20570;&#24471;&#19981;&#22815;&#22909;&#12290;</p>
<p class=" font-serif my-1">&#25991;&#20214;&#31995;&#32479;&#30340; API &#30475;&#20284;&#31616;&#21333;&#65292;&#20294;&#20854;&#23454;&#38543;&#22788;&#37117;&#20805;&#28385;&#20102;&#21508;&#31181;&#21508;&#26679;&#30340;&#22353; (&#20363;&#22914;&#22914;&#20309;&#36827;&#34892;&#36335;&#24452;&#35299;&#26512;&#12289;&#22914;&#20309;&#23558;&#25805;&#20316;&#36716;&#21457;&#21040;&#23545;&#24212;&#30340;&#25991;&#20214;&#31995;&#32479;&#23454;&#29616;&#31561;&#31561;)&#12290;&#22312;&#36825;&#37324; jyy &#35201;&#35686;&#21578;&#22823;&#23478;&#65306;&#35831;&#30041;&#24847;&#20320;&#39033;&#30446;&#20195;&#30721;&#30340;&#32452;&#32455;&#21644;&#35774;&#35745;&#12290;&#22914;&#26524;&#20320;&#30452;&#25509; &#8220;&#19981;&#31649;&#19968;&#20999;&#8221; &#22320;&#32534;&#31243;&#65292;&#24456;&#24555;&#23601;&#20250;&#24471;&#21040;&#33192;&#32960;&#19988;&#38590;&#20197;&#32500;&#25252;&#30340;&#20195;&#30721;&#12290;&#20919;&#38745;&#19979;&#26469;&#35835;&#19968;&#35835; xv6 &#30340;&#20195;&#30721;&#26159;&#20010;&#19981;&#38169;&#30340;&#36873;&#25321;&#12290;</p>
<h2 id="3" class=" text-xl mt-2 pb-2 font-sans">3. &#27491;&#30830;&#24615;&#26631;&#20934;</h2>
<h3 id="31" class=" text-lg mt-2 pb-2 font-sans">3.1 &#25991;&#20214;&#31995;&#32479;&#23454;&#29616;</h3>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_3" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#27880;&#24847;&#65306;&#35843;&#35797;&#36755;&#20986;</h4>
<p class=" font-serif my-1">&#21516;&#19978;&#19968;&#20010;&#23454;&#39564;&#65292;&#35831;&#23613;&#37327;<strong>&#19981;&#35201;&#25171;&#21360;&#22810;&#20313;&#30340;&#36755;&#20986;</strong>&#12290;&#34429;&#28982;&#25105;&#20204;&#30340;&#26816;&#26597;&#20195;&#30721;&#20250;&#36827;&#34892;&#19968;&#23450;&#30340;&#36807;&#28388;&#65292;&#20294;&#22240;&#20026;&#22810;&#22788;&#29702;&#22120;&#30340;&#24182;&#21457;&#65292;&#20320;&#22312;&#20854;&#20182;&#22788;&#29702;&#22120;&#19978;&#30340;&#36755;&#20986;&#21487;&#33021;&#20250;&#24433;&#21709;&#25105;&#20204;&#30340;&#26816;&#26597;&#36755;&#20986;&#65292;&#20174;&#32780;&#23548;&#33268; Wrong Answer&#12290;&#22240;&#27492;&#25105;&#20204;&#24314;&#35758;&#20320;&#20351;&#29992;&#33258;&#24049;&#30340; log &#25110; printk &#20989;&#25968; (&#32780;&#19981;&#26159; printf; &#25105;&#20204;&#30340;&#27979;&#35797;&#31243;&#24207;&#20250;&#20351;&#29992; printf)&#65292;&#19988;&#23427;&#20204;&#30340;&#34892;&#20026;&#30001;&#39044;&#32534;&#35793;&#25351;&#20196;&#25511;&#21046;&#65292;&#20165;&#22312;&#20320;&#26412;&#22320;&#32534;&#35793;&#26102;&#25165;&#25171;&#21360;&#25968;&#25454;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#22312;&#36825;&#20010;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#20250;&#39318;&#20808;&#20351;&#29992;&#20320;&#30340; mkfs &#24037;&#20855;&#21021;&#22987;&#21270;&#25991;&#20214;&#31995;&#32479;&#65292;&#28982;&#21518;&#21551;&#21160;&#34394;&#25311;&#26426;&#12289;&#21019;&#24314;&#33509;&#24178;&#32447;&#31243;&#65292;&#36830;&#32493;&#35843;&#29992;&#25991;&#20214;&#31995;&#32479; API&#65292;&#26681;&#25454;&#25991;&#20214;&#31995;&#32479; API &#30340;&#36755;&#20986;&#20915;&#23450;&#20320;&#23454;&#29616;&#30340;&#27491;&#30830;&#24615;&#12290;&#22312; easy tests &#20013;&#65292;&#25105;&#20204;&#21482;&#21019;&#24314;&#19968;&#20010;&#32447;&#31243;&#65292;&#39034;&#24207;&#22320;&#25191;&#34892;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#65292;&#24182;&#26816;&#26597;&#25991;&#20214;&#31995;&#32479;&#30340;&#21151;&#33021;&#23454;&#29616;&#12290;&#22312; hard tests &#20013;&#65292;&#25105;&#20204;&#20250;&#21019;&#24314;&#33509;&#24178;&#32447;&#31243;&#25191;&#34892;&#19968;&#31995;&#21015;&#30340;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#12290;&#25191;&#34892;&#30340;&#25805;&#20316;&#21487;&#33021;&#26377;&#19968;&#23450;&#30340;&#38543;&#26426;&#24615;&#65292;&#24182;&#19988;&#22240;&#20026;&#24182;&#21457;&#31243;&#24207;&#30340;&#19981;&#30830;&#23450;&#24615;&#65292;&#20320;&#23558;&#20250;&#39044;&#26399;&#27599;&#27425;&#25191;&#34892;&#30340;&#32467;&#26524;&#37117;&#26377;&#19968;&#20123;&#19981;&#21516;&#65292;&#20294;&#20320;&#38656;&#35201;&#23454;&#29616;&#21487;&#20018;&#34892;&#21270; (serializable) &#30340;&#25991;&#20214;&#31995;&#32479;&#65306;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#30340;&#32467;&#26524;&#30475;&#36215;&#26469;&#20687;&#26159;&#25152;&#26377;&#25191;&#34892;&#36807;&#30340;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#25490;&#25104;&#26576;&#20010;&#39034;&#24207;&#25191;&#34892;&#30340;&#12290;&#26368;&#31616;&#21333;&#30340;&#23454;&#29616;&#21487;&#20018;&#34892;&#21270;&#30340;&#26041;&#24335;&#23601;&#26159;&#20026;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#21152;&#19978;&#20114;&#26021;&#38145;&#65292;&#21487;&#20197;&#20351;&#29992;&#20449;&#21495;&#37327;&#30340; P/V &#25805;&#20316;&#23454;&#29616;&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_4" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#27880;&#24847;&#65306;&#19978;&#38145;&#30340;&#31890;&#24230;</h4>
<p class=" font-serif my-1">&#30913;&#30424;&#26159;&#24930;&#36895;&#35774;&#22791;&#65307;&#19968;&#20010;&#25991;&#20214;&#31995;&#32479;&#30340;&#25805;&#20316;&#21487;&#33021;&#36739;&#38271;&#65292;&#20351;&#29992;&#33258;&#26059;&#38145;&#21487;&#33021;&#20250;&#23548;&#33268;&#20013;&#26029;&#20002;&#22833;&#12289;&#39269;&#39295;&#31561;&#21518;&#26524; (&#39269;&#39295;&#24847;&#21619;&#30528;&#20320;&#26080;&#27861;&#36798;&#21040;&#26368;&#23567;&#30340;&#24615;&#33021;&#35201;&#27714;&#20174;&#32780; Wrong Answer)&#12290;&#22914;&#26524;&#20320;&#24076;&#26395;&#20511;&#29992; Lab2 &#20013;&#30340;&#21516;&#27493;&#21407;&#35821;&#65292;&#35831;&#20351;&#29992;&#20449;&#21495;&#37327;&#23454;&#29616;&#30340;&#20114;&#26021;&#38145;&#65292;&#22312;&#32447;&#31243;&#26080;&#27861;&#33719;&#24471;&#38145;&#26102;&#30561;&#30496;&#12290;
</p>
</blockquote>
<p class=" font-serif my-1">&#25152;&#26377;&#27979;&#35797;&#29992;&#20363;&#30340;&#25991;&#20214;&#31995;&#32479;&#35843;&#29992;&#22343;&#22312;&#20351;&#29992; <code>kmt-&gt;create</code> &#21019;&#24314;&#30340;&#32447;&#31243;&#20013;&#35843;&#29992;&#8212;&#8212;&#22240;&#20026;&#25991;&#20214;&#25551;&#36848;&#31526;&#26159;&#32447;&#31243;&#30340;&#19968;&#37096;&#20998;&#65292;&#25105;&#20204;&#19981;&#20250;&#22312;&#25805;&#20316;&#31995;&#32479;&#21551;&#21160;/&#21021;&#22987;&#21270;/&#20013;&#26029;&#26102;&#25191;&#34892;&#23545;&#25991;&#20214;&#31995;&#32479;&#30340;&#25805;&#20316;&#12290;</p>
<p class=" font-serif my-1">&#20026;&#20102;&#23613;&#21487;&#33021;&#22320;&#35753;&#25152;&#26377;&#21516;&#23398;&#33021;&#23436;&#25104; Lab3&#65292;&#25105;&#20204;&#30340;&#27979;&#35797;&#29992;&#20363;&#34429;&#28982;&#20250;&#21019;&#24314;&#32447;&#31243;&#65292;&#20294;&#32447;&#31243;&#19981;&#20250;&#32456;&#27490; (&#25191;&#34892;&#23436;&#25152;&#26377;&#25805;&#20316;&#30340;&#32447;&#31243;&#20250;&#25191;&#34892;&#27515;&#24490;&#29615;&#25110; yield)&#65292;&#20063;&#19981;&#35843;&#29992;&#20449;&#21495;&#37327; (&#20250;&#35843;&#29992;&#33258;&#26059;&#38145;)&#65292;&#36825;&#26679;&#21363;&#20415;&#20320;&#30340; Lab2 &#23454;&#29616;&#26377;&#19968;&#23450;&#38382;&#39064;&#65292;&#20063;&#21487;&#20197;&#36890;&#36807;&#19968;&#23450;&#30340;&#27979;&#35797;&#29992;&#20363;&#12290;</p>
<h3 id="32" class=" text-lg mt-2 pb-2 font-sans">3.2 &#25968;&#25454;&#30340;&#25345;&#20037;&#24615;</h3>
<p class=" font-serif my-1">&#22312;&#36825;&#20010;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#19981;&#35201;&#27714;&#20320;&#23454;&#29616;&#28385;&#36275;&#23849;&#28291;&#19968;&#33268;&#24615;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#20063;&#27809;&#26377;&#25552;&#20379; fsync &#30340;&#25509;&#21475;&#65306;&#25105;&#20204;&#20551;&#35774;&#20320;&#30340;&#25968;&#25454;&#28385;&#36275; &#8220;eventual consistency&#8221;&#65292;&#21363;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#32467;&#26500;&#22312;&#27809;&#26377;&#26356;&#22810;&#25805;&#20316;&#21040;&#26469;&#26102;&#65292;&#20250;&#36798;&#21040;&#19968;&#33268;&#30340;&#29366;&#24577;&#12290;&#25105;&#20204;&#30340;&#27979;&#35797;&#25968;&#25454;&#20250;&#22312;&#25152;&#26377;&#30340;&#30913;&#30424;&#25805;&#20316;&#20043;&#21518;&#31561;&#24453;&#19968;&#31186;&#38047; (1000ms)&#65292;&#28982;&#21518;&#20851;&#38381;&#34394;&#25311;&#26426;&#12290;&#20877;&#27425;&#37325;&#21551;&#21518;&#65292;ufs &#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#25968;&#25454;&#24212;&#24403;&#34987;&#27491;&#30830;&#25345;&#20037;&#21270;&#65292;&#20363;&#22914;&#20043;&#21069;&#21019;&#24314;&#30340;&#30446;&#24405;&#21644;&#25991;&#20214;&#27492;&#26102;&#24212;&#35813;&#33021;&#22815;&#27491;&#30830;&#35775;&#38382;&#65292;&#33021;&#35835;&#21462;&#20986;&#27491;&#30830;&#30340;&#25968;&#25454;&#12290;&#22914;&#26524;&#20320;&#20351;&#29992;&#20102;&#31867;&#20284; buffer cache &#30340;&#32467;&#26500;&#23545;&#30913;&#30424;&#30340;&#35835;&#20889;&#36827;&#34892;&#20102;&#32531;&#23384;&#65292;&#35831;&#20320;&#30830;&#20445;&#22312;&#22312;&#36827;&#34892;&#25991;&#20214;&#31995;&#32479;&#35843;&#29992;&#20043;&#21518;&#30340; 1s &#20869;&#23558;&#25968;&#25454;&#25345;&#20037;&#21270;&#21040;&#30913;&#30424;&#12290;&#20363;&#22914;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">&#20320;&#21487;&#20197;&#36873;&#25321;&#26368;&#31616;&#21333;&#30340;&#23454;&#29616;&#65292;&#21363;&#27599;&#20010;&#25991;&#20214;&#31995;&#32479;&#25805;&#20316;&#37117;&#31435;&#21363;&#20889;&#20837;&#30913;&#30424;&#65292;&#22312;&#26368;&#21518;&#19968;&#20010;&#31995;&#32479;&#25805;&#20316;&#36820;&#22238;&#26102;&#65292;&#30913;&#30424;&#21363;&#22788;&#20110; consistent &#30340;&#29366;&#24577;&#12290;</li>
<li class=" ml-8">&#20320;&#21487;&#20197;&#26500;&#24314;&#33258;&#24049;&#30340;&#32531;&#23384;&#65292;&#26377;&#19968;&#20010;&#21518;&#21488;&#30340; daemon (&#31867;&#20284; jbd) &#23436;&#25104;&#30913;&#30424;&#30340;&#20889;&#22238;&#12290;&#25105;&#20204;&#24314;&#35758;&#20889;&#22238;&#30340;&#39057;&#29575;&#22312; 500ms&#65292;&#36825;&#26679;&#26377;&#36275;&#22815;&#30340;&#26102;&#38388;&#23558;&#25345;&#20037;&#25968;&#25454;&#20889;&#20837;&#30913;&#30424; (&#34429;&#28982;&#23545;&#20110;&#23454;&#38469;&#30340;&#31995;&#32479;&#65292;&#20889;&#22238;&#30340;&#39057;&#29575;&#20250;&#26356;&#20302;&#19968;&#20123;&#65292;&#20197;&#20943;&#23569;&#30913;&#30424;&#30340;&#24102;&#23485;)&#12290;</li>
</ol>
<h2 id="4" class=" text-xl mt-2 pb-2 font-sans">4. &#23454;&#39564;&#25351;&#21335;</h2>
<p class=" font-serif my-1">&#22312;&#24320;&#22987;&#23454;&#29616;&#20043;&#21069;&#8212;&#8212;&#20877;&#22238;&#39038;&#19968;&#19979;&#36825;&#21477;&#35805;&#65306;&#25991;&#20214;&#31995;&#32479;&#26159;&#19968;&#20010;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#32467;&#26500;&#12290;&#25152;&#20197;&#65292;&#23601;&#25226;&#23427;&#24403;&#25104;&#26159;&#19968;&#20010;&#25968;&#25454;&#32467;&#26500;&#38382;&#39064;&#65292;&#29992; &#8220;&#25277;&#35937;&#25968;&#25454;&#31867;&#22411;&#8221; &#21435;&#32771;&#34385;&#23427;&#30340;&#23454;&#29616;&#12290;</p>
<h3 id="41" class=" text-lg mt-2 pb-2 font-sans">4.1 &#25991;&#20214;&#31995;&#32479;&#23454;&#29616;&#65306;&#22522;&#30784;</h3>
<p class=" font-serif my-1">&#23454;&#29616;&#25991;&#20214;&#31995;&#32479;&#20013;&#26368; &#8220;&#22522;&#30784;&#8221; &#30340;&#25805;&#20316;&#26159;&#32473;&#23450;&#19968;&#20010;&#36335;&#24452; (&#32477;&#23545;&#25110;&#30456;&#23545;&#24403;&#21069;&#32447;&#31243;&#30340;&#24403;&#21069;&#36335;&#24452;)&#65292;&#23545;&#36335;&#24452;&#36827;&#34892;&#35299;&#26512;&#65292;&#28982;&#21518;&#36820;&#22238;&#30456;&#24212;&#30340; inode&#12290;&#36947;&#29702;&#30475;&#36215;&#26469;&#31616;&#21333;&#65292;&#20294;&#21364;&#28041;&#21450;&#25991;&#20214;&#31995;&#32479;&#30340;&#21508;&#20010;&#37096;&#20998;&#65292;&#20063;&#35768;&#26377;&#20123;&#32454;&#33410;&#23601;&#26159;&#20320;&#27809;&#26377;&#32771;&#34385;&#21040;&#30340;&#12290;</p>
<p class=" font-serif my-1">&#39318;&#20808;&#65292;inode &#19981;&#20165;&#26159;&#23384;&#20648;&#22312;&#30913;&#30424;&#19978;&#30340;&#25968;&#25454;&#32467;&#26500; (&#38024;&#23545; ufs &#32780;&#35328;)&#65292;&#36824;&#38656;&#35201;&#22312;&#20869;&#23384;&#20013;&#20998;&#37197;&#65307;&#34394;&#25311;&#30340;&#25991;&#20214;&#31995;&#32479; (&#20363;&#22914; procfs) &#36824;&#38656;&#35201;&#32500;&#25252;&#19968;&#20123; inode &#31169;&#26377;&#30340;&#20869;&#23384;&#25968;&#25454; (&#20363;&#22914; procfs)&#12290;&#22914;&#20309;&#31649;&#29702;&#36825;&#20123;&#25968;&#25454;&#65311;&#22914;&#20309;&#31649;&#29702;&#20869;&#23384;&#20013; inode &#30340;&#29983;&#23384;&#21608;&#26399;&#65311;&#20320;&#31435;&#21363;&#20250;&#24819;&#21040;&#19968;&#20123;&#38382;&#39064;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">&#22312;&#35299;&#26512;&#36335;&#24452;&#26102;&#65292;&#20363;&#22914; <code>/this/is/a/very/long/path</code> &#26102;&#65292;&#25105;&#20204;&#20250;&#21382;&#32463;&#22810;&#20010; inode &#30340;&#35775;&#38382;&#65292;&#20363;&#22914; <code>/</code>, <code>/this</code>, <code>/this/is</code>, ... &#25105;&#20204;&#20250;&#22312;&#36825;&#20123; inode &#19978;&#20998;&#21035;&#25191;&#34892; open &#25805;&#20316;&#65292;&#30452;&#21040;&#30830;&#23450;&#35201;&#25171;&#24320;&#30340; inode &#20026;&#27490;&#65307;</li>
<li class=" ml-8">&#32447;&#31243; (&#36827;&#31243;) &#26377;&#33258;&#24049;&#30340; &#8220;&#24403;&#21069;&#30446;&#24405;&#8221;&#65292;&#25152;&#26377;&#28041;&#21450;&#36335;&#24452;&#30340;&#31995;&#32479;&#35843;&#29992;&#65292;&#24403;&#32473;&#23450;&#30340;&#36335;&#24452;&#19981;&#26159;&#20197; <code>/</code> &#24320;&#22836;&#26102;&#65292;&#37117;&#26159;&#30456;&#23545;&#24403;&#21069;&#36827;&#31243;&#30340; &#8220;&#24403;&#21069;&#30446;&#24405;&#8221; &#36827;&#34892;&#35299;&#26512;&#30340;&#65307;</li>
<li class=" ml-8">&#25171;&#24320;&#30340; inode &#20250;&#21382;&#32463;&#21508;&#31181;&#25805;&#20316;&#65292;&#20363;&#22914;&#20174;&#25991;&#20214;&#31995;&#32479;&#20013; unlink&#12290;&#27492;&#26102;&#21487;&#33021;&#26377;&#19968;&#20010;&#36827;&#31243;&#25345;&#26377;&#35813; inode &#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#65292;&#24182;&#19988;&#27491;&#22312;&#21521;&#25991;&#20214;&#35835;&#20889;&#25968;&#25454;&#12290;&#27492;&#26102;&#20250;&#21457;&#29983;&#20160;&#20040;&#65311;&#26159;&#21542;&#20250;&#26377;&#19968;&#26041;&#36820;&#22238;&#22833;&#36133;&#65311;&#35831;&#20320;&#22312; Linux &#20013;&#35797;&#19968;&#35797;&#12290;</li>
</ol>
<p class=" font-serif my-1">&#21482;&#35201;&#20320;&#22312;&#20869;&#23384;&#20013;&#23454;&#29616; <code>struct inode</code>, &#20320;&#23601;&#24517;&#39035;&#23567;&#24515;&#22320;&#31649;&#29702;&#23427;&#30340;&#29983;&#23384;&#21608;&#26399;&#8212;&#8212;&#24403;&#32447;&#31243;&#21019;&#24314;&#12289;&#38144;&#27585;&#12289;&#25991;&#20214;&#20851;&#38381;&#8230;&#8230;&#21508;&#31181;&#26102;&#21051;&#65292;&#20320;&#37117;&#35201;&#23567;&#24515;&#22320;&#32500;&#25252;&#20869;&#23384;&#20013;&#30340; inodes&#65292;&#20351;&#24471;&#23427;&#20204;&#22312;&#19981;&#20877;&#20351;&#29992;&#26102; (&#25110;&#32773;&#26159;&#22312;&#21487;&#20197;&#37322;&#25918;&#21518;&#19968;&#27573;&#26102;&#38388;&#21518;) &#33021;&#34987;&#23433;&#20840;&#22320;&#37322;&#25918;&#65292;&#24182;&#19988;&#19981;&#24341;&#36215; double-free, use-after-free &#31561;&#38382;&#39064;&#12290;&#24341;&#29992;&#35745;&#25968;&#26159;&#20010;&#24456;&#22909;&#30340;&#26426;&#21046;&#65292;&#20294;&#20320;&#24517;&#39035;&#35201;&#23567;&#24515;&#22320;&#31649;&#29702;&#24341;&#29992;&#8212;&#8212;&#19968;&#26086;&#26576;&#20010;&#24341;&#29992;&#21457;&#29983;&#22797;&#21046;&#26102;&#20320;&#24536;&#35760;&#22686;&#21152;&#24341;&#29992;&#35745;&#25968;&#65292;&#23601;&#24847;&#21619;&#30528;&#31243;&#24207;&#37324;&#21487;&#33021;&#20250;&#20986;&#29616;&#20005;&#37325;&#30340;&#38382;&#39064;&#12290;</p>
<p class=" font-serif my-1">&#36335;&#24452;&#35299;&#26512;&#30340;&#26680;&#24515;&#26159;&#32473;&#23450;&#19968;&#20010; inode (&#20551;&#35774;&#20320;&#24050;&#32463;&#36733;&#20837;&#20869;&#23384;&#65292;&#24182;&#19988;&#30830;&#20445;&#26159;&#19968;&#20010;&#30446;&#24405;&#25991;&#20214;)&#65292;&#28982;&#21518;&#35835;&#21462;&#36825;&#20010;&#30446;&#24405;&#25991;&#20214;&#20013;&#30340;&#30446;&#24405;&#39033; (&#36890;&#36807;&#25991;&#20214;&#31995;&#32479;&#30340; read &#25805;&#20316;)&#65292;&#25214;&#21040;&#21517;&#23383;&#21305;&#37197;&#30340; inode &#32534;&#21495;&#65292;&#36882;&#24402;&#36825;&#20010;&#36807;&#31243;&#23601;&#33021;&#23436;&#25104;&#36335;&#24452;&#35299;&#26512;&#8212;&#8212;&#25105;&#20204;&#20063;&#40723;&#21169;&#20320;&#23454;&#29616;&#25104;&#36882;&#24402;&#30340;&#65292;&#36825;&#20250;&#22823;&#22823;&#31616;&#21270;&#20320;&#30340;&#23454;&#29616;&#12290;</p>
<p class=" font-serif my-1">&#36335;&#24452;&#35299;&#26512;&#30340;&#21478;&#19968;&#20010;&#26377;&#36259;&#30340;&#38382;&#39064;&#26159;&#22788;&#29702; <code>/proc</code>, <code>/dev</code> &#36825;&#26679;&#30340;&#25346;&#36733;&#28857; (mount point)&#12290;&#20320;&#24212;&#35813;&#33021;&#24819;&#21040;&#19968;&#20010;&#36890;&#29992;&#30340;&#23454;&#29616;&#25346;&#36733;&#30340;&#26041;&#26696;&#65292;&#36825;&#26679;&#20320;&#30340;&#25991;&#20214;&#31995;&#32479;&#33021;&#25346;&#36733;&#21040;&#30446;&#24405;&#26641;&#30340;&#20219;&#20309;&#22320;&#26041;&#8212;&#8212;Linux/UNIX &#30340;&#30830;&#23601;&#26159;&#36825;&#26679;&#23454;&#29616;&#30340;&#12290;</p>
<h3 id="42" class=" text-lg mt-2 pb-2 font-sans">4.2 &#22810;&#20010;&#25991;&#20214;&#31995;&#32479;&#30340;&#20849;&#23384;</h3>
<p class=" font-serif my-1">&#22312;&#36335;&#24452;&#35299;&#26512;&#30340;&#36807;&#31243;&#20013;&#65292;&#20320;&#20250;&#24847;&#35782;&#21040;&#25105;&#20204;&#27599;&#20010;&#25991;&#20214;&#31995;&#32479;&#30340; &#8220;&#25968;&#25454;&#32467;&#26500;&#8221; &#37117;&#19981;&#22826;&#19968;&#26679;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">ufs &#30340;&#25991;&#20214;&#21644;&#30446;&#24405;&#37117;&#20197;&#19968;&#20010;&#31867;&#20284; UNIX &#25991;&#20214;&#31995;&#32479;&#30340;&#35774;&#35745;&#26041;&#24335;&#23384;&#20648;&#22312;&#30913;&#30424;&#19978;&#65292;&#22240;&#27492;&#23545; ufs &#25991;&#20214;&#21644;&#30446;&#24405;&#30340;&#20462;&#25913;&#38656;&#35201;&#32763;&#35793;&#25104; <code>sda</code> &#35774;&#22791;&#19978;&#30340;&#35835;&#20889;&#25805;&#20316;&#65307;</li>
<li class=" ml-8">procfs &#30340;&#30446;&#24405;&#26159;&#21160;&#24577;&#21019;&#24314;&#30340; (&#24182;&#19988;&#19981;&#22312;&#25345;&#20037;&#23384;&#20648;&#19978;&#65292;&#32780;&#26159;&#26681;&#25454;&#24403;&#21069;&#30340;&#32447;&#31243;)&#65292;&#22240;&#27492;&#20320;&#38656;&#35201;&#36941;&#21382;&#31995;&#32479;&#20013;&#30340; <code>struct task</code>&#65292;&#24182;&#19988;&#23558;&#32447;&#31243;&#20449;&#24687;&#20889;&#20837;&#32531;&#20914;&#21306;&#20013;&#65292;&#28982;&#21518;&#36820;&#22238;&#32473;&#23545; procfs &#30340; read&#65307;</li>
<li class=" ml-8">devfs &#30340;&#27599;&#20010;&#25991;&#20214;&#37117;&#26377;&#19968;&#20010;&#23545;&#24212;&#30340;&#35774;&#22791; (&#21487;&#33021;&#26159;&#34394;&#25311;&#30340;&#12289;&#21487;&#33021;&#26159;&#23454;&#38469;&#23384;&#22312;&#30340;)&#65292;&#23545;&#20110;&#23454;&#38469;&#23384;&#22312;&#30340;&#35774;&#22791;&#65292;&#20320;&#38656;&#35201;&#35843;&#29992;&#35774;&#22791;&#30340; read/write; &#32780;&#23545;&#20110;&#34394;&#25311;&#30340;&#35774;&#22791;&#65292;&#20320;&#38656;&#35201;&#21521;&#35835;&#32773;&#25552;&#20379;&#27491;&#30830;&#30340;&#25968;&#25454;&#65292;&#25110;&#26159;&#27169;&#25311;&#21521;&#35774;&#22791;&#30340;&#20889;&#20837;&#12290;</li>
</ol>
<p class=" font-serif my-1">&#20320;&#38656;&#35201;&#20026;&#27599;&#19968;&#20010;&#25991;&#20214;&#31995;&#32479;&#30340;&#37117;&#23454;&#29616;&#19968;&#22871;&#25991;&#20214;/&#30446;&#24405;&#30340; API&#8212;&#8212;&#36825;&#20063;&#23601;&#26159;&#20026;&#20160;&#20040;&#36825;&#20010;&#23454;&#39564;&#26174;&#24471;&#22797;&#26434;&#30340;&#21407;&#22240;&#12290;&#22914;&#26524;&#20320;&#20351;&#29992;&#32039;&#32806;&#21512;&#30340;&#26041;&#24335;&#23454;&#29616;&#65292;&#20320;&#30340;&#20195;&#30721;&#24456;&#23481;&#26131;&#20250;&#38519;&#20837;&#19981;&#21487;&#32500;&#25252;&#30340;&#27877;&#28525;&#65307;&#20363;&#22914;&#20165;&#20165;&#26159;&#20889;&#19968;&#20010; &#8220;&#20195;&#30721;&#26694;&#26550;&#8221; &#23601;&#24050;&#32463;&#22312;&#35270;&#35273;&#19978;&#30475;&#36215;&#26469;&#19981;&#22826;&#21451;&#22909;&#20102;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">vfs_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">oflies</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span><span class="w"> </span><span class="c1">// &#21462;&#20986;&#25968;&#25454;&#32467;&#26500;</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">abort</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FS_PROCFS</span><span class="p">:</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FS_DEVFS</span><span class="p">:</span>
<span class="w">      </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getdev</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DEV_NULL</span><span class="p">:</span>
<span class="w">          </span><span class="p">...</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">DEV_RANDOM</span><span class="p">:</span>
<span class="w">          </span><span class="p">...</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="c1">// &#20854;&#20182;&#35774;&#22791;&#65292;&#36716;&#21457;&#32473;&#35774;&#22791;&#39537;&#21160;</span>
<span class="w">          </span><span class="p">...</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FS_UFS</span><span class="p">:</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="p">...</span>
<span class="nl">abort</span><span class="p">:</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#22240;&#27492;&#65292;&#22312;&#36825;&#37324;&#26377;&#24517;&#35201;&#20570;&#19968;&#28857; &#8220;&#38754;&#21521;&#23545;&#35937;&#32534;&#31243;&#8221;&#12290;&#25105;&#20204;&#19981;&#22952;&#25226; &#8220;&#25991;&#20214;&#31995;&#32479;&#8221; &#21644; &#8220;&#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#25991;&#20214; (&#21253;&#25324;&#30446;&#24405;&#25991;&#20214;)&#8221; &#37117;&#20197;&#23545;&#35937;&#30340;&#24418;&#24335;&#21253;&#35013;&#36215;&#26469;&#12290;&#20320;&#31435;&#21363;&#23601;&#24819;&#21040;&#20102;&#65292;&#25105;&#20204;&#30340;&#26694;&#26550;&#20195;&#30721;&#20854;&#23454;&#24050;&#32463;&#20570;&#20102;&#24456;&#22810;&#38754;&#21521;&#23545;&#35937;&#30340;&#23553;&#35013;&#20102;&#65281;&#20363;&#22914;&#25105;&#20204;&#30340;&#25972;&#20010;&#25805;&#20316;&#31995;&#32479;&#30340; &#8220;&#27169;&#22359;&#8221; &#23601;&#26159;&#38754;&#21521;&#23545;&#35937;&#30340;&#65292;&#19968;&#20010;&#27169;&#22359;&#23601;&#26159;&#19968;&#20010;&#23545;&#35937;&#12290;&#21478;&#22806;&#19968;&#20010;&#20540;&#24471;&#22823;&#23478;&#21442;&#32771;&#30340;&#26159;&#25105;&#20204;&#23545; I/O &#35774;&#22791;&#36827;&#34892;&#30340;&#23553;&#35013;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">devops</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="n">device_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">devops_t</span><span class="p">;</span>
</code></pre></div>

<p class=" font-serif my-1">&#28982;&#21518;&#25105;&#20204;&#23601;&#33021;&#36827;&#34892; &#8220;&#38754;&#21521;&#23545;&#35937;&#8221; &#30340;&#35843;&#29992;&#20102;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">d</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="c1">// d: pointer to struct dev</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#26679;&#30340;&#20889;&#27861;&#22312; C++ &#20013;&#21487;&#20197;&#26356;&#31934;&#31616;&#65292;&#20363;&#22914; C++ &#30340;&#23545;&#35937;&#33258;&#24102;&#20989;&#25968;&#65292;&#21487;&#20197;&#30465;&#30053; &#8220;this&#8221; &#30340;&#35843;&#29992;&#12290;&#20197;&#21450; C++ &#25903;&#25345;&#31867;&#30340;&#32487;&#25215;&#21644;&#34394;&#20989;&#25968;&#8212;&#8212;&#34394;&#20989;&#25968;&#23601;&#26159;&#29992;&#31867;&#20284; <code>devops_t</code> &#23454;&#29616;&#30340;&#65281;&#27599;&#20010;&#23545;&#35937;&#30340;&#22836;&#37096;&#37117;&#26377;&#19968;&#20010;&#31216;&#20026; &#8220;vtable&#8221; &#30340;&#25968;&#25454;&#32467;&#26500;&#65292;&#25351;&#21521;&#20102;&#23427;&#34394;&#20989;&#25968;&#23454;&#29616;&#30340;&#22320;&#22336;&#12290; </p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">d</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w"> </span><span class="c1">// d: reference of a Device object</span>
</code></pre></div>

<p class=" font-serif my-1">&#20320;&#20063;&#21487;&#20197;&#23545;&#25991;&#20214;&#31995;&#32479;/&#25991;&#20214;&#30340;&#25805;&#20316;&#20570;&#20986;&#31867;&#20284;&#30340;&#23553;&#35013;&#65292;&#21487;&#20197;&#22823;&#24133;&#22686;&#21152;&#20320;&#20195;&#30721;&#30340;&#21487;&#32500;&#25252;&#24615;&#65292;&#20320;&#22312;&#38405;&#35835;&#26102;&#20063;&#26356;&#23481;&#26131;&#26803;&#29702;&#20320;&#23454;&#29616;&#30340;&#27491;&#30830;&#24615;&#12290;</p>
<h3 id="43" class=" text-lg mt-2 pb-2 font-sans">4.3 &#25991;&#20214;&#31995;&#32479;&#23454;&#29616;</h3>
<p class=" font-serif my-1">&#36825;&#37324;&#26377;&#24456;&#22810;&#24494;&#22937;&#30340;&#22353; (&#29978;&#33267;&#27979;&#35797;&#29992;&#20363;&#26080;&#27861;&#23436;&#25972;&#22320;&#35206;&#30422;&#21040;&#23427;&#20204;)&#12290;&#20363;&#22914;&#65292;&#24403;&#20320;&#36941;&#21382; procfs &#26102;&#65292;&#20320;&#38656;&#35201;&#36941;&#21382;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;&#32447;&#31243;&#65307;&#32780;&#19982;&#27492;&#21516;&#26102;&#65292;&#32447;&#31243;&#21487;&#33021;&#34987;&#21019;&#24314;/&#22238;&#25910;&#12290;&#19968;&#20010;&#22797;&#26434;&#31995;&#32479;&#30340;&#23454;&#29616;&#24456;&#23481;&#26131;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#20135;&#29983;&#25968;&#25454;&#31454;&#20105; (&#20960;&#20046;&#24635;&#26159; bug&#65292;&#20363;&#22914;&#20320;&#21487;&#33021;&#20250;&#35835;&#21462;&#19968;&#20010;&#23578;&#26410;&#21021;&#22987;&#21270;&#22909;&#30340;&#32447;&#31243;) &#25110;&#26159;&#27515;&#38145;&#12290;&#36825;&#26679;&#30340;&#38382;&#39064;&#22312;&#27979;&#35797;&#20013;&#24688;&#24688;&#26159;&#24456;&#38590;&#26292;&#38706;&#30340;&#65306;&#20320;&#24456;&#38590;&#20250;&#24819;&#21040;&#26500;&#36896;&#36825;&#26679;&#30340;&#27979;&#35797;&#29992;&#20363;&#65292;&#20197;&#21450;&#23454;&#38469;&#30340;&#31995;&#32479;&#21487;&#33021;&#20250;&#22312;&#26356; subtle &#30340;&#24773;&#20917;&#19979;&#20986;&#38169;&#12290;</p>
<p class=" font-serif my-1">&#25105;&#20204;&#26080;&#27861;&#23436;&#25972;&#21015;&#20030;&#20320;&#25152;&#26377;&#21487;&#33021;&#36935;&#21040;&#30340;&#22353;&#8212;&#8212;&#20294;&#20320;&#22312;&#23436;&#25104;&#23454;&#39564;&#30340;&#36807;&#31243;&#20013;&#65292;&#20320;&#19968;&#23450;&#20250;&#24863;&#21497;&#20570;&#22909;&#19968;&#23450;&#30340;&#35774;&#35745;&#26159;&#22810;&#20040;&#37325;&#35201;&#12290;&#20197;&#21450;&#65292;&#26080;&#35770;&#20320;&#20570;&#20102;&#22810;&#23569;&#35774;&#35745;&#65292;&#22312;&#23454;&#38469;&#20013;&#37117;&#21487;&#33021;&#36935;&#21040;&#22855;&#22855;&#24618;&#24618;&#30340;&#38382;&#39064;&#65292;&#20320;&#20063;&#30495;&#27491;&#29702;&#35299;&#20102; lockdep, AddressSanitizer/ThreadSanitizer &#36825;&#26679;&#30340;&#24037;&#20855;&#23384;&#22312;&#30340;&#24517;&#35201;&#24615;&#12290;&#24635;&#20043;&#36825;&#20010; &#8220;&#32534;&#31243;&#22823;&#23454;&#39564;&#8221; &#20250;&#35753;&#20320;&#30495;&#27491;&#20307;&#20250;&#19968;&#20123;&#35745;&#31639;&#26426;&#31995;&#32479;&#35774;&#35745;/&#23454;&#29616;&#30340;&#22256;&#38590;&#12290;Happy hacking!</p>
<h3 id="44" class=" text-lg mt-2 pb-2 font-sans">4.4 &#31119;&#21033;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#20026;&#22823;&#23478;&#25552;&#20379;&#20102; Hard Test &#31867;&#20284;&#30340; workload&#65292;&#29992;&#20110;&#21019;&#24314;&#19968;&#20010;&#30446;&#24405;&#26641; (&#20551;&#35774;&#21021;&#22987;&#26102;&#65292;&#32447;&#31243;&#30340;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;&#20026; <code>/</code>)&#12290;&#25991;&#20214;&#22312; <a href="../../../pages/OS/2021/labs/vfs-workload.inc" class=" text-amber-900">vfs-workload.inc</a>&#12290;&#22823;&#23478;&#21487;&#20197;&#30452;&#25509;&#32534;&#20889;&#19968;&#20010; C &#25991;&#20214;&#65292;&#28982;&#21518;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">run_fs_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"vfs-workload.inc"</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#26469;&#23558; workload &#30452;&#25509;&#31896;&#36148;&#21040; C &#20195;&#30721;&#20013;&#12290;&#36825;&#20063;&#26159;&#20320;&#20204;&#29983;&#25104;&#27979;&#35797;&#29992;&#20363;&#30340;&#26041;&#27861;&#8212;&#8212;&#22914;&#26524;&#20320;&#20204;&#23436;&#25104;&#20102;&#19968;&#20010;&#33258;&#21160;&#30340;&#38543;&#26426;&#27979;&#35797;&#29992;&#20363;&#29983;&#25104;&#24037;&#20855;&#65292;&#20320;&#21487;&#20197;&#23558;&#31995;&#32479;&#35843;&#29992;&#30340;&#24207;&#21015;&#20889;&#20837;&#19968;&#20010; <code>.inc</code> &#25991;&#20214;&#20013;&#65292;&#28982;&#21518;&#23427;&#34987; include &#21040;&#20195;&#30721;&#20013;&#25191;&#34892;&#12290;&#22312;&#23454;&#38469;&#30340;&#27979;&#35797;&#20013;&#65292;&#25105;&#20204;&#30340;&#30446;&#24405;&#26641;&#20250;&#27604;&#32473;&#20986;&#30340; workload.inc &#31245;&#22823;&#19968;&#20123;&#65292;&#20294;&#19981;&#20250;&#22823;&#22826;&#22810;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#25191;&#34892;&#23436; workload &#20043;&#21518;&#65292;&#25105;&#20204;&#20250;&#36882;&#24402;&#22320;&#36941;&#21382;&#30446;&#24405;&#65292;&#22823;&#33268;&#30340;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">traverse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span><span class="w"> </span><span class="c1">// asserts success</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_stat</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">"/"</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">),</span><span class="w"> </span><span class="n">nread</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">release</span><span class="p">;</span>

<span class="w">  </span><span class="n">vfs</span><span class="o">-&gt;</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">T_DIR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">           </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_dirent</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nread</span><span class="p">;</span>
<span class="w">           </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_dirent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_dirent</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ufs_dirent</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">'.'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &#23567;&#24425;&#34507;&#65306;&#20320;&#36825;&#19979;&#30693;&#36947;&#20026;&#20160;&#20040;</span>
<span class="w">                                 </span><span class="c1">// Linux &#20197; &#8220;.&#8221; &#24320;&#22836;&#30340;&#25991;&#20214;&#26159;&#38544;&#34255;&#25991;&#20214;&#20102;&#21543;</span>
<span class="w">          </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">MAX_PATH_LEN</span><span class="p">);</span><span class="w"> </span><span class="c1">// assert success</span>
<span class="w">          </span><span class="n">sprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="s">"%s/%s"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">          </span><span class="n">traverse</span><span class="p">(</span><span class="n">fname</span><span class="p">);</span>
<span class="w">          </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">fname</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="nl">release</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">vfs</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">  </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#25105;&#20204;&#20250;&#35843;&#29992; <code>traverse("");</code> &#23436;&#25104;&#30446;&#24405;&#26641;&#30340;&#36941;&#21382;&#12290;</p></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../../../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../../../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>