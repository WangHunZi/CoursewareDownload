<!DOCTYPE html><html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // &#8226; auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // &#8226; rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<style>
.article {
  -webkit-hyphens: auto;
}
form {
  margin-block-end: 0;
}
img {
  display: inline-block;
}
code { font-size: 85%; }
pre {
  font-size: 95%;
  line-height: 120%;
}
blockquote {
  font-size: 95%;
}
p {
  font-size: 105%;
  text-indent: 2em;
}
li {
  font-size: 105%;
}
blockquote p {
  text-indent: 0em;
}
.float-right {
  padding-left: 10px;
}
.float-left {
  padding-right: 10px;
}
a {
  color: rgb(29 78 216);
}
strong {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.box        {
  border-radius: 2px; padding: 1px 4px 2px 4px;
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
  font-size: 95%;
}
.box-blue,  .badge-primary  { background-color: rgba(66, 139, 202, 0.5); color: #1d4ed8; }
.box-green, .badge-success  { background-color: rgba(92, 184, 92, 0.5);  color: #15803d; }
.box-red,   .badge-danger   { background-color: rgba(217, 83, 79, 0.5);  color: #b91c1c; }
.box-yellow,.badge-warning  { background-color: rgba(240, 173, 78, 0.5); color: #a16207; }
.box-gray   { background-color: #a0a0a0; }

.badge {
  padding: 1 4 1 4;
  display: inline-block;
  border-radius: 0.25rem;
  border: 1px solid;
}
.message p {
  text-indent: 0em;
  margin-top: 1px;
}
.message h1, h2, h3, h4, h5 {
  font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
}
.message h2 {
  font-size: 120%;
  margin-top: 5px;
  margin-bottom: 2px;
}
.message li {
  list-style: disc;
  margin-left: 2em;
}
li > p {
  text-indent: 0em;
}
block-quote h4 {
  float: left;
  display: inline-block;
}
.center {
  display: block;
  margin: auto;
}
hr {
  margin-top: 20px;
  padding-bottom: 20px;
}

.fa-gradient {
	background: -webkit-gradient(linear, left top, left bottom, from(rgb(99, 27, 103)), to(#333));
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

</style>


  <title>L1: &#29289;&#29702;&#20869;&#23384;&#31649;&#29702; (pmm)</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div>

<div class="px-2 py-1 w-full fixed z-50 bg-gradient-to-r from-black via-purple-700 via-purple-500 shadow-lg" style="-webkit-backdrop-filter: saturate(150%) blur(4px); backdrop-filter: saturate(150%) blur(4px)">
  <form>
    <a href="http://localhost:5001/index.html"><span class="text-lg px-2 text-white">Yanyan's Wiki</span></a>
    <a href="http://localhost:5001/OS/2023/index.html"><span class="text-sm px-2 text-white">&#25805;&#20316;&#31995;&#32479; (2023)</span></a>
    <input maxlength="9" id="token-input" class="float-right appearance-none border border-transparent px-2 py-1 w-20 bg-white text-gray-700 placeholder-gray-400 shadow-md rounded text-xs focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono" type="text" placeholder="TOKEN" oninput="login();">
  </form>
</div>

<div class="article container mx-auto md:px-8 lg:px-8 xl:px-8 2xl:px-8 shadow-lg border pb-8 pt-10 max-w-screen-md text-justify divide-y-2 divide-white">
  <div><h1 id="l1-pmm" class=" text-2xl mt-2 font-sans">L1: &#29289;&#29702;&#20869;&#23384;&#31649;&#29702; (pmm)</h1>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_1" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-red" style=" padding-bottom: 0;">&#9200; &#25130;&#27490;&#26085;&#26399;</h4>
<p class=" font-serif my-1"><strong>Soft Deadline: 2023 &#24180; 4 &#26376; 16 &#26085; 23:59:59&#12290;</strong></p>
<p class=" font-serif my-1">&#20320;&#38656;&#35201;&#39318;&#20808;&#38405;&#35835;<a href="http://localhost:5001/OS/2023/Labs/Labs.html" class=" text-amber-900">&#23454;&#39564;&#39035;&#30693;</a>&#12290;</p>
<p class=" font-serif my-1">&#22312;&#21629;&#20196;&#34892;&#20013; <code>git pull origin L1</code> &#19979;&#36733;&#26694;&#26550;&#20195;&#30721;&#12290;&#25105;&#20204;&#24635;&#26159;&#22312; kernel &#30446;&#24405;&#19979;&#24037;&#20316;&#65292;&#22240;&#27492;&#22914;&#26524;&#20320;&#36935;&#21040;&#20102; Git &#20914;&#31361; (&#21512;&#24182;&#38382;&#39064;)&#65292;&#35831;&#20197;&#25105;&#20204;&#30340;&#26032;&#29256;&#26412;&#20026;&#20934;&#12290;<red><strong>&#22312;&#33719;&#21462;&#21040;&#26694;&#26550;&#21518;&#65292;&#35831;&#25226;&#20320; L0 &#30340;&#20195;&#30721;&#25163;&#24037;&#20174; kernel &#30446;&#24405;&#20013;&#31227;&#38500;</strong></red>&#65307;</p>
<p class=" font-serif my-1">&#26412;&#23454;&#39564;&#38656;&#35201;&#25552;&#20132;&#20197;&#23398;&#21495;&#21629;&#21517;&#30340; .pdf &#26684;&#24335;&#23454;&#39564;&#25253;&#21578; (&#20445;&#23384;&#22312; <code>kernel/</code> &#30446;&#24405;&#19979;)&#65292;&#20043;&#21518;&#30340; OSLabs &#23558;&#19981;&#26029;&#22312;&#27492;&#23454;&#39564;&#25253;&#21578;&#22522;&#30784;&#19978;&#28155;&#21152;&#12290;</p>
<p class=" font-serif my-1"><strong>&#25298;&#32477;&#20869;&#21367;</strong>&#65306;&#38500;&#38750;&#29305;&#27530;&#24773;&#20917;&#65292;&#26412;&#27425;&#23454;&#39564;&#30340;&#23454;&#39564;&#25253;&#21578;<strong>&#19981;&#24314;&#35758;&#36229;&#36807; 2 &#39029; A4 &#32440;</strong>&#12290;&#35831;&#22312;&#23454;&#39564;&#25253;&#21578;&#20013;&#25551;&#36848;&#20320;&#22312;&#23454;&#39564;&#20013;&#36935;&#21040;&#30340;&#29305;&#21035;&#20540;&#24471;&#19968;&#25552;&#30340;&#20107;&#20214;&#65292;&#20363;&#22914;&#20320;&#20195;&#30721;&#30340;&#26550;&#26500;&#35774;&#35745;&#12289;&#29305;&#21035;&#31934;&#24039;&#30340;&#23454;&#29616;&#12289;&#36935;&#21040;&#21360;&#35937;&#28145;&#21051;&#30340; bug &#31561;&#12290;</p>
</blockquote>
<p class=" font-serif my-1"><oj-status course="OS2023" module="L1"><div class="divide-y divide-dashed">
    <div class="flex font-semibold">
      OS2023-L1 &#25552;&#20132;&#32467;&#26524;
    </div>
    
  </div>
</oj-status></p>
<h2 id="1" class=" text-xl mt-2 pb-2 font-sans">1. &#32972;&#26223;</h2>
<p class=" font-serif my-1">&#22312;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#21097;&#19979;&#30340;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#36981;&#24490;&#30340;&#26159; &#8220;&#19968;&#27493;&#19968;&#20010;&#33050;&#21360;&#8221;&#65292;&#33258;&#24213;&#21521;&#19978;&#23454;&#29616;&#19968;&#20010;&#22522;&#30784;&#22362;&#23454;&#30340;&#25805;&#20316;&#31995;&#32479;&#12290;&#20026;&#20102;&#20026;&#22312;&#20869;&#26680;&#37324;&#23454;&#29616;&#24456;&#37239;&#30340; &#8220;&#20998;&#26102;&#22810;&#32447;&#31243;&#8221; (&#21363;&#24182;&#21457;&#36816;&#34892;&#22810;&#20010;&#29366;&#24577;&#26426;) &#20570;&#22909;&#20934;&#22791;&#65292;&#25105;&#20204;&#20877;&#23436;&#25104;&#19968;&#20010;&#19982;&#25805;&#20316;&#31995;&#32479;&#30456;&#20851;&#30340;&#28909;&#36523;&#32451;&#20064;&#8212;&#8212;&#22810;&#22788;&#29702;&#22120;&#19978;&#30340;&#29289;&#29702;&#20869;&#23384;&#31649;&#29702;&#65292;&#20855;&#20307;&#23436;&#25104;&#29289;&#29702;&#20869;&#23384;&#30340;&#20998;&#37197;&#21644;&#22238;&#25910;&#12290;</p>
<p class=" font-serif my-1">&#22312;&#20174;&#20170;&#24448;&#21518;&#30340;&#23454;&#39564;&#37324;&#65292;&#25105;&#20204;&#20250;&#36880;&#27493;&#24110;&#21161;&#22823;&#23478;&#32416;&#27491;&#22312;&#38754;&#21521;&#31639;&#27861;&#31454;&#36187;&#30340; Online Judge &#32534;&#31243;&#26102;&#19968;&#20010;&#19981;&#22909;&#30340;&#20064;&#24815;&#65306;&#21482;&#31649;&#20998;&#37197;&#65292;&#19981;&#31649;&#22238;&#25910;&#12290;&#22823;&#23478;&#22312;&#20570; &#8220;&#31639;&#27861;&#39064;&#8221; &#26102;&#65292;&#19981;&#31649;&#26159;&#22823;&#25968;&#32452; <code>int dp[N][N]</code>&#65292;&#36824;&#26159; <code>new Tree[N]</code>&#65292;&#37117;&#25351;&#26395;&#25805;&#20316;&#31995;&#32479;&#22312;&#36827;&#31243;&#32467;&#26463;&#21518;&#33258;&#21160;&#22238;&#25910;&#36164;&#28304;&#12290;&#20294;&#22312;&#12298;&#25805;&#20316;&#31995;&#32479;&#12299;&#35838;&#19978;&#20320;&#36867;&#19981;&#20102;&#20102;&#65292;&#22240;&#20026;&#20320;&#23601;&#26159;&#25805;&#20316;&#31995;&#32479;&#30340;&#23454;&#29616;&#32773;&#65281;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_2" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#35880;&#24910;&#20351;&#29992;&#21160;&#24577;&#20869;&#23384;&#20998;&#37197;</h4>
<p class=" font-serif my-1">&#22914;&#26524;&#20320;&#27809;&#26377;&#20889;&#36807;&#30456;&#24403;&#35268;&#27169;&#30340;&#31243;&#24207;&#65292;&#22312;&#23545;&#35937;&#30340;&#31181;&#31867;&#22686;&#21152;&#26102;&#65292;&#20869;&#23384;&#31649;&#29702;&#20250;&#24102;&#26469;&#30456;&#24403;&#40635;&#28902;&#12290; <strong>&#23545;&#20110;&#23545;&#36855;&#20320;&#33258;&#21046;&#25805;&#20316;&#31995;&#32479;&#26469;&#35828;&#65292;&#29992;&#22266;&#23450;&#22823;&#23567;&#30340;&#25968;&#32452;&#31649;&#29702;&#23545;&#35937;&#26159;&#19968;&#20010;&#22909;&#21150;&#27861;</strong> (xv6 &#20013;&#23601;&#32463;&#24120;&#36825;&#20040;&#20570;)&#65292;&#20998;&#31867;&#31649;&#29702;&#30340;&#23545;&#35937; (&#32780;&#19981;&#26159;&#28151;&#22312;&#19968;&#20010;&#20840;&#23616;&#30340; &#8220;&#27744;&#23376;&#8221; &#37324;) &#23545;&#35843;&#35797;&#26356;&#21451;&#22909;&#65292;&#32780;&#19988;&#23545;&#35937;&#30340;&#22823;&#23567;&#36890;&#24120;&#26377;&#38480;&#65292;&#22914;&#26524;&#23384;&#22312;&#27844;&#28431;&#20063;&#24456;&#23481;&#26131;&#35302;&#21457;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#22312;&#36825;&#20010;&#23454;&#39564;&#37324;&#65292;&#25105;&#20204;&#36808;&#20986;&#32416;&#27491;&#30340;&#31532;&#19968;&#27493;&#65306;&#20146;&#25163;&#20307;&#39564;&#29087;&#24713;&#30340; malloc/free &#24212;&#35813;&#24590;&#26679;&#23454;&#29616;&#12290;</p>
<h2 id="2" class=" text-xl mt-2 pb-2 font-sans">2. &#23454;&#39564;&#25551;&#36848;</h2>
<h3 id="21" class=" text-lg mt-2 pb-2 font-sans">2.1. &#23454;&#29616;&#22810;&#22788;&#29702;&#22120;&#23433;&#20840;&#30340;&#20869;&#23384;&#20998;&#37197;&#21644;&#22238;&#25910;</h3>
<p class=" font-serif my-1">&#22312; AbstractMachine &#21551;&#21160;&#21518;&#65292;<code>[heap.start, heap.end)</code> &#20250;&#32473;&#20986;&#19968;&#27573;&#21487;&#29992;&#30340;&#29289;&#29702;&#20869;&#23384; (&#22534;&#21306;)&#12290;&#20320;&#38656;&#35201;&#22312;&#27492;&#22522;&#30784;&#19978;&#23454;&#29616;&#20801;&#35768;&#22810;&#20010;&#22788;&#29702;&#22120;<strong>&#24182;&#21457;</strong>&#22320;&#30003;&#35831;&#25110;&#37322;&#25918;&#20869;&#23384;&#30340;&#20998;&#37197;&#22120;&#65292;&#21253;&#25324;&#20197;&#19979;&#20004;&#20010;&#20989;&#25968;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// &#20869;&#23384;&#20998;&#37197;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// &#20869;&#23384;&#37322;&#25918;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#20855;&#20307;&#26469;&#35828;&#65292;&#36825;&#20010;&#23454;&#39564;&#32500;&#25252;&#19968;&#20010;&#25968;&#25454;&#32467;&#26500; (&#25277;&#35937;&#25968;&#25454;&#31867;&#22411;)&#65292;&#32500;&#25252;&#19968;&#20010;&#19981;&#30456;&#20132;&#21306;&#38388;&#30340;&#38598;&#21512; (&#22534;&#21306;)</p>
<p class=" font-serif my-1">$$ H = \big\{ [\ell_0, r_0), [\ell_1, r_1), \ldots, [\ell_n, r_n) \big\}&#12290;$$</p>
<p class=" font-serif my-1">&#21021;&#22987;&#26102;&#65292;&#22534;&#21306;&#20026;&#31354;&#12290;&#20551;&#35774;&#24403;&#21069;&#22534;&#21306;&#20026; $H$&#65292;<code>heap.start</code>$\ = L$, <code>heap.end</code>$\ = R$&#65292;&#20320;&#38656;&#35201;&#23454;&#29616;&#30340;&#25805;&#20316;&#26377;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>kalloc</code>($s$) &#20998;&#37197; $s$ &#23383;&#33410;&#30340;&#20869;&#23384; $[\ell, r)$ &#28385;&#36275;&#65306;<ol class=" list-decimal font-serif">
<li class=" ml-8">&#20998;&#37197;&#21457;&#29983;&#22312;&#22534;&#21306;&#20013; $$L \le \ell &lt; r &lt; R$$</li>
<li class=" ml-8">&#20998;&#37197;&#30340;&#20869;&#23384;&#19981;&#19982;&#24050;&#20998;&#37197;&#20869;&#23384;&#37325;&#21472; $$\forall [\ell_i, r_i) \in H.\ [\ell, r) \cap [\ell_i, r_i) = \varnothing$$</li>
<li class=" ml-8">&#20998;&#37197;&#21518;&#26032;&#30340;&#22534;&#21306; $$H' = H \cup \big\{ [\ell, r) \big\}$$ </li>
<li class=" ml-8">&#36820;&#22238;&#20998;&#37197;&#21306;&#38388;&#30340;&#24038;&#31471;&#28857; $\ell$&#12290;</li>
</ol>
</li>
<li class=" ml-8"><code>kfree</code>($\ell$) &#21024;&#38500;&#19968;&#20010;&#24050;&#26377;&#21306;&#38388; $[\ell, r) \in H$&#65292;&#24471;&#21040;&#26032;&#30340;&#22534;&#21306;
    $$H' = H \setminus \big\{ [\ell, r) \big\}.$$
&#24403; $\ell$ &#19981;&#26159; $H$ &#20013;&#20219;&#20309;&#19968;&#20010;&#21306;&#38388;&#24038;&#31471;&#28857;&#26102;&#65292;&#20135;&#29983; undefined behavior&#8212;&#8212;&#21363; <code>kfree</code> &#30340;&#35843;&#29992;&#32773;&#26377;&#20041;&#21153;&#20445;&#35777;&#19968;&#23450;&#37322;&#25918;&#19968;&#20010;&#24050;&#20998;&#37197;&#30340;&#31354;&#38388;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#22914;&#26524;&#20165;&#30475;&#19978;&#38754;&#30340;&#25277;&#35937;&#25551;&#36848;&#65292;&#36825;&#30475;&#36215;&#26469;&#23601;&#26159;&#19968;&#36947;&#22823;&#23478;&#20570;&#36807;&#30340; Online Judge &#39064;&#30446;&#22043;&#65281;&#21035;&#24613;&#12290;&#34429;&#28982;&#25968;&#23398;&#27169;&#22411; (&#26426;&#21046;) &#31616;&#21333;&#65292;&#20294;&#36824;&#26377;&#24456;&#22810;&#21487;&#20197;&#28789;&#27963;&#35774;&#35745;&#30340;&#31574;&#30053;&#65292;&#20363;&#22914;&#22312;&#26377;&#22823;&#37327;&#31354;&#20313;&#31354;&#38388;&#26102;&#65292;&#25105;&#20204;&#21040;&#24213;&#24212;&#35813;&#36820;&#22238;&#21738;&#19968;&#20010;&#12290;&#36825;&#37096;&#20998;&#20869;&#23481;&#20132;&#32473;&#22823;&#23478;&#33258;&#30001;&#25506;&#32034;&#65292;&#25105;&#20204;&#21482;&#26377;&#19968;&#20123;&#20316;&#20026;<strong>&#35745;&#31639;&#26426;&#31995;&#32479;&#36719;&#20214;&#22522;&#30784;&#35774;&#26045;</strong>&#30340;&#35201;&#27714;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><red><strong>&#23545;&#20110;&#22823;&#23567;&#20026; $s$ &#30340;&#20869;&#23384;&#20998;&#37197;&#35831;&#27714;&#65292;&#36820;&#22238;&#30340;&#20869;&#23384;&#22320;&#22336;&#24517;&#39035;&#23545;&#40784;&#21040; $2^i$</strong></red>&#65292;&#20854;&#20013; $i$ &#26159;&#26368;&#23567;&#30340;&#27491;&#25972;&#25968;&#28385;&#36275; $2^i \ge s$&#12290;&#20363;&#22914;&#65292;4 KiB &#30340;&#20869;&#23384;&#20998;&#37197;&#35831;&#27714;&#36820;&#22238;&#30340;&#22320;&#22336;&#24517;&#39035;&#26159; 4,096 &#30340;&#25972;&#25968;&#20493; (&#39029;&#38754;&#36793;&#30028;)&#12290;&#20363;&#22914;&#65292;&#20998;&#37197; 17 &#23383;&#33410;&#20869;&#23384;&#36820;&#22238;&#30340;&#22320;&#22336;&#24517;&#39035;&#26159; 32 &#30340;&#25972;&#25968;&#20493;&#12290;&#36825;&#20040;&#35201;&#27714;&#20854;&#23454;&#31616;&#21270;&#20102;&#22823;&#23478;&#30340;&#23454;&#29616;&#12290;</li>
<li class=" ml-8">&#22312;&#20320;&#30340;&#20998;&#37197;&#31639;&#27861;&#19981;&#33021;&#25214;&#21040;&#36275;&#22815;&#30340;&#20869;&#23384;&#21487;&#20197;&#20998;&#37197;&#26102;&#65292;&#36820;&#22238; <code>NULL</code> (<code>0</code>)&#12290;<ul class=" list-disc font-serif">
<li class=" ml-8">&#21463;&#20998;&#37197;&#31639;&#27861;&#30340;&#23616;&#38480;&#65292;&#21487;&#33021;&#31995;&#32479;&#20013;&#20173;&#28982;&#26377;&#31354;&#38386;&#30340;&#20869;&#23384;&#65292;&#20294;&#24418;&#25104;&#20102;&#30862;&#29255;&#30340;&#20869;&#23384;&#65292;&#25110;&#26159;&#20320;&#30340;&#31639;&#27861;&#19981;&#33021;&#25214;&#21040;&#23427;&#20174;&#32780;&#20998;&#37197;&#22833;&#36133;&#12290;&#36825;&#26159;&#20801;&#35768;&#30340;&#65307;&#20294;&#22312;&#31995;&#32479;&#20869;&#23384;&#21387;&#21147;&#24456;&#23567;&#30340;&#26102;&#20505;&#20381;&#28982;&#39057;&#32321;&#20998;&#37197;&#22833;&#36133;&#65292;&#21487;&#33021;&#23548;&#33268; hard test failure&#12290;</li>
</ul>
</li>
<li class=" ml-8">&#30001;&#20110;&#25105;&#20204;&#22312;&#33258;&#21046;&#30340;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#20013;&#20351;&#29992;&#65292;&#20320;<red><strong>&#21487;&#20197;&#30452;&#25509;&#25298;&#32477;&#36229;&#36807; 16 MiB &#30340;&#20869;&#23384;&#20998;&#37197;</strong></red>&#12290;</li>
<li class=" ml-8">&#19981;&#24517;&#21021;&#22987;&#21270;&#36820;&#22238;&#30340;&#20869;&#23384;&#65292;&#24403;&#28982;&#65292;&#23545;&#36820;&#22238;&#30340;&#20869;&#23384;&#36171;&#19978;&#21021;&#22987;&#20540; (&#20363;&#22914;&#38646;) &#20063;&#35768;&#26159;&#20010;&#19981;&#38169;&#30340;&#20027;&#24847;&#12290;</li>
<li class=" ml-8"><red><strong>&#20801;&#35768;&#22810;&#22788;&#29702;&#22120;&#24182;&#34892;&#22320;&#35843;&#29992; kalloc/kfree</strong></red>&#65306;<ul class=" list-disc font-serif">
<li class=" ml-8">&#19981;&#21516;&#30340;&#22788;&#29702;&#22120;&#21487;&#33021;&#21516;&#26102;&#25191;&#34892; kalloc &#20998;&#37197;&#22823;&#23567;&#19981;&#21516;&#30340;&#20869;&#23384;&#65307;</li>
<li class=" ml-8">&#19981;&#21516;&#30340;&#22788;&#29702;&#22120;&#21487;&#33021;&#21516;&#26102;&#25191;&#34892; kfree &#37322;&#25918;&#20869;&#23384;&#65307;</li>
<li class=" ml-8">&#22312;&#19968;&#20010;&#22788;&#29702;&#22120;&#20998;&#37197;&#30340;&#20869;&#23384;&#65292;&#21487;&#33021;&#22312;&#21478;&#19968;&#20010;&#22788;&#29702;&#22120;&#19978;&#37322;&#25918;&#65307;&#20294;&#25105;&#20204;&#20445;&#35777;&#25105;&#20204;&#30340;&#27979;&#35797;&#20195;&#30721;&#20013;&#19981;&#23384;&#22312;&#25968;&#25454;&#31454;&#20105;&#65307;</li>
<li class=" ml-8">&#22312; kalloc/kfree &#23454;&#29616;&#27491;&#30830;&#30340;&#21069;&#25552;&#19979;&#65292;&#23613;&#21487;&#33021;&#20351;&#19981;&#21516;&#22788;&#29702;&#22120;&#19978;&#30340;&#20869;&#23384;&#20998;&#37197;&#33021;&#22815;&#24182;&#34892;&#12290;&#22914;&#26524;&#20320;&#20195;&#30721;&#30340;&#24615;&#33021;&#36807;&#20302; (&#20363;&#22914;&#29992;&#20840;&#23616;&#30340;&#38145;&#20445;&#25252;&#31354;&#38386;&#38142;&#34920;&#65292;&#24182;&#29992;&#36941;&#21382;&#38142;&#34920;&#30340;&#26041;&#24335;&#23547;&#25214;&#21487;&#29992;&#30340;&#20869;&#23384;)&#65292;&#21487;&#33021;&#20250;&#23548;&#33268; hard test failure&#12290;</li>
</ul>
</li>
</ul>
<h3 id="22-hard-tests" class=" text-lg mt-2 pb-2 font-sans">2.2. &#24615;&#33021;&#20248;&#21270; (Hard Tests)</h3>
<p class=" font-serif my-1">&#22810;&#22788;&#29702;&#22120;&#19978;&#30340;&#20869;&#23384;&#20998;&#37197;&#21644;&#37322;&#25918;&#24102;&#26469;&#39069;&#22806;&#30340;&#25361;&#25112;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">&#25105;&#20204;&#24076;&#26395;&#20445;&#35777;&#20998;&#37197;&#30340;&#27491;&#30830;&#24615;&#12290;&#36825;&#24847;&#21619;&#30528;&#29992;&#19968;&#25226;&#22823;&#38145;&#20445;&#25252;&#19968;&#20010;&#20018;&#34892;&#25968;&#25454;&#32467;&#26500; (&#20363;&#22914;&#31639;&#27861;&#23548;&#35770;&#19978;&#30340; &#8220;&#21306;&#38388;&#26641;&#8221; &#23601;&#33021;&#22312; $O(\log n)$ &#30340;&#26102;&#38388;&#20869;&#23436;&#25104;&#20998;&#37197;&#21644;&#37322;&#25918;&#25805;&#20316;) &#23601;&#33021;&#27491;&#30830;&#23454;&#29616;&#22810;&#22788;&#29702;&#22120;&#19978;&#30340;&#20869;&#23384;&#20998;&#37197;&#12290;</li>
<li class=" ml-8">&#25105;&#20204;&#24076;&#26395;&#20445;&#35777;&#20998;&#37197;&#22312;&#22810;&#22788;&#29702;&#22120;&#19978;&#30340;&#24615;&#33021;&#21644;&#20280;&#32553;&#24615; (scalability)&#12290;&#36825;&#24847;&#21619;&#30528;&#19981;&#21516;&#30340;&#22788;&#29702;&#22120;&#33021;&#22815;&#24182;&#34892;&#22320;&#30003;&#35831;&#20869;&#23384;&#65292;&#23613;&#21487;&#33021;&#20943;&#23569;&#22240;&#20026;&#21516;&#26102;&#30003;&#35831;&#32780;&#21457;&#29983;&#19968;&#20010;&#22788;&#29702;&#22120;&#31561;&#21478;&#19968;&#20010;&#22788;&#29702;&#22120;&#30340;&#24773;&#20917;&#12290;</li>
</ol>
<p class=" font-serif my-1">&#19978;&#38754;&#20004;&#28857;&#38656;&#27714;&#26159;&#30683;&#30462;&#30340;&#65292;&#36825;&#20063;&#26159;&#26412;&#27425;&#23454;&#39564;&#30340;&#37325;&#28857;&#25361;&#25112;&#12290;&#22312;&#36825;&#20010;&#23454;&#39564;&#37324;&#65292;&#25105;&#20204;&#36890;&#36807; &#8220;system&#8221; &#30340;&#26041;&#27861;&#35299;&#20915;&#38382;&#39064;&#65292;&#32780;&#19981;&#26159;&#24039;&#22937;&#30340;&#31639;&#27861;/&#25968;&#25454;&#32467;&#26500;&#8212;&#8212;&#36825;&#19981;&#24847;&#21619;&#30528;&#31639;&#27861;/&#25968;&#25454;&#32467;&#26500;&#22312;&#35745;&#31639;&#26426;&#31995;&#32479;&#20013;&#27809;&#26377;&#24212;&#29992;&#65292;&#21482;&#26159;&#22312;&#36825;&#20010;&#38382;&#39064;&#19978;&#24182;&#19981;&#38750;&#24120;&#24517;&#35201;&#12290;</p>
<h3 id="23-abstractmachine-klib" class=" text-lg mt-2 pb-2 font-sans">2.3. &#23454;&#29616; AbstractMachine &#20013; klib &#20013;&#32570;&#22833;&#30340;&#20989;&#25968;</h3>
<p class=" font-serif my-1">&#22312; Lab0 &#20013;&#65292;&#25105;&#20204;&#24050;&#32463;&#25552;&#20986;&#20102;&#36825;&#20010;&#23454;&#39564;&#35201;&#27714;&#12290;&#36825;&#20010;&#23454;&#39564;&#24314;&#35758;&#22823;&#23478;&#23454;&#29616; klib &#37324;&#32570;&#22833;&#30340;&#20989;&#25968;&#8212;&#8212;&#27809;&#26377; printf, sprintf &#31561;&#20989;&#25968;&#65292;&#20320;&#26681;&#26412;&#23601;&#26159;&#22312;&#29992;&#27719;&#32534;&#35821;&#35328;&#20889;&#25805;&#20316;&#31995;&#32479;&#65292;&#20320;&#26080;&#27861;&#27963;&#21040;&#26368;&#21518;&#12290;&#25105;&#20204;&#19981;&#20250;&#26816;&#26597;&#22823;&#23478;&#30340; klib &#23454;&#29616;&#65292;&#20294;&#20063;&#35831;&#22823;&#23478;&#19981;&#35201;&#25220;&#34989;&#8212;&#8212;&#34429;&#28982;&#20114;&#32852;&#32593;&#19978;&#26377;&#24456;&#22810;&#20195;&#30721;&#65292;&#20294;&#33258;&#24049;&#20889;&#19968;&#36941;&#20381;&#28982;&#26159;&#25484;&#25569;&#36825;&#20123;&#24211;&#20989;&#25968;&#21407;&#29702;&#30340;&#26368;&#22909;&#26041;&#24335;&#12290;</p>
<h2 id="3" class=" text-xl mt-2 pb-2 font-sans">3. &#27491;&#30830;&#24615;&#26631;&#20934;</h2>
<p class=" font-serif my-1">&#20174;&#36825;&#20010;&#23454;&#39564;&#24320;&#22987;&#65292;&#27491;&#30830;&#24615;&#23558;&#21464;&#24471;&#38750;&#24120;&#37325;&#35201;&#12290;&#22914;&#26524;&#20320;&#30340; kalloc/kfree &#8220;&#20960;&#20046;&#23436;&#20840;&#19981;&#27491;&#30830;&#8221; &#20498;&#20063;&#36824;&#22909;&#65292;&#38382;&#39064;&#23481;&#26131;&#25490;&#26597;&#65292;&#20294;&#22914;&#26524;&#22312;&#29316;&#35282;&#26094;&#26095;&#30340;&#24773;&#20917;&#37324;&#26377;&#19968;&#20010;&#24182;&#21457; bug&#65292;&#21448;&#24688;&#22909;&#21040;&#24456;&#26202; (&#27604;&#22914;&#25991;&#20214;&#31995;&#32479;&#31561;&#37117;&#23454;&#29616;&#23436;&#20197;&#21518;) &#25165;&#20197;&#38750;&#30830;&#23450;&#24615;&#30340;&#26041;&#24335;&#26292;&#38706;&#20986;&#26469;&#65292;&#20320;&#30340;&#26085;&#23376;&#23601;&#27809;&#37027;&#20040;&#22909;&#36807;&#20102;&#8212;&#8212;&#22240;&#20026;&#20320;&#26681;&#26412;&#19981;&#30693;&#36947;&#36825;&#20010; bug &#21040;&#24213;&#20301;&#20110;&#21738;&#20010;&#27169;&#22359;&#65281;&#22823;&#23478;&#27605;&#19994;&#20197;&#21518;&#23601;&#38656;&#35201;&#33073;&#31163; Online Judge&#65292;&#21435;&#23454;&#29616; &#8220;&#20174;&#27809;&#20154;&#20570;&#36807;&#30340;&#19996;&#35199;&#8221;&#65292;&#25152;&#20197;&#20320;&#21487;&#33021;&#20250;&#25265;&#24616; Online Judge &#30340;&#26080;&#24773;&#25298;&#32477;&#21644;&#20919;&#21364;&#26102;&#38388;&#65292;&#20294;&#20063;&#35831;&#22362;&#25345;&#20303;&#65281;</p>
<h2 id="31" class=" text-xl mt-2 pb-2 font-sans">3.1. &#27979;&#35797;&#29992;&#20363;&#35828;&#26126;</h2>
<p class=" font-serif my-1">&#20026;&#20102;&#24378;&#36843;&#22823;&#23478;&#20351;&#29992;&#21160;&#24577;&#30340;&#26041;&#24335;&#31649;&#29702;&#22823;&#23567;&#19981;&#21516;&#30340;&#22534;&#21306;&#65292;&#25105;&#20204;&#35268;&#23450;&#20320;&#20351;&#29992;&#30340;&#25152;&#26377;&#38745;&#24577;&#20869;&#23384; (64-bit &#27169;&#24335;&#19979;&#30340;&#20195;&#30721;&#12289;&#25968;&#25454;&#12289;bss) &#19981;&#33021;&#36229;&#36807; 1 MiB&#12290;&#25105;&#20204;&#23558;&#20250;&#22312;&#36816;&#34892;&#20043;&#21069;&#23545;&#20869;&#26680;&#20351;&#29992; size &#21629;&#20196;&#36827;&#34892;&#26816;&#26597;&#65292;&#24182;&#25298;&#32477;&#36807;&#22823;&#30340; kernel&#12290;&#31649;&#29702;&#22534;&#21306;&#30340;&#25968;&#25454;&#32467;&#26500;&#24212;&#24403;&#22312;&#22534;&#21306;&#20013;&#32780;&#19981;&#26159;&#38745;&#24577;&#21306;&#20013;&#36827;&#34892;&#20998;&#37197;&#12290;</p>
<p class=" font-serif my-1">&#25105;&#20204;&#20250;&#20351;&#29992;&#26469;&#33258;&#31867;&#20284;&#20110;&#30495;&#23454;&#25805;&#20316;&#31995;&#32479;&#31995;&#32479;&#20869;&#26680;&#30340; workload (&#22810;&#22788;&#29702;&#22120;) &#26469;&#27979;&#35797;&#22823;&#23478;&#30340;&#31243;&#24207;&#12290;&#31995;&#32479;/workload &#30340;&#19968;&#20123;&#20551;&#35774;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#19981;&#36229;&#36807; 8 &#20010;&#22788;&#29702;&#22120;&#12289;&#19981;&#23569;&#20110; 64 MiB&#12289;&#19981;&#22810;&#20110; 4 GiB &#20869;&#23384;&#30340;&#22534;&#21306;&#65307;</li>
<li class=" ml-8">&#22823;&#37327;&#12289;&#39057;&#32321;&#30340;&#23567;&#20869;&#23384;&#20998;&#37197;/&#37322;&#25918;&#65307;&#20854;&#20013;&#32477;&#22823;&#37096;&#20998;&#19981;&#36229;&#36807; 128 &#23383;&#33410;&#65307;</li>
<li class=" ml-8">&#36739;&#20026;&#39057;&#32321;&#30340;&#65292;&#20197;&#29289;&#29702;&#39029;&#38754;&#22823;&#23567;&#20026;&#21333;&#20301;&#30340;&#20998;&#37197;/&#37322;&#25918; (4 KiB)&#65307;</li>
<li class=" ml-8">&#38750;&#24120;&#32597;&#35265;&#30340;&#22823;&#20869;&#23384;&#20998;&#37197;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#25105;&#20204;&#39044;&#26399;&#20320;&#30340; kalloc/kfree &#20855;&#26377;&#36275;&#22815;&#30340; robustness&#65292;&#36275;&#20197;&#25215;&#36733;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#30340;&#23454;&#29616;:</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">
<p class=" font-serif my-1">Safety: &#25105;&#20204;&#39044;&#26399;&#20320;&#30340; kalloc/kfree &#23454;&#29616;&#26159;&#27491;&#30830;&#30340;&#12290;&#19968;&#26086;&#20197;&#19979;&#24773;&#20917;&#21457;&#29983;&#65292;&#23558;&#34987;&#31435;&#21363;&#34987; Online Judge &#21028;&#23450;&#20026;&#38169;&#35823;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#34394;&#25311;&#26426;&#37325;&#21551;&#12289;crash&#12289;&#27979;&#35797;&#20195;&#30721;&#20013;&#30340; assert fail &#31561; (&#36890;&#24120;&#30001; undefined behavior &#35302;&#21457;&#65292;&#20363;&#22914;&#25968;&#25454;&#31454;&#20105;)</li>
<li class=" ml-8">kalloc &#30340;&#36820;&#22238;&#20540;&#19981;&#28385;&#36275; API &#35268;&#32422;&#65292;&#20363;&#22914;&#20998;&#37197;&#30340;&#20869;&#23384;&#19981;&#20301;&#20110;&#22534;&#21306;&#12289;&#38169;&#35823;&#30340;&#20869;&#23384;&#23545;&#40784;&#31561;</li>
<li class=" ml-8">kalloc &#36820;&#22238;&#19968;&#27573;&#23578;&#26410;&#34987; kfree &#30340;&#20869;&#23384;</li>
</ul>
</li>
<li class=" ml-8">
<p class=" font-serif my-1">Liveness: &#25105;&#20204;&#36824;&#38656;&#35201;&#31995;&#32479;&#26377;&#19968;&#23450;&#30340; liveness&#65292;&#21363;&#31995;&#32479;&#20013;&#26377;&#20805;&#36275;&#21097;&#20313;&#20869;&#23384;&#26102;&#65292;&#20869;&#23384;&#20998;&#37197;&#19981;&#24212;&#36807;&#20110;&#39057;&#32321;&#30340;&#39057;&#32321;&#22833;&#36133;&#12290;&#36825;&#26159;&#20026;&#20102;&#38450;&#27490;&#20320;&#20026;&#20102; safety &#36827;&#34892;&#19968;&#20123; &#8220;&#25237;&#26426;&#21462;&#24039;&#8221;&#65306;&#23545;&#25152;&#26377; kalloc &#37117;&#36820;&#22238; <code>NULL</code>&#65292;safety trivially &#34987;&#28385;&#36275;&#12290;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">liveness &#24182;&#19981;&#26159;&#19968;&#20010; &#8220;&#30828;&#24615;&#8221; &#30340;&#35201;&#27714;&#12290;&#22312;&#21512;&#29702;&#30340; workload &#19978;&#65292;&#20320;&#31243;&#24207;&#30340;&#34920;&#29616;&#21482;&#35201;&#19981;&#27604;&#19968;&#20010; (&#23454;&#29616;&#24471;&#38750;&#24120;&#19968;&#33324;) &#30340; baseline &#24046;&#22826;&#22810; (&#20320;&#20381;&#28982;&#20801;&#35768;&#22312;&#26576;&#20123;&#20320;&#35748;&#20026;&#26080;&#27861;&#28385;&#36275;&#30340; kalloc &#19978;&#36820;&#22238; <code>NULL</code>)&#65292;&#23601;&#20250;&#34987;&#21028;&#23450;&#20026;&#27491;&#30830;</li>
</ul>
</li>
</ol>
<p class=" font-serif my-1">&#19982; L0 &#31867;&#20284;&#65292;&#25105;&#20204;&#20250;&#38142;&#25509;&#25105;&#20204; klib &#30340;&#21442;&#32771;&#23454;&#29616;&#65292;&#22240;&#27492;&#20320;&#19981;&#24517;&#25285;&#24515;&#20320;&#30340; klib &#26377;&#20123;&#35768;&#38382;&#39064;&#65307;&#20294;&#20320;&#35201;&#20445;&#25345; klib &#24211;&#20989;&#25968;&#30340;&#34892;&#20026;&#19982; libc &#19968;&#33268;&#12290;&#27880;&#24847; native &#20250;&#38142;&#25509;&#31995;&#32479;&#26412;&#22320;&#30340; glibc (&#32780;&#38750; klib)&#12290;</p>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="hard-test" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">Hard Test &#24456;&#38590;&#65311;</h4>
<p class=" font-serif my-1">&#22914;&#26524;&#20320;&#35273;&#24471;&#33021;&#21147;&#23454;&#22312;&#26377;&#38480;&#65292;&#26410;&#24517;&#19968;&#23450;&#35201;&#25630;&#23450;&#25152;&#26377;&#30340; test cases&#12290;&#20363;&#22914;&#65292;&#22914;&#26524;&#20320;&#23454;&#22312;&#24863;&#21040;&#22256;&#38590;&#65292;&#21487;&#20197;&#32771;&#34385;&#19981;&#23454;&#29616; kfree:</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p class=" font-serif my-1">&#36825;&#26679; kalloc &#30340;&#23454;&#29616;&#23601;&#38750;&#24120;&#31616;&#21333;&#20102;&#8212;&#8212;&#31616;&#21333;&#21040;&#21482;&#38656;&#35201;&#32500;&#25252;&#19968;&#20010;&#25351;&#38024;&#21363;&#21487;&#65292;&#20381;&#28982;&#33021;&#30830;&#20445;&#26377; easy tests &#36890;&#36807;&#65292;&#24182;&#19988;&#21487;&#20197;&#32487;&#32493;&#21518;&#32493;&#30340;&#23454;&#39564;&#65292;&#33719;&#24471;&#21518;&#32493;&#23454;&#39564;&#30340;&#37096;&#20998;&#20998;&#25968;&#12290;&#25105;&#20204;&#19981;&#20005;&#26684;&#31105;&#27490;&#36825;&#26679;&#30340;&#23454;&#29616;&#65292;&#32780;&#19988;&#20320;&#20250;&#21457;&#29616;&#65292;&#22914;&#26524;&#20869;&#23384;&#20805;&#36275;&#65292;&#20320;&#20043;&#21518;&#32534;&#20889;&#30340;&#25805;&#20316;&#31995;&#32479;&#20381;&#28982;&#26159;&#21487;&#20197;&#36816;&#34892;&#30340; (&#21482;&#26159;&#36816;&#34892;&#19968;&#27573;&#26102;&#38388;&#20197;&#21518;&#65292;&#23601;&#20250; out of memory &#26080;&#27861;&#20877;&#36816;&#34892;&#19979;&#21435;&#65292;&#20250;&#24433;&#21709;&#21518;&#32493;&#23454;&#39564;&#27979;&#35797;&#29992;&#20363;&#30340;&#24471;&#20998;)&#12290;</p>
</blockquote>
<h3 id="32-online-judge" class=" text-lg mt-2 pb-2 font-sans">3.2. Online Judge &#36816;&#34892;&#27979;&#35797;&#20195;&#30721;&#30340;&#26041;&#24335;</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#20250;&#26367;&#25442; <code>framework/main.c</code> &#30340;&#20195;&#30721;&#65292;&#20294;&#20445;&#25345;&#30340; <code>src/</code> &#30446;&#24405;&#19979;&#30340;&#25991;&#20214;&#19981;&#21464;&#12290;&#22240;&#27492;&#65292;&#20320;&#33258;&#24049;&#30340;&#27979;&#35797;&#29992;&#20363; (&#22312; <code>os_run()</code> &#20013;) &#21487;&#20197;&#19981;&#24517;&#20462;&#25913;&#12290;&#27979;&#35797;&#26102;&#65292;&#25105;&#20204;&#20250;&#25913;&#21464; <code>mpe_init</code> &#30340;&#20837;&#21475; (&#19981;&#20877;&#20174; <code>os-&gt;run</code> &#24320;&#22987;&#25191;&#34892;&#65292;&#32780;&#26159;&#30452;&#25509;&#36816;&#34892;&#27979;&#35797;&#30340; workload)&#12290;&#22240;&#27492;&#20320;&#24517;&#39035;&#22312; <code>os-&gt;init()</code> &#20013;&#23436;&#25104;&#25152;&#26377;&#24517;&#35201;&#30340;&#21021;&#22987;&#21270;&#65292;&#20363;&#22914;&#35843;&#29992; <code>pmm-&gt;init()</code>&#12290;</p>
<p class=" font-serif my-1">&#20197;&#19979;&#26159;&#19968;&#20010;&#25105;&#20204;&#27979;&#35797;&#20195;&#30721;&#30340;&#20363;&#23376;&#65292;&#23427;&#20250;&#19981;&#26029;&#29983;&#25104;&#38543;&#26426;&#30340; kalloc/kfree &#35831;&#27714; (&#20320;&#21487;&#20197;&#20551;&#35774;&#25105;&#20204;&#30340;&#29983;&#25104;&#22120;&#24635;&#26159;&#29983;&#25104;&#21512;&#27861;&#30340;&#35831;&#27714;&#65292;&#20363;&#22914;&#19981;&#20250;&#21457;&#29983; double-free &#31561;)&#65292;&#24182;&#19988;&#26816;&#26597; kalloc/kfree &#36820;&#22238;&#32467;&#26524;&#30340;&#21512;&#27861;&#24615;&#65307;&#24403;&#26816;&#27979;&#21040;&#38382;&#39064;&#21518;&#20250; assert fail &#36864;&#20986;&#65292;&#28982;&#21518;&#20320;&#21487;&#33021;&#20250;&#24471;&#21040; &#8220;Runtime Error&#8221;&#12290;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;common.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;klib.h&gt;</span>

<span class="k">enum</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">OP_ALLOC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">OP_FREE</span><span class="w"> </span><span class="p">};</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">malloc_op</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">  </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span><span class="w"> </span><span class="p">};</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">stress_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_op</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random_op</span><span class="p">();</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">OP_ALLOC</span><span class="p">:</span><span class="w"> </span><span class="n">alloc_check</span><span class="p">(</span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">sz</span><span class="p">),</span><span class="w"> </span><span class="n">op</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">OP_FREE</span><span class="p">:</span><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">os</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<span class="w">  </span><span class="n">mpe_init</span><span class="p">(</span><span class="n">stress_test</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4" class=" text-xl mt-2 pb-2 font-sans">4. &#23454;&#39564;&#25351;&#21335;</h2>
<h3 id="41" class=" text-lg mt-2 pb-2 font-sans">4.1. &#20195;&#30721;&#32452;&#32455;&#19982;&#36816;&#34892;</h3>
<p class=" font-serif my-1">&#23454;&#39564;&#26694;&#26550;&#20195;&#30721;&#30001;&#19977;&#20010;&#30446;&#24405;&#32452;&#25104;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>.
&#9500;&#9472;&#9472; framework  -&gt; &#26694;&#26550;&#20195;&#30721;&#65307;&#21487;&#20197;&#22312;&#26412;&#22320;&#20462;&#25913;&#65292;&#20294; Online Judge &#35780;&#27979;&#26102;&#20250;&#34987;&#26367;&#25442;&#25104;&#25105;&#20204;&#30340;&#29256;&#26412;
&#9474;&#160;&#160; &#9500;&#9472;&#9472; kernel.h
&#9474;&#160;&#160; &#9492;&#9472;&#9472; main.c
&#9500;&#9472;&#9472; include    -&gt; &#22836;&#25991;&#20214;&#65307;&#21487;&#20197;&#33258;&#30001;&#20462;&#25913;/&#21019;&#24314;&#25991;&#20214; (Online Judge &#20250;&#22797;&#21046;)
&#9474;&#160;&#160; &#9492;&#9472;&#9472; common.h
&#9500;&#9472;&#9472; Makefile
&#9492;&#9472;&#9472; src        -&gt; &#28304;&#25991;&#20214;&#65307;&#21487;&#20197;&#33258;&#30001;&#20462;&#25913;/&#21019;&#24314;&#25991;&#20214; (Online Judge &#20250;&#22797;&#21046;)
    &#9500;&#9472;&#9472; os.c
    &#9492;&#9472;&#9472; pmm.c
</code></pre></div>

<p class=" font-serif my-1">&#29702;&#35299;&#26694;&#26550;&#20195;&#30721;&#30340;&#32534;&#35793;&#65292;&#26368;&#22909;&#30340;&#21150;&#27861;&#26159;&#30475; Makefile &#21862;&#12290;&#22312;&#35838;&#22530;&#19978;&#25105;&#20204;&#24050;&#32463;&#35762;&#35299;&#20102;&#22914;&#20309;&#38405;&#35835; Makefile (&#22823;&#23478;&#21487;&#20197;&#26597;&#30475;&#35270;&#39057;&#22238;&#30475;)&#65292;&#24182;&#35762;&#35299;&#20102;&#38236;&#20687;&#30340;&#29983;&#25104;&#36807;&#31243;&#12290;&#22909;&#22855;&#25805;&#20316;&#31995;&#32479;&#26159;&#22914;&#20309;&#34987; &#8220;&#32534;&#35793;&#8221; &#20986;&#26469;&#30340;&#65311;&#22914;&#26524;&#35273;&#24471;&#38405;&#35835; Makefile (&#21644;&#37324;&#38754;&#22855;&#22855;&#24618;&#24618;&#30340;&#35821;&#27861;) &#26377;&#28857;&#22256;&#38590;&#65292;&#25105;&#20204;&#19981;&#22952;&#25226; make &#24037;&#20855;&#30340;&#25191;&#34892;&#20063;&#24819;&#35937;&#25104;&#26159;&#29366;&#24577;&#26426;&#8212;&#8212;&#27809;&#38169;&#65292;&#31243;&#24207;&#23601;&#26159;&#29366;&#24577;&#26426;&#65292;&#32780;&#25105;&#20204;&#22914;&#26524;&#35266;&#27979;&#36825;&#20010;&#29366;&#24577;&#26426;&#30340;&#25191;&#34892;&#65292;&#25105;&#20204;&#26368;&#20851;&#24515;&#30340;&#24403;&#28982;&#26159; make &#24037;&#20855;&#25191;&#34892;&#30340;&#25152;&#26377;&#21629;&#20196;&#20102;&#65292;&#22240;&#20026;&#26159;&#36825;&#20123;&#21629;&#20196;&#20135;&#29983;&#20102;&#25105;&#20204;&#32534;&#35793;&#20986;&#30340; <code>.o</code> &#25991;&#20214;&#12289;&#38142;&#25509;&#24471;&#21040;&#30340; ELF &#20108;&#36827;&#21046;&#25991;&#20214;&#65292;&#20197;&#21450;&#25105;&#20204;&#30340;&#25805;&#20316;&#31995;&#32479;&#38236;&#20687;&#12290;</p>
<p class=" font-serif my-1">GNU make &#33258;&#28982;&#20026;&#25105;&#20204;&#25552;&#20379;&#20102;&#36825;&#20010;&#21151;&#33021;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ make -nB # RTFM!
... (&#23436;&#20840;&#19981;&#21487;&#35835;&#30340;&#36755;&#20986;)
</code></pre></div>

<p class=" font-serif my-1">&#20294;&#22914;&#26524;&#20320;&#31245;&#31245;&#23545;&#36755;&#20986;&#20570;&#19968;&#20123;&#22788;&#29702;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>make -nB | grep -v '^mkdir' | vim -
</code></pre></div>

<p class=" font-serif my-1">&#24182;&#19988;&#22312; Vim &#37324;&#20570;&#19968;&#20123;&#20320;&#33298;&#36866;&#30340;&#25991;&#26412;&#22788;&#29702;&#65292;&#20363;&#22914; <code>:%s/^/\r</code> &#22312;&#21629;&#20196;&#20043;&#38388;&#25554;&#20837;&#31354;&#34892;&#65307;<code>:%s/ /\r  /g</code> &#23558;&#21629;&#20196;&#30340;&#21442;&#25968;&#32553;&#36827;&#25490;&#29256;&#8230;&#8230;&#20320;&#24456;&#24555;&#23601;&#20250;&#24471;&#21040; &#8220;&#21487;&#35835;&#8221; &#30340;&#20195;&#30721;&#65292;&#20363;&#22914;&#32534;&#35793;&#19968;&#20010; .c &#25991;&#20214;&#30340;&#21629;&#20196;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>x86_64-linux-gnu-gcc
  -std=gnu11 -O2
  -MMD -Wall -Werror -ggdb
  -Iinclude/ -Iframework/ -I$KERNEL/include -I$AM/am/include/ -I$AM/klib/include/
  -D__ISA__=\"x86_64\"
  -D__ISA_X86_64__
  -D__ARCH__=x86_64-qemu
  -D__ARCH_X86_64_QEMU
  -D__PLATFORM__=qemu
  -D__PLATFORM_QEMU
  -DARCH_H=\"arch/x86_64-qemu.h\"
  -fno-asynchronous-unwind-tables -fno-builtin -fno-stack-protector -Wno-main -m64 -fPIC -mno-sse
  -c -o $BUILD/x86_64-qemu/framework/main.o
  $KERNEL/framework/main.c
</code></pre></div>

<p class=" font-serif my-1">&#38142;&#25509;&#29983;&#25104; ELF &#25991;&#20214;&#30340;&#21629;&#20196;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>x86_64-linux-gnu-ld
  -melf_x86_64 -N
  -Ttext-segment=0x00100000
  -o $BUILD/kernel-x86_64-qemu.elf
  $BUILD/x86_64-qemu/framework/main.o
  $BUILD/x86_64-qemu/./src/pmm.o
  $BUILD/x86_64-qemu/./src/os.o
  $AM/am/build/am-x86_64-qemu.a
  $AM/klib/build/klib-x86_64-qemu.a
</code></pre></div>

<p class=" font-serif my-1">&#20197;&#21450;&#26368;&#32456;&#29983;&#25104;&#21487;&#36816;&#34892;&#30340;&#30913;&#30424;&#38236;&#20687;&#30340;&#36807;&#31243;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>( cat $AM/am/src/x86/qemu/boot/bootblock.o;
  head -c 1024 /dev/zero;
  cat $BUILD/kernel-x86_64-qemu.elf
) &gt; $BUILD/kernel-x86_64-qemu
</code></pre></div>

<p class=" font-serif my-1">&#21703;&#21734;&#65281;&#25805;&#20316;&#31995;&#32479;&#22909;&#20687;&#20063;&#27809;&#26377;&#37027;&#20040;&#21487;&#24597;&#20102;&#12290;&#30495;&#30340;&#26159;&#12298;&#35745;&#31639;&#26426;&#31995;&#32479;&#22522;&#30784;&#12299;&#35838;&#19978;&#23398;&#36807;&#30340;&#32534;&#35793;-&#38142;&#25509;&#65292;&#23545;&#29031;&#30528;&#25163;&#20876;&#65292;&#23601;&#33021;&#30693;&#36947;&#20010;&#22823;&#27010;&#20102; (&#20010;&#21035;&#21442;&#25968;&#30340;&#20855;&#20307;&#21547;&#20041;&#20063;&#24182;&#19981;&#38656;&#35201;&#29702;&#35299;&#24471;&#38750;&#24120;&#28165;&#26970;&#65292;&#21482;&#38656;&#35201;&#30693;&#36947;&#36825;&#20123;&#26159;&#29992;&#20110;&#32534;&#35793;&#20986;&#19968;&#20010; &#8220;&#19981;&#20511;&#21161;&#25805;&#20316;&#31995;&#32479;&#8221; &#33021;&#30452;&#25509;&#36816;&#34892;&#22312;&#30828;&#20214;&#19978;&#30340;&#31243;&#24207;&#30340;&#23601;&#22815;&#20102;)&#12290;</p>
<p class=" font-serif my-1">&#20351;&#29992; <code>make run</code> &#32534;&#35793;&#36816;&#34892;&#65292;&#20320;&#23558;&#20250;&#30475;&#21040;&#19968;&#20010;&#22788;&#29702;&#22120;&#36755;&#20986; Hello World&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ make run ARCH=x86_64-qemu
# Building kernel-image [x86_64-qemu]
...
Got 125 MiB heap: [0x300000, 0x8000000)
Hello World from CPU #0
</code></pre></div>

<p class=" font-serif my-1">&#22914;&#26524;&#35201;&#21551;&#21160;&#22810;&#20010;&#22788;&#29702;&#22120;&#65292;&#21487;&#20197;&#20026; <code>make run</code> &#20256;&#36882; <code>smp</code> &#29615;&#22659;&#21464;&#37327;&#65292;&#20363;&#22914; <code>smp=2</code> &#20195;&#34920;&#21551;&#21160; 2 &#20010;&#22788;&#29702;&#22120;&#65307;<code>smp=4</code> &#20195;&#34920;&#21551;&#21160; 4 &#20010;&#22788;&#29702;&#22120;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ make run ARCH=x86_64 smp=4
...
Got 125 MiB heap: [0x300000, 0x8000000)
Hello World from CPU #1
Hello World from CPU #2
Hello World from CPU #3
Hello World from CPU #0
</code></pre></div>

<h3 id="42" class=" text-lg mt-2 pb-2 font-sans">4.2. &#26694;&#26550;&#20195;&#30721;&#23548;&#35835;</h3>
<p class=" font-serif my-1">&#26694;&#26550;&#20195;&#30721;&#24456;&#30701;&#65292;&#23427;&#30340; <code>main</code> &#20989;&#25968;&#39318;&#20808;&#25191;&#34892; <code>os</code> &#30340;&#21021;&#22987;&#21270;&#65292;&#28982;&#21518;&#21551;&#21160;&#22810;&#20010;&#22788;&#29702;&#22120;&#65292;&#27599;&#20010;&#22788;&#29702;&#22120;&#37117;&#36339;&#36716;&#21040; <code>os-&gt;run</code> &#25191;&#34892;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">os</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<span class="w">  </span><span class="n">mpe_init</span><span class="p">(</span><span class="n">os</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1"><code>os</code> &#26159;&#19968;&#20010;&#25805;&#20316;&#31995;&#32479;&#30340; &#8220;&#27169;&#22359;&#8221;&#65292;&#21487;&#20197;&#30475;&#25104;&#26159;&#25105;&#20204;&#29992; C &#23454;&#29616;&#30340;&#38754;&#21521;&#23545;&#35937;&#32534;&#31243;&#65292;&#33021;&#22686;&#21152;&#20195;&#30721;&#30340;&#21487;&#35835;&#24615;&#12290;&#25972;&#20010;&#26694;&#26550;&#20195;&#30721;&#20013;&#21807;&#19968;&#26377;&#20123;&#38590;&#20197;&#29702;&#35299;&#30340;&#37096;&#20998;&#23601;&#26159;&#27169;&#22359;&#30340;&#22768;&#26126;&#21644;&#23450;&#20041; (<code>framework/kernel.h</code>)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#define MODULE(mod) \</span>
<span class="cp">  typedef struct mod_##mod##_t mod_##mod##_t; \</span>
<span class="cp">  extern mod_##mod##_t *mod; \</span>
<span class="cp">  struct mod_##mod##_t</span>

<span class="cp">#define MODULE_DEF(mod) \</span>
<span class="cp">  extern mod_##mod##_t __##mod##_obj; \</span>
<span class="cp">  mod_##mod##_t *mod = &amp;__##mod##_obj; \</span>
<span class="cp">  mod_##mod##_t __##mod##_obj</span>
</code></pre></div>

<p class=" font-serif my-1">&#25105;&#20204;&#29992; <code>MODULE</code> &#22768;&#26126;&#19968;&#20010;&#27169;&#22359;&#65292;&#29992; <code>MODULE_DEF</code> &#23454;&#38469;&#23450;&#20041;&#23427;&#12290;</p>
<p class=" font-serif my-1">&#36825;&#20010;&#23439;&#30340;&#35270;&#35273;&#25928;&#26524;&#24456;&#24046;&#65292;&#20026;&#20102;&#38405;&#35835;&#23427;&#65292;&#22823;&#23478;&#19981;&#22952;&#21487;&#20197;&#22312;&#21018;&#25165;&#30475;&#21040;&#30340;&#32534;&#35793;&#21629;&#20196;&#20013;&#25226; <code>-c -o ...</code> &#26367;&#25442;&#25104; <code>-E</code>&#65292;&#23601;&#24471;&#21040;&#20102;&#39044;&#32534;&#35793;&#21518;&#30340;&#20195;&#30721;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mod_os_t</span><span class="w"> </span><span class="n">mod_os_t</span><span class="p">;</span>
<span class="k">extern</span><span class="w"> </span><span class="n">mod_os_t</span><span class="w"> </span><span class="o">*</span><span class="n">os</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mod_os_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">run</span><span class="p">)();</span>
<span class="p">};</span>

<span class="p">...</span>

<span class="k">extern</span><span class="w"> </span><span class="n">mod_os_t</span><span class="w"> </span><span class="n">__os_obj</span><span class="p">;</span>
<span class="n">mod_os_t</span><span class="w"> </span><span class="o">*</span><span class="n">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">__os_obj</span><span class="p">;</span>
<span class="n">mod_os_t</span><span class="w"> </span><span class="n">__os_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os_init</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os_run</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p class=" font-serif my-1">&#28982;&#21518;&#20320;&#23601;&#21487;&#20197;&#23545;&#29031;&#30528;&#38405;&#35835;&#39044;&#32534;&#35793;&#30340;&#20195;&#30721; (&#29992;&#23545;&#20102;&#26041;&#27861;&#65292;&#20063;&#23601;&#27809;&#26377;&#37027;&#20040;&#38590;&#20102;)&#65292;&#21482;&#38656;&#35201;&#35760;&#20303;&#20197;&#19979;&#20004;&#28857;&#65306;</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">&#23439;&#26159;&#23383;&#38754;&#26367;&#25442;&#65292;<code>MODULE(mod)</code> &#20013;&#25152;&#26377;&#30340; &#8220;<code>mod</code>&#8221; &#37117;&#20250;&#34987;&#26367;&#25442;&#25481;&#65307;</li>
<li class=" ml-8"><code>##</code> &#26159; C &#35821;&#35328;&#29992;&#26469;&#25340;&#25509;&#26631;&#35782;&#31526;&#30340;&#26426;&#21046;&#65292;<code>sys ## tem</code> &#23558;&#20250;&#24471;&#21040; <code>system</code>;</li>
</ol>
<p class=" font-serif my-1">&#22914;&#26524;&#20320;&#38405;&#35835;&#19978;&#36848;&#20195;&#30721;&#24863;&#21040;&#38556;&#30861;&#65292;&#20320;&#21487;&#33021;&#38656;&#35201;&#34917;&#20805;&#65306;(1) <code>typedef</code> &#31867;&#22411;&#21035;&#21517;&#23450;&#20041;, (2) <code>extern</code> &#20851;&#38190;&#23383;, (3) C11 &#32467;&#26500;&#20307;&#21021;&#22987;&#21270;&#30340;&#30693;&#35782;&#12290;&#21478;&#22806;&#65292;&#19979;&#21010;&#32447; <code>_</code> &#20063;&#21487;&#20197;&#26159;&#26631;&#35782;&#31526;&#30340;&#19968;&#37096;&#20998;&#12290;</p>
<p class=" font-serif my-1">&#38543;&#30528;&#23454;&#39564;&#30340;&#36827;&#23637;&#65292;&#20320;&#20250;&#21457;&#29616;&#27169;&#22359;&#26426;&#21046;&#28165;&#26224;&#22320;&#21246;&#21202;&#20986;&#20102;&#25805;&#20316;&#31995;&#32479;&#20013;&#21508;&#20010;&#37096;&#20998;&#20197;&#21450;&#23427;&#20204;&#20043;&#38388;&#30340;&#20132;&#20114;&#65292;&#33021;&#22815;&#24110;&#21161;&#22823;&#23478;&#26356;&#22909;&#22320;&#29702;&#35299;&#25805;&#20316;&#31995;&#32479;&#30340;&#23454;&#29616;&#21407;&#29702;&#12290;</p>
<h3 id="43" class=" text-lg mt-2 pb-2 font-sans">4.3. &#26694;&#26550;&#20195;&#30721;&#30340;&#25191;&#34892;</h3>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_3" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#22909;&#28040;&#24687;&#65306;&#23454;&#39564;&#20570;&#20986;&#30340;&#31616;&#21270;</h4>
<p class=" font-serif my-1">&#22312;&#36825;&#20010;&#23454;&#39564;&#20013;&#65292;&#25105;&#20204;&#21482;&#21551;&#21160;&#20102; AbstractMachine &#20013;&#30340; TRM &#21644; MPE&#65292;&#22240;&#27492;&#20320;&#19981;&#24517;&#32771;&#34385;&#20013;&#26029;&#21644;&#22810;&#22788;&#29702;&#22120;&#21516;&#26102;&#24102;&#26469;&#30340;&#35832;&#22810;&#40635;&#28902; (&#19979;&#19968;&#20010;&#23454;&#39564;&#25165;&#24320;&#22987;&#32771;&#34385;)&#12290;&#20320;&#19981;&#22952;&#25226;&#27599;&#20010;&#22788;&#29702;&#22120;&#24819;&#35937;&#25104;&#19968;&#20010;&#32447;&#31243;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#25105;&#20204;&#30340;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#65292;&#30446;&#21069;&#21482;&#26377;&#20004;&#20010;&#20989;&#25968;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>os-&gt;init()</code> &#23436;&#25104;&#25805;&#20316;&#31995;&#32479;&#25152;&#26377;&#37096;&#20998;&#30340;&#21021;&#22987;&#21270;&#12290;<code>os-&gt;init()</code> &#36816;&#34892;&#22312;&#31995;&#32479;&#21551;&#21160;&#21518;&#30340;&#31532;&#19968;&#20010;&#22788;&#29702;&#22120;&#19978;&#65292;&#20013;&#26029;&#22788;&#20110;&#20851;&#38381;&#29366;&#24577;&#65307;&#27492;&#26102;&#31995;&#32479;&#20013;&#30340;&#20854;&#20182;&#22788;&#29702;&#22120;&#23578;&#26410;&#34987;&#21551;&#21160;&#12290;&#22240;&#27492;&#22312; <code>os-&gt;init</code> &#30340;&#23454;&#29616;&#20013;&#65292;&#20320;&#23436;&#20840;&#19981;&#24517;&#32771;&#34385;&#25968;&#25454;&#31454;&#20105;&#31561;&#22810;&#22788;&#29702;&#22120;&#19978;&#30340;&#38382;&#39064;&#12290;</li>
<li class=" ml-8"><code>os-&gt;run()</code> &#26159;&#25152;&#26377;&#22788;&#29702;&#22120;&#30340;&#20837;&#21475;&#65292;&#22312;&#21021;&#22987;&#21270;&#23436;&#25104;&#21518;&#65292;&#26694;&#26550;&#20195;&#30721;&#35843;&#29992; <code>_mpe_init(os-&gt;run)</code> &#21551;&#21160;&#25152;&#26377;&#22788;&#29702;&#22120;&#25191;&#34892;&#12290;&#26694;&#26550;&#20195;&#30721;&#20013;&#65292;<code>os-&gt;run</code> &#21482;&#26159;&#25171;&#21360; Hello World &#20043;&#21518;&#23601;&#24320;&#22987;&#27515;&#24490;&#29615;&#65307;&#20320;&#20043;&#21518;&#21487;&#20197;&#22312; <code>os-&gt;run</code> &#20013;&#28155;&#21152;&#21508;&#31181;&#27979;&#35797;&#20195;&#30721;&#12290;</li>
</ul>
<p class=" font-serif my-1">&#25152;&#20197;&#23601;&#24819;&#35937;&#25104;&#26159;&#20320;&#30340; <code>os-&gt;run()</code> &#23601;&#26159; <code>threads.h</code> &#37324;&#21019;&#24314;&#30340;&#19968;&#20010;&#32447;&#31243;&#65292;&#20165;&#27492;&#32780;&#24050;&#65281;</p>
<h3 id="44-kallockfree" class=" text-lg mt-2 pb-2 font-sans">4.4. &#23454;&#29616; kalloc/kfree</h3>
<p class=" font-serif my-1">&#25105;&#20204;&#30340;&#23454;&#29616;&#20027;&#35201;&#22312; pmm (physical memory management) &#27169;&#22359;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="n">MODULE</span><span class="p">(</span><span class="n">pmm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc</span><span class="p">)(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p class=" font-serif my-1">&#27169;&#22359;&#21253;&#21547;&#19977;&#20010;&#20989;&#25968;&#25351;&#38024;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><code>pmm-&gt;init()</code> &#21021;&#22987;&#21270; pmm &#27169;&#22359;&#65292;&#23427;&#24212;&#24403;&#22312;&#22810;&#22788;&#29702;&#22120;&#21551;&#21160;&#21069; (<code>os-&gt;init()</code> &#20013;) &#35843;&#29992;&#12290;&#20320;&#20250;&#22312;&#36825;&#37324;&#23436;&#25104;&#25968;&#25454;&#32467;&#26500;&#12289;&#38145;&#30340;&#21021;&#22987;&#21270;&#31561;&#65307;</li>
<li class=" ml-8"><code>pmm-&gt;alloc()</code> &#23545;&#24212;&#23454;&#39564;&#35201;&#27714;&#20013;&#30340; kalloc&#65307;</li>
<li class=" ml-8"><code>pmm-&gt;free()</code> &#23545;&#24212;&#23454;&#39564;&#35201;&#27714;&#20013;&#30340; kfree&#12290;</li>
</ul>
<p class=" font-serif my-1">&#26694;&#26550;&#20195;&#30721;&#20013;&#21253;&#21547;&#20102; &#8220;&#31354;&#30340;&#8221; pmm &#23454;&#29616;&#65292;&#23427;&#23545;&#20219;&#20309;&#20869;&#23384;&#20998;&#37197;&#30340;&#35831;&#27714;&#37117;&#36820;&#22238;&#22833;&#36133;&#65292;&#22240;&#27492;&#23427;&#28385;&#36275; safety&#65292;&#20294;&#23436;&#20840;&#27809;&#26377; liveness&#65292;&#20223;&#20315;&#22534;&#21306;&#30340;&#22823;&#23567;&#20026;&#38646;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pmm_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="n">MODULE_DEF</span><span class="p">(</span><span class="n">pmm</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.</span><span class="n">init</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pmm_init</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kalloc</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">free</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">kfree</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="static" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#24605;&#32771;&#39064;&#65306;static &#20989;&#25968;</h4>
<p class=" font-serif my-1">&#20026;&#20160;&#20040; kalloc/kfree/pmm_init &#22768;&#26126;&#25104;&#20102; <code>static</code>&#65311;&#25105;&#25226; <code>static</code> &#21435;&#25481;&#20381;&#28982;&#21487;&#20197;&#32534;&#35793;&#21568;&#65311;</p>
<p class=" font-serif my-1">&#36825;&#26159;&#19968;&#20010;&#22909;&#30340;&#32534;&#31243;&#20064;&#24815;&#65292;&#22312; C &#36825;&#26679;&#32570;&#23569; module/package/namespace &#26426;&#21046;&#30340;&#32534;&#31243;&#35821;&#35328;&#19978;&#26377;&#25928;&#20943;&#23569;&#24847;&#22806;&#21457;&#29983;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#25105;&#20204;&#22312;&#35762;&#35299; &#8220;&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;&#8221; &#26102;&#35762;&#35299;&#20102; kalloc/free &#30340;&#31639;&#27861;&#21644;&#23454;&#29616;&#12290;&#20320;&#24212;&#35813;&#38405;&#35835;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#25945;&#31185;&#20070;&#31532; 29 &#31456; (&#24182;&#21457;&#25968;&#25454;&#32467;&#26500;)&#65292;&#23398;&#20064;&#22914;&#20309;&#23545;&#25968;&#25454;&#32467;&#26500;&#36827;&#34892;&#24182;&#21457;&#25511;&#21046;&#65307;</li>
<li class=" ml-8">&#25945;&#31185;&#20070;&#31532; 17 &#31456; (&#31354;&#38386;&#31354;&#38388;&#31649;&#29702;)&#65292;&#23398;&#20064;&#22914;&#20309;&#31649;&#29702;&#29289;&#29702;&#20869;&#23384;&#65307;</li>
<li class=" ml-8">&#20114;&#32852;&#32593;&#19978;&#30340;&#20854;&#20182;&#36164;&#26009;&#12290;&#22914;&#26524;&#20320;&#24076;&#26395;&#20102;&#35299;&#29616;&#20195; malloc &#23454;&#29616;&#65292;&#20320;&#21487;&#20197;&#21442;&#32771;&#26469;&#33258;&#20004;&#20010;&#20195;&#30721;&#24040;&#22836;&#30340;&#35774;&#35745;&#65306;Google &#30340; <a href="https://google.github.io/tcmalloc/" class=" text-amber-900">tcmalloc</a> &#21644; Microsoft &#30340; <a href="https://microsoft.github.io/mimalloc" class=" text-amber-900">mimalloc</a>&#12290;</li>
</ul>
<h3 id="45" class=" text-lg mt-2 pb-2 font-sans">4.5. &#27979;&#35797;/&#35843;&#35797;&#20320;&#30340;&#20195;&#30721;</h3>
<h4 id="451" class=" pt-2 pb-2 font-sans">4.5.1. &#20570;&#19968;&#20010;&#27979;&#35797;&#26694;&#26550;</h4>
<p class=" font-serif my-1">AbstractMachine &#20195;&#30721;&#30340;&#35843;&#35797;&#24182;&#19981;&#23481;&#26131;&#8212;&#8212;&#19981;&#35770;&#26159; native &#36824;&#26159;&#36816;&#34892;&#22312;&#27169;&#25311;&#22120;&#37324;&#65292;AM APIs &#37117;&#21644;&#31995;&#32479;&#26377;&#32039;&#23494;&#30340;&#32806;&#21512;&#12290;&#22823;&#23478;&#26377;&#27809;&#26377;&#24819;&#36807;&#65292;&#20320;&#20204;&#30340;&#20195;&#30721;&#26159;&#21542;&#21487;&#20197;&#38142;&#25509; <code>threads.h</code> &#30452;&#25509;&#36816;&#34892;&#27979;&#35797;&#21602;&#65311;&#31572;&#26696;&#24403;&#28982;&#26159;&#32943;&#23450;&#30340;&#65281;&#22312;&#36825;&#20010;&#23454;&#39564;&#37324;&#65292;&#20570;&#19968;&#20010;&#27979;&#35797;&#26694;&#26550;&#23545;&#20320;&#25214;&#21040; bug &#20854;&#23454;&#26159;&#38750;&#24120;&#26377;&#29992;&#30340;&#12290;</p>
<p class=" font-serif my-1">&#20320;&#21487;&#20197;&#21019;&#24314;&#19968;&#20010; test &#30446;&#24405;&#65292;&#29992;&#20110;&#23384;&#25918;&#21644;&#27979;&#35797;&#30456;&#20851;&#30340;&#20195;&#30721;&#65292;&#20363;&#22914;&#25105;&#20204;&#25552;&#20379;&#30340; <code>threads.h</code>:</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ tree test 
test
&#9500;&#9472;&#9472; am.h # &#19968;&#20010;&#31354;&#30340; am.h
&#9500;&#9472;&#9472; common.h
&#9500;&#9472;&#9472; test.c
&#9492;&#9472;&#9472; threads.h # &#19978;&#35838;&#26102;&#32473;&#20986;&#30340;&#20195;&#30721;
</code></pre></div>

<p class=" font-serif my-1">&#38500;&#27492;&#20043;&#22806;&#65292;&#25152;&#26377;&#30340;&#25805;&#20316;&#31995;&#32479;/&#26694;&#26550;&#20195;&#30721;&#31561;&#37117;&#21644;&#20043;&#21069;&#20445;&#25345;&#19968;&#33268;&#8212;&#8212;&#25105;&#20204;&#36890;&#36807;&#26368;&#23567;&#30340;&#12289;&#38750;&#20405;&#20837;&#24335;&#30340;&#39033;&#30446;&#20462;&#25913;&#30830;&#20445;&#20320;&#22312;&#20219;&#20309;&#26102;&#20505;&#37117;&#21487;&#20197;&#36890;&#36807; <code>make submit</code> &#30452;&#25509;&#25552;&#20132;&#20195;&#30721;&#32780;&#19981;&#38656;&#35201;&#20570;&#20986;&#20219;&#20309;&#39069;&#22806;&#30340;&#20462;&#25913;&#12290;&#36825;&#20123;&#33258;&#21160;&#24037;&#20855;/&#20195;&#30721;&#26694;&#26550;&#23545;&#20110;&#20570;&#23454;&#39564; (&#21253;&#25324;&#20570; Online Judge) &#37117;&#26159;&#38750;&#24120;&#20540;&#24471;&#30340;&#12290;</p>
<p class=" font-serif my-1">&#20026;&#20102;&#35753;&#25105;&#20204;&#30340;&#20195;&#30721;&#33021;&#22815;&#20860;&#23481;&#65292;&#20320;&#21487;&#20197;&#38656;&#35201;&#22686;&#21152;&#19968;&#20123;&#26465;&#20214;&#32534;&#35793;&#65292;&#20363;&#22914;&#65292;&#22312; <code>pmm.c</code> &#20013;&#65292;&#34429;&#28982;&#20320;&#30340; <code>kalloc</code> &#21644; <code>kfree</code> &#30340;&#23454;&#29616;&#21487;&#20197;&#20445;&#25345;&#19981;&#21464;&#65292;&#20294;&#21021;&#22987;&#21270;&#20195;&#30721;&#21017;&#38656;&#35201;&#19981;&#21516;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="cp">#ifndef TEST</span>
<span class="c1">// &#26694;&#26550;&#20195;&#30721;&#20013;&#30340; pmm_init (&#22312; AbstractMachine &#20013;&#36816;&#34892;)</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pmm_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pmsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">heap</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">heap</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Got %d MiB heap: [%p, %p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">pmsize</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">heap</span><span class="p">.</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">heap</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="c1">// &#27979;&#35797;&#20195;&#30721;&#30340; pmm_init ()</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pmm_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">HEAP_SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="n">heap</span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">  </span><span class="n">heap</span><span class="p">.</span><span class="n">end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEAP_SIZE</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Got %d MiB heap: [%p, %p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">HEAP_SIZE</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">heap</span><span class="p">.</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">heap</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</code></pre></div>

<p class=" font-serif my-1">&#22312;&#20320;&#30456;&#24212;&#23436;&#25104;&#20004;&#20010;&#19981;&#21516;&#29615;&#22659;&#30340;&#26465;&#20214;&#32534;&#35793;&#21518;&#65292;&#22312;&#20320;&#30340; Makefile &#37324;&#22686;&#21152;&#19968;&#20010;&#32534;&#35793;&#30446;&#26631; (&#25105;&#20204;&#28155;&#21152;&#20102; git &#30340;&#20381;&#36182;&#65292;&#20351;&#24471;&#20320;&#30340;&#25552;&#20132;&#34987;&#27491;&#30830;&#36861;&#36394;)&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nf">test</span><span class="o">:</span><span class="w"> </span><span class="n">git</span>
<span class="w">        </span>@gcc<span class="w"> </span><span class="k">$(</span>shell<span class="w"> </span>find<span class="w"> </span>src/<span class="w"> </span>-name<span class="w"> </span><span class="s2">"*.c"</span><span class="k">)</span><span class="w">  </span><span class="se">\</span>
<span class="w">             </span><span class="k">$(</span>shell<span class="w"> </span>find<span class="w"> </span>test/<span class="w"> </span>-name<span class="w"> </span><span class="s2">"*.c"</span><span class="k">)</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-Iframework<span class="w"> </span>-Itest<span class="w"> </span>-DTEST<span class="w"> </span>-lpthread<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-o<span class="w"> </span>build/test
<span class="w">        </span>@build/test
</code></pre></div>

<p class=" font-serif my-1">&#28982;&#21518;&#23601;&#21487;&#20197;&#24841;&#24555;&#22320;&#20889;&#27979;&#35797;&#20195;&#30721;&#21862; (<code>test.c</code>):</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">entry</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">goodbye</span><span class="p">()</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">"End.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pmm</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">create</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="w">  </span><span class="n">join</span><span class="p">(</span><span class="n">goodbye</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_4" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#25226;&#26102;&#38388;&#25237;&#36164;&#22312;&#26694;&#26550;&#24314;&#35774;&#19978;</h4>
<p class=" font-serif my-1">&#20320;&#21487;&#33021;&#38656;&#35201;&#33457;&#19968;&#28857;&#26102;&#38388;&#25165;&#33021;&#23436;&#25104; <code>make</code> &#21644; <code>make test</code> &#20849;&#29992;&#21516;&#19968;&#20221; kalloc/kfree &#20195;&#30721;&#30340;&#26694;&#26550;&#12290;&#20294;&#36825;&#32477;&#23545;&#26159;&#20540;&#24471;&#30340;&#12290;&#19968;&#26086;&#23436;&#25104;&#65292;&#30452;&#25509;&#27979;&#35797;/&#35843;&#35797;&#26412;&#22320;&#20195;&#30721;&#30340;&#22909;&#22788;&#26159;&#24040;&#22823;&#30340;&#8212;&#8212;&#23427;&#33410;&#30465;&#20102;&#32534;&#35793;&#12289;&#36816;&#34892;&#12289;&#35843;&#35797;&#8230;&#8230;&#25972;&#20010;&#24320;&#21457;&#27969;&#31243;&#30340; overhead&#12290;&#20219;&#20309;&#24819;&#29992; &#8220;&#34542;&#21147;&#8221; &#25226;&#23454;&#39564;&#31946;&#24324;&#36807;&#21435;&#37117;&#23558;&#23548;&#33268;&#24040;&#22823;&#30340;&#26102;&#38388;&#28010;&#36153;&#12290;</p>
</blockquote>
<h3 id="452" class=" text-lg mt-2 pb-2 font-sans">4.5.2. &#35774;&#35745;&#27979;&#35797;&#29992;&#20363;</h3>
<p class=" font-serif my-1">&#22914;&#26524;&#19981;&#24819;&#34987; Online Judge &#25240;&#30952;&#24471;&#27515;&#21435;&#27963;&#26469;&#65292;&#20320;&#24212;&#24403;&#35774;&#35745;&#19968;&#20010;&#33258;&#24049;&#30340;&#27979;&#35797;&#26694;&#26550;&#65292;&#23581;&#35797;&#19981;&#21516;&#31867;&#22411;&#30340;&#27979;&#35797;&#65292;&#20363;&#22914;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#38024;&#23545;&#25968;&#25454;&#32467;&#26500;&#30340;&#21333;&#20803;&#27979;&#35797;&#65307;</li>
<li class=" ml-8">&#26368;&#22522;&#26412;&#30340; smoke test&#65292;&#27979;&#35797;&#21333;&#32447;&#31243;&#29256;&#26412;&#26159;&#21542;&#27491;&#30830;&#65307;</li>
<li class=" ml-8">&#22522;&#26412;&#30340;&#24182;&#21457;&#27979;&#35797;&#65292;&#20363;&#22914;&#22810;&#20010;&#22788;&#29702;&#22120;&#24182;&#21457;&#22320;&#20998;&#37197; (&#20294;&#19981;&#22238;&#25910;)&#65307;</li>
<li class=" ml-8">&#38024;&#23545;&#22238;&#25910;&#19987;&#38376;&#35774;&#35745;&#30340;&#27979;&#35797;&#65307;</li>
<li class=" ml-8">&#26497;&#31471;&#24773;&#20917;&#19979;&#30340;&#21387;&#21147;&#27979;&#35797; (&#25105;&#20204;&#20250;&#36825;&#20040;&#20570;&#65281;)<ul class=" list-disc font-serif">
<li class=" ml-8">&#22312;&#22810;&#20010;&#22788;&#29702;&#22120;&#19978;&#27169;&#25311;&#21508;&#31181;&#19981;&#21516;&#31867;&#22411;&#30340;&#20869;&#23384;&#35775;&#38382;&#27169;&#24335;<ul class=" list-disc font-serif">
<li class=" ml-8">&#39057;&#32321;&#30340;&#23567;&#20869;&#23384;&#30003;&#35831;&#65307;</li>
<li class=" ml-8">&#39057;&#32321;&#30340;&#22823;&#20869;&#23384;&#30003;&#35831;&#65307;</li>
<li class=" ml-8">&#28151;&#21512;&#30340;&#20869;&#23384;&#30003;&#35831;&#65307;</li>
<li class=" ml-8">&#22810;&#22788;&#29702;&#22120;&#31454;&#20105;&#30340;&#30003;&#35831;/&#37322;&#25918;&#8230;&#8230;</li>
</ul>
</li>
<li class=" ml-8">&#20320;&#36824;&#38656;&#35201;&#26377;&#20010;&#21150;&#27861;&#39564;&#35777;&#20320;&#30340; kalloc/free &#26159;&#21542;&#27491;&#30830;<ul class=" list-disc font-serif">
<li class=" ml-8">&#19968;&#20010;&#21487;&#34892;&#30340;&#26041;&#26696;&#26159;&#65292;&#27599;&#27425;&#20998;&#37197;/&#37322;&#25918;&#37117;&#29992; printf &#25171;&#21360;&#19968;&#26465;&#35760;&#24405;&#65292;&#28982;&#21518;&#20877;&#20889;&#19968;&#20010;&#23567;&#33050;&#26412;&#35299;&#26512;&#35760;&#24405;&#65292;&#30830;&#20445;&#20363;&#22914;&#21516;&#19968;&#27573;&#20869;&#23384;&#27809;&#26377;&#34987;&#20998;&#37197;&#32473;&#20004;&#20010; kalloc&#12290;</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1">&#36825;&#26102;&#20505;&#65292;&#20195;&#30721;&#26694;&#26550;&#30340;&#23041;&#21147;&#23601;&#26174;&#31034;&#20986;&#26469;&#20102;&#65281;&#20320;&#21487;&#20197;&#24456;&#23481;&#26131;&#22320;&#25209;&#37327;&#36816;&#34892;&#24456;&#22810;&#27979;&#35797;&#65292;&#20363;&#22914;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">do_test_0</span><span class="p">();</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">do_test_1</span><span class="p">();</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">&#28982;&#21518;&#22312;&#20320;&#30340; Makefile &#37324;&#25209;&#37327;&#36816;&#34892;&#23427;&#20204;&#65306;</p>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="nf">testall</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>
<span class="w">        </span>@build/test<span class="w"> </span><span class="m">0</span>
<span class="w">        </span>@build/test<span class="w"> </span><span class="m">1</span>
<span class="w">        </span>@build/test<span class="w"> </span><span class="m">2</span>
<span class="w">        </span>...
</code></pre></div>

<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="_5" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#35686;&#24789;&#24182;&#21457;</h4>
<p class=" font-serif my-1">&#24456;&#21487;&#33021;&#20320;&#30340;&#39034;&#24207;&#27979;&#35797;&#23436;&#20840;&#36890;&#36807;&#65292;&#20294;&#22810;&#22788;&#29702;&#22120;&#36305;&#36215;&#26469;&#23601;&#25346;&#20102;&#12290;&#19981;&#35201;&#24908;&#65292;&#22810;&#21152;&#28857; printf logs&#65292;&#24930;&#24930;&#35786;&#26029;&#21487;&#33021;&#30340;&#38382;&#39064;&#12290;&#28982;&#21518;&#20320;&#21487;&#33021;&#20250;&#24778;&#22855;&#22320;&#21457;&#29616;&#65292;&#20063;&#35768;&#21152;&#20102;&#19968;&#20010; printf&#65292;&#38169;&#35823;&#23601;&#19981;&#35265;&#20102;&#12290;&#27492;&#26102;&#30340;&#24314;&#35758;&#26159;&#35843;&#25972; workloads&#12289;&#22686;&#21152;&#24310;&#36831;&#31561;&#20445;&#35777; bug &#30340;&#31283;&#23450;&#20877;&#29616;&#65292;&#28982;&#21518;&#20877;&#36827;&#34892;&#35786;&#26029;&#12290;&#22914;&#26524;&#20320;&#24076;&#26395;&#23454;&#29616;&#21508;&#31181; fancy &#30340;&#31639;&#27861;&#65292;&#19981;&#22952;&#20174;&#19968;&#25226;&#22823;&#38145;&#20445;&#25252; kalloc/free &#24320;&#22987;&#12290;&#36825;&#26159;&#20010;&#19981;&#38169;&#30340;&#20027;&#24847;&#8212;&#8212;&#36825;&#26679;&#20320;&#19968;&#24320;&#22987;&#23601;&#21482;&#38656;&#35201;&#20851;&#27880;&#21333;&#32447;&#31243; kalloc/free &#30340;&#27491;&#30830;&#24615;&#12290;&#24403;&#20320;&#38656;&#35201;&#24615;&#33021;&#30340;&#26102;&#20505;&#65292;&#20877;&#36880;&#27493;&#25226;&#38145;&#25286;&#24320;&#12290;</p>
</blockquote>
<h3 id="453" class=" text-lg mt-2 pb-2 font-sans">4.5.3 &#24615;&#33021;&#35843;&#20248;</h3>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<h4 id="workload" class=" pt-2 pb-2 font-sans float-left text-sm box border mr-1 mt-1 box-blue" style=" padding-bottom: 0;">&#25243;&#24320; workload &#35848;&#20248;&#21270;&#65292;&#23601;&#26159;&#32781;&#27969;&#27667;</h4>
<p class=" font-serif my-1"><em>Premature optimization is the root of all evil.</em> &#8212;&#8212; D. E. Knuth</p>
<p class=" font-serif my-1">&#35201;&#32771;&#34385;&#22909;&#20320;&#20248;&#21270;&#30340;&#22330;&#26223;&#65292;&#21542;&#21017;&#19968;&#20999;&#37117;&#26159;&#31354;&#35848;&#12290;</p>
</blockquote>
<p class=" font-serif my-1">&#20320;&#38656;&#35201;&#36873;&#21462;&#36866;&#24403;&#30340; workload &#36827;&#34892;&#35843;&#20248;&#65292;&#24182;&#19988;&#29702;&#35299;&#20320;&#31243;&#24207;&#30340;&#24615;&#33021;&#29942;&#39048;&#22312;&#21738;&#37324;&#12290;&#36825;&#26102;&#20505;&#65292;&#38752; &#8220;&#29468;&#8221; &#21644;&#38543;&#26426;&#20462;&#25913;&#31243;&#24207;&#20197;&#33719;&#24471;&#24615;&#33021;&#25552;&#21319;&#30340;&#26041;&#24335;&#26159;&#19981;&#19987;&#19994;&#30340;&#34920;&#29616;&#12290;&#29702;&#35299;&#31243;&#24207;&#24615;&#33021;&#30340;&#26368;&#22909;&#26041;&#27861;&#26159;&#20351;&#29992;&#27491;&#30830;&#30340;&#24037;&#20855;&#65306;profiler&#12290;&#20316;&#20026;&#26412;&#22320;&#36827;&#31243;&#36816;&#34892;&#30340;&#27979;&#35797;&#29992;&#20363;&#20063;&#33021;&#26356;&#23481;&#26131;&#22320; profile&#8212;&#8212;&#20320;&#21487;&#20197;&#29992; Linux &#31995;&#32479;&#33258;&#24102;&#30340;&#21508;&#31181;&#24037;&#20855;&#25214;&#21040;&#20320;&#23454;&#29616;&#30340;&#24615;&#33021;&#29942;&#39048;&#12290;&#24403;&#28982;&#65292;&#36825;&#20010;&#23454;&#39564;&#23545;&#24615;&#33021;&#30340;&#35201;&#27714;&#24182;&#19981;&#39640;&#65292;&#22823;&#23478;&#20307;&#39564;&#19968;&#19979;&#21363;&#21487;&#12290;</p>
<p class=" font-serif my-1">&#24403;&#28982;&#65292;&#36825;&#20010;&#23454;&#39564;&#32473;&#22823;&#23478;&#30340;&#21095;&#36879;&#26159;&#65306;&#22914;&#26524;&#25968;&#25454;&#32467;&#26500;&#36873;&#25321;&#24471;&#19981;&#22826;&#24046;&#65292;&#24615;&#33021;&#29942;&#39048;&#23601;&#20027;&#35201;&#22312;&#20110;&#22810;&#20010;&#32447;&#31243;&#24182;&#21457;&#35775;&#38382;&#26102;&#30340;&#20114;&#26021;&#65292;&#30001;&#20110;&#22810;&#20010;&#32447;&#31243;&#37117;&#38656;&#35201;&#33719;&#24471;&#21516;&#19968;&#25226;&#38145;&#65292;&#23601;&#20250;&#20986;&#29616; &#8220;&#19968;&#26680;&#20986;&#21147;&#12289;&#20182;&#20154;&#22260;&#35266;&#8221; &#30340;&#24773;&#20917;&#12290;&#27491;&#22914;&#35838;&#26412;&#19978;&#25152;&#35828;&#65292;&#29616;&#20195; malloc/free &#23454;&#29616;&#30340;&#20027;&#35201;&#24605;&#24819;&#23601;&#26159;&#21306;&#20998; fast/slow path&#65292;&#20351;&#24471; fast path &#20998;&#37197;&#22312;&#32447;&#31243;&#26412;&#22320;&#23436;&#25104;&#65292;&#20174;&#32780;&#19981;&#20250;&#36896;&#25104;&#38145;&#30340;&#20105;&#25250;&#12290;&#20320;&#20063;&#21487;&#20197;&#20026;&#27599;&#20010; CPU &#20998;&#37197;&#39029;&#38754;&#30340;&#32531;&#23384;&#8212;&#8212;&#21487;&#20197;&#20511;&#37492; slab&#65292;&#20063;&#21487;&#20197;&#39044;&#20808;&#25226;&#39029;&#38754;&#20998;&#37197;&#32473; CPU&#65292;&#22312;&#20869;&#23384;&#19981;&#36275;&#26102;&#20877;&#19978;&#38145;&#20174;&#20854;&#20182; CPU &#8220;&#20599;&#21462;&#8221; &#39029;&#38754;&#12290;</p>
<h2 id="5" class=" text-xl mt-2 pb-2 font-sans">5. &#25805;&#20316;&#31995;&#32479;&#20013;&#30340;&#20869;&#23384;&#31649;&#29702;</h2>
<p class=" font-serif my-1">&#24456;&#22810;&#29616;&#20195;&#32534;&#31243;&#35821;&#35328;&#37117;&#36816;&#34892;&#22312;&#33258;&#21160;&#31649;&#29702;&#20869;&#23384;&#30340;&#30340;&#36816;&#34892;&#26102;&#29615;&#22659;&#19978;&#65306;Java, Python, Javascript, ...&#23427;&#20204;&#30340;&#29305;&#28857;&#26159;&#65306;&#27809;&#26377; raw pointer&#65292;&#20063;&#27809;&#26377; API &#29992;&#20110; &#8220;&#37322;&#25918;&#8221; &#20869;&#23384;&#12290;&#24403;&#19968;&#20010;&#23545;&#35937;&#20174;&#19968;&#31995;&#21015;&#30340; root objects (&#20363;&#22914;&#26632;&#19978;&#30340;&#23616;&#37096;&#21464;&#37327;&#12289;&#20840;&#23616;&#21464;&#37327;&#31561;&#8230;&#8230;) &#36890;&#36807;&#24341;&#29992;&#20851;&#31995;&#19981;&#21487;&#36798;&#65292;&#23427;&#20204;&#23601;&#20250;&#33258;&#21160;&#34987;&#36816;&#34892;&#26102;&#29615;&#22659;&#22238;&#25910;&#12290;&#36825;&#30495;&#26159;&#31243;&#24207;&#21592;&#30340;&#31119;&#38899;&#8212;&#8212;&#20877;&#20063;&#27809;&#26377; use-after-free, double-free &#31561;&#38382;&#39064;&#20102;&#65292;memory leak &#30340;&#21487;&#33021;&#24615;&#20063;&#22823;&#22823;&#38477;&#20302; (&#34429;&#28982;&#20381;&#28982;&#21487;&#33021;&#20250;&#26377;)&#12290;</p>
<p class=" font-serif my-1">&#24403;&#28982;&#65292;&#33258;&#21160;&#20869;&#23384;&#31649;&#29702;&#24102;&#26469;&#30340;&#38382;&#39064;&#26159;&#20869;&#23384;&#22238;&#25910;&#26159;&#20010; highly non-trivial &#30340;&#38382;&#39064;&#65292;&#33267;&#20170;&#20173;&#28982;&#19981;&#33021;&#31639;&#24443;&#24213;&#23436;&#32654;&#22320;&#35299;&#20915;&#65292;&#29983;&#20135;&#31995;&#32479;&#20381;&#28982;&#32463;&#24120;&#21463;&#21040;&#22403;&#22334;&#22238;&#25910; (&#22238;&#25910;&#19981;&#21487;&#36798;&#23545;&#35937;) &#20572;&#39039;/&#38477;&#20302;&#24615;&#33021;&#30340;&#22256;&#25200;&#12290;&#30001;&#20110;&#25805;&#20316;&#31995;&#32479;&#30340;&#24615;&#33021;&#33267;&#20851;&#37325;&#35201;&#65292;&#35753;&#22403;&#22334;&#22238;&#25910;&#21344;&#25454;&#22788;&#29702;&#22120;&#36816;&#34892;&#20284;&#20046;&#19981;&#26159;&#20010;&#22909;&#20027;&#24847;&#8230;&#8230;&#26410;&#24517;&#65281;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">&#38405;&#35835;&#26448;&#26009;&#65306;Cody Cutler, M. Frans Kaashoek, and Robert T. Morris. <a href="https://www.usenix.org/conference/osdi18/presentation/cutler" class=" text-amber-900">The benefits and costs of writing a POSIX kernel in a high-level language</a>. In <em>Proc. of OSDI</em>, 2018. (&#30828;&#26680;/&#19987;&#19994;&#20154;&#22763;&#35686;&#21578;)</li>
</ul>
<p class=" font-serif my-1">&#24403;&#28982;&#65292;&#25805;&#20316;&#31995;&#32479;&#20869;&#26680;&#30340;&#26377;&#36259;&#25925;&#20107;&#20063;&#27809;&#26377;&#20572;&#36807;&#65306;</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Kevin Boos, Namitha Liyanage, Ramla Ijaz, and Lin Zhong. <a href="https://www.usenix.org/conference/osdi20/presentation/boos" class=" text-amber-900">Theseus: An experiment in operating system structure and state management</a>. In <em>Proc. of OSDI</em>, 2020. </li>
</ul></div>
</div>

<div class="container text-xs py-3">
  <span class="text-muted">
    <center><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="../../../static/img/cc-4.0.png"></a>
    &#160;&#160;&#160;<a style="color:inherit" href="https://beian.miit.gov.cn/">&#33487; ICP &#22791; 2020049101 &#21495;</a>
    </center>
  </span>
</div>

</div>

<script src="../../../static/js/jquery.min.js"></script>

<script>
function get_token() {
  var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
  if (match) return match[2];
  else return "";
}
var token = get_token();
var hint = "token", box = $("#token-input");

if (token == "") { }
else { box.val(token); }

function login() {
  var token = box.val()
  if (!token) {
    document.cookie = ''
  } else {
    document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;'
  }
}
</script>


</body>

</html>