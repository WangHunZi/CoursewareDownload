<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>崩溃一致性与崩溃恢复</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans"><a href="29.3.slides.html" class=" text-amber-900">崩溃一致性与崩溃恢复</a></h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="crash-consistency" class=" text-xl mt-2 pb-2 font-sans">崩溃一致性 (Crash Consistency)</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1"><strong>Crash Consistency</strong>: Move the file system from one consistent state (e.g., before the file got appended to) to another atomically (e.g., after the inode, bitmap, and new data block have been written to disk).</p>
</blockquote>
<p class=" font-serif my-1"></p><center>(你们平时编程时假设不会发生的事，操作系统都要给你兜底)</center>
<hr>
<p class=" font-serif my-1">磁盘不提供多块读写 “all or nothing” 的支持</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">甚至为了性能，没有顺序保证<ul class=" list-disc font-serif">
<li class=" ml-8">bwrite 可能被乱序</li>
<li class=" ml-8">所以磁盘还提供了 bflush 等待已写入的数据落盘</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="file-system-checking-fsck" class=" text-xl mt-2 pb-2 font-sans">File System Checking (FSCK)</h2>
<p class=" font-serif my-1">根据磁盘上已有的信息，恢复出 “最可能” 的数据结构</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fsck-recovery.png" width="750px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.5555/1855741.1855751" class=" text-amber-900">SQCK: A declarative file system checker</a> (OSDI'08)</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/3281031" class=" text-amber-900">Towards robust file system checkers</a> (FAST'18)<ul class=" list-disc font-serif">
<li class=" ml-8">“widely used file systems (EXT4, XFS, BtrFS, and F2FS) may leave the file system in an uncorrectable state if the repair procedure is interrupted unexpectedly” 😂</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">针对 crash，我们需要更可靠的方法我们需要一个更可靠的方法</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">文件系统不一致的根本原因是<red>存储设备无法提供多次写入的原子性</red></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">重新思考数据结构的存储</h2>
<p class=" font-serif my-1">两个 “视角”</p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">存储实际<red>数据结构</red><ul class=" list-disc font-serif">
<li class=" ml-8">文件系统的 “直观” 表示</li>
<li class=" ml-8">crash unsafe</li>
</ul>
</li>
<li class=" ml-8">Append-only 记录所有<red>历史操作</red><ul class=" list-disc font-serif">
<li class=" ml-8">“重做” 所有操作得到数据结构的当前状态</li>
<li class=" ml-8">容易实现崩溃一致性</li>
</ul>
</li>
</ol>
<hr>
<p class=" font-serif my-1">二者的融合</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">数据结构操作发生时，用 (2) append-only 记录日志</li>
<li class=" ml-8">日志落盘后，用 (1) 更新数据结构</li>
<li class=" ml-8">崩溃后，重放日志并清除 (称为 redo log；相应也可以 undo log)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="atomic-append" class=" text-xl mt-2 pb-2 font-sans">实现 Atomic Append</h2>
<p class=" font-serif my-1">用 bread, bwrite 和 bflush 实现 append()</p>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/fs-journaling.png" width="800px"></p>
<ol class=" list-decimal font-serif">
<li class=" ml-8">定位到 journal 的末尾 (bread)</li>
<li class=" ml-8">bwrite TXBegin 和所有数据结构操作</li>
<li class=" ml-8">bflush 等待数据落盘</li>
<li class=" ml-8">bwrite TXEnd</li>
<li class=" ml-8">bflush 等待数据落盘</li>
<li class=" ml-8">将数据结构操作写入实际数据结构区域</li>
<li class=" ml-8">等待数据落盘后，删除 (标记) 日志</li>
</ol></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="journaling" class=" text-xl mt-2 pb-2 font-sans">Journaling: 优化</h2>
<p class=" font-serif my-1">现在磁盘需要写入双份的数据</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">批处理 (xv6; jbd)<ul class=" list-disc font-serif">
<li class=" ml-8">多次系统调用的 Tx 合并成一个，减少 log 的大小</li>
<li class=" ml-8">jbd: 定期 write back</li>
</ul>
</li>
<li class=" ml-8">Checksum (ext4)<ul class=" list-disc font-serif">
<li class=" ml-8">不再标记 TxBegin/TxEnd</li>
<li class=" ml-8">直接标记 Tx 的长度和 checksum</li>
</ul>
</li>
<li class=" ml-8">Metadata journaling (ext4 default)<ul class=" list-disc font-serif">
<li class=" ml-8">数据占磁盘写入的绝大部分<ul class=" list-disc font-serif">
<li class=" ml-8">只对 inode 和 bitmap 做 journaling 可以提高性能</li>
</ul>
</li>
<li class=" ml-8">保证文件系统的目录结构是一致的；但数据可能丢失</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="metadata-journaling" class=" text-xl mt-2 pb-2 font-sans">Metadata Journaling</h2>
<p class=" font-serif my-1">从应用视角来看，文件系统的行为可能很怪异</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">各类系统软件 (git, sqlite, gdbm, ...) 不幸中招<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://cn.bing.com/search?q=All+file+systems+are+not+created+equal%3A+On+the+complexity+of+crafting+crash-consistent+applications&form=APMCS1&PC=APMC" class=" text-amber-900">All file systems are not created equal: On the complexity of crafting crash-consistent applications</a> (OSDI'14)</li>
<li class=" ml-8">(os-workbench 里的小秘密)</li>
</ul>
</li>
<li class=" ml-8"><a href="https://zhuanlan.zhihu.com/p/25188921" class=" text-amber-900">更多的应用程序可能发生 data loss</a><ul class=" list-disc font-serif">
<li class=" ml-8">我们的工作: GNU coreutils, gmake, gzip, ... 也有问题</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/2950290.2950327" class=" text-amber-900">Crash consistency validation made easy</a> (FSE'16)</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">更为一劳永逸的方案：TxOS</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">xbegin/xend/xabort 系统调用实现跨 syscall 的 “all-or-nothing”<ul class=" list-disc font-serif">
<li class=" ml-8">应用场景：数据更新、软件更新、check-use……</li>
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/1629575.1629591" class=" text-amber-900">Operating systems transactions</a> (SOSP'09)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>