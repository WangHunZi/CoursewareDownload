<!DOCTYPE html><html class="h-100">


<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="../../../static/css/base.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/"></script>
  <link href="https://fonts.font.im/css?family=Source+Serif+Pro%7CLato%7CInconsolata" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="../../../static/img/favicon.png" type="image/x-icon">

  <style>
    .font-sans {
      font-family: 'Lato', 'SimHei', 'STHeiti', 'SimHei', 'Serif';
    }
    .font-serif {
      font-family: 'Source Serif Pro', 'Songti SC', 'SimSun', 'Serif', serif;
    }
  </style>
  <link rel="stylesheet" href="../../../static/katex/katex.min.css">
  <script defer src="../../../static/katex/katex.min.js"></script>
  <script defer src="../../../static/katex/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            // • rendering keys, e.g.:
            throwOnError : false
          });
      });
  </script>


  

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="../../../static/reveal/reveal.css">
<link rel="stylesheet" href="../../../static/reveal/theme/simple.css" id="theme">

<style>
.reveal .slide-number {
  font-size: 26px;
  border-radius: 5px;
  background-color: rgba(0, 0, 0, .3);
}

.reveal .full-screen {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
}

.reveal .slides {
  border: 1.5px #ddd solid;
  border-radius: 7px;
  text-align: left;
  font-weight: 300;
}

.reveal h1, .reveal h2, .reveal h3, .reveal h4 {
  font-family: 'Lato', 'SimHei', 'STXihei', 'Droid Sans';
  font-weight: 400;
}

.reveal p, .reveal li, .reveal center {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Droid Sans';
}

.reveal li + li {
  margin-top: 10px;
}

.reveal ul {
  display: block;
  margin-right: 15px;
}

.reveal p, .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
  padding:  0 25px 0 25px;
}

.reveal table {
  font-size: 32px;
  font-family: 'Lato', 'STHeiti', 'SimHei', 'Sans Serif';
  margin-top: 15px;
  margin-bottom: 15px;
}

.reveal th {
  background-color: #eee;
}

.reveal tr:nth-child(even) {
  background-color: #efffff;
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-align: left;
  margin: 0 0 20px 0;
 color: #222; 
  font-weight: 400;
  line-height: 1.2;
  letter-spacing: normal;
}



.reveal h1 {
  margin: 0 10 0 10;
  font-size: 60px;
}
.reveal .middle h1 {
  text-align: center;
}

.reveal h2 {
  font-size: 48px;
  border-bottom: 2px solid rgb(106, 0, 95);
  padding-bottom: 5px;
}
.reveal h3 { font-size: 1.15em; }
.reveal h4 { font-size: 1.05em; }

.reveal .center {
  text-align: center;
}

.reveal .middle {
  height: 728px;
  display: flex;
  align-items: center;
  width: 100%;
}

.reveal pre {
  font-size: 28px;
 
  background-color: #eee;

  border-radius: 3mm;
  padding: 10px 10px 10px 10px;
}

.reveal pre code {
  max-height: none;
}

.reveal code {
  font-family: 'Inconsolata', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif', Monospace;
}

.reveal .middle blockquote {
  text-align: center;
  color: rgb(106, 0, 95);
  background: none;
  box-shadow: none;
}

.reveal .middle blockquote a {
  color: inherit;
}

.reveal blockquote p, .reveal blockquote li {
  font-family: 'Lato', 'AR PL Ukai CN', 'STKaiti', 'KaiTi', 'Sans Serif';
}

section .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reveal .author-block {
  margin: 75px 0 35px 0;
}
.reveal .author-affiliation img {
  margin: 15px 0 0 0;
}
.reveal .author-block p, .reveal .author-affiliation p  {
  font-family: 'Kaiti', 'STKaiti', 'Serif', 'Times', 'Times New Roman';
  margin-block-start: 0em;
  margin-block-end: 0em;
}
.reveal .author-affiliation {
  display: inline-block;
  font-size: 90%;
}
.reveal hr {
  border: 10px solid rgba(0, 0, 0, 0);
}
.reveal li {
  margin-top: 10px;
}
</style>

  <title>真实的处理器调度</title>
</head>

<body class="d-flex flex-column h-100">
  
  

<div class="reveal">
<div class="slides">
   
    <section>
    
      
      <section>
      

      
        
        <div><div class="center middle"><div style="width:100%"><h1 id="_1" class=" text-2xl mt-2 font-sans"><a href="24.3.slides.html" class=" text-amber-900">🌶️ 真实的处理器调度</a></h1></div></div></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">不要高兴得太早</h2>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">jyy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 最低优先级</span>
<span class="w">  </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&</span><span class="n">wc_lock</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 先到先得</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">xi_zhu_ren</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 中优先级</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">xiao_zhang</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 高优先级</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&</span><span class="n">wc_lock</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p class=" font-serif my-1">jyy 在持有互斥锁的时候被赶下了处理器……</p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">这个故事在火星上发生过一次</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/mpf-sojourner.jpg" width="850px"></p>
<p class=" font-serif my-1"></p><center>Sojourner “探路者” (PathFinder)，1997 年 7 月 4 日登陆火星</center></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="the-first-bug-on-mars" class=" text-xl mt-2 pb-2 font-sans"><a href="https://news.ycombinator.com/item?id=13210478" class=" text-amber-900">The First Bug on Mars</a></h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/PATHCOV.jpg" width="300px"></p>
<p class=" font-serif my-1">Sojourner “探路者” (PathFinder)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">Lander (登陆舱)<ul class=" list-disc font-serif">
<li class=" ml-8">IBM Rad6000 SC (20 MIPS), 128 MiB RAM, 6 MiB EEPROM</li>
<li class=" ml-8">VxWorks “实时” 任务操作系统<ul class=" list-disc font-serif">
<li class=" ml-8">ASI/MET task: 大气成分监测 (低)</li>
<li class=" ml-8"><code>bc_dist</code> task: 分发任务 (中)</li>
<li class=" ml-8"><code>bc_sched</code> task: 总线调度 (高)</li>
</ul>
</li>
</ul>
</li>
<li class=" ml-8">Rover (火星车)<ul class=" list-disc font-serif">
<li class=" ml-8">Intel 80C85 (0.1 MIPS), 512K RAM, 176K Flash SSD</li>
</ul>
</li>
<li class=" ml-8">着陆后开始出现系统重启</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="the-first-bug-on-mars-contd" class=" text-xl mt-2 pb-2 font-sans">The First Bug on Mars (cont'd)</h2>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/marsbot.png" width="750px"></p>
<ul class=" list-disc font-serif">
<li class=" ml-8">(低优先级) <code>select -> pipeIoctl -> selNodeAdd -> mutex_lock</code></li>
<li class=" ml-8">(高优先级) <code>pipeWrite -> mutex_lock</code></li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">解决优先级反转问题</h2>
<p class=" font-serif my-1">Linux: 解决不了，CFS 凑合用吧</p>
<p class=" font-serif my-1">实时系统：火星车在 CPU Reset，不能摆烂啊</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">优先级继承 (Priority Inheritance)/优先级提升 (Priority Ceiling)<ul class=" list-disc font-serif">
<li class=" ml-8">持有 mutex 的线程/进程会继承 block 在该 mutex 上进程的最高优先级</li>
<li class=" ml-8">但也不是万能的 (例如条件变量唤醒)</li>
</ul>
</li>
<li class=" ml-8">在系统中动态维护资源依赖关系<ul class=" list-disc font-serif">
<li class=" ml-8">优先级继承是它的特例</li>
<li class=" ml-8">似乎更困难了……</li>
</ul>
</li>
<li class=" ml-8">避免高/低优先级的任务争抢资源<ul class=" list-disc font-serif">
<li class=" ml-8">对潜在的优先级反转进行预警 (lockdep)</li>
<li class=" ml-8">TX-based: 冲突的 TX 发生时，总是低优先级的 abort</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">还没完：多处理器调度</h2>
<p class=" font-serif my-1">还没完：我们的计算机系统可是多核心、多线程的！</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">上周的小学生竞赛：租半小时阿里云 bare-metal 搞定评测</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/taskmgr.jpg" width="600px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">多处理器调度：被低估的复杂性</h2>
<blockquote class=" bg-gray-200 p-2 rounded mb-2 mt-2 mx-4">
<p class=" font-serif my-1">“And you have to realize that there are not very many things that have aged as well as the scheduler. Which is just another proof that scheduling is easy.”
——Linus Torvalds, 2001</p>
</blockquote>
<hr>
<p class=" font-serif my-1">Linus 以为调度是个挺简单的问题？</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">As a central part of resource management, the OS thread scheduler must maintain the following, simple, invariant: <em>make sure that ready threads are scheduled on available cores</em>... this invariant is often broken in Linux. Cores may stay idle for seconds while ready threads are waiting in runqueues.<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://dl.acm.org/doi/10.1145/2901318.2901326" class=" text-amber-900">The Linux scheduler: A decade of wasted cores</a>. (EuroSys'16)<ul class=" list-disc font-serif">
<li class=" ml-8">作者在狂黑 Linus 😂</li>
</ul>
</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">多处理器调度的困难所在</h2>
<p class=" font-serif my-1">既不能简单地 “分配线程到处理器”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">线程退出，瞬间处理器开始围观</li>
</ul>
<hr>
<p class=" font-serif my-1">也不能简单地 “谁空丢给谁”</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">在处理器之间迁移会导致 cache/TLB 全都白给</li>
</ul>
<hr>
<p class=" font-serif my-1">多处理器调度的两难境地</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">迁移？可能过一会儿还得移回来</li>
<li class=" ml-8">不迁移？造成处理器的浪费</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="1" class=" text-xl mt-2 pb-2 font-sans">实际情况 (1): 多用户、多任务</h2>
<p class=" font-serif my-1">组里有一台 64-core 的服务器</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">马上要到 paper deadline 了，A 和 B 要在服务器上跑实验<ul class=" list-disc font-serif">
<li class=" ml-8">A 要跑一个任务，调用一个库，只能单线程跑</li>
<li class=" ml-8">B 跑并行的任务，创建 10,000 个线程跑<ul class=" list-disc font-serif">
<li class=" ml-8">B 获得几乎 100% 的 CPU</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">更糟糕的是，优先级解决不了这个问题……</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">B 不能随便提高自己进程的优先级<ul class=" list-disc font-serif">
<li class=" ml-8">“An unprivileged user can only increase the nice value and such changes are irreversible...”</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="linux-namespaces-control-groups-cgroups" class=" text-xl mt-2 pb-2 font-sans">Linux Namespaces Control Groups (cgroups)</h2>
<p class=" font-serif my-1">namespaces (7), cgroups (7)</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">轻量级虚拟化，创造 “操作系统中的操作系统”<ul class=" list-disc font-serif">
<li class=" ml-8">Mount, pid, network, IPC, user, cgroup namespace, time</li>
<li class=" ml-8">cgroup 允许以进程组为单位管理资源<ul class=" list-disc font-serif">
<li class=" ml-8">Docker 就变得很容易实现了</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/cgroups.jpg" width="500px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2-biglittle" class=" text-xl mt-2 pb-2 font-sans">实际情况 (2): Big.LITTLE/能效比</h2>
<p class=" font-serif my-1"><img alt="" class="float-right" src="../../../pages/OS/img/Snapdragon-888.png" width="400px"></p>
<p class=" font-serif my-1">Snapdragon 888</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">1X Prime Cortex-X1 (2.84GHz)</li>
<li class=" ml-8">3X Performance Cortex-A78 (2.4GHz)</li>
<li class=" ml-8">4X Efficiency Cortex-A55 (1.8GHz)<ul class=" list-disc font-serif">
<li class=" ml-8">这比 P/E Cores 还要夸张 😂</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">“Dark silicon” 时代的困境</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">功率无法支撑所有电路同时工作</li>
<li class=" ml-8">总得有一部分是停下的</li>
<li class=" ml-8">Linux Kernel <a href="https://www.kernel.org/doc/html/latest/scheduler/sched-energy.html" class=" text-amber-900">EAS</a> (Energy Aware Scheduler)</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="2-biglittle-contd" class=" text-xl mt-2 pb-2 font-sans">实际情况 (2): Big.LITTLE/能耗 (cont'd)</h2>
<p class=" font-serif my-1">软件可以配置 CPU 的工作模式</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">开/关/工作频率 (频率越低，能效越好)</li>
<li class=" ml-8">如何在给定功率下平衡延迟 v.s. 吞吐量？</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/power-curve.png" width="550px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="3-non-uniform-memory-access" class=" text-xl mt-2 pb-2 font-sans">实际情况 (3): Non-Uniform Memory Access</h2>
<p class=" font-serif my-1">共享内存只是假象</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">L1 Cache 花了巨大的代价才让你感到内存是共享的</li>
<li class=" ml-8">Producer/Consumer 位于同一个/不同 module 性能差距可能很大</li>
</ul>
<p class=" font-serif my-1"><img alt="" class="center" src="../../../pages/OS/img/EPYC-NUMA.png" width="640px"></p></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="_1" class=" text-xl mt-2 pb-2 font-sans">程序执行比你想象得复杂</h2>
<p class=" font-serif my-1">基本的假设可能不再成立</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">例子: more CPU time, more progress<ul class=" list-disc font-serif">
<li class=" ml-8">我们课堂上的例子就可以 challenge 这一点</li>
<li class=" ml-8">(sum-atomic)</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=" bg-gray-100 overflow-x-auto rounded p-2 mb-2 mt-2"><span></span><code>$ time taskset -c 0   ./a.out
$ time taskset -c 0,1 ./a.out
</code></pre></div>

<hr>
<p class=" font-serif my-1">分配了 1/2 的处理器资源，反而速度更快了</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">系统里进程的行为和交互是非常复杂的……<ul class=" list-disc font-serif">
<li class=" ml-8">NUMA 里尤其重要 (当然上面的例子是个 performance bug)</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
      
      <section>
      

      
        
        <div><h2 id="4-cpu-hot-plug" class=" text-xl mt-2 pb-2 font-sans">实际情况 (4): CPU Hot-plug</h2>
<p class=" font-serif my-1">😂😂😂 我讲不下去了</p>
<ul class=" list-disc font-serif">
<li class=" ml-8">实在是太复杂了</li>
<li class=" ml-8">我不是代码的维护者，并不清楚这些细节<ul class=" list-disc font-serif">
<li class=" ml-8">把上面都加起来<ul class=" list-disc font-serif">
<li class=" ml-8">这得考虑多少情况，写多少代码……</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p class=" font-serif my-1">复杂的系统无人可以掌控</p>
<ul class=" list-disc font-serif">
<li class=" ml-8"><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" class=" text-amber-900">The battle of the schedulers: FreeBSD ULE vs. Linux CFS</a>. (ATC'18)<ul class=" list-disc font-serif">
<li class=" ml-8">结论：在现实面前，没有绝对的赢家和输家</li>
<li class=" ml-8">如果你追求极致的性能，就不能全指望一个调度算法</li>
</ul>
</li>
</ul></div>
        
      
      </section>
    
    </section>
  
</div>
</div>

<script src="../../../static/reveal/reveal.js"></script>
<script>
  Reveal.initialize({
    
    width: 1024, height: 768,
    
    slideNumber: 'c/t',
    controlsTutorial: false,
    progress: false,
    hash: true,
    center: false,
    autoAnimateUnmatched: true,
    autoAnimateEasing: 'ease-out',
    autoAnimateDuration: 0.3,
    transitionSpeed: 'fast'
  });
</script>


</body>


</html>